
<feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en">
  <title type="text">Andrea Leopardi</title>
  <subtitle type="text">Writing about Elixir, system architecture, and more.</subtitle>
  <updated>2025-07-09T09:11:18.031273302+00:00</updated>
  <link rel="self" type="application/atom+xml" href="https://andrealeopardi.com/feed.xml" />
  <link rel="alternate" type="text/html" href="https://andrealeopardi.com/" />
  <id>https://andrealeopardi.com/</id>
  <author>
    <name>Andrea Leopardi</name>
    <uri>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;</uri>
    <email>hi@andrealeopardi.com</email>
  </author>
  <generator uri="https://www.getzola.org">Zola</generator>
  <icon>https://andrealeopardi.com/favicons/apple-touch-icon.png</icon>
  <logo>https://andrealeopardi.com/favicons/apple-touch-icon.png</logo>

  
    <entry>
      <id>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;posts&#x2F;async-tests-in-elixir&#x2F;</id>
      <title type="html"><![CDATA[ How to Async Tests in Elixir ]]></title>
      <link rel="alternate"
            type="text/html"
            href="https://andrealeopardi.com/posts/async-tests-in-elixir/"
            title="How to Async Tests in Elixir" />
      <published>2025-04-28T00:00:00+00:00</published>
      <author>
        <name>Andrea Leopardi</name>
        <uri>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;</uri>
        <email>hi@andrealeopardi.com</email>
      </author>
      <updated>2025-04-28T00:00:00+00:00</updated>
      <summary type="html">&lt;p&gt;Recently, I&apos;ve been focusing a lot on the health of our test suite at &lt;a href=&quot;https://knock.app&quot;&gt;Knock&lt;/a&gt;. Fast, reliable tests are a boost for confidence and developer happiness, so I naturally care a lot about this. I&apos;ve been wrestling with two main things: slow tests, and flaky tests. My sworn enemies.&lt;/p&gt;&lt;p&gt;The good news here is that I believe that the &quot;solution&quot; to both these issues are proper, robust &lt;strong&gt;asynchronous&lt;/strong&gt; tests. When tests are asynchronous, single tests can even be somewhat slow because you have ways to overcome that. You can &lt;em&gt;scale horizontally&lt;/em&gt; with more parallel tests, more cores, and so on. You can split up test cases and parallelize slow tests even more. What about flakiness? Right. In my experience, so much of the flakiness comes from either improperly-written asynchronous tests or slow timeouts and assertions on messages. Go fix the latter, I have no silver bullet for that.&lt;/p&gt;&lt;p&gt;This post is about beautiful, elegant, robust asynchronous tests in Elixir. It&apos;s also a kind of ode to OTP concurrency and about parallel-forward thinking and maybe some other made up words.&lt;/p&gt;</summary>
    
      <content type="html">&lt;p&gt;Recently, I&apos;ve been focusing a lot on the health of our test suite at &lt;a href=&quot;https://knock.app&quot;&gt;Knock&lt;/a&gt;. Fast, reliable tests are a boost for confidence and developer happiness, so I naturally care a lot about this. I&apos;ve been wrestling with two main things: slow tests, and flaky tests. My sworn enemies.&lt;/p&gt;&lt;p&gt;The good news here is that I believe that the &quot;solution&quot; to both these issues are proper, robust &lt;strong&gt;asynchronous&lt;/strong&gt; tests. When tests are asynchronous, single tests can even be somewhat slow because you have ways to overcome that. You can &lt;em&gt;scale horizontally&lt;/em&gt; with more parallel tests, more cores, and so on. You can split up test cases and parallelize slow tests even more. What about flakiness? Right. In my experience, so much of the flakiness comes from either improperly-written asynchronous tests or slow timeouts and assertions on messages. Go fix the latter, I have no silver bullet for that.&lt;/p&gt;&lt;p&gt;This post is about beautiful, elegant, robust asynchronous tests in Elixir. It&apos;s also a kind of ode to OTP concurrency and about parallel-forward thinking and maybe some other made up words.&lt;/p&gt;&lt;span id=&quot;continue-reading&quot;&gt;&lt;/span&gt;&lt;p&gt;&lt;img src=&quot;https://andrealeopardi.com/posts/async-tests-in-elixir/cover-image.jpg&quot; alt=&quot;Cover image of a bench with very geometric lines.&quot; /&gt;&lt;/p&gt;&lt;span class=&quot;unsplash-credit&quot;&gt;
    Photo by &lt;a href=&quot;&amp;lt;https:&amp;#x2F;&amp;#x2F;unsplash.com&amp;#x2F;photos&amp;#x2F;a-wooden-room-with-a-bench-in-the-middle-of-it-klE0kbCfrwk?utm_content=creditCopyText&amp;amp;utm_medium=referral&amp;amp;utm_source=unsplash&amp;gt;&quot;&gt;鱼 鱼&lt;/a&gt; on &lt;a href=&quot;https://unsplash.com&quot;&gt;Unsplash&lt;/a&gt;&lt;/span&gt;&lt;h2 id=&quot;when-is-it-hard-to-parallelize-tests&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#when-is-it-hard-to-parallelize-tests&quot; aria-label=&quot;Anchor link for: when-is-it-hard-to-parallelize-tests&quot;&gt;When Is It Hard to Parallelize Tests?&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;First of all, throw tests for pure code out of the window. We don&apos;t care about those. Say I have a function that checks if a string is valid base64 data:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;valid_base64?&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;string&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  match?&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; _&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Base&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;decode64&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;string&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Nothing that has to do with testing it in parallel here. This has no side effects. It&apos;s as pure as the eyes of a golden retriever puppy. Test this in parallel to your heart&apos;s desire, even though I doubt this is the kind of tests that are making your test suite slow.&lt;/p&gt;&lt;p&gt;So, side effects are what make it hard to turn tests async? Yeah, in some way. That, but in particular &lt;em&gt;singletons&lt;/em&gt;. We&apos;ll see in a sec, let&apos;s go through why &lt;em&gt;some&lt;/em&gt; side effects are easy to test in parallel.&lt;/p&gt;&lt;p&gt;Maybe you want to test a function that writes something to a file. Writing to the filesystem is a side effect, no doubts, and a destructive kind (the scariest kind!). But, as long as you&apos;re smart about &lt;em&gt;where&lt;/em&gt; to write, you can kind of get away with it:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;test &lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;writes output to a file&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  filename &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-interpolation z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-interpolation z-begin z-elixir&quot;&gt;#{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-interpolation z-elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir z-embedded&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;unique_integer&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;positive&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-interpolation z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;.txt&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  output_path &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Path&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;join&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;tmp_dir!&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; filename&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MyMod&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;calculate_something_and_write_it&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;output_path&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;aside class=&quot;callout callout-warning&quot;&gt;&lt;h5&gt;Don&amp;#x27;t Do This at Home&lt;/h5&gt;&lt;div class=&quot;callout-content&quot;&gt;&lt;p&gt;Use ExUnit&apos;s &lt;code&gt;tmp_dir&lt;/code&gt; tag. It cleans up for you and it&apos;s nicer and it protects kittens (probably).&lt;/p&gt;&lt;/div&gt;&lt;/aside&gt;&lt;p&gt;Cool, you can run many of these tests in parallel and they won&apos;t step on each other&apos;s toes, even though the system under test is all about the side effect.&lt;/p&gt;&lt;h3 id=&quot;singletons-are-the-bane-of-async-tests&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#singletons-are-the-bane-of-async-tests&quot; aria-label=&quot;Anchor link for: singletons-are-the-bane-of-async-tests&quot;&gt;Singletons Are the Bane of Async Tests&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Back to &lt;strong&gt;singletons&lt;/strong&gt;. A &lt;a href=&quot;https://en.wikipedia.org/wiki/Singleton_pattern&quot;&gt;singleton&lt;/a&gt; is something which you have a single instance in your system.  Those are hard to test. You want an example that you probably know about? I&apos;ll give you one. That sick, deprived &lt;code&gt;Logger&lt;/code&gt;. Yucksies. &lt;code&gt;Logger&lt;/code&gt; is a singleton in the sense that you usually only log to stdout/stderr and use &lt;code&gt;ExUnit.CaptureLog&lt;/code&gt; functions to assert on logged content. But if two pieces of code log at the same time—because spoiler, it&apos;s two tests running concurrently and executing some code that logs something—:vomiting_face:. Who captures what. It&apos;s undeterministic (well until you have to patch a hotfix in production, then it&apos;s whatever makes at least one of the tests &lt;strong&gt;fail&lt;/strong&gt; in CI).&lt;/p&gt;&lt;p&gt;You&apos;re likely to have an assorted, colorful bunch of other singletons in your system. The GenServers ticking every few seconds and doing godknowswhat™. The ETS tables doing the cachin&apos;. You know the ones.&lt;/p&gt;&lt;p&gt;But fear no more, there is a fix for almost all situations. It&apos;s based on LLMs, agentic processing, and the power of AI. Nah just kidding, it&apos;s &lt;strong&gt;ownership&lt;/strong&gt; (plus getting rid of singletons, lol).&lt;/p&gt;&lt;p&gt;The getting-rid part first.&lt;/p&gt;&lt;h2 id=&quot;no-more-singletons&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#no-more-singletons&quot; aria-label=&quot;Anchor link for: no-more-singletons&quot;&gt;No More Singletons&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Design your processes and interfaces and applications so that singleton-ness (singleton-icity? singleton-ality?) is &lt;em&gt;optional&lt;/em&gt;. Say I have a process that buffers metric writes to a StatsD agent so as to be Very Fast™ and out of the way of your system.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MetricsBuffer&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;use&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;GenServer&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;start_link&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; _opts&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;GenServer&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;start_link&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-elixir&quot;&gt;__MODULE__&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;no_args&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;name&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-elixir&quot;&gt;__MODULE__&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;increment_counter&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;name&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;GenServer&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;cast&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-elixir&quot;&gt;__MODULE__&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;metric&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;counter&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; name&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; ...
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-variable z-other z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-definition z-constant z-elixir&quot;&gt;@&lt;/span&gt;impl&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;GenServer&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;handle_cast&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;metric&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; type&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; name&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; state&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;noreply&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; buffer_metric&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;state&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; type&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; name&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Bad news: that&apos;s a singleton if I&apos;ve ever seen one. The sneaky &lt;code&gt;name: __MODULE__&lt;/code&gt; is the culprit. If you register the process with a (very &quot;static&quot;) name, and then cast to it by name, then there can only be one of those processes in the system. If two concurrent tests emit a metric through &lt;code&gt;MetricsBuffer&lt;/code&gt;, you just lost the ability to test those metrics as you&apos;ll have unpredictable results depending on the order those tests execute stuff in.&lt;/p&gt;&lt;p&gt;I don&apos;t know of a perfectly &lt;em&gt;clean&lt;/em&gt; way to solve this. &quot;Clean&quot; in testing usually involves stuff like &quot;don&apos;t change your code to make tests easier&quot; and stuff like that. I&apos;d rather have some test code in there and write tests for this, then to not write tests altogether, so let&apos;s power through.&lt;/p&gt;&lt;h3 id=&quot;de-singleton-ifying&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#de-singleton-ifying&quot; aria-label=&quot;Anchor link for: de-singleton-ifying&quot;&gt;De-singleton-ifying&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;The simplest approach to take in these cases, in my opinion, is to make your singleton behave like a singleton at production time, but not making it a singleton at test time. You&apos;ll see what I mean in a second.&lt;/p&gt;&lt;pre data-lang=&quot;diff&quot; class=&quot;language-diff z-code&quot;&gt;&lt;code class=&quot;language-diff&quot; data-lang=&quot;diff&quot;&gt;&lt;span class=&quot;z-source z-diff&quot;&gt; defmodule MetricsBuffer do
&lt;/span&gt;&lt;span class=&quot;z-source z-diff&quot;&gt;   use GenServer
&lt;/span&gt;&lt;span class=&quot;z-source z-diff&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-diff&quot;&gt;&lt;span class=&quot;z-markup z-deleted z-diff&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-deleted z-diff&quot;&gt;-&lt;/span&gt;  def start_link([] = _opts) do
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-diff&quot;&gt;&lt;span class=&quot;z-markup z-inserted z-diff&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-inserted z-diff&quot;&gt;+&lt;/span&gt;  def start_link(opts) do
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-diff&quot;&gt;&lt;span class=&quot;z-markup z-deleted z-diff&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-deleted z-diff&quot;&gt;-&lt;/span&gt;    GenServer.start_link(__MODULE__, :no_args, name: __MODULE__)
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-diff&quot;&gt;&lt;span class=&quot;z-markup z-inserted z-diff&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-inserted z-diff&quot;&gt;+&lt;/span&gt;    name = Keyword.get(opts, :name, __MODULE__)
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-diff&quot;&gt;&lt;span class=&quot;z-markup z-inserted z-diff&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-inserted z-diff&quot;&gt;+&lt;/span&gt;    GenServer.start_link(__MODULE__, :no_args, name: name)
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-diff&quot;&gt;   end
&lt;/span&gt;&lt;span class=&quot;z-source z-diff&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-diff&quot;&gt;&lt;span class=&quot;z-markup z-deleted z-diff&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-deleted z-diff&quot;&gt;-&lt;/span&gt;  def increment_counter(name) do
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-diff&quot;&gt;&lt;span class=&quot;z-markup z-inserted z-diff&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-inserted z-diff&quot;&gt;+&lt;/span&gt;  def increment_counter(server \\ __MODULE__, name) do
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-diff&quot;&gt;&lt;span class=&quot;z-markup z-deleted z-diff&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-deleted z-diff&quot;&gt;-&lt;/span&gt;    GenServer.cast(__MODULE__, {:metric, :counter, name})
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-diff&quot;&gt;&lt;span class=&quot;z-markup z-inserted z-diff&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-inserted z-diff&quot;&gt;+&lt;/span&gt;    GenServer.cast(server, {:metric, :counter, name})
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-diff&quot;&gt;   end
&lt;/span&gt;&lt;span class=&quot;z-source z-diff&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-diff&quot;&gt;   # ...
&lt;/span&gt;&lt;span class=&quot;z-source z-diff&quot;&gt; end
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Now, you&apos;re making the GenServer name optional and defaulting to &lt;code&gt;__MODULE__&lt;/code&gt;. That&apos;s what it&apos;ll use in production. In tests, you can start it with something like&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;setup context &lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  server_name &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Module&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;concat&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-elixir&quot;&gt;__MODULE__&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; context&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;test&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  start_supervised!&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MetricsBuffer&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;name&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; server_name&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;metrics_server&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; server_name&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Nice, but there are some issues. The main one is that you have to explicitly reference that new name everywhere in your test case now. But you might not be testing the public API for &lt;code&gt;MetricsBuffer&lt;/code&gt; directly—maybe your code-under-test is calling out to that. How do you pass stuff around? Turns out, you combine this technique with &lt;em&gt;ownership&lt;/em&gt;.&lt;/p&gt;&lt;h2 id=&quot;ownership-async-true-heart&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#ownership-async-true-heart&quot; aria-label=&quot;Anchor link for: ownership-async-true-heart&quot;&gt;Ownership + &lt;code&gt;async: true&lt;/code&gt; = :heart:&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;First, a few words to explain what I’m talking about. The idea with ownership is that you want to slice your resources so that each test (and its process) &lt;strong&gt;own&lt;/strong&gt; the resources. For example, you want each test process to &quot;own&quot; its own &lt;code&gt;MetricsBuffer&lt;/code&gt; running instance. If the owned resources are isolated from each other, then you can run those tests asynchronously.&lt;/p&gt;&lt;p&gt;There are a few ways you can build ownership into your code. Let&apos;s take a look.&lt;/p&gt;&lt;h3 id=&quot;at-the-process-level-nimble-ownership-and-processtree&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#at-the-process-level-nimble-ownership-and-processtree&quot; aria-label=&quot;Anchor link for: at-the-process-level-nimble-ownership-and-processtree&quot;&gt;At the Process Level: nimble_ownership and ProcessTree&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Ownership (in this context) is essentially always at the &lt;strong&gt;process level&lt;/strong&gt;. Each test process owns the resource. However, the important caveat is that you often want &quot;child processes&quot; of the test process to be allowed to use the resource too. Basically, you want this to work:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;test &lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;async metrics&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Task&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;async&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;fn&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-other z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; ↓ Should still use the metrics server owned by the test process
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    code_that_reports_metrics&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;without necessarily passing the &lt;code&gt;MetricsServer&lt;/code&gt; around (which is often a pain to do). There&apos;s a pretty easy solution that, however, requires you to modify your &lt;code&gt;MetricsServer&lt;/code&gt; code a bit.&lt;/p&gt;&lt;h4 id=&quot;processtree&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#processtree&quot; aria-label=&quot;Anchor link for: processtree&quot;&gt;&lt;code&gt;ProcessTree&lt;/code&gt;&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;I’m talking about a library called &lt;a href=&quot;https://github.com/jbsf2/process-tree&quot;&gt;process_tree&lt;/a&gt;. Its job is pretty simple: it looks up keys in the process dictionary of the current process and its &quot;parents&quot;. A short example:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Process&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;put&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;some_key&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;some value&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;task &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Task&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;async&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;fn&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-other z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Process&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;get&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;some_key&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;ProcessTree&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;get&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;some_key&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Task&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;await&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;task&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt;=&amp;gt; {nil, &amp;quot;some value&amp;quot;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;This &quot;parent lookup&quot; is based on a few features of OTP, namely the &lt;code&gt;:&quot;$callers&quot;&lt;/code&gt; process dictionary key that many OTP behaviours use as well as &lt;a href=&quot;https://www.erlang.org/docs/26/man/erlang#process_info-2&quot;&gt;&lt;code&gt;:erlang.process_info(pid, :parent)&lt;/code&gt;&lt;/a&gt;. This turns out to be pretty reliable.&lt;/p&gt;&lt;p&gt;&lt;img src=&quot;https://andrealeopardi.com/posts/async-tests-in-elixir/process_tree.png&quot; alt=&quot;A diagram showing parent-child process relationships. At the top is a pink oval labeled &amp;quot;TEST PROCESS&amp;quot; connected by lines labeled &amp;quot;Process.get&amp;quot; to a light green oval labeled &amp;quot;CHILD PROCESS&amp;quot; in the middle-right. The child process connects via another &amp;quot;Process.get&amp;quot; line to a light yellow oval labeled &amp;quot;GRAND CHILD PROCESS&amp;quot; on the right. There&amp;#39;s also a dotted line connecting the test process to another light purple oval labeled &amp;quot;CHILD PROCESS&amp;quot; on the left side.&quot; /&gt;&lt;/p&gt;&lt;p&gt;Now, the trick to have async tests here is to store the PID of the metrics server (or whatever singleton) in the process tree of your test process. Then, every &quot;child&quot; of your test process has access to this. In my opinion, a nice way to do this is to just slightly modify the &lt;code&gt;MetricsServer&lt;/code&gt; code:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MetricsServer&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;start_link&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;opts&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;GenServer&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;start_link&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-elixir&quot;&gt;__MODULE__&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;no_arg&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Keyword&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;take&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;opts&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;name&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;increment_counter&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;name&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;GenServer&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;cast&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;server&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;metric&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;counter&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; name&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; ...
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Mix&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;env&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;test&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defp&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-private z-elixir&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;ProcessTree&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;get&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-elixir&quot;&gt;__MODULE__&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;server_pid&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;else&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defp&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-private z-elixir&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-variable z-language z-elixir&quot;&gt;__MODULE__&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The idea is that you start your server with &lt;code&gt;name: MetricsServer&lt;/code&gt; in your application supervisor. In tests, instead, you do:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;setup &lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  pid &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; start_supervised&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MetricsServer&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Process&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;put&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MetricsServer&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;server_pid&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; pid&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Voila! You have Solved Async Tests™.&lt;/p&gt;&lt;p&gt;Now, if you&apos;re worried about whether this is a &quot;clean&quot; solution, I get it. However, let&apos;s think through this a sec. What is it that you&apos;re doing in production that you&apos;re not testing here? I&apos;d argue it&apos;s only the name resolution. In production, you&apos;re not testing that &lt;code&gt;__MODULE__&lt;/code&gt; name registration works... But that&apos;s OTP, so I trust that.&lt;/p&gt;&lt;p&gt;Now, &lt;code&gt;ProcessTree&lt;/code&gt; falls short when you want to have utilities that test something about the owned resource &lt;em&gt;after the test is finished&lt;/em&gt;. This is somewhat a common use case. The prime example is &lt;a href=&quot;https://github.com/dashbitco/mox&quot;&gt;Mox&lt;/a&gt;. In Mox, you want to assert that the expected number of calls were received during the test, but &lt;em&gt;after&lt;/em&gt; the test is done. Mox uses a &lt;code&gt;on_exit&lt;/code&gt; hook for this, but when &lt;code&gt;on_exit&lt;/code&gt; runs the test process has already exited... We need to store these expectations outside of the test process, and be able to retrieve them after the test is done. We need a resource that outlives the test.&lt;/p&gt;&lt;h4 id=&quot;enter-nimble-ownership&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#enter-nimble-ownership&quot; aria-label=&quot;Anchor link for: enter-nimble-ownership&quot;&gt;Enter &lt;code&gt;nimble_ownership&lt;/code&gt;&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/dashbitco/nimble_ownership&quot;&gt;nimble_ownership&lt;/a&gt; is a small library that we extracted out of Mox itself. Its job is to provide an &quot;ownership server&quot; and track ownership of resources across processes.&lt;/p&gt;&lt;p&gt;The ownership server can store some metadata for a given process. Then, that process can &lt;em&gt;allow&lt;/em&gt; other processes to access and modify that metadata.&lt;/p&gt;&lt;p&gt;&lt;img src=&quot;https://andrealeopardi.com/posts/async-tests-in-elixir/nimble_ownership.png&quot; alt=&quot;A diagram illustrating an ownership server architecture. At the top is a rectangle labeled &amp;quot;OWNERSHIP SERVER&amp;quot; containing two vertical columns labeled &amp;quot;RESOURCE&amp;quot; with multi-colored layers. Text annotation states &amp;quot;Has one &amp;#39;version&amp;#39; of the resource for each owner.&amp;quot; Below, connected by dotted lines, are two light blue ovals labeled &amp;quot;TEST PROCESS #1&amp;quot; and &amp;quot;TEST PROCESS #2&amp;quot;, each connected to two small yellow ovals labeled &amp;quot;PROC&amp;quot; that represent processes. Dotted lines show connections between these processes and the resources in the ownership server.&quot; /&gt;&lt;/p&gt;&lt;p&gt;You might see how Mox uses this. Mox starts a global ownership server when it starts (&lt;code&gt;Mox.Server&lt;/code&gt;) and stores expectations for each function in each mock module, &lt;em&gt;for each process&lt;/em&gt; that calls &lt;code&gt;Mox.expect/4&lt;/code&gt;. A simplified implementation could:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;Store a list of &lt;code&gt;{mock_module, function_name, implementation}&lt;/code&gt; tuples.&lt;/li&gt;&lt;li&gt;Whenever there&apos;s a call to a function in the mock module, the mock module (which is implemented by Mox) would find the tuple for the right mock module and function, and &quot;pop&quot; the &lt;code&gt;implementation&lt;/code&gt;.&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;Then, you&apos;d &lt;em&gt;allow&lt;/em&gt; other processes (like child processes) to use the mocks. The server would do something like:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MyMox&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;start_link&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;NimbleOwnership&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;start_link&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;name&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-elixir&quot;&gt;__MODULE__&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;expect&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;mod&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; fun&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; impl&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;NimbleOwnership&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;get_and_update&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-variable z-language z-elixir&quot;&gt;__MODULE__&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;      _owner &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; self&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;      _key &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;mocked_functions&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;fn&lt;/span&gt; current_value &lt;span class=&quot;z-keyword z-operator z-other z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;        new_value &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;current_value &lt;span class=&quot;z-keyword z-operator z-other z-elixir&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-other z-elixir&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-list-manipulation z-elixir&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;mod&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; fun&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; impl&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;new_value&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;unused_return_value&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Then, the generated mock modules could do something like:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;my_mocked_fun&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;arg1&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; arg2&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; owner&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;NimbleOwnership&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;fetch_owner&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;      _ownership_server &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MyMox&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;self&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-other z-elixir&quot;&gt;|&lt;/span&gt; callers&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;mocked_functions&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  impl &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;NimbleOwnership&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;get_and_update&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MyMox&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;      owner&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;      _key &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;mocked_functions&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;fn&lt;/span&gt; current_value &lt;span class=&quot;z-keyword z-operator z-other z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt; pop_implementation&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;current_value&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  apply&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;impl&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;arg1&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; arg2&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defp&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-private z-elixir&quot;&gt;callers&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Process&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;get&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-double-quoted z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&amp;quot;&lt;/span&gt;$callers&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-other z-elixir&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-other z-elixir&quot;&gt;|&lt;/span&gt; parents&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;self&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defp&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-private z-elixir&quot;&gt;parents&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;pid&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;case&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Process&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;info&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;pid&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;parent&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;parent&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;undefined&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;parent&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; parent&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;parent &lt;span class=&quot;z-keyword z-operator z-other z-elixir&quot;&gt;|&lt;/span&gt; parents&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;parent&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The key thing here is that mock implementations are not tied to the &lt;em&gt;lifecycle&lt;/em&gt; of the test process, nor is the ownership server. So, when the test process has exited (like in an &lt;code&gt;on_exit&lt;/code&gt; hook), you can still access the owned resources for that exited test process and perform assertions on those.&lt;/p&gt;&lt;p&gt;This whole ownership thing is not super straightforward, but the &lt;a href=&quot;https://hexdocs.pm/nimble_ownership/NimbleOwnership.html&quot;&gt;nimble_ownership documentation&lt;/a&gt; does a good job at explaining how it works. Also, you can go dig into the Mox implementation to see how it uses nimble_ownership.&lt;/p&gt;&lt;p&gt;Now, there&apos;s another way of doing process-based ownership that you&apos;ve likely been using.&lt;/p&gt;&lt;h3 id=&quot;at-the-database-level-transactions&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#at-the-database-level-transactions&quot; aria-label=&quot;Anchor link for: at-the-database-level-transactions&quot;&gt;At the Database Level: Transactions&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/elixir-ecto/ecto&quot;&gt;Ecto&lt;/a&gt; is probably the best-known example of tracking ownership. Ecto calls it the &lt;strong&gt;sandbox&lt;/strong&gt;, but the idea is quite similar. First, why this is an issue: the database is, in its own way, shared state. Say you had:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;A test that selects all rows from table &lt;code&gt;accounts&lt;/code&gt;.&lt;/li&gt;&lt;li&gt;Another test that inserts a row in the &lt;code&gt;accounts&lt;/code&gt; table.&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;Test #1 would sometimes see the new from test #2 and sometimes not. Flaky test.&lt;/p&gt;&lt;p&gt;So, instead of tracking a resource like a nimble_ownership server or similar, the Ecto sandbox tracks &lt;em&gt;a database transaction&lt;/em&gt;. All DB operations in a test and in the &lt;strong&gt;allowed processes&lt;/strong&gt; for that test run in a database transaction, that gets rolled back when the test finishes. No data overlap!&lt;/p&gt;&lt;p&gt;Ecto implements its own ownership mechanism, &lt;a href=&quot;https://hexdocs.pm/ecto_sql/Ecto.Adapters.SQL.Sandbox.html&quot;&gt;&lt;code&gt;Ecto.Adapters.SQL.Sandbox&lt;/code&gt;&lt;/a&gt;, but the ideas are the same as the ones we discussed in this post.&lt;/p&gt;&lt;h3 id=&quot;at-other-levels-whooopsie&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#at-other-levels-whooopsie&quot; aria-label=&quot;Anchor link for: at-other-levels-whooopsie&quot;&gt;At Other Levels: Whooopsie&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;There are some singletons that you cannot get out of having. We already mentioned &lt;code&gt;Logger&lt;/code&gt;, for example. You could get clever with ownership-aware logger handlers and whatnot, but that&apos;s not the only common one. Another frequent suspect is &lt;code&gt;Application&lt;/code&gt; configuration. If your code reads values from the application environment, then testing changes to those values makes it impossible to run those tests asynchronously:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;truncate_string&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;string&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  limit &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Application&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;get_env&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;my_app&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;truncation_limit&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;500&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;slice&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;string&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-elixir&quot;&gt;..&lt;/span&gt;limit&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;test &lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;truncate_string/1 respects the configured limit&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  current_limit &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Application&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;get_env&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;my_app&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;truncation_limit&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  on_exit&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;fn&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-other z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Application&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;put_env&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;my_app&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;truncation_limit&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; current_limit&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  string &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;duplicate&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;a&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Application&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;put_env&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;my_app&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;truncation_limit&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  assert truncate_string&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;string&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;aaa&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;This dance is pretty common. Get the current value, make sure to set it back after the test finishes, and then change it to test the behavior. But you can see how another concurrent test changing that value would potentially break this test.&lt;/p&gt;&lt;p&gt;So, what are you to do in these cases? Tough luck. There&apos;s no satisfaction here. The most successful practical approach I&apos;ve seen is to define an interface for &lt;code&gt;Application&lt;/code&gt; and use mocks to have values read/written in an async-friendly way. You can use Mox, you can use &lt;a href=&quot;https://github.com/edgurgel/mimic&quot;&gt;Mimic&lt;/a&gt;, whatever floats your boat really. Just go read &lt;a href=&quot;https://dashbit.co/blog/mocks-and-explicit-contracts&quot;&gt;The Mox Blog Post&lt;/a&gt; first.&lt;/p&gt;&lt;h2 id=&quot;practical-advice&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#practical-advice&quot; aria-label=&quot;Anchor link for: practical-advice&quot;&gt;Practical Advice&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Just a bunch of jotted-down advices:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;Hardcoded singletons are &quot;clean&quot; from a code perspective, but so hard to work with. Make your life easier, and &lt;em&gt;think like a library author&lt;/em&gt; when you can: no singletons, just configurable processes. Then, these can act as a single global resource if needed.&lt;/li&gt;&lt;li&gt;Try to start with &lt;code&gt;ProcessTree&lt;/code&gt; rather than nimble_ownership. The ownership idea is powerful but quite more complex than just climbing up the process tree to find a PID.&lt;/li&gt;&lt;li&gt;Abstract as much as possible into your own testing helpers. At Knock, we have quite a few &lt;code&gt;MyApp.SomePartOfTheAppTesting&lt;/code&gt; helpers that we &lt;code&gt;use&lt;/code&gt; in our tests. This facilitates abstracting what to store in the process dictionary, key names, and so on.&lt;/li&gt;&lt;/ul&gt;&lt;h2 id=&quot;conclusion&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#conclusion&quot; aria-label=&quot;Anchor link for: conclusion&quot;&gt;Conclusion&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Woah, that was a lot.&lt;/p&gt;&lt;p&gt;First, a short acknowledgement. I&apos;ve got to thank my coworker &lt;a href=&quot;https://brentjanderson.com/&quot;&gt;Brent&lt;/a&gt;, who put me onto &lt;code&gt;ProcessTree&lt;/code&gt; and who I&apos;ve designed much of what I&apos;ve talked about with.&lt;/p&gt;&lt;p&gt;We started with what the common issues that prevent asynchronous tests are. Then, we explored solutions for:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;Limiting singletons in your system.&lt;/li&gt;&lt;li&gt;Using &lt;code&gt;ProcessTree&lt;/code&gt; to track resources back to a test process.&lt;/li&gt;&lt;li&gt;Establishing resource ownership with nimble_ownership (or Ecto&apos;s sandbox).&lt;/li&gt;&lt;li&gt;Using mocks as the last resource.&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;Some resources to check out:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;I &lt;a href=&quot;https://youtu.be/clAHOdIzkW0?si=1dgCrQ7qExFl3Qtr&quot;&gt;spoke&lt;/a&gt; about some of these topics a few years ago—the talk is more philosophical and high level than this post, but might be helpful.&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://pragprog.com/titles/lmelixir/testing-elixir/&quot;&gt;&lt;em&gt;Testing Elixir&lt;/em&gt;&lt;/a&gt;, which goes into more detail on some of the things we discussed.&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;I hope this all made sense. If I can help clarify anything, leave a comment or throw an email my way. See ya!&lt;/p&gt;</content>
    
    </entry>
  
    <entry>
      <id>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;posts&#x2F;tech-i-use-2024&#x2F;</id>
      <title type="html"><![CDATA[ Tech I Use — 2024 ]]></title>
      <link rel="alternate"
            type="text/html"
            href="https://andrealeopardi.com/posts/tech-i-use-2024/"
            title="Tech I Use — 2024" />
      <published>2024-12-31T00:00:00+00:00</published>
      <author>
        <name>Andrea Leopardi</name>
        <uri>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;</uri>
        <email>hi@andrealeopardi.com</email>
      </author>
      <updated>2024-12-31T00:00:00+00:00</updated>
      <summary type="html">&lt;p&gt;Other people do this. I assume, because only &lt;a href=&quot;https://lpil.uk/blog/what-i-use-2024/&quot;&gt;Louis&apos; post&lt;/a&gt; popped up in my timeline, but hey, one&apos;s enough.&lt;/p&gt;&lt;p&gt;I&apos;ve never done a write-up on stuff I use, but I&apos;m a sucker for &lt;em&gt;reading&lt;/em&gt; this kind of posts, so I figured I&apos;d join in on the fun. Here&apos;s to this becoming a yearly tradition.&lt;/p&gt;&lt;p&gt;&lt;span class=&quot;small-aside&quot;&gt;By the way, an up-to-date list is always available at my &lt;a href=&quot;https://andrealeopardi.com/uses&quot;&gt;&lt;code&gt;/uses&lt;/code&gt; page&lt;/a&gt;.&lt;/span&gt;&lt;/p&gt;</summary>
    
      <content type="html">&lt;p&gt;Other people do this. I assume, because only &lt;a href=&quot;https://lpil.uk/blog/what-i-use-2024/&quot;&gt;Louis&apos; post&lt;/a&gt; popped up in my timeline, but hey, one&apos;s enough.&lt;/p&gt;&lt;p&gt;I&apos;ve never done a write-up on stuff I use, but I&apos;m a sucker for &lt;em&gt;reading&lt;/em&gt; this kind of posts, so I figured I&apos;d join in on the fun. Here&apos;s to this becoming a yearly tradition.&lt;/p&gt;&lt;p&gt;&lt;span class=&quot;small-aside&quot;&gt;By the way, an up-to-date list is always available at my &lt;a href=&quot;https://andrealeopardi.com/uses&quot;&gt;&lt;code&gt;/uses&lt;/code&gt; page&lt;/a&gt;.&lt;/span&gt;&lt;/p&gt;&lt;span id=&quot;continue-reading&quot;&gt;&lt;/span&gt;&lt;p&gt;&lt;img src=&quot;https://andrealeopardi.com/posts/tech-i-use-2024/cover-image.jpg&quot; alt=&quot;Cover image of some construction wrapping (pretty abstract).&quot; /&gt;&lt;/p&gt;&lt;span class=&quot;unsplash-credit&quot;&gt;
    Photo by &lt;a href=&quot;&amp;lt;https:&amp;#x2F;&amp;#x2F;unsplash.com&amp;#x2F;photos&amp;#x2F;gray-textile-xTqCNxZUEh0&amp;gt;&quot;&gt;Tim Johnson&lt;/a&gt; on &lt;a href=&quot;https://unsplash.com&quot;&gt;Unsplash&lt;/a&gt;&lt;/span&gt;&lt;h2 id=&quot;hardware&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#hardware&quot; aria-label=&quot;Anchor link for: hardware&quot;&gt;Hardware&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;I mostly type away at my desk. I&apos;ve used a 2021 14&quot; M1 MacBook Pro for most of this year (and the past three). It works fantastic. For work, I now switched to a 16&quot; M4 MacBook Pro. It&apos;s mostly the same, but the nanotexture anti-glare display thing… Eye-watering stuff.&lt;/p&gt;&lt;p&gt;I mostly keep the laptop hooked up to a 32&quot; external monitor, the &lt;a href=&quot;https://www.benq.eu/en-eu/monitor/professional/pd3205u.html&quot;&gt;BenQ PD3205U&lt;/a&gt;. I love this thing to death. I can plug a single USB-C cable and I get a big 4K screen, charging, more ports, all in one go. Had this for a year-ish, can&apos;t see myself switching for the foreseeable future.&lt;/p&gt;&lt;p&gt;This year my wife and I moved out of our house and are temporarily hanging out in temporary accommodations, so my setup is not as good as it used to be (it&apos;ll be again soon). I&apos;m not using my nice Røde desk mic for meetings these days. I do use a &lt;a href=&quot;https://www.logitech.com/en-us/products/webcams/mx-brio.html&quot;&gt;Logitech MX Brio&lt;/a&gt; webcam though—another lovely piece of tech.&lt;/p&gt;&lt;p&gt;I quietly type on an Apple Magic Keyboard. I do not need another hobby. I&apos;ve used this thing for, I don&apos;t know, 4-5 years? Anyway it has Touch ID™ and the keys have short travel. I am very fond of both those things.&lt;/p&gt;&lt;p&gt;A couple months back I upgraded from an older iPad Air to a 13&quot; M4 iPad Pro. What a lovely device. It&apos;s too thin, but man it&apos;s cool. I draw a lot of my &quot;educational&quot; stuff on there, illustrations for my blog and book(s), and whatnot. I watch all the media I watch on there. I read papers on there. Also got a keyboard for it now—not the Apple one though. The Apple one is silly IMO, because you cannot get your iPad to stand (ever watched a movie or something!?) without the keyboard in the way. Take away the keyboard, and you have no case… and no way to get the iPad to stand. Cool. I got a &lt;a href=&quot;https://www.logitech.com/en-us/products/ipad-keyboards/combo-touch-ipad-pro.920-012658.html&quot;&gt;Logitech Combo Touch&lt;/a&gt; instead. It does both things. At least it&apos;s still expensive, so you get that Apple feeling uh.&lt;/p&gt;&lt;p&gt;Headphones are still the same as they&apos;ve been for the past few years. AirPods Max (in black) at the desk, and AirPods Pro 2 or whatever version for going around. AirPods Pro are my favorite piece of tech ever, I carry them everywhere.&lt;/p&gt;&lt;h2 id=&quot;software&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#software&quot; aria-label=&quot;Anchor link for: software&quot;&gt;Software&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;I have a particular type of love for software and apps and whatnot. This list would change all the time, but here&apos;s my end-of-2024 snapshot, in no particular order.&lt;/p&gt;&lt;p&gt;Apple Mail for email (&lt;a href=&quot;https://fastmail.com&quot;&gt;Fastmail&lt;/a&gt; for personal, GMail for work). It works and I don&apos;t get enough email to need anything fancier. &lt;a href=&quot;https://flexibits.com/fantastical&quot;&gt;Fantastical&lt;/a&gt; for calendars. Love it. I use the &lt;a href=&quot;https://flexibits.com/fantastical/help/openings&quot;&gt;&quot;openings&quot; feature&lt;/a&gt; quite a bit. &lt;a href=&quot;https://todoist.com/home&quot;&gt;Todoist&lt;/a&gt; for tracking tasks. This last one is a recent entry—I switched in late 2024, coming from Apple Reminders. Apple&apos;s apps are generally good, but I want my tasks to be readable from other apps (see Obsidian) and whatnot, so there ya go.&lt;/p&gt;&lt;p&gt;Some easy ones: I still listen to music on Spotify, and I still store passwords in 1Password.&lt;/p&gt;&lt;p&gt;This year I switched from Safari to &lt;a href=&quot;https://arc.net/&quot;&gt;Arc&lt;/a&gt; for browsing the interwebs. I like it. I also recently switched to &lt;a href=&quot;https://ghostty.org/&quot;&gt;Ghostty&lt;/a&gt; for my terminal, coming from iTerm. Super nice but not a big difference for someone like me, since I use VS Code&apos;s terminal 95% of the time.&lt;/p&gt;&lt;p&gt;I started using Raycast over Alfred this year too. Plugin ecosystem is nicer.  I don&apos;t want to pay $9/mo or however much it is for their pro subscription (I can&apos;t justify it), but that leaves me without sync across computers, which is annoying. We&apos;ll see what sticks.&lt;/p&gt;&lt;p&gt;I still use:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;VS Code for writing software. I like it.&lt;/li&gt;&lt;li&gt;Obsidian for taking notes. I &lt;strong&gt;love&lt;/strong&gt; it.&lt;/li&gt;&lt;li&gt;Notion for storing DB-like information. I keep a home inventory here, info about my car and whatnot, and all that sort of stuff. I find it to work better than Obsidian, easier to share pages with my wife (like our dog&apos;s info), and I don&apos;t know, I can&apos;t seem to get out of it.&lt;/li&gt;&lt;/ul&gt;</content>
    
    </entry>
  
    <entry>
      <id>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;posts&#x2F;refactoring-gettext-to-speed-up-compilation&#x2F;</id>
      <title type="html"><![CDATA[ Reducing Compile-Time Dependencies in Gettext for Elixir ]]></title>
      <link rel="alternate"
            type="text/html"
            href="https://andrealeopardi.com/posts/refactoring-gettext-to-speed-up-compilation/"
            title="Reducing Compile-Time Dependencies in Gettext for Elixir" />
      <published>2024-09-04T00:00:00+00:00</published>
      <author>
        <name>Andrea Leopardi</name>
        <uri>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;</uri>
        <email>hi@andrealeopardi.com</email>
      </author>
      <updated>2024-09-04T00:00:00+00:00</updated>
      <summary type="html">&lt;p&gt;The Elixir compiler does what most modern compilers have to do: it only recompiles the files it &lt;em&gt;needs&lt;/em&gt; to. You change a file, and the compiler figures out all the files that somehow depend on that file. Those are the only files that get recompiled. This way, you get to avoid recompiling big projects when changing only a few files.&lt;/p&gt;&lt;p&gt;All good and nice, but it all relies on files not having too many dependent files. That&apos;s what was happening with &lt;a href=&quot;https://github.com/elixir-gettext/gettext&quot;&gt;Gettext&lt;/a&gt;, Elixir&apos;s localization and internationalization library. This post goes through the issue in detail, and how we ended up fixing it.&lt;/p&gt;</summary>
    
      <content type="html">&lt;p&gt;The Elixir compiler does what most modern compilers have to do: it only recompiles the files it &lt;em&gt;needs&lt;/em&gt; to. You change a file, and the compiler figures out all the files that somehow depend on that file. Those are the only files that get recompiled. This way, you get to avoid recompiling big projects when changing only a few files.&lt;/p&gt;&lt;p&gt;All good and nice, but it all relies on files not having too many dependent files. That&apos;s what was happening with &lt;a href=&quot;https://github.com/elixir-gettext/gettext&quot;&gt;Gettext&lt;/a&gt;, Elixir&apos;s localization and internationalization library. This post goes through the issue in detail, and how we ended up fixing it.&lt;/p&gt;&lt;span id=&quot;continue-reading&quot;&gt;&lt;/span&gt;&lt;p&gt;&lt;img src=&quot;https://andrealeopardi.com/posts/refactoring-gettext-to-speed-up-compilation/cover-image.jpg&quot; alt=&quot;Cover image of a network of ropes connected to each other.&quot; /&gt;&lt;/p&gt;&lt;span class=&quot;unsplash-credit&quot;&gt;
    Photo by &lt;a href=&quot;&amp;lt;https:&amp;#x2F;&amp;#x2F;unsplash.com&amp;#x2F;photos&amp;#x2F;green-and-black-rope-BW0vK-FA3eg&amp;gt;&quot;&gt;Clint Adair&lt;/a&gt; on &lt;a href=&quot;https://unsplash.com&quot;&gt;Unsplash&lt;/a&gt;&lt;/span&gt;&lt;h2 id=&quot;the-issue&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#the-issue&quot; aria-label=&quot;Anchor link for: the-issue&quot;&gt;The Issue&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/josevalim&quot;&gt;José&lt;/a&gt; and I started Gettext for Elixir in March 2015, so close to ten years ago at the time of writing. Back then, writing Elixir was different. We didn&apos;t think too much about generating a lot of code at compile time, inside macros and &lt;code&gt;use&lt;/code&gt; calls.&lt;/p&gt;&lt;p&gt;The way Gettext has worked for most of its lifetime has been this. Users created a &lt;strong&gt;Gettext backend&lt;/strong&gt; by calling &lt;code&gt;use Gettext&lt;/code&gt; within a module in their application:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MyApp&lt;/span&gt;.&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Gettext&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;use&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Gettext&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;otp_app&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;my_app&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;That little line of code generated a whopping &lt;strong&gt;twenty-one macros and functions&lt;/strong&gt; in the calling module. Users could call those macros to perform translation:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;import&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MyApp&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Gettext&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;gettext&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;Hello world&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Gettext backends read &lt;code&gt;.po&lt;/code&gt; and &lt;code&gt;.pot&lt;/code&gt; files containing translations and compile those translations into pattern matches. Every time you add or change a translation, the Gettext backend needs to be recompiled. I wrote a &lt;a href=&quot;https://andrealeopardi.com/posts/compile-time-work-with-elixir-macros/&quot;&gt;whole blog post&lt;/a&gt; about how Gettext extraction and compilation work, if you&apos;re curious.&lt;/p&gt;&lt;p&gt;This works pretty straightforward overall. However, calling those Gettext macros creates a compile-time dependency on the imported backend. Just &lt;code&gt;import&lt;/code&gt;ing the backend doesn&apos;t, as that&apos;s what the Elixir compiler calls an &lt;strong&gt;export dependency&lt;/strong&gt;—the difference is explained in &lt;a href=&quot;https://hexdocs.pm/mix/Mix.Tasks.Xref.html#module-dependency-types&quot;&gt;&lt;code&gt;mix xref&lt;/code&gt;&apos;s documentation&lt;/a&gt;.&lt;/p&gt;&lt;p&gt;This makes sense: if a module changes, we want to recompile modules that use &lt;em&gt;macros&lt;/em&gt; from it too, as those macros are expanded at compile time. The main issue arose with &lt;a href=&quot;https://www.phoenixframework.org/&quot;&gt;Phoenix&lt;/a&gt; applications. By default, Phoenix has a &lt;code&gt;MyAppWeb&lt;/code&gt; module for boilerplate code that you want to inject in controllers, views, and whatnot. For controllers, live views, live components, and views, the generated code included this:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;import&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MyAppWeb&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Gettext&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;You could use &lt;code&gt;*gettext&lt;/code&gt; macros everywhere this way. Maybe you can already see the issue: everything using Gettext macros would have a compile-time dependency on the backend. Uh oh. Take a look at this: I generated a new Phoenix app (&lt;code&gt;mix phx.new my_app&lt;/code&gt;), added &lt;code&gt;gettext/1&lt;/code&gt; calls to all controllers and views, and then used &lt;a href=&quot;https://hexdocs.pm/mix/Mix.Tasks.Xref.html&quot;&gt;&lt;code&gt;mix xref&lt;/code&gt;&lt;/a&gt; to trace all the files that have a compile-time dependency on &lt;code&gt;MyAppWeb.Gettext&lt;/code&gt;.&lt;/p&gt;&lt;pre data-lang=&quot;bash&quot; class=&quot;language-bash z-code&quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;z-source z-shell z-bash&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-shell&quot;&gt;&lt;span class=&quot;z-variable z-function z-shell&quot;&gt;$&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-arguments z-shell&quot;&gt; mix xref graph&lt;span class=&quot;z-variable z-parameter z-option z-shell&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-parameter z-shell&quot;&gt; --&lt;/span&gt;sink&lt;/span&gt; lib/my_app_web/gettext.ex&lt;span class=&quot;z-variable z-parameter z-option z-shell&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-parameter z-shell&quot;&gt; --&lt;/span&gt;label&lt;/span&gt; compile&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-shell z-bash&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-shell&quot;&gt;&lt;span class=&quot;z-variable z-function z-shell&quot;&gt;lib/my_app_web/components/core_components.ex&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-shell z-bash&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-shell&quot;&gt;&lt;span class=&quot;z-variable z-function z-shell&quot;&gt;└──&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-arguments z-shell&quot;&gt; lib/my_app_web/gettext.ex (compile&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-shell&quot;&gt;&lt;/span&gt;)
&lt;/span&gt;&lt;span class=&quot;z-source z-shell z-bash&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-shell&quot;&gt;&lt;span class=&quot;z-variable z-function z-shell&quot;&gt;lib/my_app_web/controllers/error_html.ex&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-shell z-bash&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-shell&quot;&gt;&lt;span class=&quot;z-variable z-function z-shell&quot;&gt;└──&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-arguments z-shell&quot;&gt; lib/my_app_web/gettext.ex (compile&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-shell&quot;&gt;&lt;/span&gt;)
&lt;/span&gt;&lt;span class=&quot;z-source z-shell z-bash&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-shell&quot;&gt;&lt;span class=&quot;z-variable z-function z-shell&quot;&gt;lib/my_app_web/controllers/page_controller.ex&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-shell z-bash&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-shell&quot;&gt;&lt;span class=&quot;z-variable z-function z-shell&quot;&gt;└──&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-arguments z-shell&quot;&gt; lib/my_app_web/gettext.ex (compile&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-shell&quot;&gt;&lt;/span&gt;)
&lt;/span&gt;&lt;span class=&quot;z-source z-shell z-bash&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-shell&quot;&gt;&lt;span class=&quot;z-variable z-function z-shell&quot;&gt;lib/my_app_web/controllers/page_html.ex&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-shell z-bash&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-shell&quot;&gt;&lt;span class=&quot;z-variable z-function z-shell&quot;&gt;└──&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-arguments z-shell&quot;&gt; lib/my_app_web/gettext.ex (compile&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-shell&quot;&gt;&lt;/span&gt;)
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Yuck! In an app with tens of controllers and views, the list above gets a lot longer. But worry not, we fixed this.&lt;/p&gt;&lt;h2 id=&quot;the-fix&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#the-fix&quot; aria-label=&quot;Anchor link for: the-fix&quot;&gt;The Fix&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;We do need to generate something in Gettext backends: the actual translations pattern matches. Gettext generates two important functions to handle that in each backend, &lt;code&gt;lgettext&lt;/code&gt; and &lt;code&gt;lngettext&lt;/code&gt;. &lt;code&gt;lgettext&lt;/code&gt;&apos;s signature looks like this:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;lgettext&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;locale&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; domain&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; msgctxt &lt;span class=&quot;z-keyword z-operator z-other z-elixir&quot;&gt;\\&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;nil&lt;/span&gt;, msgid&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; bindings&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The generated clauses are a bunch of these:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;lgettext&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;it&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;default&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;Red&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; _bindings&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;do:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;Ross&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;lgettext&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;it&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;default&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;Green&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; _bindings&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;do:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;Verde&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;lgettext&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;it&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;default&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;Yellow&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; _bindings&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;do:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;Giallo&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; ...and so on
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Well, after thinking about it for a bit, we realized that this is all we need from a Gettext backend. We don&apos;t need all the macros we generated in them, or the translation-extraction feature (we can do that outside of the backend). We just need the backend to hold the compiled patterns for the translations.&lt;/p&gt;&lt;p&gt;So, &lt;a href=&quot;https://github.com/maennchen&quot;&gt;Jonatan&lt;/a&gt; (one of the maintainers of Gettext for Elixir) &lt;a href=&quot;https://github.com/elixir-gettext/gettext/issues/330#issuecomment-2293187581&quot;&gt;came up&lt;/a&gt; with an initial API where we would not have to &lt;code&gt;import&lt;/code&gt; Gettext backends:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MyApp&lt;/span&gt;.&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Gettext&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;use&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Gettext&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;otp_app&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;my_app&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MyApp&lt;/span&gt;.&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Greeter&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;use&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Gettext&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;backend&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MyApp&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Gettext&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;say_hello&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;do:&lt;/span&gt;&lt;/span&gt; gettext&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;Hello&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;This was the right direction, but we needed to actually implement it. After refining and iterating on the API for a while, we came up with a re-hauled solution to using Gettext. It goes like this.&lt;/p&gt;&lt;p&gt;First, you &lt;code&gt;use Gettext.Backend&lt;/code&gt; (instead of just &lt;code&gt;Gettext&lt;/code&gt;) to create a Gettext backend:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MyApp&lt;/span&gt;.&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Gettext&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;use&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Gettext&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Backend&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;otp_app&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;my_app&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Very clear that you&apos;re defining just a backend—or a repository of translations, or a storage for translations, or however you want to think about this. The Gettext backend just exposes &lt;code&gt;lgettext&lt;/code&gt; and &lt;code&gt;lngettext&lt;/code&gt; (which are &lt;a href=&quot;https://hexdocs.pm/gettext/0.26.1/Gettext.Backend.html&quot;&gt;documented callbacks now&lt;/a&gt;).&lt;/p&gt;&lt;p&gt;Then, you have &lt;a href=&quot;https://hexdocs.pm/gettext/0.26.1/Gettext.Macros.html#dgettext_noop/2&quot;&gt;&lt;code&gt;Gettext.Macros&lt;/code&gt;&lt;/a&gt;. This is where all those &lt;code&gt;*gettext&lt;/code&gt; macros live now. There&apos;s a variant of each of those macros suffixed in &lt;code&gt;_with_backend&lt;/code&gt; which now explicitly takes a backend as its first argument. So, no magic here anymore:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Gettext&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Macros&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;gettext_with_backend&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MyApp&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Gettext&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;Purple&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt;=&amp;gt; &amp;quot;Viola&amp;quot;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Not super ergonomic though. So, we also have &quot;normal&quot; &lt;code&gt;gettext&lt;/code&gt; macros. These infer the backend from an internal module attribute, that you set by using the original API proposed by Jonatan:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MyApp&lt;/span&gt;.&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Greeting&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;use&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Gettext&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;backend&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MyApp&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Gettext&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;say_hello&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;do:&lt;/span&gt;&lt;/span&gt; gettext&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;Hello&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;That&apos;s it! &lt;code&gt;gettext/1&lt;/code&gt; here does not come from the backend, it comes from &lt;code&gt;Gettext.Macros&lt;/code&gt;, which is never recompiled (it comes from a dependency after all). Walking backwards, the code above roughly translates to:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MyApp&lt;/span&gt;.&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Greeting&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-variable z-other z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-definition z-constant z-elixir&quot;&gt;@&lt;/span&gt;gettext_backend&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MyApp&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Gettext&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;say_hello&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Gettext&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Macros&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;gettext_with_backend&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-other z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-definition z-constant z-elixir&quot;&gt;@&lt;/span&gt;gettext_backend&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;Hello&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;In turn, &lt;code&gt;say_hello/0&lt;/code&gt;&apos;s contents more or less expand to:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;say_hello&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;if&lt;/span&gt; extracting_gettext?&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    extract_translation&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-other z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-definition z-constant z-elixir&quot;&gt;@&lt;/span&gt;gettext_backend&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;Hello&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; This finally calls @gettext_backend.lgettext/5 internally:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Gettext&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;gettext&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-other z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-definition z-constant z-elixir&quot;&gt;@&lt;/span&gt;gettext_backend&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;Hello&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;code&gt;Gettext.gettext/2&lt;/code&gt; calls the backend&apos;s &lt;code&gt;lgettext/5&lt;/code&gt; function &quot;dynamically&quot; (akin to using &lt;a href=&quot;https://hexdocs.pm/elixir/Kernel.html#apply/3&quot;&gt;&lt;code&gt;apply/3&lt;/code&gt;&lt;/a&gt;), which &lt;strong&gt;does not create a compile-time dependency&lt;/strong&gt;!&lt;/p&gt;&lt;p&gt;That&apos;s the trick. At compile-time we can still extract translations, as we have to recompile the whole project anyway to perform extraction. However, now adding translated strings to PO files only causes the Gettext backend to recompile—and not all the files that use macros from it. You can verify this in a new Phoenix app generated with &lt;code&gt;phx_new&lt;/code&gt; from &lt;code&gt;main&lt;/code&gt; (I also added &lt;code&gt;gettext/1&lt;/code&gt; calls to the same controllers and views as the previous example):&lt;/p&gt;&lt;pre data-lang=&quot;bash&quot; class=&quot;language-bash z-code&quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;z-source z-shell z-bash&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-shell&quot;&gt;&lt;span class=&quot;z-variable z-function z-shell&quot;&gt;$&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-arguments z-shell&quot;&gt; mix xref graph&lt;span class=&quot;z-variable z-parameter z-option z-shell&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-parameter z-shell&quot;&gt; --&lt;/span&gt;sink&lt;/span&gt; lib/my_app_web/gettext.ex&lt;span class=&quot;z-variable z-parameter z-option z-shell&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-parameter z-shell&quot;&gt; --&lt;/span&gt;label&lt;/span&gt; compile&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-shell z-bash&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-shell&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-begin z-shell&quot;&gt;#&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-shell&quot;&gt; Prints nothing here&lt;/span&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-shell&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Fantastique.&lt;/p&gt;&lt;h2 id=&quot;conclusion&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#conclusion&quot; aria-label=&quot;Anchor link for: conclusion&quot;&gt;Conclusion&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;When working on libraries that do compile-time work and use macros, or do other weird stuff, think about this stuff. We didn&apos;t, and it took us a while to figure it out. If you want to do some spelunking through the changes, here&apos;s a list of stuff to look at:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;The &lt;a href=&quot;https://github.com/elixir-gettext/gettext/issues/330&quot;&gt;original Gettext issue&lt;/a&gt;.&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://github.com/elixir-gettext/gettext/pull/390&quot;&gt;This Gettext PR&lt;/a&gt; and &lt;a href=&quot;https://github.com/elixir-gettext/gettext/pull/391&quot;&gt;this other Gettext PR&lt;/a&gt;.&lt;/li&gt;&lt;li&gt;The &lt;a href=&quot;https://github.com/phoenixframework/phoenix/pull/5902&quot;&gt;PR&lt;/a&gt; that updates Phoenix generators to use the new Gettext API.&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;Lesson learned!&lt;/p&gt;</content>
    
    </entry>
  
    <entry>
      <id>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;posts&#x2F;verifying-apple-jwts&#x2F;</id>
      <title type="html"><![CDATA[ Verifying JWTs from Apple&#x27;s App Store ]]></title>
      <link rel="alternate"
            type="text/html"
            href="https://andrealeopardi.com/posts/verifying-apple-jwts/"
            title="Verifying JWTs from Apple&#x27;s App Store" />
      <published>2023-11-29T00:00:00+00:00</published>
      <author>
        <name>Andrea Leopardi</name>
        <uri>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;</uri>
        <email>hi@andrealeopardi.com</email>
      </author>
      <updated>2023-11-29T00:00:00+00:00</updated>
      <summary type="html">&lt;p&gt;If you&apos;ve ever had to interact with Apple APIs related to App Store purchases and whatnot (like the &lt;a href=&quot;https://developer.apple.com/documentation/appstoreservernotifications/receiving_app_store_server_notifications&quot;&gt;App Store Server Notifications&lt;/a&gt;), there&apos;s a chance you had to &lt;strong&gt;verify JWTs&lt;/strong&gt; at some point. I had used, signed, and verified JWTs extensively before this, but Apple uses a bit of a &lt;em&gt;unique&lt;/em&gt; way of signing their JWTs that I had never stumbled upon in the past. In this short post, I&apos;ll show some code around verifying Apple&apos;s JWT signatures in Elixir.&lt;/p&gt;</summary>
    
      <content type="html">&lt;p&gt;If you&apos;ve ever had to interact with Apple APIs related to App Store purchases and whatnot (like the &lt;a href=&quot;https://developer.apple.com/documentation/appstoreservernotifications/receiving_app_store_server_notifications&quot;&gt;App Store Server Notifications&lt;/a&gt;), there&apos;s a chance you had to &lt;strong&gt;verify JWTs&lt;/strong&gt; at some point. I had used, signed, and verified JWTs extensively before this, but Apple uses a bit of a &lt;em&gt;unique&lt;/em&gt; way of signing their JWTs that I had never stumbled upon in the past. In this short post, I&apos;ll show some code around verifying Apple&apos;s JWT signatures in Elixir.&lt;/p&gt;&lt;span id=&quot;continue-reading&quot;&gt;&lt;/span&gt;&lt;p&gt;&lt;img src=&quot;https://andrealeopardi.com/posts/verifying-apple-jwts/cover-image.jpg&quot; alt=&quot;Cover image of a very yellow safe-style lock with yellow background. Minimalistic photograph.&quot; /&gt;&lt;/p&gt;&lt;span class=&quot;unsplash-credit&quot;&gt;
    Photo by &lt;a href=&quot;&amp;lt;https:&amp;#x2F;&amp;#x2F;unsplash.com&amp;#x2F;photos&amp;#x2F;green-and-silver-padlock-on-pink-surface-f34K70FGpCg&amp;gt;&quot;&gt;FLY:D&lt;/a&gt; on &lt;a href=&quot;https://unsplash.com&quot;&gt;Unsplash&lt;/a&gt;&lt;/span&gt;&lt;p&gt;At &lt;a href=&quot;https://veeps.com&quot;&gt;Veeps&lt;/a&gt;, we&apos;re working on some features connected to the App Store. This involves verifying that the notifications (webhooks) that Apple sends to us are legitimate.&lt;/p&gt;&lt;p&gt;One note before we start: I&apos;m using the term JWT here mostly out of ignorance and out of desire to bump this blog post&apos;s ranking in search engines! What Apple sends to us is a &lt;strong&gt;JWS (JSON Web Signature)&lt;/strong&gt;. JWTs are the &lt;em&gt;payload&lt;/em&gt; that ships inside a JWS. &lt;a href=&quot;https://www.rfc-editor.org/rfc/rfc7519&quot;&gt;RFC 7519&lt;/a&gt; is the one you want to take a look at if you want to know more about this. Anyway, minutiae.&lt;/p&gt;&lt;p&gt;Let&apos;s first have a look at the general idea of how Apple signs these JWTs. After that, we&apos;ll look at some Elixir code.&lt;/p&gt;&lt;p&gt;The deal with Apple&apos;s JWTs is that they are signed via certificates rather than via symmetric or asymmetric signatures. Essentially, Apple signs the JWT&apos;s payload with a private key. Then, they include the public key for that in a DER certificate in the JWS itself (the &lt;strong&gt;&quot;leaf&quot; certificate&lt;/strong&gt;). That certificate is itself signed by an &lt;strong&gt;intermediate certificate&lt;/strong&gt;, which in turn is signed via their &lt;strong&gt;root certificate&lt;/strong&gt;. The root certificate and intermediate certificate are public and available through Apple&apos;s certificate authority (&lt;a href=&quot;https://www.apple.com/certificateauthority/&quot;&gt;Apple PKI&lt;/a&gt;).&lt;/p&gt;&lt;img src=&quot;sketch.png&quot; alt=&quot;TODO&quot; class=&quot;invert-in-dark-mode&quot;&gt;&lt;h2 id=&quot;some-elixir-code&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#some-elixir-code&quot; aria-label=&quot;Anchor link for: some-elixir-code&quot;&gt;Some Elixir Code&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;You technically don&apos;t really need any third-party Elixir/Erlang libraries for this, but I opted to use two nimble and widely-used ones:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/potatosalad/erlang-jose&quot;&gt;JOSE&lt;/a&gt; is a foundational Erlang library (with an Elixir API as well) that implements many of the components described in the series of &lt;a href=&quot;https://datatracker.ietf.org/group/jose/documents/&quot;&gt;RFCs around JOSE (Javascript Object Signing and Encryption)&lt;/a&gt;. I&apos;ve used this library many times in the past for signing and verifying JWTs.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/voltone/x509&quot;&gt;X509&lt;/a&gt; is an Elixir library that simplifies working with X.509 certificates. It&apos;s built by &lt;a href=&quot;https://github.com/voltone&quot;&gt;Bram Verburg&lt;/a&gt;, who I consider to be the most knowledgeable person around web security in the Erlang and Elixir communities.&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;Let&apos;s get into it.&lt;/p&gt;&lt;aside class=&quot;callout callout-info&quot;&gt;&lt;h5&gt;Error Handling&lt;/h5&gt;&lt;div class=&quot;callout-content&quot;&gt;&lt;p&gt;In the code I&apos;ll show, I don&apos;t do any error handling that I would consider worthy of production code. I just match on stuff with &lt;code&gt;=&lt;/code&gt; or in function heads. That leads to horrible &lt;code&gt;MatchError&lt;/code&gt;s and &lt;code&gt;FunctionClauseError&lt;/code&gt;s and whatnot, which are hard to debug and don&apos;t really provide context on what went wrong. In production, I&apos;d never want that! The real-world code I wrote uses the &lt;code&gt;throw&lt;/code&gt;/&lt;code&gt;catch&lt;/code&gt; pattern, where I use &lt;a href=&quot;https://hexdocs.pm/elixir/Kernel.html#throw/1&quot;&gt;&lt;code&gt;throw/1&lt;/code&gt;&lt;/a&gt; to throw errors that I &lt;code&gt;catch&lt;/code&gt; at the end of the top-level function and return as &lt;code&gt;{:error, reason}&lt;/code&gt; tuples.&lt;/p&gt;&lt;p&gt;&lt;code&gt;throw&lt;/code&gt;/&lt;code&gt;catch&lt;/code&gt; is a &quot;dangerous&quot; pattern because it uses non-local returns. However, it&apos;s a pattern that I&apos;ve reached for several times in this type of situations. The trick is to never let a thrown term get out of a local function, or module at most. That way, users of the functions that throw don&apos;t have to know that those functions use &lt;code&gt;throw&lt;/code&gt;/&lt;code&gt;catch&lt;/code&gt; internally.&lt;/p&gt;&lt;/div&gt;&lt;/aside&gt;&lt;h3 id=&quot;decoding-the-jws-s-header&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#decoding-the-jws-s-header&quot; aria-label=&quot;Anchor link for: decoding-the-jws-s-header&quot;&gt;Decoding the JWS&apos;s Header&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;The first thing you want to do when verifying one of these JWTs is to peek at its header. This doesn&apos;t do any verification, but the header contains the certificate chain that we need to verify the JWT&apos;s signature, so we gotta look at it. JOSE provides a &lt;code&gt;JOSE.JWT.peek_protected/1&lt;/code&gt; function that returns the JWT&apos;s header as a raw JSON-encoded string:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;decoded_header &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  signed_payload
&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-pipe z-elixir&quot;&gt;|&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;JOSE&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;JWS&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;peek_protected&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-pipe z-elixir&quot;&gt;|&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Jason&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;decode!&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Right. The algorithm should be &lt;code&gt;ES256&lt;/code&gt;, so why not throw in a check for that:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;%&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;alg&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-map-pair z-elixir&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;ES256&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; decoded_header
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&quot;extracting-and-verifying-the-certificates&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#extracting-and-verifying-the-certificates&quot; aria-label=&quot;Anchor link for: extracting-and-verifying-the-certificates&quot;&gt;Extracting and Verifying the Certificates&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Next, we need to look at the &lt;code&gt;x5c&lt;/code&gt; in the header. The &lt;code&gt;x5c&lt;/code&gt; header field &lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc7515#section-4.1.6&quot;&gt;is documented in the JWT RFC (RFC 7515, sec. 4.1.6)&lt;/a&gt;. It&apos;s a JSON array of base-64-encoded DER PKIX certificates. Those are complex acronyms that you and I really don&apos;t have to care about. The RFC (and Apple) says that you must validate the certificate chain.&lt;/p&gt;&lt;p&gt;First, let&apos;s extract the certificate chain:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; We pattern match on [_ | _] to make sure that the list of certs
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; isn&amp;#39;t empty.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;%&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;x5c&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-map-pair z-elixir&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;_ &lt;span class=&quot;z-keyword z-operator z-other z-elixir&quot;&gt;|&lt;/span&gt; _&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; base64_cert_chain&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; decoded_header
&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;cert_chain &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Enum&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;map&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;base64_cert_chain&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; &amp;amp;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Base&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;decode64!&lt;span class=&quot;z-keyword z-operator z-arithmetic z-elixir&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Now, we can &lt;em&gt;verify&lt;/em&gt; the certificate chain. We&apos;ll follow the process that I described above:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;We&apos;ll check that the root certificate is the same as the certificate that Apple offers on &lt;a href=&quot;https://www.apple.com/certificateauthority/&quot;&gt;Apple PKI&lt;/a&gt;.&lt;/li&gt;&lt;li&gt;We&apos;ll check that the certificate chain is &lt;em&gt;valid&lt;/em&gt;, meaning that each certificate was used to sign the next one in the chain.&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;The code below assumes that you downloaded the Apple root certificate (&lt;a href=&quot;https://www.apple.com/certificateauthority/AppleRootCA-G3.cer&quot;&gt;&lt;code&gt;AppleRootCA-G3&lt;/code&gt;&lt;/a&gt; in particular). It reads it at compile time and embeds it in the bytecode of the module, so that you don&apos;t have to ship the file with your production application or release.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-variable z-other z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-definition z-constant z-elixir&quot;&gt;@&lt;/span&gt;apple_root_cert&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;read!&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;certs/AppleRootCA-G3.cer&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defp&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-private z-elixir&quot;&gt;valid_certificate_chain?&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;raw_leaf&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; raw_intermediate&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; _raw_root &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-variable z-other z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-definition z-constant z-elixir&quot;&gt;@&lt;/span&gt;apple_root_cert&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;case&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;public_key&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;pkix_path_validation&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-variable z-other z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-definition z-constant z-elixir&quot;&gt;@&lt;/span&gt;apple_root_cert&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;raw_intermediate&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; raw_leaf&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; _&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;error&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; _&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defp&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-private z-elixir&quot;&gt;valid_certificate_chain?&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;_x5c_certs&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/voltone&quot;&gt;Bram&lt;/a&gt; basically hand-held me through this code, so thank you, Bram! We can use the &lt;code&gt;valid_certificate_chain?/1&lt;/code&gt; helper function to verify the certificate chain and blow up if it doesn&apos;t look right:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-logical z-elixir&quot;&gt;not&lt;/span&gt; valid_certificate_chain?&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;cert_chain&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;raise&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;certificate chain is invalid&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&quot;verifying-the-jws-s-signature&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#verifying-the-jws-s-signature&quot; aria-label=&quot;Anchor link for: verifying-the-jws-s-signature&quot;&gt;Verifying the JWS&apos;s Signature&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Lastly, the final (and fundamental) step: we need to check that the X.509 key in the leaf certificate was used to sign the whole JWT. JOSE provides the &lt;a href=&quot;https://hexdocs.pm/jose/1.11.6/JOSE.JWK.html#from_key/1&quot;&gt;&lt;code&gt;JOSE.JWK.from_key/1&lt;/code&gt;&lt;/a&gt; function to build a JWK struct from a public key:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;jwk &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  leaf_cert
&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-pipe z-elixir&quot;&gt;|&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;X509&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Certificate&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;from_der!&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-pipe z-elixir&quot;&gt;|&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;X509&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Certificate&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;public_key&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-pipe z-elixir&quot;&gt;|&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;JOSE&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;JWK&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;from_key&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Now, the easiest part of all of this: we just use JOSE&apos;s &lt;code&gt;verify/2&lt;/code&gt; function to verify the signature in the JWT:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;case&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;JOSE&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;JWT&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;verify&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;jwk&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; signed_payload&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;_valid_signature? &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; jwt&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; _jws&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; jwt&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;_valid_signature? &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; _jwt&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; _jws&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;error&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;invalid_signature&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;error&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; reason&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;error&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; reason&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&quot;conclusion&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#conclusion&quot; aria-label=&quot;Anchor link for: conclusion&quot;&gt;Conclusion&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;There&apos;s not much else to say about this. I spent a bunch of time on it and how to do it in Elixir after finding several pieces of code to do this in other languages. For example, Apple provides &quot;App Store libraries&quot; for a bunch of languages (take a look at the &lt;a href=&quot;https://github.com/apple/app-store-server-library-python&quot;&gt;Python one&lt;/a&gt;). Apple also provides a useful &lt;a href=&quot;https://developer.apple.com/videos/play/wwdc2022/10040/&quot;&gt;video&lt;/a&gt; that explains this process.&lt;/p&gt;&lt;p&gt;Well, hope this helps someone. Thanks for stopping by!&lt;/p&gt;</content>
    
    </entry>
  
    <entry>
      <id>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;posts&#x2F;breakdown-of-http-clients-in-elixir&#x2F;</id>
      <title type="html"><![CDATA[ A Breakdown of HTTP Clients in Elixir ]]></title>
      <link rel="alternate"
            type="text/html"
            href="https://andrealeopardi.com/posts/breakdown-of-http-clients-in-elixir/"
            title="A Breakdown of HTTP Clients in Elixir" />
      <published>2023-07-24T00:00:00+00:00</published>
      <author>
        <name>Andrea Leopardi</name>
        <uri>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;</uri>
        <email>hi@andrealeopardi.com</email>
      </author>
      <updated>2023-07-24T00:00:00+00:00</updated>
      <summary type="html">&lt;p&gt;Elixir&apos;s ecosystem has quite a few &lt;strong&gt;HTTP clients&lt;/strong&gt; at this point. But what&apos;s
the &lt;em&gt;best one&lt;/em&gt;? In this post, I want to break down a bunch of the clients we
have available. I&apos;ll give an overview of the clients I personally like the most,
and I&apos;ll talk about which clients are the best choice in different use cases.
I&apos;ll also share some advice with library authors.&lt;/p&gt;</summary>
    
      <content type="html">&lt;p&gt;Elixir&apos;s ecosystem has quite a few &lt;strong&gt;HTTP clients&lt;/strong&gt; at this point. But what&apos;s
the &lt;em&gt;best one&lt;/em&gt;? In this post, I want to break down a bunch of the clients we
have available. I&apos;ll give an overview of the clients I personally like the most,
and I&apos;ll talk about which clients are the best choice in different use cases.
I&apos;ll also share some advice with library authors.&lt;/p&gt;&lt;span id=&quot;continue-reading&quot;&gt;&lt;/span&gt;&lt;p&gt;&lt;img src=&quot;https://andrealeopardi.com/posts/breakdown-of-http-clients-in-elixir/cover-image.png&quot; alt=&quot;Cover image of a futuristic-looking box ring with a metallic snake inside of it&quot; /&gt;&lt;/p&gt;&lt;p&gt;&lt;span class=&quot;image-caption&quot;&gt;This is AI generated, just to be clear&lt;/span&gt;&lt;/p&gt;&lt;h2 id=&quot;all-your-clients-are-belong-to-us&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#all-your-clients-are-belong-to-us&quot; aria-label=&quot;Anchor link for: all-your-clients-are-belong-to-us&quot;&gt;All Your Clients Are Belong to Us&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;So, let&apos;s take a whirlwind tour of some HTTP clients available in Elixir. We&apos;ll
talk about these:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://andrealeopardi.com/posts/breakdown-of-http-clients-in-elixir/#mint&quot;&gt;Mint&lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://andrealeopardi.com/posts/breakdown-of-http-clients-in-elixir/#finch&quot;&gt;Finch&lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://andrealeopardi.com/posts/breakdown-of-http-clients-in-elixir/#req&quot;&gt;Req&lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://andrealeopardi.com/posts/breakdown-of-http-clients-in-elixir/#httpc&quot;&gt;httpc&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;This is not a comprehensive list of all the Elixir HTTP clients, but rather a
list of clients that I think make sense in different situation. At the end of
this post, you&apos;ll also find a mention of other well-known clients, as well as
advice for library authors.&lt;/p&gt;&lt;h3 id=&quot;mint&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#mint&quot; aria-label=&quot;Anchor link for: mint&quot;&gt;Mint&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Let&apos;s start with &lt;a href=&quot;https://github.com/elixir-mint/mint&quot;&gt;Mint&lt;/a&gt;. Mint is arguably the lowest-level HTTP client
we&apos;ve got in Elixir. It&apos;s essentially a &lt;em&gt;wrapper&lt;/em&gt; around a raw TCP or SSL
socket. Its job is to make the socket &lt;strong&gt;aware of the network protocol&lt;/strong&gt;. It&apos;s
stateless, meaning that all you deal with is a &quot;connection&quot; data structure, and
it&apos;s process-less, meaning that it doesn&apos;t impose any process architecture on
you.&lt;/p&gt;&lt;p&gt;Think about a &lt;code&gt;:gen_tcp&lt;/code&gt; or a &lt;code&gt;:ssl&lt;/code&gt; socket. Their job is to allow you to
connect servers and clients on the TCP and TLS network protocols, respectively.
When you&apos;re using one of these directly, you usually have to do most of the
encoding of decoding of the data that you&apos;re sending or receiving, because the
sockets carry just binary data.&lt;/p&gt;&lt;p&gt;Mint introduces an abstraction layer &lt;em&gt;around&lt;/em&gt; raw sockets, rather than &lt;em&gt;on top&lt;/em&gt;
of them. Here&apos;s a visual representation:&lt;/p&gt;&lt;img src=&quot;./sketch-mint.png&quot; alt=&quot;Drawing of Mint surrounding a raw socket&quot; width=&quot;70%&quot;&gt;&lt;p&gt;When you use Mint, you have an API that is similar to the one provided by the
&lt;code&gt;:gen_tcp&lt;/code&gt; and &lt;code&gt;:ssl&lt;/code&gt; modules, and you&apos;re using a socket underneath. Mint
provides a &lt;em&gt;data structure&lt;/em&gt; that it calls a &lt;strong&gt;connection&lt;/strong&gt;, which wraps the
underlying socket. A Mint connection is aware of the HTTP protocol, so you don&apos;t
send and receive raw binary data here, but rather data that makes sense in the
semantics of HTTP.&lt;/p&gt;&lt;p&gt;For example, let&apos;s see how you&apos;d make a request using Mint. First, you&apos;d want to
open a connection. Mint itself is &lt;strong&gt;stateless&lt;/strong&gt;, and it stores all the
connection information inside the connection data structure itself.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; conn&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Mint&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;HTTP&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;connect&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;http&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;httpbin.org&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Then, you&apos;d use &lt;a href=&quot;https://hexdocs.pm/mint/Mint.HTTP.html#request/5&quot;&gt;&lt;code&gt;Mint.HTTP.request/5&lt;/code&gt;&lt;/a&gt; to send a
request.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; conn&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; request_ref&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Mint&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;HTTP&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;request&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;conn&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;GET&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;/&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Sending a request is analogous to sending raw binary data on a &lt;code&gt;:gen_tcp&lt;/code&gt; or
&lt;code&gt;:ssl&lt;/code&gt; socket: it&apos;s &lt;em&gt;not blocking&lt;/em&gt;. The call to &lt;code&gt;request/5&lt;/code&gt; returns right away,
giving you a &lt;strong&gt;request reference&lt;/strong&gt; back. The underlying socket will eventually
receive a response as an Erlang message. At that point, you can use
&lt;code&gt;Mint.HTTP.stream/2&lt;/code&gt; to turn that message into something that makes sense in
HTTP.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;receive&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  message &lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; conn&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; responses&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Mint&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;HTTP&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;stream&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;conn&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; message&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;IO&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;inspect&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;responses&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt;=&amp;gt; [
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt;=&amp;gt;   {:status, #Reference&amp;lt;...&amp;gt;, 200},
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt;=&amp;gt;   {:headers, #Reference&amp;lt;...&amp;gt;, [{&amp;quot;connection&amp;quot;, &amp;quot;keep-alive&amp;quot;}, ...},
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt;=&amp;gt;   {:data, #Reference&amp;lt;...&amp;gt;, &amp;quot;&amp;lt;!DOCTYPE html&amp;gt;...&amp;quot;},
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt;=&amp;gt;   {:done, #Reference&amp;lt;...&amp;gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt;=&amp;gt; ]
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Mint supports HTTP/1.1 and HTTP/2 out of the box, as well as WebSocket through
&lt;a href=&quot;https://github.com/elixir-mint/mint_web_socket&quot;&gt;mint_web_socket&lt;/a&gt;.&lt;/p&gt;&lt;h4 id=&quot;when-to-use-mint&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#when-to-use-mint&quot; aria-label=&quot;Anchor link for: when-to-use-mint&quot;&gt;When to Use Mint&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;Generally, &lt;em&gt;&lt;strong&gt;don&apos;t use Mint&lt;/strong&gt;&lt;/em&gt;. Seriously. You know I mean this advice, because
I&apos;m one of the &lt;a href=&quot;https://github.com/whatyouhide&quot;&gt;two&lt;/a&gt;&lt;a href=&quot;https://github.com/ericmj&quot;&gt;people&lt;/a&gt; who maintain and
originally created Mint itself! For most use cases, Mint is too low
level. When you use it, you&apos;ll have to care about things such as pooling
connections, process architecture, keeping the connection structs around, and so
on. It&apos;s a bit like what you&apos;d do in other cases, after all. For example, you&apos;re
unlikely to use &lt;code&gt;:gen_tcp&lt;/code&gt; to communicate directly with your PostgreSQL
database. Instead, you&apos;d probably reach &lt;em&gt;at least&lt;/em&gt; for something like
&lt;a href=&quot;https://github.com/elixir-ecto/postgrex&quot;&gt;Postgrex&lt;/a&gt; to abstract a lot of the complexity away.&lt;/p&gt;&lt;p&gt;Still, there are some use cases where Mint can make a lot of sense. First and
foremost, you can use it to build higher-level abstractions. That&apos;s exactly what
a library called Finch does, which we&apos;ll talk about in a bit. Mint can also be
useful in cases where you need fine-grained control over the performance and
process architecture of your application. For example, say you have a fine-tuned
&lt;a href=&quot;https://github.com/elixir-lang/gen_stage&quot;&gt;GenStage&lt;/a&gt; pipeline where you need to make some HTTP calls at some
point. GenStage stages are already processes, so having an HTTP client based on
a process might introduce an unnecessary layer of processes in your application.
Mint being processless solves exactly that.&lt;/p&gt;&lt;p&gt;&lt;img src=&quot;https://andrealeopardi.com/posts/breakdown-of-http-clients-in-elixir/./sketch-genstage.png&quot; alt=&quot;Drawing of a GenStage pipeline with a traditional process-based HTTP client on the left, and the same pipeline but with Mint as the HTTP client on the right&quot; /&gt;&lt;/p&gt;&lt;p&gt;A few years ago, I worked at a company where we would&apos;ve likely used Mint in
exactly this way. At the time, I wrote &lt;a href=&quot;https://tech.forzafootball.com/blog/maximizing-http2-performance-with-genstage&quot;&gt;a blog
post&lt;/a&gt; that goes into more detail in case you&apos;re
interested.&lt;/p&gt;&lt;h4 id=&quot;bonus-why-isn-t-mint-in-the-elixir-standard-library&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#bonus-why-isn-t-mint-in-the-elixir-standard-library&quot; aria-label=&quot;Anchor link for: bonus-why-isn-t-mint-in-the-elixir-standard-library&quot;&gt;Bonus: Why Isn&apos;t Mint in the Elixir Standard Library?&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;That&apos;s a great question! When we introduced Mint back in 2019, we &lt;a href=&quot;https://elixir-lang.org/blog/2019/02/25/mint-a-new-http-library-for-elixir/&quot;&gt;posted about
it&lt;/a&gt; on Elixir&apos;s website. Our original intention was to ship Mint
with Elixir&apos;s standard library. This is also one of the reasons why we wrote
Mint in Elixir, instead of Erlang. However, we then realized that it worked well
as a standalone library, and including it into the standard library would
increase the cost of maintaining the language as well as potentially slow down
the development of Mint itself.&lt;/p&gt;&lt;p&gt;That said, I think of Mint as the &quot;standard-library HTTP client&quot;, that is, the
low-level client that you&apos;d expect in the standard library of a language like
Elixir.&lt;/p&gt;&lt;h3 id=&quot;finch&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#finch&quot; aria-label=&quot;Anchor link for: finch&quot;&gt;Finch&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/sneako/finch&quot;&gt;Finch&lt;/a&gt; is a client built on top of Mint. It serves an important job in
the &quot;pyramid of abstractions&quot; of HTTP clients listed in this post: &lt;strong&gt;pooling&lt;/strong&gt;.
Finch provides pooling for Mint connections. Using Mint on its own means
implementing some sort of strategy to store and pool connections, which is what
Finch provides.&lt;/p&gt;&lt;p&gt;Finch is quite smart about its pooling. It uses &lt;a href=&quot;https://github.com/dashbitco/nimble_pool&quot;&gt;nimble_pool&lt;/a&gt; when pooling
HTTP/1.1 connections. The nimble_pool library is a tiny resource-pool
implementation heavily focused on a small resource-usage footprint as well as on
performance. Since HTTP/2 works quite differently from HTTP/1.1 and the former
is capable of multiplexing requests, Finch uses a completely different strategy
for HTTP/2, without any pooling. All of this is transparent to users.&lt;/p&gt;&lt;p&gt;The API that Finch provides is still quite low-level, with manual request
building and such:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; _&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Finch&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;start_link&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;name&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MyFinch&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Finch&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;build&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;get&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;https://hex.pm&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-pipe z-elixir&quot;&gt;|&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Finch&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;request&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MyFinch&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt;=&amp;gt; {:ok, %Finch.Response{...}}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;However, but the convenience of pooling and reconnections that Finch provides is
fantastic.&lt;/p&gt;&lt;p&gt;Okay, when to use Finch then? Personally, I think Finch is a fantastic library
whenever you have performance-sensitive applications where you&apos;re ready to
sacrifice some of the convenience provided by &quot;higher-level&quot; clients. It&apos;s also
great when you know you&apos;ll have to make a lot of requests to the same host,
since you can specify dedicated connection pools per host. This is especially
useful when communicating across internal services, or talking to third-party
APIs.&lt;/p&gt;&lt;h3 id=&quot;req&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#req&quot; aria-label=&quot;Anchor link for: req&quot;&gt;Req&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/wojtekmach/req&quot;&gt;Req&lt;/a&gt; is a relatively-new kid on the block when it comes to HTTP clients in
Elixir. It&apos;s one of my favorite Elixir libraries out there.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Req&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;get!&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;https://api.github.com/repos/wojtekmach/req&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;body&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;description&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt;=&amp;gt; &amp;quot;Req is a batteries-included HTTP client for Elixir.&amp;quot;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;It&apos;s built on top of Finch, and it takes a quite &quot;functional-programming&quot;
approach to HTTP. What I mean by that is that Req revolves around a
&lt;a href=&quot;https://hexdocs.pm/req/Req.Request.html&quot;&gt;&lt;code&gt;Req.Request&lt;/code&gt;&lt;/a&gt;&lt;em&gt;data structure&lt;/em&gt;, which you manipulate to add
options, callbacks, headers, and more before making an HTTP request.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;req &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Req&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Request&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;new&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;method&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;get&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;url&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;https://github.com/...&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-pipe z-elixir&quot;&gt;|&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Req&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Request&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;append_request_steps&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;put_user_agent&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; &amp;amp;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Req&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Steps&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;put_user_agent&lt;span class=&quot;z-keyword z-operator z-arithmetic z-elixir&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-pipe z-elixir&quot;&gt;|&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Req&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Request&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;append_response_steps&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;decompress_body&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; &amp;amp;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Req&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Steps&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;decompress_body&lt;span class=&quot;z-keyword z-operator z-arithmetic z-elixir&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;decode_body&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; &amp;amp;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Req&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Steps&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;decode_body&lt;span class=&quot;z-keyword z-operator z-arithmetic z-elixir&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-pipe z-elixir&quot;&gt;|&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Req&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Request&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;append_error_steps&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;retry&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; &amp;amp;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Req&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Steps&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;retry&lt;span class=&quot;z-keyword z-operator z-arithmetic z-elixir&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;req&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; resp&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Req&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Request&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;run_request&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;req&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Req is extensively customizable, since you can &lt;a href=&quot;https://hexdocs.pm/req/Req.Request.html#module-writing-plugins&quot;&gt;write
plugins&lt;/a&gt; for it in order to build HTTP clients that
are tailored to your application.&lt;/p&gt;&lt;h4 id=&quot;when-to-use-req&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#when-to-use-req&quot; aria-label=&quot;Anchor link for: when-to-use-req&quot;&gt;When To Use Req&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;First and foremost, Req is &lt;em&gt;fantastic&lt;/em&gt; for scripting. With the introduction of
&lt;a href=&quot;https://hexdocs.pm/mix/Mix.html#install/1&quot;&gt;&lt;code&gt;Mix.install/2&lt;/code&gt;&lt;/a&gt; in Elixir 1.12, using libraries in Elixir
scripts is a breeze, and Req fits like a glove.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Mix&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;install&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;req&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;~&amp;gt; 0.3.0&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Req&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;get!&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;https://andrealeopardi.com&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;headers
&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt;=&amp;gt; [
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt;=&amp;gt;   {&amp;quot;connection&amp;quot;, &amp;quot;keep-alive&amp;quot;},
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt;=&amp;gt;   ...
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt;=&amp;gt; ]
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Req is also a great fit to use in your applications. It provides a ton of
features and plugins to use for things like encoding and decoding request
bodies, instrumentation, authentication, and so much more. I&apos;ll take a quote
straight from Finch&apos;s README here:&lt;/p&gt;&lt;blockquote&gt;&lt;p&gt;Most developers will most likely prefer to use the fabulous HTTP client
&lt;a href=&quot;https://github.com/wojtekmach/req&quot;&gt;Req&lt;/a&gt; which takes advantage of Finch&apos;s pooling and provides an extremely
friendly and pleasant to use API.&lt;/p&gt;&lt;/blockquote&gt;&lt;p&gt;So, yeah. In your applications, unless you have some of the needs that we
described so far, just go with Req.&lt;/p&gt;&lt;h3 id=&quot;httpc&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#httpc&quot; aria-label=&quot;Anchor link for: httpc&quot;&gt;httpc&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;While Mint is the lowest-level HTTP client I know of, there&apos;s another client
worth mentioning alongside it: &lt;a href=&quot;https://www.erlang.org/doc/man/httpc.html&quot;&gt;&lt;code&gt;httpc&lt;/code&gt;&lt;/a&gt;. &lt;code&gt;httpc&lt;/code&gt; ships with the Erlang
standard library, making it the &lt;strong&gt;only&lt;/strong&gt; HTTP client in the ecosystem that
&lt;em&gt;doesn&apos;t require any additional dependencies&lt;/em&gt;. This is so appealing! There are
cases where not having dependencies is a huge bonus. For example, if you&apos;re a
library author, being able to make HTTP requests without having to bring in
additional dependencies can be great, because those additional dependencies
would trickle down (as transitive dependencies) to all users of your library.&lt;/p&gt;&lt;p&gt;However, &lt;code&gt;httpc&lt;/code&gt; has major drawbacks. One of them is that it provides little
control over connection pooling. This is usually fine in cases where you need a
few one-off HTTP requests or where your throughput needs are low, but it can be
problematic if you need to make a lot of HTTP requests. Another drawback is that
its API is, how to put it, &lt;em&gt;awkward&lt;/em&gt;.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;version&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;200&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; reason_phrase&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; headers&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; body&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;httpc&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;request&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;get&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-storage z-type z-string z-elixir&quot;&gt;~c&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-other z-literal z-lower z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-other z-literal z-lower z-elixir&quot;&gt;http://www.erlang.org&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-other z-literal z-lower z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The API is quite low level in some aspects, since it can make it hard to compose
functionality and requires you to write custom code for common functionality
such as authentication, compression, instrumentation, and so on.&lt;/p&gt;&lt;p&gt;That said, the main drawback of &lt;code&gt;httpc&lt;/code&gt; in my opinion is &lt;em&gt;security&lt;/em&gt;. While all
HTTP clients on the BEAM use &lt;a href=&quot;https://erlang.org/doc/man/ssl.html&quot;&gt;&lt;code&gt;ssl&lt;/code&gt;&lt;/a&gt; sockets under the hood (when
using TLS), some are much better at providing &lt;strong&gt;secure defaults&lt;/strong&gt;.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;iex&lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;httpc&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;request&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;get&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-storage z-type z-string z-elixir&quot;&gt;~c&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-other z-literal z-lower z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-other z-literal z-lower z-elixir&quot;&gt;https://wrong.host.badssl.com&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-other z-literal z-lower z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;09&lt;/span&gt;:&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;01&lt;/span&gt;:&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;35.967&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;warning&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;Description&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-storage z-type z-string z-elixir&quot;&gt;~c&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-other z-literal z-lower z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-other z-literal z-lower z-elixir&quot;&gt;Server authenticity is not verified since certificate path validation is not enabled&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-other z-literal z-lower z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;Reason&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-storage z-type z-string z-elixir&quot;&gt;~c&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-other z-literal z-lower z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-other z-literal z-lower z-elixir&quot;&gt;The option {verify, verify_peer} and one of the options &amp;#39;cacertfile&amp;#39; or &amp;#39;cacerts&amp;#39; are required to enable this.&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-other z-literal z-lower z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;While you do get a warning regarding the bad SSL certificate here, the request
still goes through. The good news is that this is mostly going away from OTP 26
onward, since OTP 26 &lt;a href=&quot;https://www.erlang.org/blog/otp-26-highlights/#ssl-safer-defaults&quot;&gt;made SSL defaults &lt;strong&gt;significantly
safer&lt;/strong&gt;&lt;/a&gt;.&lt;/p&gt;&lt;h4 id=&quot;when-to-use-httpc&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#when-to-use-httpc&quot; aria-label=&quot;Anchor link for: when-to-use-httpc&quot;&gt;When to Use &lt;code&gt;httpc&lt;/code&gt;&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;So, when to use &lt;code&gt;httpc&lt;/code&gt;? I would personally recommend &lt;code&gt;httpc&lt;/code&gt; only when the most
important goal is to not have any external dependencies. The perfect example for
this is Elixir&apos;s package manager itself, &lt;a href=&quot;https://hex.pm&quot;&gt;Hex&lt;/a&gt;. Hex &lt;a href=&quot;https://github.com/hexpm/hex/blob/1881f9fe8e0571ba7fdcfc86ecf484913125dc37/lib/hex/http.ex&quot;&gt;uses
&lt;code&gt;httpc&lt;/code&gt;&lt;/a&gt; because, if you think about it, what would be the
alternative? You need Hex to fetch dependencies in your Elixir projects, so it
would be a nasty chicken-and-egg problem to try to use a third-party HTTP client
to fetch libraries over HTTP (including that client!).&lt;/p&gt;&lt;p&gt;Other libraries that use &lt;code&gt;httpc&lt;/code&gt; are &lt;a href=&quot;https://github.com/phoenixframework/tailwind&quot;&gt;Tailwind&lt;/a&gt; and
&lt;a href=&quot;https://github.com/phoenixframework/esbuild&quot;&gt;Esbuild&lt;/a&gt;. Both of these use &lt;code&gt;httpc&lt;/code&gt; to download artifacts the first
time they run, so using a more complex HTTP client (at the cost of additional
dependencies) isn&apos;t really necessary.&lt;/p&gt;&lt;h2 id=&quot;choosing-the-right-client&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#choosing-the-right-client&quot; aria-label=&quot;Anchor link for: choosing-the-right-client&quot;&gt;Choosing the Right Client&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;I&apos;ve tried to write a bit about when to use each client so far, but to recap,
these are my loose recommendations:&lt;/p&gt;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th style=&quot;text-align: left&quot;&gt;Client&lt;/th&gt;&lt;th style=&quot;text-align: left&quot;&gt;When&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td style=&quot;text-align: left&quot;&gt;&lt;em&gt;Mint&lt;/em&gt;&lt;/td&gt;&lt;td style=&quot;text-align: left&quot;&gt;You need 100% control on connections and request lifecycle&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td style=&quot;text-align: left&quot;&gt;&lt;em&gt;Mint&lt;/em&gt;&lt;/td&gt;&lt;td style=&quot;text-align: left&quot;&gt;You already have a process architecture, and don&apos;t want to introduce any more processes&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td style=&quot;text-align: left&quot;&gt;&lt;em&gt;Mint&lt;/em&gt;&lt;/td&gt;&lt;td style=&quot;text-align: left&quot;&gt;You&apos;re a library author, and you want to force as few dependencies as possible on your users while being mindful of performance and security (so no &lt;code&gt;httpc&lt;/code&gt;)&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td style=&quot;text-align: left&quot;&gt;&lt;em&gt;Finch&lt;/em&gt;&lt;/td&gt;&lt;td style=&quot;text-align: left&quot;&gt;You need a low-level client with high performance, transparent support for HTTP/1.1 (with pooling) and HTTP/2 (with multiplexing)&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td style=&quot;text-align: left&quot;&gt;&lt;em&gt;Req&lt;/em&gt;&lt;/td&gt;&lt;td style=&quot;text-align: left&quot;&gt;Most applications that make HTTP calls&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td style=&quot;text-align: left&quot;&gt;&lt;em&gt;Req&lt;/em&gt;&lt;/td&gt;&lt;td style=&quot;text-align: left&quot;&gt;Scripting&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td style=&quot;text-align: left&quot;&gt;&lt;em&gt;httpc&lt;/em&gt;&lt;/td&gt;&lt;td style=&quot;text-align: left&quot;&gt;You&apos;re a (hardcore) library author who needs a few HTTP requests in their library, but you don&apos;t want to add unnecessary transitive dependencies for your users&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;p&gt;Some of the HTTP clients I&apos;ve talked about here form sort of an abstraction
pyramid.&lt;/p&gt;&lt;p&gt;&lt;img src=&quot;https://andrealeopardi.com/posts/breakdown-of-http-clients-in-elixir/./sketch-pyramid.png&quot; alt=&quot;A drawing of a pyramid (like the food pyramid thing) but for HTTP clients&quot; /&gt;&lt;/p&gt;&lt;h3 id=&quot;library-authors&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#library-authors&quot; aria-label=&quot;Anchor link for: library-authors&quot;&gt;Library Authors&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;I want to also talk about library authors here. If you&apos;re the author of a
library that needs to make HTTP calls, you have the options we talked about. If
you&apos;re only making a handful of one-off HTTP calls, then I&apos;d go with &lt;code&gt;httpc&lt;/code&gt;, so
that you don&apos;t have any impact on downstream code that depends on your library.
However, if making HTTP requests is central to your library, I would really
recommend you use the &quot;adapter behaviour&quot; technique.&lt;/p&gt;&lt;p&gt;What I mean by &lt;em&gt;adapter behaviour technique&lt;/em&gt; is that ideally you&apos;d build an
interface for what you need your HTTP client to do in your library. For example,
if you&apos;re building a client for an error-reporting service (such as
&lt;a href=&quot;https://sentry.io&quot;&gt;Sentry&lt;/a&gt;), you might only care about making synchronous &lt;code&gt;POST&lt;/code&gt; requests.
In those cases, you can define a behaviour in your library:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;SentryClient&lt;/span&gt;.&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;HTTPClientBehaviour&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-variable z-other z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-definition z-constant z-elixir&quot;&gt;@&lt;/span&gt;type&lt;/span&gt; status&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt; :: &lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-elixir&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;599&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-variable z-other z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-definition z-constant z-elixir&quot;&gt;@&lt;/span&gt;type&lt;/span&gt; headers&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt; :: &lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;t&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;t&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-variable z-other z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-definition z-constant z-elixir&quot;&gt;@&lt;/span&gt;type&lt;/span&gt; body&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt; :: binary&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-variable z-other z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-definition z-constant z-elixir&quot;&gt;@&lt;/span&gt;callback&lt;/span&gt; post&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;url :: &lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;t&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; headers&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; body&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt; ::
&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; status&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; headers&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; body&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-other z-elixir&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;error&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; term&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;This would be a &lt;em&gt;public&lt;/em&gt; interface, allowing your users to implement their own
clients. This allows users to choose a client that they&apos;re already using in
their codebase, for example. You can still provide a default implementation that
ships with your library and uses the client of your choice. Incidentally, this
is exactly what the Sentry library for Elixir does: it ships with &lt;a href=&quot;https://hexdocs.pm/sentry/Sentry.HackneyClient.html&quot;&gt;a default
client&lt;/a&gt; based on Hackney. If you go with this
approach, remember to make the HTTP client an &lt;strong&gt;optional dependency&lt;/strong&gt; of your
library:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; In mix.exs
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defp&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-private z-elixir&quot;&gt;deps&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; ...,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;hackney&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;~&amp;gt; 1.0&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;optional&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&quot;what-about-the-others&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#what-about-the-others&quot; aria-label=&quot;Anchor link for: what-about-the-others&quot;&gt;What About the Others?&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;These are not all the HTTP clients available in Elixir, let alone on the BEAM! I
have not mentioned well-known Elixir clients such as &lt;a href=&quot;https://github.com/edgurgel/httpoison&quot;&gt;HTTPoison&lt;/a&gt; and
&lt;a href=&quot;https://github.com/elixir-tesla/tesla&quot;&gt;Tesla&lt;/a&gt;, nor Erlang clients such as &lt;a href=&quot;https://github.com/benoitc/hackney&quot;&gt;hackney&lt;/a&gt;.&lt;/p&gt;&lt;h3 id=&quot;httpoison&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#httpoison&quot; aria-label=&quot;Anchor link for: httpoison&quot;&gt;HTTPoison&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;HTTPoison is an Elixir wrapper on top of hackney:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;HTTPoison&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;get!&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;https://example.com&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt;=&amp;gt; %HTTPoison.Response{...}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Because of this, I tend to not really use HTTPoison and, if necessary, go
straight to hackney.&lt;/p&gt;&lt;h3 id=&quot;hackney&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#hackney&quot; aria-label=&quot;Anchor link for: hackney&quot;&gt;Hackney&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;hackney is a widely-used Erlang client which provides a nice and modern API and
has support for streaming requests, compression, encoding, file uploads, and
more. If your project is an Erlang project (which is not the focus of this
post), hackney can be a good choice.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;hackney&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;request&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;get&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;https://example.com&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt;=&amp;gt; {:ok, 200, [...], &amp;quot;...&amp;quot;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;However, hackney presents some issues in my opinion. The first is that hackney
had questionable &lt;em&gt;security defaults&lt;/em&gt;. It uses good defaults, but when changing
even a single SSL option, then it drops all those defaults. This is prone to
security flaws, because users don&apos;t always fill in secure options. While not
technically a fault of the library itself, the API makes it easy to mess up:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; Secure defaults:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;hackney&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;get&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;https://wrong.host.badssl.com&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt;=&amp;gt; {:error, {:tls_alert, {:handshake_failure, ...
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; When changing any SSL options, no secure defaults anymore:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;ssl_options &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;reuse_sessions&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;hackney&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;get&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;https://wrong.host.badssl.com&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;ssl_options&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; ssl_options&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; 11:52:32.033 [warning] Description: ~c&amp;quot;Server authenticity is not verified ...
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt;=&amp;gt; {:ok, 200, ...}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;In the second example above, where I changed the &lt;code&gt;reuse_sessions&lt;/code&gt; SSL options,
you get a warning about the host&apos;s authenticity, but the request goes through.&lt;/p&gt;&lt;p&gt;Another thing that I think could be improved in hackney is that it brings in a
whopping &lt;em&gt;seven&lt;/em&gt; dependencies. They&apos;re all pertinent to what hackney does, but
it&apos;s quite a few in my opinion.&lt;/p&gt;&lt;p&gt;Last but not least, hackney doesn&apos;t use the standard &lt;a href=&quot;https://github.com/beam-telemetry/telemetry&quot;&gt;telemetry&lt;/a&gt; library to
report metrics, which can make it a bit of a hassle to wire in metrics (since
many Elixir applications, at this point, use telemetry for instrumentation).&lt;/p&gt;&lt;p&gt;One important thing to mention: while HTTPoison is a wrapper around hackney, its
&lt;a href=&quot;https://github.com/edgurgel/httpoison#upgrading-to-2xx&quot;&gt;version 2.0.0&lt;/a&gt; fixes the potentially-unsecure SSL behavior
that we just described for hackney.&lt;/p&gt;&lt;h3 id=&quot;tesla&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#tesla&quot; aria-label=&quot;Anchor link for: tesla&quot;&gt;Tesla&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/elixir-tesla/tesla&quot;&gt;Tesla&lt;/a&gt; is a pretty widely-used HTTP client for Elixir. It provides a
similar level of abstraction as Req. In my opinion, its main advantage is that
it provides &lt;strong&gt;swappable HTTP client adapters&lt;/strong&gt;, meaning that you can use its
common API but choose the underlying HTTP client among ones like Mint, hackney,
and more. Luckily, this feature is in the works for Req as well.&lt;/p&gt;&lt;p&gt;The reason I tend to not reach for Tesla is mostly that, in my opinion, it
relies a bit too much on module-based configuration and meta-programming. In
comparison, I find Req&apos;s functional API easier to compose, abstract, and reuse.&lt;/p&gt;&lt;p&gt;There are &lt;strong&gt;other clients&lt;/strong&gt; in Erlang and Elixir: &lt;a href=&quot;https://github.com/ninenines/gun&quot;&gt;gun&lt;/a&gt;, &lt;a href=&quot;https://github.com/cmullaparthi/ibrowse&quot;&gt;ibrowse&lt;/a&gt;, and
more. But we gotta draw a line at some point!&lt;/p&gt;&lt;h2 id=&quot;conclusions&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#conclusions&quot; aria-label=&quot;Anchor link for: conclusions&quot;&gt;Conclusions&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;We went through a bunch of stuff here. We talked about the clients I personally
like and recommend for different use cases. You also got a nice little summary
table for when to use each of those client. Last but not least, I mentioned some
other clients as well reasons why I prefer the ones in this post.&lt;/p&gt;&lt;p&gt;That&apos;s all. Happy HTTP&apos;ing!&lt;/p&gt;&lt;h3 id=&quot;acknowledgements&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#acknowledgements&quot; aria-label=&quot;Anchor link for: acknowledgements&quot;&gt;Acknowledgements&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;I want to thank a few folks for helping review this post before it went out. Thank you &lt;a href=&quot;https://twitter.com/josevalim&quot;&gt;José&lt;/a&gt;, &lt;a href=&quot;http://wojtekmach.pl&quot;&gt;Wojtek&lt;/a&gt;, and &lt;a href=&quot;https://github.com/sabiwara&quot;&gt;Jean&lt;/a&gt;.&lt;/p&gt;</content>
    
    </entry>
  
    <entry>
      <id>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;posts&#x2F;protohackers-in-elixir&#x2F;</id>
      <title type="html"><![CDATA[ Protohackers in Elixir ]]></title>
      <link rel="alternate"
            type="text/html"
            href="https://andrealeopardi.com/posts/protohackers-in-elixir/"
            title="Protohackers in Elixir" />
      <published>2023-01-05T00:00:00+00:00</published>
      <author>
        <name>Andrea Leopardi</name>
        <uri>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;</uri>
        <email>hi@andrealeopardi.com</email>
      </author>
      <updated>2023-01-05T00:00:00+00:00</updated>
      <summary type="html">&lt;p&gt;I recently published a new screencast series where I solve some network programming puzzles in Elixir. The challenges are provided by &lt;a href=&quot;https://protohackers.com&quot;&gt;Protohackers&lt;/a&gt;, a website I recently found on the interwebs (it&apos;s sort of like &lt;a href=&quot;https://andrealeopardi.com/posts/advent-of-code-2022/&quot;&gt;Advent of Code&lt;/a&gt;, but for network challenges). You can find all the videos in this post.&lt;/p&gt;</summary>
    
      <content type="html">&lt;p&gt;I recently published a new screencast series where I solve some network programming puzzles in Elixir. The challenges are provided by &lt;a href=&quot;https://protohackers.com&quot;&gt;Protohackers&lt;/a&gt;, a website I recently found on the interwebs (it&apos;s sort of like &lt;a href=&quot;https://andrealeopardi.com/posts/advent-of-code-2022/&quot;&gt;Advent of Code&lt;/a&gt;, but for network challenges). You can find all the videos in this post.&lt;/p&gt;&lt;span id=&quot;continue-reading&quot;&gt;&lt;/span&gt;&lt;p&gt;Here&apos;s the playlist on YouTube:&lt;/p&gt;&lt;iframe width=&quot;100%&quot; height=&quot;400px&quot; src=&quot;https://www.youtube.com/embed/videoseries?list=PLd7I3U4fDsULTLqbRAkWzA002-IzMe8fl&quot; title=&quot;YouTube video player&quot; frameborder=&quot;0&quot; allow=&quot;accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share&quot; allowfullscreen&gt;&lt;/iframe&gt;</content>
    
    </entry>
  
    <entry>
      <id>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;posts&#x2F;advent-of-code-2022&#x2F;</id>
      <title type="html"><![CDATA[ Advent of Code 2022 ]]></title>
      <link rel="alternate"
            type="text/html"
            href="https://andrealeopardi.com/posts/advent-of-code-2022/"
            title="Advent of Code 2022" />
      <published>2022-12-01T00:00:00+00:00</published>
      <author>
        <name>Andrea Leopardi</name>
        <uri>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;</uri>
        <email>hi@andrealeopardi.com</email>
      </author>
      <updated>2022-12-26T00:00:00+00:00</updated>
      <summary type="html">&lt;p&gt;I&apos;m doing &lt;a href=&quot;https://adventofcode.com&quot;&gt;Advent of Code&lt;/a&gt; 2022 in &lt;a href=&quot;https://www.rust-lang.org&quot;&gt;Rust&lt;/a&gt; as a chance to get more familiar with the language. In this ongoing post, I&apos;m documenting each day&apos;s progress, my thought process, and so on. I&apos;m better at writing than recording screencasts or what have you. This is essentially a small journal. Ah, and I&apos;m trying &lt;strong&gt;AI tools&lt;/strong&gt; for doing this as well, so this is bound to be fun.&lt;/p&gt;</summary>
    
      <content type="html">&lt;p&gt;I&apos;m doing &lt;a href=&quot;https://adventofcode.com&quot;&gt;Advent of Code&lt;/a&gt; 2022 in &lt;a href=&quot;https://www.rust-lang.org&quot;&gt;Rust&lt;/a&gt; as a chance to get more familiar with the language. In this ongoing post, I&apos;m documenting each day&apos;s progress, my thought process, and so on. I&apos;m better at writing than recording screencasts or what have you. This is essentially a small journal. Ah, and I&apos;m trying &lt;strong&gt;AI tools&lt;/strong&gt; for doing this as well, so this is bound to be fun.&lt;/p&gt;&lt;span id=&quot;continue-reading&quot;&gt;&lt;/span&gt;&lt;p&gt;&lt;img src=&quot;https://andrealeopardi.com/posts/advent-of-code-2022/cover-image.png&quot; alt=&quot;Cover image of a futuristic-looking Christmas tree&quot; /&gt;&lt;/p&gt;&lt;p&gt;I don&apos;t really know Rust, but it&apos;s a fascinating language for me. I mostly write &lt;a href=&quot;https://elixir-lang.org&quot;&gt;Elixir&lt;/a&gt;. Even when it comes to other languages, I&apos;m used to and fond of functional programming, immutable data everywhere, and things like those. Rust is quite different. I&apos;m not used to working with &lt;strong&gt;static types&lt;/strong&gt;, &lt;strong&gt;mutability&lt;/strong&gt;, or &lt;strong&gt;low-level memory access&lt;/strong&gt;. This is a good excuse to learn a bit more about the language, given its recent rise to fame.&lt;/p&gt;&lt;p&gt;The thing is this: it&apos;s hard to search specific stuff on the web when learning a new programming language, especially &lt;em&gt;at the beginning&lt;/em&gt;. I&apos;m clueless, so I go about it by searching for stuff like &quot;how to read a file and split it into lines in Rust?&quot;. It takes a lot of Stack Overflow questions, small snippets of code lying around in blog posts, and documentation. However, 2022 is the &lt;strong&gt;year of AI&lt;/strong&gt;, isn&apos;t it? I have not been too deep into the AI scene. I&apos;ve used &lt;a href=&quot;https://openai.com/index/dall-e-2/&quot;&gt;DALL·E 2&lt;/a&gt; a bit, but not much else. Never tried writing software with the help of &lt;a href=&quot;https://github.com/features/copilot&quot;&gt;GitHub Copilot&lt;/a&gt;, for example. And at the time of writing this, a lot of what I read on the Internet is about the recent release of &lt;a href=&quot;https://openai.com/index/chatgpt/&quot;&gt;ChatGPT&lt;/a&gt;. There&apos;s no time like the present, right? I figured these tools might be a nice help when learning a new language.&lt;/p&gt;&lt;p&gt;Anyway, enough prefacing. I&apos;ll post each day, and I&apos;ll probably break that promise. Most recent day on top. All complete solutions are &lt;a href=&quot;https://github.com/whatyouhide/advent_of_code_2022&quot;&gt;on GitHub&lt;/a&gt;.&lt;/p&gt;&lt;p&gt;Also, a disclaimer: this is not a polished post. I went with the approach that publishing something is better than publishing nothing, so I&apos;m going for it. I&apos;d absolutely love to know if this was interesting for you, so reach out on Twitter or via email (links in footer) if you have feedback.&lt;/p&gt;&lt;h2 id=&quot;day-25&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-25&quot; aria-label=&quot;Anchor link for: day-25&quot;&gt;Day 25&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;I could only do part one here since I don&apos;t have all other puzzles completed yet. The most fun thing about today&apos;s puzzle was implementing a bunch of Rust traits for these &quot;SNAFU&quot; numbers to play more with Rust.&lt;/p&gt;&lt;p&gt;I went with:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;code&gt;std::fmt::Display&lt;/code&gt;, which prints a SNAFU as a string (as seen in the puzzle input).&lt;/li&gt;&lt;li&gt;&lt;code&gt;std::str::FromStr&lt;/code&gt;, which lets me parse a string representation of a SNAFU number.&lt;/li&gt;&lt;li&gt;&lt;code&gt;TryFrom&amp;lt;i128&amp;gt;&lt;/code&gt;, which lets me convert &lt;code&gt;i128&lt;/code&gt; numbers to &lt;code&gt;SNAFU&lt;/code&gt; numbers.&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;Other than that, this is a base conversion thing. Early in my career, I got obsessed for a little bit with base conversions and even created &lt;a href=&quot;https://github.com/whatyouhide/convertat&quot;&gt;a library for Elixir&lt;/a&gt; and &lt;a href=&quot;https://github.com/whatyouhide/bases&quot;&gt;a library for Ruby&lt;/a&gt; to do base conversion. Go figure.&lt;/p&gt;&lt;h2 id=&quot;day-24&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-24&quot; aria-label=&quot;Anchor link for: day-24&quot;&gt;Day 24&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Haven&apos;t attempted yet. Time.&lt;/p&gt;&lt;h2 id=&quot;day-23&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-23&quot; aria-label=&quot;Anchor link for: day-23&quot;&gt;Day 23&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Some kind of &lt;a href=&quot;https://en.wikipedia.org/wiki/Conway%27s_Game_of_Life&quot;&gt;Conway&apos;s Game of Life&lt;/a&gt; thing for today&apos;s puzzle.&lt;/p&gt;&lt;p&gt;Absolutely nothing interesting to write about. I didn&apos;t really learn anything new, didn&apos;t play with any Rust features, or anything like that. Just plain old working-through-the-problem. Same for part two.&lt;/p&gt;&lt;h2 id=&quot;day-22&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-22&quot; aria-label=&quot;Anchor link for: day-22&quot;&gt;Day 22&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Uh, sort-of-2D work. Not a fan here.&lt;/p&gt;&lt;p&gt;Part one was a matter of getting the wrapping and directions and grid right. I don&apos;t even know what to write about here, as the code is pretty boring to look at. The only thing I enjoyed doing was using types a lot to &lt;a href=&quot;https://fsharpforfunandprofit.com/posts/designing-with-types-making-illegal-states-unrepresentable/&quot;&gt;&quot;make illegal states unrepresentable&quot;&lt;/a&gt;. For example, instead of having a board of &lt;code&gt;char&lt;/code&gt;s (&lt;code&gt;&apos; &apos;&lt;/code&gt;, &lt;code&gt;&apos;.&apos;&lt;/code&gt;, or &lt;code&gt;&apos;#&apos;&lt;/code&gt;), I went with an enum:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-enum z-rust&quot;&gt;enum&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-enum z-rust&quot;&gt;Cell&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    Empty&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    Space&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    Wall
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Other than this… Not my jam. I didn&apos;t even attempt part two yet because it goes from sort-of-2D to sort-of-3D. I don&apos;t want anything to do with that!&lt;/p&gt;&lt;h2 id=&quot;day-21&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-21&quot; aria-label=&quot;Anchor link for: day-21&quot;&gt;Day 21&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Nice puzzle today. For part one, I was able to get away with a quick-enough solution: iterate through the monkeys and &quot;solve&quot; the ones that point to monkeys that already have a number. Without all the parsing code, the core looks something like this:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; monkeys &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; input
&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;lines&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;line&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;parse&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;Monkey&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;collect&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;HashMap&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;String&lt;/span&gt;, Monkey&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; computed_monkeys &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;HashMap&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;new&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;loop&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;if&lt;/span&gt; monkeys&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-comparison z-rust&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;for&lt;/span&gt; monkey &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;in&lt;/span&gt; monkeys&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;clone&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;match&lt;/span&gt; monkey&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;clone&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Monkey&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;YellingMonkey&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;name&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; number&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                monkeys&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;remove&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;monkey&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                computed_monkeys&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;insert&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;name&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; number&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Monkey&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;MathMonkey&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;name&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; op&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; monkey1&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; monkey2&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;match&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;                    computed_monkeys&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;monkey1&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;                    computed_monkeys&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;monkey2&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;number1&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;number2&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                        monkeys&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;remove&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;monkey&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; result &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; op&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;apply&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;*&lt;/span&gt;number1&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;*&lt;/span&gt;number2&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                        computed_monkeys&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;insert&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;name&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; result&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;continue&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;println!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;The &amp;#39;root&amp;#39; monkey yells: &lt;span class=&quot;z-constant z-other z-placeholder z-rust&quot;&gt;{}&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; computed_monkeys&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;root&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Not very pretty, but fast enough to spit out the correct result.&lt;/p&gt;&lt;h3 id=&quot;day-21-part-two&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-21-part-two&quot; aria-label=&quot;Anchor link for: day-21-part-two&quot;&gt;Day 21: Part Two&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Part two was more fun! The same brute-force approach as above crumbled down. I naively tried this: if I know how to calculate the &lt;code&gt;root&lt;/code&gt; monkey&apos;s values, and I can compare them for equality… Let&apos;s try all numbers (&lt;code&gt;0..&lt;/code&gt;) for the &lt;code&gt;humn&lt;/code&gt; value and see if we find one that works. Failed miserably.&lt;/p&gt;&lt;p&gt;So, time to roll up my sleeves and build an AST of operations. I went with a straightforward structure:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-enum z-rust&quot;&gt;enum&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-enum z-rust&quot;&gt;ASTNode&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    Human&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    Number&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;isize&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    Operation&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;Operation&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Box&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;ASTNode&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Box&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;ASTNode&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Parsing the AST was easy enough. The fun part was to &quot;solve&quot; the full AST for the &lt;code&gt;humn&lt;/code&gt; variable. To do that, I went with the simplest one-variable equation solving approach I could think of. The idea was to do something to both sides of the &lt;code&gt;=&lt;/code&gt; that would simplify the side where the &lt;code&gt;humn&lt;/code&gt; variable is. This is really early grades math, I know. So, I went with a &lt;code&gt;simplify_equation(left_ast, right_ast)&lt;/code&gt; function:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;simplify_equation&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;, &lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;right&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;, &lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;match&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;left&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; right&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; We solved it!
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Human&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Number&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;_&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;left&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;clone&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; right&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;clone&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; If there&amp;#39;s an operation on the left, we simplify it.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Operation&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;op&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; x&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; y&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Number&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;right_number&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; The equation is number • y = right_number, so we can simplify it as
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; y = right_number ¬ number, where ¬ is the opposite of •.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;match&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;as_ref&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; y&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;as_ref&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Number&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;number&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;_&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; The Sub operation is tricky, because it&amp;#39;s technically
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; (Add -&amp;gt; Mul(-1)).
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;simplified_left&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; op&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;*&lt;/span&gt;op &lt;span class=&quot;z-keyword z-operator z-comparison z-rust&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Operation&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Sub &lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Box&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;new&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Operation&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Operation&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Mul&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Box&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;new&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Number&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;                                y&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;clone&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Operation&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Add&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;y&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;clone&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;*&lt;/span&gt;op&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; simplified_right &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Number&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;op&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;inverse&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;apply&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;*&lt;/span&gt;right_number&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;*&lt;/span&gt;number&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;simplify_equation&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;simplified_left&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;simplified_right&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; The equation is x • number = right_number, so we can simplify it as
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; x = right_number ¬ number, where ¬ is the opposite of •.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Number&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;number&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; simplified_left &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; x&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;clone&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; simplified_right &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Number&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;op&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;inverse&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;apply&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;*&lt;/span&gt;right_number&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;*&lt;/span&gt;number&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;simplify_equation&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;simplified_left&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;simplified_right&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;panic!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;found an operation on the left where neither operand is a number&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;panic!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;Should never get here&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;To make this work, I also added a &lt;code&gt;simplify(ast)&lt;/code&gt; function that simplifies an AST made entirely of numbers (which can be reduced to a single number). My initial solution did not work, so I turned out to Reddit and someone mentioned the &lt;a href=&quot;https://quickmath.com/webMathematica3/quickmath/equations/solve/basic.jsp&quot;&gt;QuickMath website&lt;/a&gt;. I pretty-printed my original equation, pasted it in there, and it spit out the right number. After a bit of debugging, I figured that the issue in my code was that I was not handling the &lt;code&gt;-&lt;/code&gt; operation correctly (which I did in the code above). All is well now.&lt;/p&gt;&lt;h2 id=&quot;day-20&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-20&quot; aria-label=&quot;Anchor link for: day-20&quot;&gt;Day 20&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Today&apos;s puzzle was surprisingly easy considering that it&apos;s day 20 at this point. It&apos;s also the sort of puzzle that a language like Rust, with constant-access vectors and mutable data structures.&lt;/p&gt;&lt;p&gt;For part one, I mostly used the puzzle as an excuse to learn more about some traits.&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-struct z-rust&quot;&gt;struct&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-entity z-name z-struct z-rust&quot;&gt;CircularList&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;i64&lt;/span&gt;, &lt;span class=&quot;z-storage z-type z-rust&quot;&gt;usize&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-comparison z-rust&quot;&gt;&amp;gt;&lt;/span&gt;)&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;I stored each number (&lt;code&gt;i64&lt;/code&gt;) along its &quot;ID&quot; (the &lt;code&gt;usize&lt;/code&gt;), which is just its original index in the provided input. There are duplicates in the input numbers, so trying to find each number by its value wouldn&apos;t have worked. Now for the traits:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Allows me to do some_iter.collect::&amp;lt;CircularList&amp;gt;().
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-impl z-rust&quot;&gt;impl&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;FromIterator&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;i64&lt;/span&gt;, &lt;span class=&quot;z-storage z-type z-rust&quot;&gt;usize&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-other z-rust&quot;&gt;for&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-entity z-name z-impl z-rust&quot;&gt;CircularList&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;from_iter&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;I&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;IntoIterator&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;Item = &lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;i64&lt;/span&gt;, &lt;span class=&quot;z-storage z-type z-rust&quot;&gt;usize&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;iter&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt; I&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;iter&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;into_iter&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;collect&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Nice for reproducing the input example with println!(&amp;quot;{}&amp;quot;, circular_list).
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-impl z-rust&quot;&gt;impl&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;Display &lt;span class=&quot;z-keyword z-other z-rust&quot;&gt;for&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-entity z-name z-impl z-rust&quot;&gt;CircularList&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;fmt&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;self&lt;/span&gt;, &lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;std&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;fmt&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;Formatter&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&amp;#39;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;std&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;fmt&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Result&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;write!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;f,&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-placeholder z-rust&quot;&gt;{}&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-float z-rust&quot;&gt;0.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;iter&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; _&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;n&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;join&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;, &lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;After this, it was a matter of looping through each original number and moving each one to the new position. The only thing that took a second to realize was that the way to calculate the right destination index was to do modulo &lt;code&gt;length - 1&lt;/code&gt;. This makes sense as we remove the element before finding its new position.&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-impl z-rust&quot;&gt;impl&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-entity z-name z-impl z-rust&quot;&gt;CircularList&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;move_element&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;self&lt;/span&gt;, &lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;element&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;i64&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;usize&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; len &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-float z-rust&quot;&gt;0.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;as&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;i64&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;number&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; target_id&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; element&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; current_index &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-float z-rust&quot;&gt;0.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;iter&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;_&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;id&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;*&lt;/span&gt;id &lt;span class=&quot;z-keyword z-operator z-comparison z-rust&quot;&gt;==&lt;/span&gt; target_id&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; new_index &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;current_index &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;as&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;i64&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;+&lt;/span&gt; number&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;len &lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;if&lt;/span&gt; new_index &lt;span class=&quot;z-keyword z-operator z-comparison z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;            new_index &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;len &lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;+&lt;/span&gt; new_index&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; element &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-float z-rust&quot;&gt;0.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;remove&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;current_index&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-float z-rust&quot;&gt;0.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;insert&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;new_index &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;as&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;usize&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; element&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;After this, I just looped through the original elements, moved each one, and then calculated the 1000th, 2000th, and 3000th element in the list with:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;get_element_from_zero&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;self&lt;/span&gt;, &lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;offset_from_zero&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u32&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;i64&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; zero_index &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-float z-rust&quot;&gt;0.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;iter&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; _&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;*&lt;/span&gt;n &lt;span class=&quot;z-keyword z-operator z-comparison z-rust&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; offset &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;offset_from_zero &lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;+&lt;/span&gt; zero_index &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;as&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u32&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-float z-rust&quot;&gt;0.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;as&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u32&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;offset &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;as&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;usize&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&quot;day-20-part-two&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-20-part-two&quot; aria-label=&quot;Anchor link for: day-20-part-two&quot;&gt;Day 20: Part Two&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Part two was such a small iteration over part one today. I only had to multiply each number in the input with the &quot;decryption key&quot; and run through the full iteration 10 times instead of only once.&lt;/p&gt;&lt;h2 id=&quot;day-19&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-19&quot; aria-label=&quot;Anchor link for: day-19&quot;&gt;Day 19&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;Loved&lt;/strong&gt; today&apos;s puzzle. I got re-acquainted with a bunch of new stuff that I had studied in university many ages ago. Namely:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;p&gt;What &lt;a href=&quot;https://en.wikipedia.org/wiki/Linear_programming&quot;&gt;linear programming&lt;/a&gt; is. I did not actually do anything with this info, but it was great to brush up.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Depth-first_search&quot;&gt;Depth-first search&lt;/a&gt; and &lt;a href=&quot;https://en.wikipedia.org/wiki/Breadth-first_search&quot;&gt;breadth-first search&lt;/a&gt; for trees.&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;For part one, I did not have to look anything up. The basic idea was to build a tree of possible successive states, branching at each state by the possible next states. Then, I walked down the tree and calculate the number of geodes at each final state, choosing the maximum for that given tree. I called trees &quot;simulations&quot;.&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-annotation z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-annotation z-rust&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-variable z-annotation z-rust&quot;&gt;derive&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;Clone&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; Copy&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; Debug&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; Hash&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; PartialEq&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; Eq&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-struct z-rust&quot;&gt;struct&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-entity z-name z-struct z-rust&quot;&gt;State&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-variable z-other z-member z-rust&quot;&gt;ore_robots&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-type z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u16&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-variable z-other z-member z-rust&quot;&gt;clay_robots&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-type z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u16&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-variable z-other z-member z-rust&quot;&gt;obsidian_robots&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-type z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u16&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-variable z-other z-member z-rust&quot;&gt;geode_robots&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-type z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u16&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-variable z-other z-member z-rust&quot;&gt;ore&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-type z-rust&quot;&gt;:&lt;/span&gt; Ore,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-variable z-other z-member z-rust&quot;&gt;clay&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-type z-rust&quot;&gt;:&lt;/span&gt; Clay,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-variable z-other z-member z-rust&quot;&gt;obsidian&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-type z-rust&quot;&gt;:&lt;/span&gt; Obsidian,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-variable z-other z-member z-rust&quot;&gt;cracked_geodes&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-type z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u16&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;I liked the approach I went with: I took advantage of the &lt;code&gt;Option&amp;lt;State&amp;gt;&lt;/code&gt; type to figure out the possible next states. The heart of the puzzle is the following method in the &lt;code&gt;State&lt;/code&gt; implementation:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;possible_next_states&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;self&lt;/span&gt;, &lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;blueprint&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;Blueprint, &lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;time_left&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u16&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;State&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Each of the buil_* functions returns Option&amp;lt;State&amp;gt;, returning None
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; if that state is impossible at this point, and Some(state) if it&amp;#39;s
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; possible.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; possible_next_states_with_new_robots &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;vec!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;build_ore_robot&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;blueprint&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; time_left&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;build_clay_robot&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;blueprint&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; time_left&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;build_obsidian_robot&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;blueprint&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; time_left&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;build_geode_robot&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;blueprint&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;clone&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; This state is an &amp;quot;idle&amp;quot; state of just mining
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; next_states &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; possible_next_states_with_new_robots
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;iter&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;filter_map&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;state&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;state&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;clone&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;collect&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Update &amp;quot;mined resources&amp;quot;.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; state &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; next_states &lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;        state&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;ore &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; Ore&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;state&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;ore&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;ore_robots&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;        state&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;clay &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; Clay&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;state&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;clay&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;clay_robots&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;        state&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;obsidian &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; Obsidian&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;state&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;obsidian&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;obsidian_robots&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;        state&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;cracked_geodes &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; state&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;cracked_geodes &lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;geode_robots&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    next_states
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Then, you have your sort of usual tree walk function that recursively goes down the tree. Initially, this was so painfully slow for the input 24 minutes that I had to figure out some optimizations. After lightly browsing &lt;a href=&quot;https://reddit.com/r/adventofcode&quot;&gt;/r/adventofcode&lt;/a&gt;, I understood that the main idea here is to try to &lt;em&gt;prune&lt;/em&gt; as many tree branches as possible. This can be done in several ways. For example, an easy way was:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;p&gt;When building the state, calculate the maximum resource needed for each robot for each type of resource.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;Now, when building the next possible states, you can ignore the &quot;idle&quot; state (&lt;code&gt;Some(self.clone())&lt;/code&gt; above) if you already have the max of each needed resource, since you can only build a single robot at each minute anyway.&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;Since the tree growth is exponential on the number of possible next states, reducing that number has quite a big effect in general. With these optimizations, part one of the puzzle took a handful of seconds to run.&lt;/p&gt;&lt;h3 id=&quot;day-19-part-two&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-19-part-two&quot; aria-label=&quot;Anchor link for: day-19-part-two&quot;&gt;Day 19: Part Two&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Part two&apos;s deal was bumping the minutes from 24 to 32, which is a significant exponential growth in the search space. So, I had to scout for a few more optimizations:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;p&gt;Say the number you mine for resource R reaches the maximum number of R needed for any robot. Also, say you won&apos;t be able to mine enough for new robots with the time left. Then, you can stop building robots that produce R. This is harder to write than to implement, but the main idea is to prune useless states where you build robots that you&apos;re not going to need.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;The biggest optimization, by far, was to keep track of the maximum number of geodes produced in any final state of a simulation. When exploring that simulation, you can then prune whole subtrees where the &lt;strong&gt;optimal&lt;/strong&gt; number of geodes produced is lower than that tree. The optimal number is calculated by pretending that you start producing a geode robot each minute from the current state, and you crack as many geodes as possible. This optimization ended up reducing the search space significantly.&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;With these, it took about ~3 minutes to solve part two. I saw on Reddit that many folks managed to optimize this enough to run in a few hundred milliseconds. That&apos;s pretty interesting, and as far as I could tell it was all done through other optimizations, playing with DFS/BFS, and stuff like that. Great (re-)learning experience today.&lt;/p&gt;&lt;h2 id=&quot;day-18&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-18&quot; aria-label=&quot;Anchor link for: day-18&quot;&gt;Day 18&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Today I managed to squeeze in the puzzle. Parsing the input and defining types was straightforward:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-annotation z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-annotation z-rust&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-variable z-annotation z-rust&quot;&gt;derive&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;Debug&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; PartialEq&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; Eq&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; Hash&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; Clone&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-struct z-rust&quot;&gt;struct&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-entity z-name z-struct z-rust&quot;&gt;Cube&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;i32&lt;/span&gt;, &lt;span class=&quot;z-storage z-type z-rust&quot;&gt;i32&lt;/span&gt;, &lt;span class=&quot;z-storage z-type z-rust&quot;&gt;i32&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-impl z-rust&quot;&gt;impl&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-entity z-name z-impl z-rust&quot;&gt;Cube&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;pub&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;from_string&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;str&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-comment z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;/*&lt;/span&gt; ... &lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;*/&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Then, I went for an inefficient-but-effective approach. I added a method to &lt;code&gt;Cube&lt;/code&gt; that counts the exposed sides of the given cube when compared to a given &lt;strong&gt;set&lt;/strong&gt; of other cubes. The trick of the function is to build a set of all cubes &quot;adjacent&quot; to the target one, and then check how many of those are in the given set of other cubes. The total of exposed sides is six minus that number.&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;exposed_sides&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;self&lt;/span&gt;, &lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;other_cubes&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;HashSet&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u16&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; adjacent_cubes &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;HashSet&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;from&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;adjacent_cubes&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;intersection&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;other_cubes&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;as&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u16&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Calculating all the exposed sides was then a matter of this:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; total_exposed_sides &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; cubes
&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;iter&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;cube&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; set_with_cube &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;HashSet&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;from&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;cube&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;clone&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; difference&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;HashSet&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;Cube&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;HashSet&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;from_iter&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;cubes&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;difference&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;set_with_cube&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;cloned&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;        cube&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;exposed_sides&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;difference&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;as&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u32&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;sum&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u32&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;This approach works because two cubes that are adjacent on one side are &lt;strong&gt;both&lt;/strong&gt; adjacent to each other on that side, which means that we&apos;ll only count the uniquely-exposed sides.&lt;/p&gt;&lt;h2 id=&quot;day-17&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-17&quot; aria-label=&quot;Anchor link for: day-17&quot;&gt;Day 17&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Same as yesterday… Had to skip for now!&lt;/p&gt;&lt;h2 id=&quot;day-16&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-16&quot; aria-label=&quot;Anchor link for: day-16&quot;&gt;Day 16&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;&lt;del&gt;Had to skip for now due to time constraints, I&apos;ll try to come back to this later.&lt;/del&gt;&lt;/p&gt;&lt;p&gt;I went back to this. I used the help of &lt;a href=&quot;https://reddit.com/r/adventofcode&quot;&gt;/r/adventofcode&lt;/a&gt; again. The idea I found to work was:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;p&gt;Build an undirected graph of valves. I used the &lt;a href=&quot;https://docs.rs/petgraph/latest/petgraph/index.html&quot;&gt;&lt;code&gt;petgraph&lt;/code&gt; crate&lt;/a&gt; (in particular, the &lt;a href=&quot;https://docs.rs/petgraph/latest/petgraph/graphmap/type.UnGraphMap.html&quot;&gt;&lt;code&gt;petgraph::graphmap::UnGraphMap&lt;/code&gt;&lt;/a&gt; type).&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;Use the &lt;a href=&quot;https://en.wikipedia.org/wiki/Floyd%E2%80%93Warshall_algorithm&quot;&gt;Floyd-Warshall algorithm&lt;/a&gt; to build a matrix of distance between each node in the graph, assigning the value of &lt;code&gt;1&lt;/code&gt; to each edge. I typed the distance matrix as:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-struct z-rust&quot;&gt;struct&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-entity z-name z-struct z-rust&quot;&gt;DistanceMatrix&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-lifetime z-rust&quot;&gt;&amp;#39;a&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;HashMap&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-lifetime z-rust&quot;&gt;&amp;#39;a&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;str&lt;/span&gt;, &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-lifetime z-rust&quot;&gt;&amp;#39;a&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;str&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u32&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-comparison z-rust&quot;&gt;&amp;gt;&lt;/span&gt;)&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;and has one method, &lt;code&gt;DistanceMatrix::get(u, v)&lt;/code&gt;, that returns the distance between &lt;code&gt;u&lt;/code&gt; and &lt;code&gt;v&lt;/code&gt; (or &lt;code&gt;v&lt;/code&gt; and &lt;code&gt;u&lt;/code&gt;, since the graph is undirected).&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;Instead of exploring all solutions by moving one step at a time, I explored solutions by moving directly to the next valve to open, using the distance matrix to calculate how long it would take.&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;Building the graph was fairly easy. It looks something like this:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Valve is just a struct with a few fields that you can easily guess
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; from this function.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;graph_from_valves&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;valves&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;Valve&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt; ValveGraph&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; graph&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt; ValveGraph &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;graphmap&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;UnGraphMap&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;new&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;for&lt;/span&gt; valve &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;in&lt;/span&gt; valves&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;iter&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;        graph&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;add_node&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;valve&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;id&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;as_str&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;for&lt;/span&gt; valve &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;in&lt;/span&gt; valves&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;iter&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;for&lt;/span&gt; connected_valve &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;in&lt;/span&gt; valve&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;connected_valves&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;iter&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;            graph&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;add_edge&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;valve&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;id&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;as_str&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; connected_valve&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;as_str&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    graph
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Then, the idea is to run simulations on successive states:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;run_simulation&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;state&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt; State,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;distance_matrix&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;DistanceMatrix,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;graph&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;ValveGraph,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;flow_rates&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;HashMap&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u32&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;explored_states&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u32&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt; State&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Just for fun, seeing how many states we need to explore.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;*&lt;/span&gt;explored_states &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;+=&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    state
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;next_states&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;graph&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; distance_matrix&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; flow_rates&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;into_iter&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;run_simulation&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;s&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; distance_matrix&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; graph&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; flow_rates&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; explored_states&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;max_by_key&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;s&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;released_pressure&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap_or&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;state&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;With this strategy, I found a solution after exploring less than 100k states, in about 300ms.&lt;/p&gt;&lt;h3 id=&quot;day-16-part-two&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-16-part-two&quot; aria-label=&quot;Anchor link for: day-16-part-two&quot;&gt;Day 16: Part Two&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;I didn&apos;t really know where to start on part two, and honestly out of laziness I went to Reddit straight away. &lt;a href=&quot;https://www.reddit.com/r/adventofcode/comments/znr2eh/2022_day_16_the_elephant_in_the_room/&quot;&gt;This post&lt;/a&gt; suggested that I do something like this:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;p&gt;Run the simulation like in part one.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;Now, take away all the valves opened by the human, and run the simulation again as the elephant, seeing which valves get opened.&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;With the data structures I used, the easiest way to do this was to set the flow rate of the vales opened in part one to &lt;code&gt;0&lt;/code&gt; before running the &quot;elephant simulation&quot;. Still under 100k states explored, and still under 300ms to get a solution.&lt;/p&gt;&lt;h2 id=&quot;day-15&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-15&quot; aria-label=&quot;Anchor link for: day-15&quot;&gt;Day 15&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Today&apos;s puzzle was interesting: in the second part, I had to actually shrink my little brain and figure out an &lt;em&gt;efficient&lt;/em&gt; way to solve it, instead of brute forcing. But let&apos;s start from part one. Data structures first.&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Love using tuple-like structs.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-annotation z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-annotation z-rust&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-variable z-annotation z-rust&quot;&gt;derive&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;Debug&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; PartialEq&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; Eq&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; Hash&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; Clone&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-struct z-rust&quot;&gt;struct&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-entity z-name z-struct z-rust&quot;&gt;Point&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;i64&lt;/span&gt;, &lt;span class=&quot;z-storage z-type z-rust&quot;&gt;i64&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-annotation z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-annotation z-rust&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-variable z-annotation z-rust&quot;&gt;derive&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;Debug&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-struct z-rust&quot;&gt;struct&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-entity z-name z-struct z-rust&quot;&gt;Grid&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-variable z-other z-member z-rust&quot;&gt;sensors_and_closest_beacons&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-type z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;HashMap&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;Point, Point&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-variable z-other z-member z-rust&quot;&gt;top_left_corner&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-type z-rust&quot;&gt;:&lt;/span&gt; Point,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-variable z-other z-member z-rust&quot;&gt;bottom_right_corner&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-type z-rust&quot;&gt;:&lt;/span&gt; Point,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;I won&apos;t show how I parsed the input into a &lt;code&gt;Grid&lt;/code&gt;, as parsing the input is becoming quite repetitive. The only interesting function in &lt;code&gt;Grid&lt;/code&gt; is &lt;code&gt;Grid::manhattan_distance&lt;/code&gt;. The best thing? GitHub Copilot basically wrote this.&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;manhattan_distance&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;Point, &lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;Point&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;i64&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;-&lt;/span&gt; b&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;abs&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;-&lt;/span&gt; b&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;abs&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;For part one of the puzzle, I was able to find a solution through sheer brute force.&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; target_row &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; forbidden_positions &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Grid::points_in_row returns an iterator of points on the given y.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;for&lt;/span&gt; point &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;in&lt;/span&gt; grid&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;points_in_row&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;target_row&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;if&lt;/span&gt; grid&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;is_in_sensor_range&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;point&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;        forbidden_positions &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;+=&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;println!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;On line &lt;span class=&quot;z-constant z-other z-placeholder z-rust&quot;&gt;{target_row}&lt;/span&gt; there are &lt;span class=&quot;z-constant z-other z-placeholder z-rust&quot;&gt;{forbidden_positions}&lt;/span&gt; forbidden positions&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;One thing to note: the more days go by, the more I find it useful to have a way to &lt;em&gt;represent&lt;/em&gt; data structures on the terminal. In this case, I also implemented a &lt;code&gt;Grid::draw&lt;/code&gt; method, which helped me match my representation and calculations against the provided examples.&lt;/p&gt;&lt;h3 id=&quot;day-15-part-two&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-15-part-two&quot; aria-label=&quot;Anchor link for: day-15-part-two&quot;&gt;Day 15: Part Two&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Part two was a fun challenge. The problem instructs you to search through the space &lt;code&gt;(0, 0) -&amp;gt; (4000000, 4000000)&lt;/code&gt;. That&apos;s 16 trillion points. Rust is fast, but apparently not &lt;em&gt;that&lt;/em&gt; fast. So, I had to get clever. The thing is: I&apos;m not clever! I rarely have to think through optimizations like these, because I tend to work in higher-level domains (like the Web™).&lt;/p&gt;&lt;p&gt;The intuition I followed was to build a list of ranges on each row from the list of beacons. Ranges are fairly cheap to build. I&apos;m sure I could&apos;ve done something more clever, but I went with something like this:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; ranges_by_row &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;HashMap&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;new&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Prefill each row with an empty vector. There&amp;#39;s probably a better way to do
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; this in Rust, but laziness got the best of me.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;for&lt;/span&gt; y &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;top_left_corner&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-rust&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;bottom_right_corner&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    ranges_by_row&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;insert&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;y&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;new&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;sensor&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; beacon&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;sensors_and_closest_beacons &lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; distance &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;manhattan_distance&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;sensor&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; beacon&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;for&lt;/span&gt; current_distance &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;-&lt;/span&gt;distance&lt;span class=&quot;z-keyword z-operator z-range z-rust&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;distance &lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; row &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; sensor&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;+&lt;/span&gt; current_distance&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; offset &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;current_distance&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;abs&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;-&lt;/span&gt; distance&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;abs&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; range &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;sensor&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;-&lt;/span&gt; offset&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-rust&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;sensor&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;+&lt;/span&gt; offset&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;        ranges_by_row&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;get_mut&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;row&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;range&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;This was reasonably fast, in the ballpark of a few seconds tops. Then, for each row, I went through all the ranges and &lt;strong&gt;merged&lt;/strong&gt; them. This was fun to write:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; merged_ranges &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;HashMap&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;new&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;row&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; ranges&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;in&lt;/span&gt; ranges_by_row &lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    ranges&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;sort_by_key&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;range&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;clone&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Start with the first element
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; mut_ranges &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;vec!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;ranges&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;clone&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-rust&quot;&gt;..&lt;/span&gt;ranges&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; next_range &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; ranges&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;i&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;clone&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Pop the current range, modify it if necessary, and put it back.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; current_range &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; mut_ranges&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;pop&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;if&lt;/span&gt; current_range&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-comparison z-rust&quot;&gt;&amp;gt;=&lt;/span&gt; next_range&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; start &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; current_range&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;min&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;next_range&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; end &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; current_range&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;max&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;next_range&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;            mut_ranges&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;*&lt;/span&gt;start&lt;span class=&quot;z-keyword z-operator z-range z-rust&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;*&lt;/span&gt;end&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; If the ranges don&amp;#39;t overlap, but both back.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;            mut_ranges&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;current_range&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;            mut_ranges&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;next_range&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    merged_ranges&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;insert&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;row&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; mut_ranges&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Now the trick: the point we&apos;re searching for is on the only row (in the search space) that has &lt;strong&gt;two&lt;/strong&gt; instead of one &quot;detected ranges&quot;.&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;for&lt;/span&gt; y &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-rust&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;4000000&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; ranges &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; detected_ranges&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;y&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; ranges_len &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; ranges&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;if&lt;/span&gt; ranges_len &lt;span class=&quot;z-keyword z-operator z-comparison z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;println!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;Found the line with a space! It&amp;#39;s line &lt;span class=&quot;z-constant z-other z-placeholder z-rust&quot;&gt;{y}&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;println!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;It has ranges: &lt;span class=&quot;z-constant z-other z-placeholder z-rust&quot;&gt;{:?}&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; ranges&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;This was done in a few seconds, too. There&apos;s a good chance that there would be a smarter and more efficient solution, but hey, not my day job. Another day another puzzle!&lt;/p&gt;&lt;h2 id=&quot;day-14&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-14&quot; aria-label=&quot;Anchor link for: day-14&quot;&gt;Day 14&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;It seems to me like picking the right data structures, just like in the real world, is a game changer when it comes to Advent of Code puzzles. Today, I was lucky enough to start out with a data structure that made solving the problem straightforward.&lt;/p&gt;&lt;p&gt;Usually, when the puzzle input is a sort of &lt;em&gt;grid&lt;/em&gt;, I think many of us tend to reach for arrays of arrays (vectors of vectors in Rust) to represent the grid as a bi-dimensional matrix. Point &lt;code&gt;(x, y)&lt;/code&gt; can be accessed as &lt;code&gt;grid[x][y]&lt;/code&gt;. However, I find that sometimes a &lt;strong&gt;map&lt;/strong&gt; (or dict, depending on the language) of &lt;code&gt;(x, y)&lt;/code&gt; to value is a good alternative. That&apos;s what I used for today&apos;s puzzle. The &lt;code&gt;HashMap&lt;/code&gt; came in handy especially for the second part, as we&apos;ll see later.&lt;/p&gt;&lt;p&gt;For part one, I started out with a &lt;code&gt;Point&lt;/code&gt; type alias and a function for initializing the &quot;world&quot; (that is, the grid map):&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-other z-rust&quot;&gt;use&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;std&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;collections&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;HashMap&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-type z-rust&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-type z-rust&quot;&gt;Point&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;usize&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;usize&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-type z-rust&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-type z-rust&quot;&gt;World&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;HashMap&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;Point, &lt;span class=&quot;z-storage z-type z-rust&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Then, it was time to parse the input. This was the deal: go through each input line, go through each &lt;code&gt;x1,y1 -&amp;gt; x2,y2&lt;/code&gt; pair, and &quot;draw&quot; lines between each pair. Drawing a line with the &lt;code&gt;World&lt;/code&gt; data structure meant adding a &lt;code&gt;(x, y) -&amp;gt; &apos;#&apos;&lt;/code&gt; entry for each point on the line.&lt;/p&gt;&lt;p&gt;The heart of the puzzle is &lt;em&gt;pouring sand&lt;/em&gt;. So, I wrote a &lt;code&gt;pour_sand&lt;/code&gt; function that does exactly that:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Returns the point where the sand comes to rest.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;pour_sand&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;world&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; World, &lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;sand_starting_point&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt; Point&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt; Point&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; sand_point &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; sand_starting_point&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;loop&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; down &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;sand_point&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; sand_point&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; down_left &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;sand_point&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; sand_point&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; down_right &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;sand_point&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; sand_point&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;match&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;            world&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;down&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;            world&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;down_left&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;            world&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;down_right&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; There is space right below, so we move the sand down and keep going.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;.&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;_&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                world&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;insert&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;sand_point&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;.&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                world&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;insert&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;down&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;+&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                sand_point &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; down&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Space below is taken by sand or rock, but down left is free.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;#&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;o&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;.&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;_&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                world&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;insert&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;sand_point&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;.&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                world&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;insert&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;down_left&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;+&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                sand_point &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; down_left&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Spaces below *and* down left are taken by sand or rock, but down right is free.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;#&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;o&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;#&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;o&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;.&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                world&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;insert&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;sand_point&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;.&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                world&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;insert&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;down_right&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;+&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                sand_point &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; down_right&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; All spaces are taken, so the sand comes to rest at the current point.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;#&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;o&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;#&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;o&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;#&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;o&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                world&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;insert&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;sand_point&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;o&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;return&lt;/span&gt; sand_point&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;panic!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;Unexpected state at {:?}&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; sand_point&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Finding the solution was a matter of &lt;code&gt;loop&lt;/code&gt;ing until we could not put sand to rest anymore.&lt;/p&gt;&lt;h3 id=&quot;day-14-part-two&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-14-part-two&quot; aria-label=&quot;Anchor link for: day-14-part-two&quot;&gt;Day 14: Part Two&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;The second part was fairly straightforward with a couple of small changes. The first one was changing the &lt;code&gt;World&lt;/code&gt; type a bit: now, I wanted a struct with the same map as before, but also the &lt;code&gt;y&lt;/code&gt; coordinate of the &quot;floor&quot;.&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-struct z-rust&quot;&gt;struct&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-entity z-name z-struct z-rust&quot;&gt;World&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-variable z-other z-member z-rust&quot;&gt;points&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-type z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;HashMap&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;Point, &lt;span class=&quot;z-storage z-type z-rust&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-variable z-other z-member z-rust&quot;&gt;floor_y&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-type z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;usize&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Then, the trick was to replace the &lt;code&gt;HashMap::get&lt;/code&gt; method in &lt;code&gt;pour_sand&lt;/code&gt; with a custom &lt;code&gt;at_point&lt;/code&gt; method in &lt;code&gt;impl World&lt;/code&gt;. The custom method accounts for the presence of the floor, and looks like this:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-impl z-rust&quot;&gt;impl&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-entity z-name z-impl z-rust&quot;&gt;World&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;at_point&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;self&lt;/span&gt;, &lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;point&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;Point&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Option&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;match&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;points&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;point&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;char&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;char&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Always rocks on the floor
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;None&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;if&lt;/span&gt; point&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-comparison z-rust&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;floor_y &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;#&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Empty space everywhere above the floor
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;None&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;if&lt;/span&gt; point&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-comparison z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;floor_y &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;.&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;None&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;None&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Now, the solution was about &lt;code&gt;loop&lt;/code&gt;ing until a sand&apos;s resting point was &lt;code&gt;(500, 0)&lt;/code&gt; (the starting point).&lt;/p&gt;&lt;p&gt;I loved today&apos;s puzzle: simple enough to be done in a reasonable amount of time, but still fun to work through.&lt;/p&gt;&lt;h2 id=&quot;day-13&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-13&quot; aria-label=&quot;Anchor link for: day-13&quot;&gt;Day 13&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Today&apos;s problem could be solved with different data structures. The important property was the ability to arbitrarily nest lists of integers. I used a well-known data structure for us functional programmers: linked lists. Thanks to &lt;a href=&quot;https://andrealeopardi.com/posts/advent-of-code-2022/#day-7&quot;&gt;day 7&lt;/a&gt;, I now know a bit more about Rust&apos;s smart pointers, so I was able to use &lt;code&gt;Box&lt;/code&gt;es here. I started with the main data structure. A linked list is made of a &lt;strong&gt;cons cell&lt;/strong&gt; that holds a value, plus a link to the next cons cell. In this case, since we can have nested lists, a cons cell can be:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;an integer (I went with &lt;code&gt;u16&lt;/code&gt;)&lt;/li&gt;&lt;li&gt;a linked list (think of the first nested list in &lt;code&gt;[[1], 2, 3]&lt;/code&gt;)&lt;/li&gt;&lt;li&gt;the &lt;em&gt;empty&lt;/em&gt; cell, which signals the end of the linked list&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;There are several ways to model this. You can use &lt;code&gt;Option&lt;/code&gt; to model the empty cell as &lt;code&gt;None&lt;/code&gt;, for example. I went with an approach I liked.&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; The value contained in a cons cell.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-annotation z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-annotation z-rust&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-variable z-annotation z-rust&quot;&gt;derive&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;Debug&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; PartialEq&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; Eq&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; Clone&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-enum z-rust&quot;&gt;enum&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-enum z-rust&quot;&gt;Value&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    Int&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u16&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    List&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Box&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;LinkedList&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; This is essentially a cons cell itself.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-annotation z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-annotation z-rust&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-variable z-annotation z-rust&quot;&gt;derive&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;Debug&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; PartialEq&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; Eq&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; Clone&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-enum z-rust&quot;&gt;enum&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-enum z-rust&quot;&gt;LinkedList&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    Empty&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    Cons&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;Value&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Box&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;LinkedList&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;After this, the problem was really about two things:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;Parsing a line of input into a linked list.&lt;/li&gt;&lt;li&gt;Making linked lists &lt;strong&gt;orderable&lt;/strong&gt; in order to compare them.&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;To parse lines into &lt;code&gt;LinkedList&lt;/code&gt; structs, I went with a simple function in the &lt;code&gt;LinkedList&lt;/code&gt; implementation:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-impl z-rust&quot;&gt;impl&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-entity z-name z-impl z-rust&quot;&gt;LinkedList&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;pub&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;from_string&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;str&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt; LinkedList&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; chars &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; string&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;chars&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;skip&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;from_chars&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; chars&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;from_chars&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;chars&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; impl &lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Iterator&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;Item = &lt;span class=&quot;z-storage z-type z-rust&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt; LinkedList&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;loop&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;match&lt;/span&gt; chars&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;[&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;LinkedList&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Cons&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Value&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;List&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Box&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;new&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;from_chars&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;chars&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Box&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;new&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;from_chars&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;chars&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;]&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;if&lt;/span&gt; char_digits&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;is_empty&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;LinkedList&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Empty&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; int &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; char_digits&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;parse&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u16&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;LinkedList&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Cons&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Value&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Int&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;int&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Box&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;new&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;LinkedList&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Empty&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;,&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-logical z-rust&quot;&gt;!&lt;/span&gt;char_digits&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;is_empty&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; int &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; char_digits&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;parse&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u16&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;LinkedList&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Cons&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Value&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Int&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;int&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Box&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;new&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;from_chars&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;chars&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;continue&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                    char_digits&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;char&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Then, I took the chance to learn a bit more about Rust&apos;s trait, and in particular &lt;a href=&quot;https://doc.rust-lang.org/1.65.0/std/cmp/trait.Ord.html&quot;&gt;&lt;code&gt;std::cmp::Ord&lt;/code&gt;&lt;/a&gt;. Pretty straightforward stuff: you implement a &lt;code&gt;cmp&lt;/code&gt; function that returns a &lt;code&gt;Ordering&lt;/code&gt; enum (equal, less than, greater than).&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-impl z-rust&quot;&gt;impl&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;Ord &lt;span class=&quot;z-keyword z-other z-rust&quot;&gt;for&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-entity z-name z-impl z-rust&quot;&gt;LinkedList&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;cmp&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;self&lt;/span&gt;, &lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;other&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt; Ordering&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-comment z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;/*&lt;/span&gt; ... &lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;*/&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; This required me to implement PartialOrd as well, which I did
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; by just proxying to Ord. That&amp;#39;s exactly what the docs for Ord
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; show, after all.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-impl z-rust&quot;&gt;impl&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;PartialOrd &lt;span class=&quot;z-keyword z-other z-rust&quot;&gt;for&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-entity z-name z-impl z-rust&quot;&gt;LinkedList&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;partial_cmp&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;self&lt;/span&gt;, &lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;other&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Option&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;Ordering&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;cmp&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;other&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The implementation of &lt;code&gt;cmp&lt;/code&gt; is tedious to look at, so I&apos;m including it in the collapsed code block below. It essentially implements the rules described by the puzzle description.&lt;/p&gt;&lt;details&gt;&lt;summary&gt;&lt;code&gt;fn cmp(&amp;amp;self, other: &amp;amp;Self) -&amp;gt; Ordering&lt;/code&gt;&lt;/summary&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;cmp&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;self&lt;/span&gt;, &lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;other&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;Self&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt; Ordering&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;match&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; other&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;LinkedList&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Empty&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;LinkedList&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Empty&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Ordering&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Equal&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; If the left list runs out of items first, the inputs are in the right order.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;LinkedList&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Empty&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;_&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Ordering&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Less&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; If the right list runs out of items first, the inputs are in the wrong order.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;LinkedList&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Empty&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Ordering&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Greater&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;LinkedList&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Cons&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;value&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; tail&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;LinkedList&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Cons&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;other_value&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; other_tail&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; If both values are integers, the lower integer should come first.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;match&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;value&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; other_value&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Value&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Int&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;int&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Value&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Int&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;other_int&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;match&lt;/span&gt; int&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;cmp&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;other_int&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Ordering&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Equal &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt; tail&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;cmp&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;other_tail&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                    ordering &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt; ordering&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; If exactly one value is an integer, convert the integer to a list which
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; contains that integer as its only value, then retry the comparison.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Value&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Int&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;int&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Value&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;List&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;list&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; wrapped_int &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;LinkedList&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Cons&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Value&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Int&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;*&lt;/span&gt;int&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Box&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;new&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;LinkedList&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Empty&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;match&lt;/span&gt; wrapped_int&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;cmp&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;list&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Ordering&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Equal &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt; tail&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;cmp&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;other_tail&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                        ordering &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt; ordering&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; If exactly one value is an integer, convert the integer to a list which
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; contains that integer as its only value, then retry the comparison.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Value&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;List&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;list&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Value&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Int&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;int&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; wrapped_int &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;LinkedList&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Cons&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Value&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Int&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;*&lt;/span&gt;int&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Box&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;new&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;LinkedList&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Empty&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;match&lt;/span&gt; list&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;cmp&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Box&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;new&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;wrapped_int&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Ordering&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Equal &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt; tail&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;cmp&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;other_tail&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                        ordering &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt; ordering&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Value&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;List&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;list&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Value&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;List&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;other_list&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;match&lt;/span&gt; list&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;cmp&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;other_list&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Ordering&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Equal &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt; tail&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;cmp&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;other_tail&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                    ordering &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt; ordering&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/details&gt;&lt;p&gt;Now it was just a matter of counting the pairs where &lt;code&gt;left &amp;lt; right&lt;/code&gt;, which we can do thanks to &lt;code&gt;PartialOrd&lt;/code&gt;.&lt;/p&gt;&lt;h3 id=&quot;day-13-part-two&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-13-part-two&quot; aria-label=&quot;Anchor link for: day-13-part-two&quot;&gt;Day 13: Part Two&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Today&apos;s second part was quite easy to build on top of part one. This is especially true in Rust, where &lt;code&gt;PartialOrd&lt;/code&gt; allowed me to build a &lt;code&gt;Vec&amp;lt;LinkedList&amp;gt;&lt;/code&gt; and then just call &lt;code&gt;sort&lt;/code&gt; on it. All the new code I needed to solve part two is what&apos;s below.&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; packets &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; input
&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;lines&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;filter&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-logical z-rust&quot;&gt;!&lt;/span&gt;line&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;trim&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;is_empty&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;LinkedList&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;from_string&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;collect&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;LinkedList&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Push the divider packets.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; divider_packet1 &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;LinkedList&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;from_string&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;[[2]]&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; divider_packet2 &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;LinkedList&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;from_string&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;[[6]]&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;packets&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;divider_packet1&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;clone&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;packets&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;divider_packet2&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;clone&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Comes for free with PartialOrd.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;packets&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;sort&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; position1 &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; packets&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;iter&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;packet&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;packet &lt;span class=&quot;z-keyword z-operator z-comparison z-rust&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;divider_packet1&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; position2 &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; packets&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;iter&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;position&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;packet&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;packet &lt;span class=&quot;z-keyword z-operator z-comparison z-rust&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;divider_packet2&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;println!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;Position of packet 1 is &lt;span class=&quot;z-constant z-other z-placeholder z-rust&quot;&gt;{position1}&lt;/span&gt;, packet 2 is &lt;span class=&quot;z-constant z-other z-placeholder z-rust&quot;&gt;{position2}&lt;/span&gt;, key is &lt;span class=&quot;z-constant z-other z-placeholder z-rust&quot;&gt;{}&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;    position1 &lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;*&lt;/span&gt; position2
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&quot;day-12&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-12&quot; aria-label=&quot;Anchor link for: day-12&quot;&gt;Day 12&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;No time for screencasting today, so I&apos;m gonna type it out real quick.&lt;/p&gt;&lt;p&gt;Today&apos;s puzzle was about applying &lt;a href=&quot;https://en.wikipedia.org/wiki/Dijkstra%27s_algorithm&quot;&gt;&lt;strong&gt;Dijkstra&apos;s shortest-path algorithm&lt;/strong&gt;&lt;/a&gt;. The algorithm is somewhat straightforward, and the thing that took me some time was figuring out little things here and there to do with distance between vertices and so on.&lt;/p&gt;&lt;p&gt;It took me a while to get to this implementation, and I won&apos;t really go through the steps today. I&apos;ll just explain what I got to. First off, a couple of data structures, one for nodes in the graph and one fo the graph itself:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-annotation z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-annotation z-rust&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-variable z-annotation z-rust&quot;&gt;derive&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;PartialEq&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; Eq&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; Debug&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; Hash&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; Clone&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; Copy&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; PartialOrd&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; Ord&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-struct z-rust&quot;&gt;struct&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-entity z-name z-struct z-rust&quot;&gt;Node&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;i32&lt;/span&gt;, &lt;span class=&quot;z-storage z-type z-rust&quot;&gt;i32&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-annotation z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-annotation z-rust&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-variable z-annotation z-rust&quot;&gt;derive&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;Debug&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; Clone&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-struct z-rust&quot;&gt;struct&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-entity z-name z-struct z-rust&quot;&gt;Graph&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-variable z-other z-member z-rust&quot;&gt;nodes&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-type z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;HashMap&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;Node, &lt;span class=&quot;z-storage z-type z-rust&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Then, a few methods on &lt;code&gt;Graph&lt;/code&gt;. They&apos;re all standard graph methods, and I could&apos;ve probably used any graph library for Rust, but I wanted to try this out myself. The body of the methods below is not included here, but you can find it out &lt;a href=&quot;https://github.com/whatyouhide/advent_of_code_2022/blob/main/src/day12.rs&quot;&gt;on GitHub&lt;/a&gt;.&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-impl z-rust&quot;&gt;impl&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-entity z-name z-impl z-rust&quot;&gt;Graph&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Parses a graph from the input string.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;pub&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;from&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;input&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;str&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt; Graph
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Gets the distance between node1 and node2. It&amp;#39;s 1 if the nodes
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; point to a different character, otherwise it&amp;#39;s 0.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;distance_between_nodes&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;self&lt;/span&gt;, &lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;node1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt; Node, &lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;node2&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt; Node&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u16&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Find a node in the graph. I only used this for finding the
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; start node &amp;#39;S&amp;#39; and target node &amp;#39;E&amp;#39;.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;find_node&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;self&lt;/span&gt;, &lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;target&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;char&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Option&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;Node&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Returns all the neighbors of the given node.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;neighbors&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;self&lt;/span&gt;, &lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt; Node&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;Node&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Then, just a couple more helper functions:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;chars_are_connectable&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;char1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;char&lt;/span&gt;, &lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;char2&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;char&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;bool&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;*&lt;/span&gt;char2 &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;as&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;i32&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-comparison z-rust&quot;&gt;&amp;lt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;*&lt;/span&gt;char1 &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;as&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;i32&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;find_node_with_min_distance&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;distances&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;DistanceMap, &lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;set&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;HashSet&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;Node&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt; Node&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    set&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;iter&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;min_by_key&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;distances&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;*&lt;/span&gt;node&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;clone&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;After that, I really just went through the &lt;a href=&quot;https://en.wikipedia.org/wiki/Dijkstra%27s_algorithm#Pseudocode&quot;&gt;Wikipedia pseudocode&lt;/a&gt; and turned it into Rust.&lt;/p&gt;&lt;details&gt;&lt;summary&gt;&lt;code&gt;fn dijkstra(graph: &amp;amp;mut Graph, start_node: Node, end_node: Node) -&amp;gt; Option&amp;lt;u32&amp;gt;&lt;/code&gt;&lt;/summary&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;dijkstra&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;graph&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; Graph, &lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;start_node&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt; Node, &lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;end_node&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt; Node&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Option&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u32&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; unvisited_set&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;HashSet&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;Node&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;HashSet&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;new&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; distances&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt; DistanceMap &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;HashMap&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;new&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; prev&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;HashMap&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;Node, &lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Option&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;Node&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;HashMap&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;new&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;for&lt;/span&gt; node &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;in&lt;/span&gt; graph&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;nodes&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;keys&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;        unvisited_set&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;insert&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;node&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;clone&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;        distances&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;insert&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;node&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;clone&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; Infinity&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;        prev&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;insert&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;node&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;clone&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;None&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    distances&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;insert&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;start_node&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; Finite&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;while&lt;/span&gt; unvisited_set&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-comparison z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Pick the position with minimum distance that is in the unvisited set.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; u &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;find_node_with_min_distance&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;distances&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;unvisited_set&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;if&lt;/span&gt; u &lt;span class=&quot;z-keyword z-operator z-comparison z-rust&quot;&gt;==&lt;/span&gt; end_node &lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;        unvisited_set&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;remove&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;u&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;for&lt;/span&gt; v &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;in&lt;/span&gt; graph
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;neighbors&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;u&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;iter&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;filter&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;unvisited_set&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;contains&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;*&lt;/span&gt;node&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; alt &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;match&lt;/span&gt; distances&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;u&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                Infinity &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;continue&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                NegativeInfinity &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;continue&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                Finite&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;alt&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt; alt&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;+&lt;/span&gt; graph&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;distance_between_nodes&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;u&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; v&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;clone&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;as&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;i32&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;if&lt;/span&gt; Finite&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;alt&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-comparison z-rust&quot;&gt;&amp;lt;&lt;/span&gt; distances&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;v&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                distances&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;insert&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;v&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;clone&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; Finite&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;alt&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                prev&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;insert&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;v&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;clone&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;u&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; s &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;vec!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; u &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;end_node&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;_&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; prev&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;u&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;while&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;u1&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; u &lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;            s&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;insert&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; u1&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;            u &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; prev&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;u1&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;None&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;s&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;as&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u32&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/details&gt;&lt;p&gt;The function is more parametrized than needed for part one, but it turned out to be useful for part two (hindsight!). With this code in place, it&apos;s a matter of running the &lt;code&gt;dijkstra&lt;/code&gt; function.&lt;/p&gt;&lt;h3 id=&quot;day-12-part-two&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-12-part-two&quot; aria-label=&quot;Anchor link for: day-12-part-two&quot;&gt;Day 12: Part Two&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;For the second part, it&apos;s about &quot;brute forcing&quot;, really. We want to calculate the &lt;code&gt;dijkstra&lt;/code&gt; function above for all starting point &lt;code&gt;a&lt;/code&gt;s. It was a bit slow to run, but it could&apos;ve been parallelized easily. Oh well. Not enough time today!&lt;/p&gt;&lt;h2 id=&quot;day-11&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-11&quot; aria-label=&quot;Anchor link for: day-11&quot;&gt;Day 11&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Part one went smoothly. Part two took quite a lot, and I ended up needing some help from &lt;a href=&quot;https://reddit.com/r/adventofcode&quot;&gt;r/adventofcode&lt;/a&gt;. Bums me out a bit, but hey, never stop learning and being humbled!&lt;/p&gt;&lt;div class=&quot;embedded-youtube-player&quot;&gt;&lt;iframe src=&quot;https://www.youtube-nocookie.com/embed/dTfYoeLri1M&quot; webkitallowfullscreen mozallowfullscreen allowfullscreen&gt;&lt;/iframe&gt;&lt;/div&gt;&lt;h2 id=&quot;day-10&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-10&quot; aria-label=&quot;Anchor link for: day-10&quot;&gt;Day 10&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;You know the drill: it&apos;s a screencast.&lt;/p&gt;&lt;div class=&quot;embedded-youtube-player&quot;&gt;&lt;iframe src=&quot;https://www.youtube-nocookie.com/embed/lDBKLYZMe9o&quot; webkitallowfullscreen mozallowfullscreen allowfullscreen&gt;&lt;/iframe&gt;&lt;/div&gt;&lt;h2 id=&quot;day-9&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-9&quot; aria-label=&quot;Anchor link for: day-9&quot;&gt;Day 9&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;I didn&apos;t have time for a screencast today, so we&apos;ll walk through the solution here.&lt;/p&gt;&lt;p&gt;I started out with a few data structures. The first thing was trying out &lt;code&gt;type&lt;/code&gt; aliases in Rust:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Grid looks like this:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; (2, 0) (2, 1) (2, 2) (2, 3)
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; (1, 0) (1, 1) (1, 2) (1, 3)
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; (0, 0) (0, 1) (0, 2) (0, 3)
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-type z-rust&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-type z-rust&quot;&gt;Position&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;i32&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;i32&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;A position can be negative, too, that&apos;s why the indexes are &lt;code&gt;i32&lt;/code&gt;s. Next, we have &quot;moves&quot;:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-annotation z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-annotation z-rust&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-variable z-annotation z-rust&quot;&gt;derive&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;PartialEq&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; Debug&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-enum z-rust&quot;&gt;enum&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-enum z-rust&quot;&gt;Direction&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    Up&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    Down&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    Left&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    Right&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-struct z-rust&quot;&gt;struct&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-entity z-name z-struct z-rust&quot;&gt;Move&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-variable z-other z-member z-rust&quot;&gt;direction&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-type z-rust&quot;&gt;:&lt;/span&gt; Direction,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-variable z-other z-member z-rust&quot;&gt;distance&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-type z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;usize&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-impl z-rust&quot;&gt;impl&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-entity z-name z-impl z-rust&quot;&gt;Move&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;pub&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;from_line&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;str&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt; Move&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;direction&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; distance&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; line&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;split_at&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; distance &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; distance&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;trim&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;parse&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;usize&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; direction &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;match&lt;/span&gt; direction &lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;U&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Direction&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Up&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;D&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Direction&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Down&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;L&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Direction&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Left&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;R&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Direction&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Right&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;panic!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;Unknown direction: {}&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; direction&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;        Move &lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;            direction&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;            distance&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Pretty straightforward to model this with types.&lt;/p&gt;&lt;p&gt;Alright, the central data structure of this puzzle is a &lt;strong&gt;rope&lt;/strong&gt;. For the first part of the puzzle, I started with a simple struct with &lt;code&gt;head&lt;/code&gt; and &lt;code&gt;tail&lt;/code&gt; fields.&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-annotation z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-annotation z-rust&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-variable z-annotation z-rust&quot;&gt;derive&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;Debug&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-struct z-rust&quot;&gt;struct&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-entity z-name z-struct z-rust&quot;&gt;Rope&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-variable z-other z-member z-rust&quot;&gt;head&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-type z-rust&quot;&gt;:&lt;/span&gt; Position,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-variable z-other z-member z-rust&quot;&gt;tail&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-type z-rust&quot;&gt;:&lt;/span&gt; Position,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;To count the visited positions, instead, I opted for a &lt;code&gt;HashSet&lt;/code&gt;. The initialization looks like this:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; input &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;include_str!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;../inputs/day9.txt&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; visited_positions&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;HashSet&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;Position&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;HashSet&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;new&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; rope &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; Rope &lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt; head&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; tail&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Then, the gist of the problem is going through all moves in the input, update the rope, and then print out the number of elements in &lt;code&gt;visited_positions&lt;/code&gt; at the end.&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;for&lt;/span&gt; move_ &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;in&lt;/span&gt; input&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;lines&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Move&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;from_line&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-rust&quot;&gt;..&lt;/span&gt;move_&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;distance &lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;        rope&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;move_head&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;move_&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;        rope&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;update_tail&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; visited_positions&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;println!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;Visited &lt;span class=&quot;z-constant z-other z-placeholder z-rust&quot;&gt;{}&lt;/span&gt; positions&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; visited_positions&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;I won&apos;t bother you with the details of &lt;code&gt;.move_head()&lt;/code&gt; and &lt;code&gt;.update_tail()&lt;/code&gt; here, but it&apos;s a bunch of index math (that you can find &lt;a href=&quot;https://github.com/whatyouhide/advent_of_code_2022/commit/73b51c0a439ca092291a37a60b2337c163cd1b6e&quot;&gt;in GitHub&lt;/a&gt;).&lt;/p&gt;&lt;h3 id=&quot;day-9-part-two&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-9-part-two&quot; aria-label=&quot;Anchor link for: day-9-part-two&quot;&gt;Day 9: Part Two&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;The second part was really about generalizing the rope to have a bigger number of knots. Instead of having just &lt;code&gt;head&lt;/code&gt; and &lt;code&gt;tail&lt;/code&gt;, I went for a fixed-length slice:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-annotation z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-annotation z-rust&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-variable z-annotation z-rust&quot;&gt;derive&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;Debug&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-struct z-rust&quot;&gt;struct&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-entity z-name z-struct z-rust&quot;&gt;Rope&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-variable z-other z-member z-rust&quot;&gt;knots&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-type z-rust&quot;&gt;:&lt;/span&gt; [Position; 10],
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Then, it was a matter of renaming &lt;code&gt;update_tail&lt;/code&gt; to &lt;code&gt;update_other_knots&lt;/code&gt;. The math is the same, but generalized to go through all knots and make each one &quot;follow&quot; the next, with the exact same logic as before.&lt;/p&gt;&lt;p&gt;One note I had fun with: I got stuck initially with some small bugs here and there, and the best thing I did was writing some code to &lt;em&gt;print&lt;/em&gt; the grid. Visually debugging the puzzle against the example one on the website helped a lot. To do that, I implemented the &lt;code&gt;std::fmt::Display&lt;/code&gt; trait for my &lt;code&gt;Rope&lt;/code&gt; struct.&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-impl z-rust&quot;&gt;impl&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;fmt&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Display &lt;span class=&quot;z-keyword z-other z-rust&quot;&gt;for&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-entity z-name z-impl z-rust&quot;&gt;Rope&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;fmt&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;self&lt;/span&gt;, &lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;fmt&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;Formatter&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&amp;#39;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;fmt&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Result&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;for&lt;/span&gt; row &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-rust&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;20&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;rev&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;for&lt;/span&gt; column &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-rust&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; found &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-rust&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;for&lt;/span&gt; index &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-rust&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;knots&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;knots&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;index&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-comparison z-rust&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;row&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; column&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;write!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;f,&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-placeholder z-rust&quot;&gt;{}&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; index&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                        found &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-rust&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-logical z-rust&quot;&gt;!&lt;/span&gt;found &lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;write!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;f,&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;.&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;?&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;write!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;f,&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;z-constant z-character z-escape z-rust&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Ok&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&quot;day-8&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-8&quot; aria-label=&quot;Anchor link for: day-8&quot;&gt;Day 8&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Today&apos;s puzzle was pretty fun, and not that hard. I opted for a screencast again.&lt;/p&gt;&lt;div class=&quot;embedded-youtube-player&quot;&gt;&lt;iframe src=&quot;https://www.youtube-nocookie.com/embed/0yI_vlx5evM&quot; webkitallowfullscreen mozallowfullscreen allowfullscreen&gt;&lt;/iframe&gt;&lt;/div&gt;&lt;h2 id=&quot;day-7&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-7&quot; aria-label=&quot;Anchor link for: day-7&quot;&gt;Day 7&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Holy. Shit. I do not know Rust. I started recording a screencast for today&apos;s puzzle, but I stopped in anger one hour and twenty minutes in. It took me around four hours to get this right. As it turns out, recursive data structures are easy in functional programming languages like Elixir, but a whole other level of nightmares in something like Rust. That&apos;s due to the ownership and all that jazz. I struggled a lot with the &lt;strong&gt;tree&lt;/strong&gt; data structure that is kind of needed to solve the puzzle: how to reference parent and children nodes was just not working for me.&lt;/p&gt;&lt;p&gt;In the end, I had to do just a bit of searching the web, and I stumbled across &lt;a href=&quot;https://applied-math-coding.medium.com/a-tree-structure-implemented-in-rust-8344783abd75&quot;&gt;this post&lt;/a&gt; on how to implement these recursive data structures in Rust. I thought of using &lt;code&gt;Box&lt;/code&gt; initially, without having any idea what that really is, but I would have never arrived to the conclusion that the solution was &lt;code&gt;Rc&lt;/code&gt; and &lt;code&gt;RefCell&lt;/code&gt;.&lt;/p&gt;&lt;p&gt;In any case, let&apos;s go through my solution, without the four hours of &lt;del&gt;head smashing&lt;/del&gt; thought process. Let&apos;s start out with some data structures: the file system is a &lt;em&gt;tree&lt;/em&gt;. Each node can be a &lt;em&gt;directory&lt;/em&gt; or a &lt;em&gt;file&lt;/em&gt;. Directories can have children, which are other tree nodes. Directories and files also have a parent node, but I only bothered with adding it to directories (and not to files) for simplicity.&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-annotation z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-annotation z-rust&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-variable z-annotation z-rust&quot;&gt;derive&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;Debug&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;pub&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-struct z-rust&quot;&gt;struct&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-entity z-name z-struct z-rust&quot;&gt;File&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-variable z-other z-member z-rust&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-type z-rust&quot;&gt;:&lt;/span&gt; String,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-variable z-other z-member z-rust&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-type z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u64&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-annotation z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-annotation z-rust&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-variable z-annotation z-rust&quot;&gt;derive&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;Debug&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;pub&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-struct z-rust&quot;&gt;struct&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-entity z-name z-struct z-rust&quot;&gt;Dir&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-variable z-other z-member z-rust&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-type z-rust&quot;&gt;:&lt;/span&gt; String,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-annotation z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-annotation z-rust&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-variable z-annotation z-rust&quot;&gt;derive&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;Debug&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-enum z-rust&quot;&gt;enum&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-enum z-rust&quot;&gt;NodeValue&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    File&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;File&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    Dir&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;Dir&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-struct z-rust&quot;&gt;struct&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-entity z-name z-struct z-rust&quot;&gt;Node&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-variable z-other z-member z-rust&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-type z-rust&quot;&gt;:&lt;/span&gt; NodeValue,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-variable z-other z-member z-rust&quot;&gt;children&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-type z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;HashMap&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;Rc&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;RefCell&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;Node&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-variable z-other z-member z-rust&quot;&gt;parent&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-type z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Option&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;Rc&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;RefCell&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;Node&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;One interesting thing was that I had to implement the &lt;code&gt;Debug&lt;/code&gt; trait for &lt;code&gt;Node&lt;/code&gt;, because otherwise it would recursively try to print a node&apos;s parent, which prints another node that has children, that have parents, and so on.&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-impl z-rust&quot;&gt;impl&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;fmt&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Debug &lt;span class=&quot;z-keyword z-other z-rust&quot;&gt;for&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-entity z-name z-impl z-rust&quot;&gt;Node&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;fmt&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;self&lt;/span&gt;, &lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;fmt&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;Formatter&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&amp;#39;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;fmt&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Result&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;        f&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;debug_struct&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;Node&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;field&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;value&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;value&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;field&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;children&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;children&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;finish&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Then, just a couple of methods on the &lt;code&gt;Node&lt;/code&gt; struct to construct it, append nodes, and calculate the size:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-impl z-rust&quot;&gt;impl&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-entity z-name z-impl z-rust&quot;&gt;Node&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;pub&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;new&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;dir&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt; Dir&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt; Node&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;        Node &lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;            value&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;NodeValue&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Dir&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;dir&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;            children&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;HashMap&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;new&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;            parent&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;None&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;append_node&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-lifetime z-rust&quot;&gt;&amp;#39;a&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;self&lt;/span&gt;, &lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt; String, &lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;Rc&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;RefCell&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;Node&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;children&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;insert&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;name&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;clone&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; node&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;size&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;self&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u64&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;match&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;value &lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;NodeValue&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;File&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;file&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt; file&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;size&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;NodeValue&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Dir&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;_&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; size &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;for&lt;/span&gt; child &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-rust&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;children&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;values&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                    size &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;+=&lt;/span&gt; child&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;borrow&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                size
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-impl z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;After this, I went with a couple of enums to give structure to the lines in the input:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; A command is either &amp;quot;cd &amp;lt;&amp;gt;&amp;quot; or &amp;quot;ls&amp;quot;.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-enum z-rust&quot;&gt;enum&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-enum z-rust&quot;&gt;Command&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    Cd&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;String&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    Ls&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-enum z-rust&quot;&gt;enum&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-enum z-rust&quot;&gt;Line&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    Command&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;Command&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    FileWithSize&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u64&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    Dir&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;String&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;I also wrote a small function to parse each line into one a &lt;code&gt;Line&lt;/code&gt;:&lt;/p&gt;&lt;details&gt;&lt;summary&gt;&lt;code&gt;fn parse_line(line: &amp;amp;str) -&amp;gt; Line&lt;/code&gt;&lt;/summary&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;parse_line&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;str&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt; Line&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;if&lt;/span&gt; line&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;starts_with&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;$&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; command &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; line&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-rust&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;trim&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;if&lt;/span&gt; command&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;starts_with&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;cd&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; dir &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; command&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-rust&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;trim&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Line&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Command&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Command&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Cd&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;dir&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;to_string&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;if&lt;/span&gt; command &lt;span class=&quot;z-keyword z-operator z-comparison z-rust&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;ls&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Line&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Command&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Command&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Ls&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;panic!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;Unknown command: {}&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; command&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;if&lt;/span&gt; line&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;starts_with&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;dir&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; dir_name &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; line&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-rust&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;trim&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Line&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Dir&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;dir_name&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;to_string&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; parts &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; line&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;split_whitespace&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; size&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u64&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; parts&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;to_string&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;parse&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u64&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; name &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; parts&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;to_string&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Line&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;FileWithSize&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;name&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; size&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/details&gt;&lt;p&gt;Alright. Now for the heart of this puzzle: a function that walks through all the lines in the input, and builds out the tree data structure.&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; input &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;include_str!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;../inputs/day7.txt&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; root &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Rc&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;new&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;RefCell&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;new&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Node&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;new&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;Dir &lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    name&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;/&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;to_string&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; current_dir &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Rc&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;clone&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;root&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; lines &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; input&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;lines&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;skip&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;parse_line&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;for&lt;/span&gt; line &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;in&lt;/span&gt; lines &lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;match&lt;/span&gt; line &lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; For a file, we create a new file struct and add it to the current directory&amp;#39;s
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; children.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Line&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;FileWithSize&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;filename&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; size&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; child_node &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Rc&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;new&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;RefCell&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;new&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;Node &lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                value&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;NodeValue&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;File&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;File &lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                    name&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt; filename&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;to_string&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                    size&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                children&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;HashMap&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;new&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                parent&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;None&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;            current_dir
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;borrow_mut&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;append_node&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;filename&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Rc&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;clone&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;child_node&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;            child_node&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;borrow_mut&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;parent &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Rc&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;clone&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;current_dir&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; For a directory, we create a new directory struct, set its parent
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; the current directory, and add it to the current directory&amp;#39;s
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; children.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Line&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Dir&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;dir_name&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; child_node &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Rc&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;new&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;RefCell&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;new&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Node&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;new&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;Dir &lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                name&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt; dir_name&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;to_string&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;            current_dir
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;borrow_mut&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;append_node&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;dir_name&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Rc&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;clone&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;child_node&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; mut_child &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; child_node&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;borrow_mut&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;            mut_child&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;parent &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Some&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Rc&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;clone&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;current_dir&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; &amp;quot;ls&amp;quot; is kind of not very useful, so we just ignore it.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Line&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Command&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Command&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Ls&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;continue&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; For &amp;quot;cd&amp;quot;, we find the directory in the current directory&amp;#39;s children
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; and make it the current directory. If the directory is &amp;quot;/&amp;quot;, we go
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; back to the root. If the directory is &amp;quot;..&amp;quot;, we go to the parent
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; of the current directory.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Line&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Command&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Command&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Cd&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;dir_name&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;match&lt;/span&gt; dir_name&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;as_str&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;/&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                current_dir &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Rc&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;clone&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;root&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;..&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; current_dir_clone &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Rc&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;clone&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;current_dir&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                current_dir &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Rc&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;clone&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;current_dir_clone&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;borrow&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;parent&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;as_ref&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; child_clone &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Rc&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;clone&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;current_dir&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;borrow&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;children&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;dir_name&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                current_dir &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; child_clone&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;A lot of &lt;code&gt;.borrow()&lt;/code&gt;, &lt;code&gt;.borrow_mut()&lt;/code&gt;, &lt;code&gt;Rc::clone()&lt;/code&gt;, and what have you. I&apos;m sure this is not peak Rust, but I&apos;m pretty proud that this worked!&lt;/p&gt;&lt;p&gt;To solve part one of the puzzle, I then ended up writing a small function to calculate the size of all directories whose total size is at most &lt;code&gt;100_000&lt;/code&gt;.&lt;/p&gt;&lt;details&gt;&lt;summary&gt;&lt;code&gt;fn calc_size(node: &amp;amp;Node) -&amp;gt; u64&lt;/code&gt;&lt;/summary&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;calc_size&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;Node&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u64&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; total &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; size &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; node&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;if&lt;/span&gt; size &lt;span class=&quot;z-keyword z-operator z-comparison z-rust&quot;&gt;&amp;lt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;100000&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;        total &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;+=&lt;/span&gt; size&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;for&lt;/span&gt; child &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;in&lt;/span&gt; node&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;children&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;values&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;match&lt;/span&gt; child&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;borrow&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;value &lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;NodeValue&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;File&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;_&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;continue&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;NodeValue&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Dir&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;_&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;                total &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;+=&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;calc_size&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;child&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;borrow&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;return&lt;/span&gt; total&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/details&gt;&lt;h3 id=&quot;day-7-part-two&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-7-part-two&quot; aria-label=&quot;Anchor link for: day-7-part-two&quot;&gt;Day 7: Part Two&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;The second part had virtually no complexity once I had the first part down. I just:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;Walked the tree again.&lt;/li&gt;&lt;li&gt;Calculated the size of each node.&lt;/li&gt;&lt;li&gt;If the size of a node was enough to &quot;free up enough space&quot;, I stored it as the minimum size.&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;I got this one right on the first try, and it took about 2% of the time it took to do the first part! Crossing my fingers that tomorrow&apos;s puzzle will have more mercy on me.&lt;/p&gt;&lt;h2 id=&quot;day-6&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-6&quot; aria-label=&quot;Anchor link for: day-6&quot;&gt;Day 6&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;A screencast you said? Let&apos;s try that! I&apos;m tired of typing!&lt;/p&gt;&lt;div class=&quot;embedded-youtube-player&quot;&gt;&lt;iframe src=&quot;https://www.youtube-nocookie.com/embed/FaEorUDhZq4&quot; webkitallowfullscreen mozallowfullscreen allowfullscreen&gt;&lt;/iframe&gt;&lt;/div&gt;&lt;h2 id=&quot;day-5&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-5&quot; aria-label=&quot;Anchor link for: day-5&quot;&gt;Day 5&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Ah, this starts to be more convoluted. The most annoying thing with this puzzle was to parse out the &quot;stacks&quot;, since each stack is on a variable number of input lines.&lt;/p&gt;&lt;p&gt;For this puzzle, I took a bottom-up approach. I started out with creating a new type for a &quot;move&quot;, and a function to parse a &lt;code&gt;move N from X to Y&lt;/code&gt; line into said struct.&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Deriving PartialEq because I want to be able to check if move1 == move2.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-annotation z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-annotation z-rust&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-variable z-annotation z-rust&quot;&gt;derive&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;Debug&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; PartialEq&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-struct z-rust&quot;&gt;struct&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-entity z-name z-struct z-rust&quot;&gt;Move&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-variable z-other z-member z-rust&quot;&gt;start_stack&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-type z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u16&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-variable z-other z-member z-rust&quot;&gt;end_stack&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-type z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u16&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-variable z-other z-member z-rust&quot;&gt;crates_to_move&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-type z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u16&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;parse_move&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;str&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt; Move&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; words&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;str&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; string&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;split_ascii_whitespace&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;collect&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Hard-code a bunch of indexes since the words are always the same.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; I miss Elixir pattern matching!
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; crates_to_move &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; words&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;parse&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u16&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; start_stack &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; words&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;parse&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u16&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; end_stack &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; words&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;parse&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u16&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    Move &lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt; start_stack&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; end_stack&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; crates_to_move&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;I&apos;m starting to get the hang of references. I understand that the input to this function needs to be a &lt;code&gt;&amp;amp;str&lt;/code&gt; because I want just a little window to that string, and I&apos;m not modifying it in any way. We&apos;re good.&lt;/p&gt;&lt;p&gt;Next is a little function to find the line that goes &lt;code&gt; 1  2  3 ...&lt;/code&gt; to get to the &lt;em&gt;count&lt;/em&gt; of stacks in the input. In hindsight, this is probably unnecessary as I could&apos;ve hardcoded that to &lt;code&gt;9&lt;/code&gt;, but here you go if you&apos;re curious.&lt;/p&gt;&lt;details&gt;&lt;summary&gt;&lt;code&gt;fn count_stacks(input: &amp;amp;str) -&amp;gt; u16&lt;/code&gt;&lt;/summary&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;count_stacks&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;input&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;str&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u16&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; indexes_line &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; input
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;lines&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;find&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;line&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;trim&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;starts_with&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;1&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    indexes_line
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;split_ascii_whitespace&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;try_into&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/details&gt;&lt;p&gt;Last but not least, a way to parse stacks. I created a new &lt;code&gt;Stack&lt;/code&gt; struct first:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-annotation z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-annotation z-rust&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-variable z-annotation z-rust&quot;&gt;derive&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;Debug&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-annotation z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-struct z-rust&quot;&gt;struct&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-entity z-name z-struct z-rust&quot;&gt;Stack&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Crates are ordered from bottm to top (that is, the top crate is the last crate in the vector)
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-variable z-other z-member z-rust&quot;&gt;crates&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-type z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-struct z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Then, I went with the most imperative approach I could think of. In a functional language, I&apos;d have probably tried to matrices-and-transpositions my way out of this, but here I went with just slicing strings. I created a &lt;code&gt;parse_stack()&lt;/code&gt; function that takes the whole &lt;code&gt;input: &amp;amp;str&lt;/code&gt; as well as a &quot;column index&quot;. Here you go:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;parse_stack&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;input&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;str&lt;/span&gt;, &lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;column_index&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;usize&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt; Stack&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; crates&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;new&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Iterate through all lines until there&amp;#39;s an empty one.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;for&lt;/span&gt; line &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;in&lt;/span&gt; input&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;lines&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;take_while&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-logical z-rust&quot;&gt;!&lt;/span&gt;line&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;trim&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;is_empty&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; I don&amp;#39;t like this, but it allows me to get the right [x] crate
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; from the input line.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; range &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;column_index &lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;4&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-rust&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;column_index &lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; cleaned_line &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; line&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;range&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;trim&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;if&lt;/span&gt; cleaned_line&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;starts_with&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;[&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; cleaned_line
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;trim_start_matches&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;[&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;trim_end_matches&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;]&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;chars&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;            crates&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;char&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    crates&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;reverse&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    Stack &lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt; crates &lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Now, the final push: getting it all together. First, I built the &quot;world&quot;, which is just a vector of &lt;code&gt;Stack&lt;/code&gt;s:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; input &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;include_str!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;../inputs/day5.txt&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; world&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;Stack&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;new&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;for&lt;/span&gt; column_index &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-rust&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;count_stacks&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;input&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; stack &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;parse_stack&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;input&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; column_index &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;as&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;usize&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    world&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;stack&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; A couple of tests can&amp;#39;t hurt.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;assert_eq!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;world&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;9&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;assert_eq!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;world&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;crates&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;vec!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;W&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;D&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;G&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;B&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;H&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;R&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;V&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Now, I parsed all the &lt;code&gt;Move&lt;/code&gt; structs:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; moves&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;Move&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; input
&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;lines&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;filter&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;line&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;starts_with&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;move&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;parse_move&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;collect&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Spot check the first move.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;assert_eq!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;    moves&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;    Move &lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt; start_stack&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; end_stack&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; crates_to_move&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Finally, I iterated through &lt;code&gt;moves&lt;/code&gt; and applied each move:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;for&lt;/span&gt; move_ &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;in&lt;/span&gt; moves &lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;move_crates&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; world&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; move_&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; This is to get the puzzle output in the desired format.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; top_chars_iter &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; world&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;iter&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;stack&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;stack&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;crates&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;last&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;println!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-placeholder z-rust&quot;&gt;{}&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;from_iter&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;top_chars_iter&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The &lt;code&gt;move_crates&lt;/code&gt; function was fun to write because it was the first time
I used &lt;code&gt;&amp;amp;mut&lt;/code&gt;. I had to pass &lt;code&gt;&amp;amp;mut world&lt;/code&gt; to the function in order to be able
to modify the stacks in place in the function.&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;move_crates&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;world&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;Stack&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;, &lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;move_&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt; Move&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-rust&quot;&gt;..&lt;/span&gt;move_&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;crates_to_move &lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; start_stack &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; world&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;move_&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;start_stack &lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;as&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;usize&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; crate_to_move &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; start_stack&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;crates&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;pop&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; end_stack &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; world&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;move_&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;end_stack &lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;as&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;usize&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;        end_stack&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;crates&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;crate_to_move&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The most interesting thing about the code above? I tried to &lt;code&gt;let&lt;/code&gt; both &lt;code&gt;start_stack&lt;/code&gt; and &lt;code&gt;end_stack&lt;/code&gt; after each other, but the compiler yelled at me after I successively tried to modify &lt;code&gt;start_stack&lt;/code&gt;. This was pretty cool, and it makes sense: I can have &lt;em&gt;one&lt;/em&gt; mutable reference to a piece of &lt;code&gt;world&lt;/code&gt; at a time. If I get one by doing &lt;code&gt;&amp;amp;mut world[...]&lt;/code&gt;, then I need to use it first, and only then I can get more references. Neat, and I&apos;m quite happy that I have some idea of what&apos;s going on.&lt;/p&gt;&lt;h3 id=&quot;day-5-part-two&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-5-part-two&quot; aria-label=&quot;Anchor link for: day-5-part-two&quot;&gt;Day 5: Part Two&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;The second part didn&apos;t take too long. It&apos;s essentially about swapping the &lt;code&gt;pop()&lt;/code&gt; + &lt;code&gt;push()&lt;/code&gt; calls with a &lt;code&gt;pop_many&lt;/code&gt;-sort-of-thing that keeps the order of the popped crates. I let Copilot guide me in writing this:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;pop_many&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;T&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;vec&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;T&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;, &lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u16&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;T&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; popped &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;new&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-rust&quot;&gt;..&lt;/span&gt;count &lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;        popped&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;insert&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; vec&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;pop&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    popped
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Wrote my first function with a parametrized type! How cool. Now, I rewrote &lt;code&gt;move_crates()&lt;/code&gt; from earlier into &lt;code&gt;move_craates_9001()&lt;/code&gt; (after the model number of the new crane):&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;move_crates_9001&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;world&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;Stack&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;, &lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;move_&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt; Move&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; start_stack &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; world&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;move_&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;start_stack &lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;as&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;usize&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; to_move &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;pop_many&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; start_stack&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;crates&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; move_&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;crates_to_move&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; end_stack &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; world&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;move_&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;end_stack &lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;as&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;usize&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Didn&amp;#39;t know about extend(), but Copilot got my back.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    end_stack&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;crates&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;extend&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;to_move&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Another successful puzzle solution!&lt;/p&gt;&lt;h2 id=&quot;day-4&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-4&quot; aria-label=&quot;Anchor link for: day-4&quot;&gt;Day 4&lt;/a&gt;&lt;/h2&gt;&lt;ol&gt;&lt;li&gt;Split each line into two ranges, &lt;code&gt;left&lt;/code&gt; and &lt;code&gt;right&lt;/code&gt;, by splitting at the comma &lt;code&gt;,&lt;/code&gt;.&lt;/li&gt;&lt;li&gt;Convert each text range (&lt;code&gt;&amp;lt;start&amp;gt;-&amp;lt;end&amp;gt;&lt;/code&gt;) into a range data structure (Rust should have one).&lt;/li&gt;&lt;li&gt;Count the occurrences of range pairs where &lt;code&gt;left&lt;/code&gt; is included in &lt;code&gt;right&lt;/code&gt; or &lt;code&gt;right&lt;/code&gt; in &lt;code&gt;left&lt;/code&gt;.&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;The first nice thing I found out today is the &lt;code&gt;include_str!&lt;/code&gt; macro. It&apos;s exactly what I want: it reads a file at compile time and includes its contents into the compiled binary as a static string.&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; input &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;include_str!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;../inputs/day4.txt&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Ready to go. First, I split up each line into two (text) ranges. I found the &lt;code&gt;.split_once()&lt;/code&gt; method for strings, which does exactly what I want. I like that it returns a &lt;code&gt;Option&lt;/code&gt; type.&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;for&lt;/span&gt; line &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;in&lt;/span&gt; input&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;lines&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;left&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; right&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; line&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;split_once&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;,&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Next, I wanted to write a small helper function that parses a textual range into a &lt;a href=&quot;https://doc.rust-lang.org/1.65.0/std/ops/struct.Range.html&quot;&gt;&lt;code&gt;std::ops::Range&lt;/code&gt;&lt;/a&gt; struct. Hello, &lt;strong&gt;Copilot&lt;/strong&gt;! Wow. I wrote the signature (&lt;code&gt;fn parse_into_range(input: &amp;amp;str) -&amp;gt; Range&amp;lt;u32&amp;gt; {}&lt;/code&gt;), and Copilot did its magic:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;parse_into_range&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;input&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;str&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;Range&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u32&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;left&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; right&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; input&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;split_once&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;-&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; left_range &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; left&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;parse&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u32&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; right_range &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; right&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;parse&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u32&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    left_range&lt;span class=&quot;z-keyword z-operator z-range z-rust&quot;&gt;..&lt;/span&gt;right_range
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;I think I can do better at naming variable, but other than that, Copilot beats me easily. I understand Rust ranges are &lt;code&gt;[...)&lt;/code&gt;, so we should do &lt;code&gt;right_range + 1&lt;/code&gt; there to behave like the puzzle description wants us to. But I&apos;m really only using Rust ranges here to play around, because we&apos;d probably be better off with a &lt;code&gt;(u32, u32)&lt;/code&gt; tuple anyway.&lt;/p&gt;&lt;p&gt;Now I want a function that checks whether a &lt;code&gt;Range&amp;lt;u32&amp;gt;&lt;/code&gt; is contained in another range. Once again, Copilot sketches it out great:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;is_contained&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;Range&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u32&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;, &lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;right&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;Range&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u32&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;bool&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    left&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;start &lt;span class=&quot;z-keyword z-operator z-comparison z-rust&quot;&gt;&amp;lt;=&lt;/span&gt; right&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;start &lt;span class=&quot;z-keyword z-operator z-logical z-rust&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; right&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;end &lt;span class=&quot;z-keyword z-operator z-comparison z-rust&quot;&gt;&amp;lt;=&lt;/span&gt; left&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;end
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Ah, AI, you. I can&apos;t read that because of the order in which the boolean expression is written, but it does check if &lt;code&gt;right&lt;/code&gt; is contained in &lt;code&gt;left&lt;/code&gt;. Amazing.&lt;/p&gt;&lt;p&gt;All that&apos;s left now is to count occurrences. Once again, let&apos;s go imperative mutable style.&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; count&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u32&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;for&lt;/span&gt; line &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;in&lt;/span&gt; input&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;lines&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Same as before.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;is_contained&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;left_range&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;right_range&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-logical z-rust&quot;&gt;||&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;is_contained&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;right_range&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;left_ranage&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;        count &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;+=&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Here, I changed &lt;code&gt;is_contained()&lt;/code&gt; to take &lt;code&gt;&amp;amp;Range&amp;lt;u32&amp;gt;&lt;/code&gt; values instead of &lt;code&gt;Range&amp;lt;u32&amp;gt;&lt;/code&gt;. I&apos;m not sure if it was the right thing to do, but the checker was complaining about moving values. It makes sense that here I only want to pass references to the same piece of data around, and I&apos;m not modifying anything, so let&apos;s go for this.&lt;/p&gt;&lt;h3 id=&quot;day-4-part-two&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-4-part-two&quot; aria-label=&quot;Anchor link for: day-4-part-two&quot;&gt;Day 4: Part Two&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Okay, easy peasy. The change is that the puzzle is now about finding &lt;strong&gt;overlapping&lt;/strong&gt; ranges, not just &lt;strong&gt;included&lt;/strong&gt; ranges.&lt;/p&gt;&lt;p&gt;I started with a &lt;code&gt;is_overlapping()&lt;/code&gt; function, and it turns out the boolean check I wrote was buggy. I submitted the puzzle solution and, for the first time this year, I got yelled at! Guess it&apos;s time for some testing, isn&apos;t it. I don&apos;t know much about Rust testing, but I saw &lt;code&gt;assert_eq!()&lt;/code&gt; used everywhere, so I figured it&apos;d be easy to test &lt;code&gt;is_overlapping()&lt;/code&gt; before doing anything in the main function.&lt;/p&gt;&lt;p&gt;What I got is something like this:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Returns true if left and right overlap.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;is_overlapping&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;left&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;Range&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u32&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;, &lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;right&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;Range&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;u32&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;bool&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;min&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; max&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;if&lt;/span&gt; left&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;start &lt;span class=&quot;z-keyword z-operator z-comparison z-rust&quot;&gt;&amp;lt;&lt;/span&gt; right&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;start &lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;left&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; right&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;right&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; left&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    min&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;end &lt;span class=&quot;z-keyword z-operator z-comparison z-rust&quot;&gt;&amp;gt;=&lt;/span&gt; max&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;start
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The assertions look something like this:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;pub&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;run2&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;assert_eq!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;is_overlapping&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-rust&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;3&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-rust&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;4&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-rust&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;assert_eq!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;is_overlapping&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-rust&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;3&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-rust&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;4&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-rust&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;assert_eq!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;is_overlapping&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-rust&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;4&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-rust&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;3&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-rust&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;assert_eq!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;is_overlapping&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-rust&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;3&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-rust&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;6&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-rust&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;assert_eq!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;is_overlapping&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-rust&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;6&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-rust&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;3&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-rust&quot;&gt;false&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Works now.&lt;/p&gt;&lt;h2 id=&quot;day-3&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-3&quot; aria-label=&quot;Anchor link for: day-3&quot;&gt;Day 3&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;The &quot;translated-to-computerese&quot; puzzle is this:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;Split each input line in half to get the items in the two compartments.&lt;/li&gt;&lt;li&gt;For each line, find the char that appears in both halves.&lt;/li&gt;&lt;li&gt;Associate a score with that char.&lt;/li&gt;&lt;li&gt;Sum the score for all lines.&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;When I hear &quot;appears in both halves&quot;, the first thing I think is sets. Rust seems to have a pretty straightforward set implementation in the standard library, &lt;a href=&quot;https://doc.rust-lang.org/1.65.0/std/collections/hash_set/struct.HashSet.html&quot;&gt;&lt;code&gt;std::collections::hash_set::HashSet&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt;&lt;p&gt;I&apos;m taking the same approach as day 2 with the &lt;code&gt;total&lt;/code&gt; accumulator and the &lt;code&gt;for&lt;/code&gt; loop. For each line, I split it in half, turn each half into a set, find the intersection of the two sets, and calculate the score associated with that character.&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;pub&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;run&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; lines &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;fs&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;read_to_string&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;inputs/day3.txt&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;expect&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;Failed to read file&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;lines&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; total&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;i32&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;for&lt;/span&gt; line &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;in&lt;/span&gt; lines &lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;left&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; right&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; line&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;split_at&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;line&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; left_items&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;HashSet&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;HashSet&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;from_iter&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;left&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;chars&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; right_items&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;HashSet&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;HashSet&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;from_iter&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;right&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;chars&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Here, I&amp;#39;m not bothering with checking whether the intersection has
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; zero or &amp;gt;1 characters. It&amp;#39;ll panice with index out of bounds or
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; something like that, and that&amp;#39;s okay.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; common&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; left_items
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;intersection&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;right_items&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;collect&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;        total &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; total &lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;priority&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;*&lt;/span&gt;common&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;println!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-placeholder z-rust&quot;&gt;{:?}&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; total&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;code&gt;priority&lt;/code&gt; is a small helper function that uses ASCII trickery to assign scores to &lt;code&gt;a..z&lt;/code&gt; and &lt;code&gt;A..Z&lt;/code&gt;. There&apos;s probably a better Rust way to do that, but I&apos;m going for what I know.&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;priority&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;char&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;i32&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; ascii_value &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; c &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;as&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;i32&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;if&lt;/span&gt; c&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;is_lowercase&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;        ascii_value &lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;a&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;as&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;i32&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;        ascii_value &lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-single z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;#39;&lt;/span&gt;A&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;as&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;i32&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;27&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&quot;day-3-part-two&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-3-part-two&quot; aria-label=&quot;Anchor link for: day-3-part-two&quot;&gt;Day 3: Part Two&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Okay, the second part boils down to:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;Get chunks of three lines each from the input&lt;/li&gt;&lt;li&gt;Split each line into characters like before&lt;/li&gt;&lt;li&gt;Find the character in common among the three lines&lt;/li&gt;&lt;li&gt;Calculate its score and sum all the scores&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;The main struggle I found here was, wait for it, doing the intersection of three sets. I&apos;m not good with references and pointers and whatnot. What I ended up doing is looking like the worst Rust code I&apos;ve ever seen!&lt;/p&gt;&lt;p&gt;The first step I did was to get the lines in the file and chunk them up into 3-line chunks.&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; contents &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;fs&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;read_to_string&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;inputs/day3.txt&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;expect&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;Could not read file&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; lines &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; contents&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;lines&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;collect&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;str&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; chunks &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; lines&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;chunks&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;3&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;collect&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;str&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;I kind of let rust-analyzer figure out the types here. It&apos;s not the clearest thing to me. Then, for the main &lt;code&gt;for&lt;/code&gt; loop:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; total&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;i32&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;for&lt;/span&gt; chunk &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;in&lt;/span&gt; chunks &lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Destructuring is always a good feature.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;line1&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; line2&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; line3&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;chunk&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; chunk&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; chunk&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; set1&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;HashSet&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;HashSet&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;from_iter&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;line1&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;chars&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; set2&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;HashSet&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;HashSet&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;from_iter&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;line2&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;chars&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; set3&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;HashSet&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;HashSet&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;from_iter&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;line3&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;chars&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; This was weird to figure out. The .map() calls to dereference &amp;amp;char
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; pointers is very weird, but it works.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; common&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; set1
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;intersection&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;set2&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;*&lt;/span&gt;c&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;collect&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;HashSet&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;intersection&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;&amp;amp;&lt;/span&gt;set3&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;*&lt;/span&gt;c&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;collect&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    total &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; total &lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;priority&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;common&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Rust people: how do I make this right?&lt;/p&gt;&lt;h2 id=&quot;day-2&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-2&quot; aria-label=&quot;Anchor link for: day-2&quot;&gt;Day 2&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Okay, I&apos;m already over doing stuff in &lt;code&gt;src/main.rs&lt;/code&gt;. I create &lt;code&gt;src/day2.rs&lt;/code&gt;.&lt;/p&gt;&lt;p&gt;The gist of the puzzle:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;Parse each input line into a &lt;code&gt;(opponent_choice, my_choice)&lt;/code&gt; tuple.&lt;/li&gt;&lt;li&gt;Calculate the score of &lt;code&gt;my_choice&lt;/code&gt; based on the rules.&lt;/li&gt;&lt;li&gt;Calculate the score of the game (win, loss, draw).&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;I start with making an enum for the possible choices. Overkill? Maybe, but I&apos;m not used to static types, so I like doing stuff like this.&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-enum z-rust&quot;&gt;enum&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-enum z-rust&quot;&gt;Choice&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    Rock&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    Paper&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    Scissors&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Awesome. Now, I kind of translate the algorithm above. In the spirit of trying new things, I go for a &lt;code&gt;for&lt;/code&gt; loop instead of the functional &lt;code&gt;map + sum&lt;/code&gt; approach that I&apos;d naturally go for.&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;pub&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;run&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; lines &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;fs&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;read_to_string&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;inputs/day2.txt&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;expect&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;Failed to read file&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;lines&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Declare a mutable variable to keep the total. Feels vintage.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; total &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;for&lt;/span&gt; line &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;in&lt;/span&gt; lines &lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; split&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;str&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt; line&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;split_whitespace&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;collect&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; opponent_choice &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;match&lt;/span&gt; split&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;A&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Rock&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;B&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Paper&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;C&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Scissors&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;panic!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;Invalid choice&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; my_choice &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;match&lt;/span&gt; split&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;X&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Rock&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;Y&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Paper&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;Z&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Scissors&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;panic!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;Invalid choice&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;        total &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;            total &lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;calculate_choice_value&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;my_choice&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-rust&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;calculate_score&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;opponent_choice&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; my_choice&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;println!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-placeholder z-rust&quot;&gt;{:?}&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; total&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Now, I just need to implement the two helper functions. I love pattern matching.&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;calculate_choice_value&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;choice&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt; Choice&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;i32&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;match&lt;/span&gt; choice &lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Rock &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Paper &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Scissors &lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;calculate_score&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;opponent_choice&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt; Choice, &lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;my_choice&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt; Choice&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;i32&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;match&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;opponent_choice&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; my_choice&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Rock&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Rock&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Paper&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Paper&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-bitwise z-rust&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Scissors&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Scissors&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Paper&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Rock&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Scissors&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Rock&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Rock&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Paper&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Scissors&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Paper&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Rock&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Scissors&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Paper&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Scissors&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&quot;day-2-part-two&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-2-part-two&quot; aria-label=&quot;Anchor link for: day-2-part-two&quot;&gt;Day 2: Part Two&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;The second part here is about turning the second letter in each line into a &quot;round end&quot;, that is, a win, loss, or draw. That sounds like an enum to me.&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-enum z-rust&quot;&gt;enum&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-enum z-rust&quot;&gt;RoundEnd&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    Win&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    Lose&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;    Draw&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-enum z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Now we can parse the round end into a &lt;code&gt;RoundEnd&lt;/code&gt; enum with a &lt;code&gt;match&lt;/code&gt; expression as before, and then calculate which choice we should make in order to finish the round as instructed. That function looks like this:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;choose_based_on_end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;opponent_choice&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt; Choice, &lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;round_end&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;:&lt;/span&gt; RoundEnd&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-return-type z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;-&amp;gt;&lt;/span&gt; Choice&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-keyword z-control z-rust&quot;&gt;match&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;opponent_choice&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; round_end&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;choice&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;RoundEnd&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Draw&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt; choice&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Paper&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;RoundEnd&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Win&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Scissors&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Paper&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;RoundEnd&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Lose&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Rock&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Rock&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;RoundEnd&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Win&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Paper&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Rock&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;RoundEnd&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Lose&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Scissors&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Scissors&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;RoundEnd&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Win&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Rock&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Scissors&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;RoundEnd&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Lose&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-rust&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;Choice&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;Paper&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Calculating the total is a matter of parsing the round end, feeding it into this function, and adding up to &lt;code&gt;total&lt;/code&gt;.&lt;/p&gt;&lt;h2 id=&quot;day-1&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-1&quot; aria-label=&quot;Anchor link for: day-1&quot;&gt;Day 1&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;This is set-up day. I&apos;m not completely clueless about Rust, so I have &lt;a href=&quot;https://doc.rust-lang.org/book/ch01-03-hello-cargo.html&quot;&gt;Cargo&lt;/a&gt; installed and I&apos;m capable of creating a project. I created a new &lt;code&gt;aoc22&lt;/code&gt; crate. I shove puzzle inputs in there with something like:&lt;/p&gt;&lt;pre data-lang=&quot;bash&quot; class=&quot;language-bash z-code&quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;z-source z-shell z-bash&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-shell&quot;&gt;&lt;span class=&quot;z-variable z-function z-shell&quot;&gt;mkdir&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-arguments z-shell&quot;&gt; inputs&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-shell z-bash&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-shell&quot;&gt;&lt;span class=&quot;z-variable z-function z-shell&quot;&gt;pbpaste&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-arguments z-shell&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-redirection z-shell&quot;&gt;&amp;gt;&lt;/span&gt; inputs/day1.txt&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;I did the whole first day in &lt;code&gt;src/main.rs&lt;/code&gt;. Too early for refactoring!&lt;/p&gt;&lt;p&gt;The gist of the puzzle is to:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;Split a file into &quot;chunks of lines&quot; separated by an empty line.&lt;/li&gt;&lt;li&gt;Parse each line into an integer and calculate the sum of the lines in each cluster.&lt;/li&gt;&lt;li&gt;Find the cluster with the highest sum.&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;The solution, with comments:&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-function z-rust&quot;&gt;fn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-rust&quot;&gt;run&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt; chunk_sums &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;fs&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;read_to_string&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;inputs/day1.txt&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;expect&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;Failed to read file&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;split&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;z-constant z-character z-escape z-rust&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;z-constant z-character z-escape z-rust&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Split into chunks of lines
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;chunk&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-rust&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;            chunk
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;split&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;z-constant z-character z-escape z-rust&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Split the chunk into lines
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-begin z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-parameters z-rust&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-rust&quot;&gt;calorie&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-parameters z-end z-rust&quot;&gt;|&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;calorie&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;parse&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;i32&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Parse integers
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Calculate the sum for each chunk
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-closure z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;println!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-placeholder z-rust&quot;&gt;{:?}&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; chunk_sums&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;max&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;unwrap&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-meta z-function z-rust&quot;&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-rust&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;I have not used Copilot or ChatGPT yet at this point. This was fairly straightforward. Some notes:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;p&gt;I like the &lt;code&gt;.expect()&lt;/code&gt; and &lt;code&gt;.unwrap()&lt;/code&gt; calls. For example, I expect that reading a file would return a result type, and I like having a simple method to panic on the non-OK result. Practical for use cases like this.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;My solution is pretty functional. I would have written something &lt;em&gt;very&lt;/em&gt; similar in Elixir.&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h3 id=&quot;day-1-part-two&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#day-1-part-two&quot; aria-label=&quot;Anchor link for: day-1-part-two&quot;&gt;Day 1: Part Two&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;The second part of the puzzle boils down to finding the sum of the three highest chunks. It takes little changes to get there: I only need to sort &lt;code&gt;chunk_sums&lt;/code&gt;, get the first three elements, and sum those.&lt;/p&gt;&lt;pre data-lang=&quot;rust&quot; class=&quot;language-rust z-code&quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-rust&quot;&gt;mut&lt;/span&gt; chunk_sums &lt;span class=&quot;z-keyword z-operator z-assignment z-rust&quot;&gt;=&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-rust&quot;&gt;//&lt;/span&gt; Same as before
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-meta z-path z-rust&quot;&gt;collect&lt;span class=&quot;z-punctuation z-accessor z-rust&quot;&gt;::&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-meta z-generic z-rust&quot;&gt;&lt;span class=&quot;z-support z-type z-rust&quot;&gt;Vec&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-begin z-rust&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-rust&quot;&gt;i32&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-generic z-end z-rust&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;chunk_sums&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;sort&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;chunk_sums&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;reverse&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;chunk_sums&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;truncate&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-rust&quot;&gt;3&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-rust&quot;&gt;&lt;span class=&quot;z-support z-macro z-rust&quot;&gt;println!&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-placeholder z-rust&quot;&gt;{:?}&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-end z-rust&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-separator z-rust&quot;&gt;,&lt;/span&gt; chunk_sums&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;iter&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-accessor z-dot z-rust&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-support z-function z-rust&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-rust&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-rust&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-rust&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-rust&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;It feels weird to modify the data in place. Sure, it&apos;s efficient! I know this could be done &lt;em&gt;more&lt;/em&gt; efficiently. I could go through &lt;code&gt;chunk_sums&lt;/code&gt; and keep just three &lt;code&gt;i32&lt;/code&gt;s for the top three integers, but it&apos;s a small data set plus a fast language plus toy code.&lt;/p&gt;&lt;p&gt;The &lt;code&gt;let mut&lt;/code&gt; makes sense here. I love that I have to declare that a variable is mutable.&lt;/p&gt;&lt;p&gt;Surely I&apos;m missing something, but I&apos;m also weirded out by having to turn &lt;code&gt;chunk_sums&lt;/code&gt; into an iterator in order to call &lt;code&gt;.sum()&lt;/code&gt; on it. Why wouldn&apos;t &lt;code&gt;Vec&lt;/code&gt; implement something like &lt;code&gt;sum()&lt;/code&gt; directly?&lt;/p&gt;</content>
    
    </entry>
  
    <entry>
      <id>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;posts&#x2F;get-rid-of-your-old-database-migrations&#x2F;</id>
      <title type="html"><![CDATA[ Get Rid of Your Old Database Migrations ]]></title>
      <link rel="alternate"
            type="text/html"
            href="https://andrealeopardi.com/posts/get-rid-of-your-old-database-migrations/"
            title="Get Rid of Your Old Database Migrations" />
      <published>2022-11-28T00:00:00+00:00</published>
      <author>
        <name>Andrea Leopardi</name>
        <uri>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;</uri>
        <email>hi@andrealeopardi.com</email>
      </author>
      <updated>2022-11-28T00:00:00+00:00</updated>
      <summary type="html">&lt;p&gt;Database migrations are great. I love to be able to change the shape of tables and move data around in a controlled way to avoid issues and downtime. However, lately I started to view migrations more like &lt;em&gt;Git commits&lt;/em&gt; than like active pieces of code in my applications. In this post, I want to dig a bit deeper into the topic. I&apos;ll start with some context on database migrations, I&apos;ll expand on the Git commits analogy, and I&apos;ll show you &lt;em&gt;what I&apos;ve been doing instead&lt;/em&gt;.&lt;/p&gt;</summary>
    
      <content type="html">&lt;p&gt;Database migrations are great. I love to be able to change the shape of tables and move data around in a controlled way to avoid issues and downtime. However, lately I started to view migrations more like &lt;em&gt;Git commits&lt;/em&gt; than like active pieces of code in my applications. In this post, I want to dig a bit deeper into the topic. I&apos;ll start with some context on database migrations, I&apos;ll expand on the Git commits analogy, and I&apos;ll show you &lt;em&gt;what I&apos;ve been doing instead&lt;/em&gt;.&lt;/p&gt;&lt;span id=&quot;continue-reading&quot;&gt;&lt;/span&gt;&lt;p&gt;I mostly write Elixir, so my examples will be in Elixir. If you&apos;re interested in the workflow I’m currently using for Elixir, jump to the last section of the post.&lt;/p&gt;&lt;p&gt;&lt;img src=&quot;https://andrealeopardi.com/posts/get-rid-of-your-old-database-migrations/cover-image.png&quot; alt=&quot;Cover image of a flock of birds flying, with a sunset sky in the background&quot; /&gt;&lt;/p&gt;&lt;h2 id=&quot;what-are-db-migrations&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#what-are-db-migrations&quot; aria-label=&quot;Anchor link for: what-are-db-migrations&quot;&gt;What Are DB Migrations&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;DB migrations are pieces of code that you run to &lt;strong&gt;change the schema (and data, if desired) of your database&lt;/strong&gt;. Wikipedia does &lt;a href=&quot;https://en.wikipedia.org/wiki/Schema_migration&quot;&gt;a great job&lt;/a&gt; at explaining migrations, their history, and their use cases. I&apos;ll write a few words here for context, but go read that if you want to dig deeper.&lt;/p&gt;&lt;p&gt;Migrations have a few selling points over executing direct SQL commands.&lt;/p&gt;&lt;p&gt;First, database migrations usually &lt;em&gt;keep information&lt;/em&gt; about the migrations themselves in a dedicated database table. To be precise, the framework that runs the migrations is the one storing information in that table. The framework uses this table to only run migrations that have not been run yet.&lt;/p&gt;&lt;p&gt;Another benefit is that you&apos;ll usually write migrations in a way that makes it possible to &lt;strong&gt;roll them back&lt;/strong&gt;. &quot;Rolling back&quot; a migration means executing SQL statements that revert the changes done in that migration. Most database frameworks can infer the rollback steps from the migration definition if the migration is simple enough. This results in concise pieces of code to alter the database schema that can be executed &quot;in both directions&quot;.&lt;/p&gt;&lt;p&gt;Let&apos;s see an example with &lt;a href=&quot;https://github.com/elixir-ecto/ecto&quot;&gt;Ecto&lt;/a&gt;, Elixir&apos;s database framework.&lt;/p&gt;&lt;h3 id=&quot;example-with-ecto&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#example-with-ecto&quot; aria-label=&quot;Anchor link for: example-with-ecto&quot;&gt;Example with Ecto&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Let&apos;s say you have a &lt;code&gt;users&lt;/code&gt; table with columns &lt;code&gt;email&lt;/code&gt; and &lt;code&gt;password&lt;/code&gt;. New requirements force you to add two new columns, &lt;code&gt;first_name&lt;/code&gt; and &lt;code&gt;last_name&lt;/code&gt;. To do that, you can write a migration that looks like this:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MyApp&lt;/span&gt;.&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;AddNameToUsers&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;use&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Ecto&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Migration&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;change&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    alter table&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;users&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;      add &lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;first_name&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;string&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;      add &lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;last_name&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;string&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;In this simple example, the framework is able to do what I mentioned above: you can define a single &lt;code&gt;change/0&lt;/code&gt; function with migration steps in it, and the framework is able to infer the corresponding rollback steps (in this case, removing the two new columns).&lt;/p&gt;&lt;p&gt;When you run the migration (with &lt;code&gt;mix ecto.migrate&lt;/code&gt; in this case), Ecto adds a row to the &lt;code&gt;schema_migrations&lt;/code&gt; table:&lt;/p&gt;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;&lt;code&gt;version&lt;/code&gt;&lt;/th&gt;&lt;th&gt;&lt;code&gt;inserted_at&lt;/code&gt;&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;code&gt;20221114232841&lt;/code&gt;&lt;/td&gt;&lt;td&gt;&lt;code&gt;2022-11-15 21:27:50&lt;/code&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;h2 id=&quot;why-do-we-keep-migrations-around&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#why-do-we-keep-migrations-around&quot; aria-label=&quot;Anchor link for: why-do-we-keep-migrations-around&quot;&gt;Why Do We Keep Migrations Around?&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Until recently, I had never worked on an application that did not keep &lt;em&gt;all the migrations&lt;/em&gt; around. I&apos;d always seen the &lt;code&gt;priv/repo/migrations&lt;/code&gt; directory in Elixir applications full of files. I want to get one disclaimer out of the way: the many-migrations experience is a personal one, and I might be late to the party here. But hey, here&apos;s to hoping someone else is too and that this write-up is gonna help them out.&lt;/p&gt;&lt;p&gt;At one point, I started working on an older unfamiliar codebase. The experience made me think of two things.&lt;/p&gt;&lt;p&gt;The first one is reading the &lt;strong&gt;complete, up-to-date database schema structure&lt;/strong&gt;. I&apos;d constantly fire up a Postgres GUI (I use &lt;a href=&quot;https://tableplus.com&quot;&gt;TablePlus&lt;/a&gt;) to look at the structure of the database, since it was hard to navigate old migrations and piece together what their end result is.&lt;/p&gt;&lt;p&gt;The second one revolves around &lt;strong&gt;searching through code&lt;/strong&gt;. Working on the new codebase involved &lt;em&gt;a lot&lt;/em&gt; of searching all around the code to understand the structure of the application. Function names, modules, database columns, and what have you. However, database columns stuck with me: I&apos;d always find a bunch of misleading search results in old migrations. For example, I&apos;d see a few results for a column name that was created, then modified, and then dropped.&lt;/p&gt;&lt;p&gt;So I started wondering: why do we keep old migrations around? Don&apos;t get me wrong, I know why we &lt;em&gt;write&lt;/em&gt; migrations in the first place. They&apos;re great, no doubts. But why not &lt;strong&gt;throw them away&lt;/strong&gt; after they&apos;ve done their job? How many times did you roll back &lt;em&gt;more than one migration&lt;/em&gt;? I have never done that. It&apos;s hard to imagine rolling back many changes, especially when they involve not only the schema but also the data in the database itself. There must be a better way.&lt;/p&gt;&lt;h3 id=&quot;analogy-with-git-commits&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#analogy-with-git-commits&quot; aria-label=&quot;Anchor link for: analogy-with-git-commits&quot;&gt;Analogy with Git Commits&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;I started to think of database migrations more like Git commits. You apply commits to get to the current state of your application. You apply database migrations to get to the current schema of your database. But after some time, Git commits become a tool for keeping track of history more than an active tool for moving back and forth between versions of the code. I&apos;m now leaning towards treating database migrations the same way. I want them to stick around for a bit, and then &quot;archive&quot; them away. They&apos;re always going to be in the Git history, so I’m never really losing the source file, only the ability to apply the migrations.&lt;/p&gt;&lt;p&gt;So, how do we deal with this in practice?&lt;/p&gt;&lt;h3 id=&quot;dumping-and-loading&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#dumping-and-loading&quot; aria-label=&quot;Anchor link for: dumping-and-loading&quot;&gt;Dumping and Loading&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;It turns out that this is something others have already thought about.&lt;/p&gt;&lt;p&gt;Database frameworks that provide migration functionality usually provide ways to &lt;strong&gt;dump&lt;/strong&gt; and &lt;strong&gt;load&lt;/strong&gt; a database schema. If they don&apos;t, fear not: major databases provide that themselves. In fact, in Elixir Ecto&apos;s dump and load tasks only really act as proxies on top of tools provided by the underlying databases (such as &lt;code&gt;pg_dump&lt;/code&gt; and &lt;code&gt;psql&lt;/code&gt; for PostgreSQL).&lt;/p&gt;&lt;p&gt;The idea is always the same: to get the current state of the database, you&apos;ll run the &lt;strong&gt;dumping task&lt;/strong&gt;. With Ecto and other frameworks, this produces an SQL file of instructions that you can feed to your database when you want to load the schema again.&lt;/p&gt;&lt;p&gt;Some frameworks provide a way to &lt;em&gt;squash migrations&lt;/em&gt; instead. Django, for example, has the &lt;a href=&quot;https://docs.djangoproject.com/en/4.1/topics/migrations/#migration-squashing&quot;&gt;&lt;code&gt;squashmigrations&lt;/code&gt; command&lt;/a&gt;. However, the concept is almost the same. &lt;a href=&quot;https://rubyonrails.org&quot;&gt;Ruby on Rails&lt;/a&gt;&apos;s &lt;code&gt;ActiveRecord&lt;/code&gt; framework has a unique approach: it can &lt;a href=&quot;https://edgeguides.rubyonrails.org/active_record_migrations.html&quot;&gt;generate a &lt;strong&gt;Ruby&lt;/strong&gt; schema file from migrations&lt;/a&gt;. It can also generate the SQL schema file mentioned above via the database, but the Ruby approach is interesting. Its power is limited, however, since the Ruby schema file might not be able to reconstruct the exact schema of the database. From the documentation:&lt;/p&gt;&lt;blockquote&gt;&lt;p&gt;While migrations may use execute to create database constructs that are not supported by the Ruby migration DSL, these constructs may not be able to be reconstituted by the schema dumper.&lt;/p&gt;&lt;/blockquote&gt;&lt;p&gt;Dumping and loading the database schema works well in local development and testing, but &lt;em&gt;not in production&lt;/em&gt; though, right? You don&apos;t want to load a big old SQL file in a running production database. I think. Well, you don&apos;t really have to. Production databases tend to be reliable and (hopefully) backed up, so &quot;restoring&quot; a schema is not something you really do in production. It&apos;d be analogous to re-running all the migrations: you just never do it.&lt;/p&gt;&lt;h3 id=&quot;advantages-and-disadvantages-of-ditching-old-migrations&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#advantages-and-disadvantages-of-ditching-old-migrations&quot; aria-label=&quot;Anchor link for: advantages-and-disadvantages-of-ditching-old-migrations&quot;&gt;Advantages and Disadvantages of Ditching Old Migrations&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;I find that dumping old migrations and loading an up-to-date SQL file has a few &lt;strong&gt;advantages&lt;/strong&gt;.&lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;You get a complete view of the schema&lt;/strong&gt; — The SQL file with the database schema now represents a complete look at the structure of the database. You can see all the tables, indexes, default values, constraints, and so on. Sometimes, you&apos;ll still need to create migrations and run them, but they&apos;re going to live in your codebase only temporarily, and it&apos;s only going to be a handful of them at a time, instead of tens (or hundreds) of files.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Speed&lt;/strong&gt;: A minor but not irrelevant advantage of this approach is that it speeds up resetting the database for local development and tests. Applying migrations can do many unnecessary operations in the database, such as creating tables only to delete them just after. When loading the database dump, you&apos;re really doing the &lt;em&gt;smallest possible set of commands&lt;/em&gt; to get to the desired state.&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;However, it&apos;s not all great here. There are some &lt;strong&gt;disadvantages&lt;/strong&gt; as well:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Digging through Git&lt;/strong&gt; — there are going to be situations in which you look at the migration table in your database and want to figure out the migration that corresponds to a given row. This approach makes this use case slightly more annoying, because you&apos;ll have to dig through your Git history to find the original migration. Not a big deal in my opinion, I don&apos;t really do this that much.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;strong&gt;Deploying without running migrations&lt;/strong&gt; — make sure to deploy and run migrations. With this approach, that&apos;s not something to give for granted. You might get a bit too comfortable dumping the current database schema and deleting migration files. You might end up in situations where you create a migration, run it locally, and then dump the schema and delete the migration, all without deploying. This would result in the migration not running in production.&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;h2 id=&quot;workflow-in-elixir&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#workflow-in-elixir&quot; aria-label=&quot;Anchor link for: workflow-in-elixir&quot;&gt;Workflow in Elixir&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Now for a small section specific to Elixir. Ecto provides the dump and load tasks mentioned above, &lt;a href=&quot;https://hexdocs.pm/ecto_sql/Mix.Tasks.Ecto.Dump.html&quot;&gt;&lt;code&gt;mix ecto.dump&lt;/code&gt;&lt;/a&gt; and &lt;a href=&quot;https://hexdocs.pm/ecto_sql/Mix.Tasks.Ecto.Load.html&quot;&gt;&lt;code&gt;mix ecto.load&lt;/code&gt;&lt;/a&gt; respectively.&lt;/p&gt;&lt;p&gt;In my applications, I&apos;ve been doing something like this:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;p&gt;I updated the common Mix aliases for dealing with migrations to take dumping/loading into account. Those aliases look something like this now:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defp&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-private z-elixir&quot;&gt;aliases&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-symbol z-double-quoted z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-begin z-regexp z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;ecto.setup&lt;span class=&quot;z-punctuation z-definition z-constant z-end z-regexp z-elixir&quot;&gt;&amp;quot;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;ecto.create&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;ecto.load&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;ecto.migrate&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-symbol z-double-quoted z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-begin z-regexp z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;ecto.reset&lt;span class=&quot;z-punctuation z-definition z-constant z-end z-regexp z-elixir&quot;&gt;&amp;quot;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;ecto.drop&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;ecto.setup&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;test&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;ecto.create --quiet&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;ecto.load --quiet --skip-if-loaded&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;ecto.migrate --quiet&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;test&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;As you can see, the aliases now always run &lt;code&gt;mix ecto.load&lt;/code&gt; before calling &lt;code&gt;mix ecto.migrate&lt;/code&gt;. The &lt;code&gt;--skip-if-loaded&lt;/code&gt; flag in the &lt;code&gt;test&lt;/code&gt; alias ensures that the command is &lt;em&gt;idempotent&lt;/em&gt;, that is, can be run multiple times without changing the result.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;I added a Mix alias to &quot;dump migrations&quot;, that is, dump the current database structure and delete all the current migration files. It looks like this:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defp&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-private z-elixir&quot;&gt;aliases&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;dump_migrations&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;ecto.dump&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-variable z-other z-capture z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-capture z-elixir&quot;&gt;&amp;amp;&lt;/span&gt;delete_migration_files&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-elixir&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defp&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-private z-elixir&quot;&gt;delete_migration_files&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;_args&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; Match all files in the 21st century (year is 20xx).
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Enum&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;each&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Path&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;wildcard&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;priv/repo/migrations/20*.exs&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;fn&lt;/span&gt; migration_file &lt;span class=&quot;z-keyword z-operator z-other z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;rm!&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;migration_file&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Mix&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;shell&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;info&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;bright&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;Deleted: &lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;reset&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;red&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; migration_file&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The path wildcard could be improved, or you could have logic that reads the files and checks that they&apos;re migrations. However, this does a good-enough job.&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;h2 id=&quot;conclusions&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#conclusions&quot; aria-label=&quot;Anchor link for: conclusions&quot;&gt;Conclusions&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;If you start to look at database migrations as analogous to Git commits, you can start to treat them that way. We saw how to use the &quot;dumping&quot; and &quot;loading&quot; functionality provided by many database and database frameworks. We saw the advantages and disadvantages of this approach. Finally, I showed you the approach I use in Elixir.&lt;/p&gt;</content>
    
    </entry>
  
    <entry>
      <id>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;posts&#x2F;testing-aws-in-elixir&#x2F;</id>
      <title type="html"><![CDATA[ Testing AWS in Elixir ]]></title>
      <link rel="alternate"
            type="text/html"
            href="https://andrealeopardi.com/posts/testing-aws-in-elixir/"
            title="Testing AWS in Elixir" />
      <published>2022-01-25T00:00:00+00:00</published>
      <author>
        <name>Andrea Leopardi</name>
        <uri>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;</uri>
        <email>hi@andrealeopardi.com</email>
      </author>
      <updated>2022-01-25T00:00:00+00:00</updated>
      <summary type="html">&lt;p&gt;At Community, we run most of our infrastructure and services on AWS. We use several AWS services. Many of our own services interact with AWS directly, such as by uploading and downloading files from S3, querying Athena, and more. Lately, I&apos;ve been trying to improve how we &lt;em&gt;test&lt;/em&gt; the interaction between our services and AWS, testing error conditions and edge cases as well as running reproducible integration tests. In this post, I&apos;ll talk about Localstack, mocks, ExAws, and more.&lt;/p&gt;</summary>
    
      <content type="html">&lt;p&gt;At Community, we run most of our infrastructure and services on AWS. We use several AWS services. Many of our own services interact with AWS directly, such as by uploading and downloading files from S3, querying Athena, and more. Lately, I&apos;ve been trying to improve how we &lt;em&gt;test&lt;/em&gt; the interaction between our services and AWS, testing error conditions and edge cases as well as running reproducible integration tests. In this post, I&apos;ll talk about Localstack, mocks, ExAws, and more.&lt;/p&gt;&lt;span id=&quot;continue-reading&quot;&gt;&lt;/span&gt;&lt;p&gt;&lt;img src=&quot;https://andrealeopardi.com/posts/testing-aws-in-elixir/cover-image.jpg&quot; alt=&quot;Cover image of a data center&quot; /&gt;&lt;/p&gt;&lt;span class=&quot;unsplash-credit&quot;&gt;
    Photo by &lt;a href=&quot;https:&amp;#x2F;&amp;#x2F;unsplash.com&amp;#x2F;@ianjbattaglia?utm_source=unsplash&amp;amp;utm_medium=referral&amp;amp;utm_content=creditCopyText&quot;&gt;Ian Battaglia&lt;/a&gt; on &lt;a href=&quot;https://unsplash.com&quot;&gt;Unsplash&lt;/a&gt;&lt;/span&gt;&lt;p&gt;AWS is an external system that our system has limited control over. First, it operates over the network, which makes it vulnerable to all sorts of network issues and failures. Furthermore, I can&apos;t control how an AWS service operates or its business logic. However, as external services go, it&apos;s a stable one when it comes to its APIs.&lt;/p&gt;&lt;p&gt;When I work with external systems like AWS, I want to test two aspects:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;p&gt;What happens on the uncommon code branches — network failures, services unavailable, all sorts of things that we know can (and will) happen.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;What happens when interacting with the actual service — I want the application&apos;s code to have some tests that execute the whole code that interacts with the external service end-to-end, without mocks in the middle.&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;Let&apos;s take a look at these below. I set up &lt;a href=&quot;https://github.com/whatyouhide/testing_aws_in_elixir&quot;&gt;a repository&lt;/a&gt; with most of the code discussed here, so you can see it pieced together and working.&lt;/p&gt;&lt;h2 id=&quot;testing-uncommon-conditions&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#testing-uncommon-conditions&quot; aria-label=&quot;Anchor link for: testing-uncommon-conditions&quot;&gt;Testing Uncommon Conditions&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Testing relatively-uncommon conditions (such as network failures) requires precise control of the external system. We do not have &lt;em&gt;any&lt;/em&gt; control of the external system in the case of something like AWS. &lt;strong&gt;Test doubles&lt;/strong&gt; are helpful in these cases.&lt;/p&gt;&lt;p&gt;I call &quot;test double&quot; any piece of code that mimics a dependency of a system but is only used in tests. Folks use terms like test double, mock, or stub interchangeably, but I&apos;m a stickler for this stuff, so I&apos;ll use &lt;em&gt;test double&lt;/em&gt; in this post.&lt;/p&gt;&lt;p&gt;In our case, AWS is a natural point where to define a contract between our system and an external dependency. I always think back to &lt;a href=&quot;https://twitter.com/josevalim&quot;&gt;José Valim&lt;/a&gt;&apos;s legendary post &lt;a href=&quot;http://blog.plataformatec.com.br/2015/10/mocks-and-explicit-contracts/&quot;&gt;&quot;Mocks and Explicit Contracts&quot;&lt;/a&gt; when talking about these things. Go give it a read if you haven&apos;t read it already.&lt;/p&gt;&lt;h3 id=&quot;exaws-and-its-behaviour-with-a-u&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#exaws-and-its-behaviour-with-a-u&quot; aria-label=&quot;Anchor link for: exaws-and-its-behaviour-with-a-u&quot;&gt;ExAws and Its Behaviour (With a &quot;U&quot;)&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;To interact with AWS in our Elixir services we use &lt;a href=&quot;https://github.com/ex-aws/ex_aws&quot;&gt;ExAws&lt;/a&gt; and its plethora of service libraries. I generally like ExAws but lately found a not-very-advertised feature that I &lt;em&gt;love&lt;/em&gt;. I suspect it&apos;s not even intended for the purpose we&apos;re going to use it for here, but it fits like a glove.&lt;/p&gt;&lt;p&gt;ExAws&apos;s architecture is essentially made of a main ExAws library which contains code to make generic HTTP requests to various AWS services. On top of that, there are many service-specific libraries (such as &lt;a href=&quot;https://github.com/ex-aws/ex_aws_s3&quot;&gt;ex_aws_s3&lt;/a&gt;). These libraries usually define &lt;strong&gt;operations&lt;/strong&gt; that implement the &lt;a href=&quot;https://hexdocs.pm/ex_aws/ExAws.Operation.html&quot;&gt;&lt;code&gt;ExAws.Operation&lt;/code&gt;&lt;/a&gt; behaviour. Operations are just data structures. The way you use ExAws is that you create operations (that is, data structures) using the service-specific libraries and execute them against AWS using the main ExAws library.&lt;/p&gt;&lt;p&gt;This is where the cool things begin. ExAws also ships with the &lt;a href=&quot;https://hexdocs.pm/ex_aws/ExAws.Behaviour.html&quot;&gt;&lt;code&gt;ExAws.Behaviour&lt;/code&gt;&lt;/a&gt; behaviour, which defines the core functionality provided by the library. Well, wouldn&apos;t you know, that core functionality is exactly the set of functions that take operations and execute them against AWS. This is the perfect architecture for test doubles.&lt;/p&gt;&lt;h3 id=&quot;test-doubles-for-exaws&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#test-doubles-for-exaws&quot; aria-label=&quot;Anchor link for: test-doubles-for-exaws&quot;&gt;Test Doubles for ExAws&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;We use &lt;a href=&quot;https://github.com/dashbitco/mox&quot;&gt;Mox&lt;/a&gt; for test doubles (well, &quot;mocks&quot; as the library calls them). In our application, we usually define a test double for &lt;code&gt;ExAws&lt;/code&gt; itself. It&apos;s as simple as the code below, which we have in a file called &lt;code&gt;test/support/mocks.ex&lt;/code&gt;. We add &lt;code&gt;test/support&lt;/code&gt; to &lt;code&gt;:elixirc_paths&lt;/code&gt; in &lt;code&gt;mix.exs&lt;/code&gt; for the &lt;code&gt;:test&lt;/code&gt; Mix environment.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Mox&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;defmock&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;ExAwsMock&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;for&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;ExAws&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Behaviour&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;In any code that executes AWS requests, we don&apos;t use &lt;code&gt;ExAws.request/1&lt;/code&gt; or &lt;code&gt;ExAws.stream/1&lt;/code&gt;. Instead, we read the module to use at compile time from our application configuration (still defaulting to &lt;code&gt;ExAws&lt;/code&gt;).&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MyApp&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-variable z-other z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-definition z-constant z-elixir&quot;&gt;@&lt;/span&gt;ex_aws_mod&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Application&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;compile_env&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;my_app&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;test_doubles&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ex_aws&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;ExAws&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;get_s3_file&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;bucket&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; path&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    operation &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;ExAws&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;S3&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;get_object&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;bucket&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; path&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-variable z-other z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-definition z-constant z-elixir&quot;&gt;@&lt;/span&gt;ex_aws_mod&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;request&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;operation&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Now, testing this is straightforward using the functionality provided by Mox.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;import&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Mox&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;setup &lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;verify_on_exit!&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;test &lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;some piece of code that uses get_s3_file/2&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  expect&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;ExAwsMock&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;request&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;fn&lt;/span&gt; operation &lt;span class=&quot;z-keyword z-operator z-other z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    assert %&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;ExAws&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Operation&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;S3&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; operation
&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    assert operation&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;http_method &lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;get&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    assert operation&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;bucket &lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;my bucket&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    assert operation&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;path &lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;expected/path&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;body&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;file contents&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  run_code&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Testing the uncommon cases is just as straightforward, since we control the value returned by the mock&apos;s function.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;expect&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;ExAwsMock&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;request&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;fn&lt;/span&gt; _operation &lt;span class=&quot;z-keyword z-operator z-other z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;error&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;http_error&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;403&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;We need little code to achieve all this. The operation data structure combined with the behaviour make it easy to build flexible test doubles that we can use to assert we are making the right calls to AWS and to control return values with precision.&lt;/p&gt;&lt;h2 id=&quot;integration-tests&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#integration-tests&quot; aria-label=&quot;Anchor link for: integration-tests&quot;&gt;Integration Tests&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Using test doubles works well in many cases, but it has one drawback that I can&apos;t get over. By using test doubles, we are &lt;em&gt;not exercising&lt;/em&gt; parts of our application code when running tests. Achieving 100% code coverage and exercising every single production code line when testing is not easy. Often, it&apos;s not worth it either. However, testing the interactions with AWS only in the running production code seems a bit too far on the other end.&lt;/p&gt;&lt;p&gt;Luckily, for this particular use case there&apos;s a pretty fantastic tool called &lt;a href=&quot;https://localstack.cloud/&quot;&gt;Localstack&lt;/a&gt;. Localstack provides a faithful replica of AWS itself, but running locally. It fits this use case perfectly (it was kind of built for local integration testing, you could say).&lt;/p&gt;&lt;p&gt;Just a note here: before Localstack, we sometimes used to use &lt;a href=&quot;https://github.com/parroty/exvcr&quot;&gt;ExVCR&lt;/a&gt; to perform this sort of more integration tests. ExVCR lets you &lt;em&gt;record HTTP requests&lt;/em&gt; and make sure that your requests conform to the recorded real requests. It can work well in some cases, but for AWS it didn&apos;t give us the flexibility of quickly changing the way we interface with AWS itself. On top of that, ExVCR is ultimately still defining test doubles under the hood, so we are still not exercising the real ExAws HTTP code.&lt;/p&gt;&lt;h3 id=&quot;running-localstack&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#running-localstack&quot; aria-label=&quot;Anchor link for: running-localstack&quot;&gt;Running Localstack&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;We use &lt;a href=&quot;https://www.docker.com/&quot;&gt;Docker&lt;/a&gt; for running our production application, so we are heavily invested in the Docker ecosystem on our local machines too. We already use Docker and &lt;a href=&quot;https://docs.docker.com/compose/&quot;&gt;Docker Compose&lt;/a&gt; locally to spin up infrastructure needed by the services we work on. A typical &lt;code&gt;docker-compose.yml&lt;/code&gt; file in one of our services looks like this:&lt;/p&gt;&lt;pre data-lang=&quot;yaml&quot; class=&quot;language-yaml z-code&quot;&gt;&lt;code class=&quot;language-yaml&quot; data-lang=&quot;yaml&quot;&gt;&lt;span class=&quot;z-source z-yaml&quot;&gt;&lt;span class=&quot;z-string z-unquoted z-plain z-out z-yaml&quot;&gt;&lt;span class=&quot;z-entity z-name z-tag z-yaml&quot;&gt;version&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-key-value z-mapping z-yaml&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-yaml&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-yaml&quot;&gt;&amp;quot;&lt;/span&gt;3&lt;span class=&quot;z-punctuation z-definition z-string z-end z-yaml&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-yaml&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-yaml&quot;&gt;&lt;span class=&quot;z-string z-unquoted z-plain z-out z-yaml&quot;&gt;&lt;span class=&quot;z-entity z-name z-tag z-yaml&quot;&gt;services&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-key-value z-mapping z-yaml&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-yaml&quot;&gt;&lt;span class=&quot;z-string z-unquoted z-plain z-out z-yaml&quot;&gt;&lt;span class=&quot;z-entity z-name z-tag z-yaml&quot;&gt;event-bus&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-key-value z-mapping z-yaml&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-yaml&quot;&gt;&lt;span class=&quot;z-string z-unquoted z-plain z-out z-yaml&quot;&gt;&lt;span class=&quot;z-entity z-name z-tag z-yaml&quot;&gt;image&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-key-value z-mapping z-yaml&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-string z-unquoted z-plain z-out z-yaml&quot;&gt;our-rabbitmq-image&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-yaml&quot;&gt;&lt;span class=&quot;z-string z-unquoted z-plain z-out z-yaml&quot;&gt;&lt;span class=&quot;z-entity z-name z-tag z-yaml&quot;&gt;ports&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-key-value z-mapping z-yaml&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-yaml&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-block z-sequence z-item z-yaml&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-yaml&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-yaml&quot;&gt;&amp;quot;&lt;/span&gt;5672:5672&lt;span class=&quot;z-punctuation z-definition z-string z-end z-yaml&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-yaml&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-block z-sequence z-item z-yaml&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-yaml&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-yaml&quot;&gt;&amp;quot;&lt;/span&gt;15672:15672&lt;span class=&quot;z-punctuation z-definition z-string z-end z-yaml&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-yaml&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-yaml&quot;&gt;&lt;span class=&quot;z-string z-unquoted z-plain z-out z-yaml&quot;&gt;&lt;span class=&quot;z-entity z-name z-tag z-yaml&quot;&gt;redis&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-key-value z-mapping z-yaml&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-yaml&quot;&gt;&lt;span class=&quot;z-string z-unquoted z-plain z-out z-yaml&quot;&gt;&lt;span class=&quot;z-entity z-name z-tag z-yaml&quot;&gt;image&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-key-value z-mapping z-yaml&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-yaml&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-yaml&quot;&gt;&amp;quot;&lt;/span&gt;redis:5.0-alpine&lt;span class=&quot;z-punctuation z-definition z-string z-end z-yaml&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-yaml&quot;&gt;&lt;span class=&quot;z-string z-unquoted z-plain z-out z-yaml&quot;&gt;&lt;span class=&quot;z-entity z-name z-tag z-yaml&quot;&gt;ports&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-key-value z-mapping z-yaml&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-yaml&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-block z-sequence z-item z-yaml&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-yaml&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-yaml&quot;&gt;&amp;quot;&lt;/span&gt;6379:6379&lt;span class=&quot;z-punctuation z-definition z-string z-end z-yaml&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;You can run Localstack in a few different ways, but for us the natural fit is to add it as an infrastructure dependency in the &lt;code&gt;docker-compose.yml&lt;/code&gt; file.&lt;/p&gt;&lt;pre data-lang=&quot;yaml&quot; class=&quot;language-yaml z-code&quot;&gt;&lt;code class=&quot;language-yaml&quot; data-lang=&quot;yaml&quot;&gt;&lt;span class=&quot;z-source z-yaml&quot;&gt;&lt;span class=&quot;z-string z-unquoted z-plain z-out z-yaml&quot;&gt;&lt;span class=&quot;z-entity z-name z-tag z-yaml&quot;&gt;localstack&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-key-value z-mapping z-yaml&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-yaml&quot;&gt;&lt;span class=&quot;z-string z-unquoted z-plain z-out z-yaml&quot;&gt;&lt;span class=&quot;z-entity z-name z-tag z-yaml&quot;&gt;image&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-key-value z-mapping z-yaml&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-string z-unquoted z-plain z-out z-yaml&quot;&gt;localstack/localstack&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-yaml&quot;&gt;&lt;span class=&quot;z-string z-unquoted z-plain z-out z-yaml&quot;&gt;&lt;span class=&quot;z-entity z-name z-tag z-yaml&quot;&gt;environment&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-key-value z-mapping z-yaml&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-yaml&quot;&gt;&lt;span class=&quot;z-string z-unquoted z-plain z-out z-yaml&quot;&gt;&lt;span class=&quot;z-entity z-name z-tag z-yaml&quot;&gt;AWS_DEFAULT_REGION&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-key-value z-mapping z-yaml&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-yaml&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-yaml&quot;&gt;&amp;quot;&lt;/span&gt;us-west-2&lt;span class=&quot;z-punctuation z-definition z-string z-end z-yaml&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-yaml&quot;&gt;&lt;span class=&quot;z-string z-unquoted z-plain z-out z-yaml&quot;&gt;&lt;span class=&quot;z-entity z-name z-tag z-yaml&quot;&gt;SERVICES&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-key-value z-mapping z-yaml&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-yaml&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-yaml&quot;&gt;&amp;quot;&lt;/span&gt;s3,sqs&lt;span class=&quot;z-punctuation z-definition z-string z-end z-yaml&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-yaml&quot;&gt;&lt;span class=&quot;z-string z-unquoted z-plain z-out z-yaml&quot;&gt;&lt;span class=&quot;z-entity z-name z-tag z-yaml&quot;&gt;EDGE_PORT&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-key-value z-mapping z-yaml&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-yaml&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-yaml&quot;&gt;&amp;quot;&lt;/span&gt;4566&lt;span class=&quot;z-punctuation z-definition z-string z-end z-yaml&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-yaml&quot;&gt;&lt;span class=&quot;z-string z-unquoted z-plain z-out z-yaml&quot;&gt;&lt;span class=&quot;z-entity z-name z-tag z-yaml&quot;&gt;ports&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-key-value z-mapping z-yaml&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-yaml&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-block z-sequence z-item z-yaml&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-yaml&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-yaml&quot;&gt;&amp;quot;&lt;/span&gt;4566:4566&lt;span class=&quot;z-punctuation z-definition z-string z-end z-yaml&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;As you can see, Localstack uses the &lt;code&gt;SERVICES&lt;/code&gt; environment variable configure which services to make available. In this case, we specified AWS S3 and AWS SQS.&lt;/p&gt;&lt;p&gt;We can now spin up local infrastructure the same way we did before, with &lt;code&gt;docker compose up&lt;/code&gt;. AWS S3 and AWS SQS are running locally, which is pretty cool.&lt;/p&gt;&lt;h3 id=&quot;pointing-exaws-to-localstack&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#pointing-exaws-to-localstack&quot; aria-label=&quot;Anchor link for: pointing-exaws-to-localstack&quot;&gt;Pointing ExAws to Localstack&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Next step is configuring ExAws to talk to the local Localstack running instance.&lt;/p&gt;&lt;p&gt;To do that, we add some configuration to &lt;code&gt;config/test.exs&lt;/code&gt; that only takes affect in the &lt;code&gt;:test&lt;/code&gt; Mix environment. You could easily adapt this to work similarly in the &lt;code&gt;:dev&lt;/code&gt; environment if you wanted to.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; In config/test.exs
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;aws_uri &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;get_env&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;AWS_ENDPOINT_URL&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;http://localhost:4566&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-pipe z-elixir&quot;&gt;|&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;URI&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;parse&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;for&lt;/span&gt; service &lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;s3&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;sqs&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  config &lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ex_aws&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; service&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;scheme&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; aws_uri&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;scheme&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;host&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; aws_uri&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;host&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;port&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; aws_uri&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;port&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; You might also want to set bogus credentials:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;access_key_id&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;my-key-id&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;secret_access_key&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;my-secret-key&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;We&apos;re now almost ready to run some integration tests by talking to the local Localstack.&lt;/p&gt;&lt;h3 id=&quot;bypassing-the-exaws-test-double&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#bypassing-the-exaws-test-double&quot; aria-label=&quot;Anchor link for: bypassing-the-exaws-test-double&quot;&gt;Bypassing the ExAws Test Double&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Remember that in our code we read the ExAws module to use &lt;strong&gt;at compile time&lt;/strong&gt;.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-variable z-other z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-definition z-constant z-elixir&quot;&gt;@&lt;/span&gt;ex_aws_mod&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Application&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;compile_env&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;my_app&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;test_doubles&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ex_aws&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;ExAws&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;This means that we cannot use &lt;code&gt;ExAws&lt;/code&gt; as the module, because &lt;code&gt;@ex_aws_mod&lt;/code&gt; has been &lt;em&gt;compiled&lt;/em&gt; to &lt;code&gt;ExAwsMock&lt;/code&gt; in the test environment. This is great for performance since we don&apos;t need any runtime lookup to retrieve the ExAws module in production, so we&apos;re not really willing to change this approach.&lt;/p&gt;&lt;p&gt;Luckily, Mox ships with the perfect feature for this: the &lt;a href=&quot;https://hexdocs.pm/mox/Mox.html#stub_with/2&quot;&gt;&lt;code&gt;stub_with/2&lt;/code&gt; function&lt;/a&gt;. This function tells mock to call out to another module when defining the stubs for all the functions in the given module. The only requirement is that both the mock module passed as the first argument as well as the module passed as the second argument implement the same behaviour. Well, &lt;code&gt;ExAws&lt;/code&gt; implements the &lt;code&gt;ExAws.Behaviour&lt;/code&gt; already. The world is smiling upon us all here.&lt;/p&gt;&lt;p&gt;In integration tests that want to talk to the local Localstack instead of defining stubs and mocks for &lt;code&gt;ExAws&lt;/code&gt; functions, we do this:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;setup &lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Mox&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;stub_with&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;ExAwsMock&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;ExAws&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;This effectively &quot;resets&quot; the ExAws mock to use ExAws itself. To make this a little more streamlined, we can define this as a test helper function and use it similarly to how we use &lt;code&gt;setup :verify_on_exit!&lt;/code&gt; from Mox.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; In test_helpers.exs (or wherever you define your test helpers)
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;TestHelpers&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;use_real_ex_aws&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;_ex_unit_context&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Mox&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;stub_with&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;ExAwsMock&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;ExAws&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; In tests
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MyTest&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;use&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;ExUnit&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Case&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;import&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;TestHelpers&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  setup &lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;use_real_ex_aws&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; ...
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&quot;data-setup-and-teardown&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#data-setup-and-teardown&quot; aria-label=&quot;Anchor link for: data-setup-and-teardown&quot;&gt;Data Setup and Teardown&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;One missing piece of the puzzle here is that, when using Localstack, we need to manually perform some test setup and teardown. When using test doubles, we can decide &quot;on the fly&quot; what to return from the stub or mock functions, without having to &lt;em&gt;prepare&lt;/em&gt; the test doubles in any way. With Localstack, we need to perform all the necessary AWS setup and data setup (and teardown) in order for our tests to test something.&lt;/p&gt;&lt;p&gt;For example, imagine you want to test how your code retrieves a file from AWS S3 and writes its contents to a local file. To do that, you&apos;ll have to:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;Create a bucket in Localstack&apos;s S3&lt;/li&gt;&lt;li&gt;Write a file to that bucket&lt;/li&gt;&lt;li&gt;Exercise your code and run assertions&lt;/li&gt;&lt;li&gt;Likely, delete the bucket to clean up for other tests to run&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;These steps vary for different configurations and test architectures, but you get the idea. To do the setup and teardown, we just use ExAws directly and manually create the topology we want in the AWS services. For the S3 example above, we would do something like this:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;test &lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;reading a file and writing it out&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; Create some random bytes to store in the file.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  contents &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;crypto&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;strong_rand_bytes&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; We set up an on_exit callback to empty and then delete the bucket
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; when the test exit, so that the next test has a clean slate.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  on_exit&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;fn&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-other z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;test-bucket&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-pipe z-elixir&quot;&gt;|&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;ExAws&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;S3&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;list_objects&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-pipe z-elixir&quot;&gt;|&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;ExAws&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;stream!&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-pipe z-elixir&quot;&gt;|&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Enum&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;each&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&amp;amp;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;ExAws&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;request!&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;ExAws&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;S3&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;delete_object&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;test-bucket&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-capture z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-capture z-elixir&quot;&gt;&amp;amp;&lt;/span&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;key&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;ExAws&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;request!&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;ExAws&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;S3&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;delete_bucket&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;test-bucket&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; Create bucket.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;ExAws&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;request!&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;ExAws&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;S3&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;put_bucket&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;test-bucket&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;us-west-2&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; Upload a file.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;ExAws&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;request!&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;ExAws&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;S3&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;put_object&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;test-bucket&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;my/random/file&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; contents&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; Now, we run our code and assert on its behavior.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MyApp&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;download_s3_file!&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;test-bucket&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;my/random/file&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;to&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;localfile&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  assert &lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;read!&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;localfile&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;==&lt;/span&gt; contents
&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&quot;conclusion&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#conclusion&quot; aria-label=&quot;Anchor link for: conclusion&quot;&gt;Conclusion&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;In this post we saw how ExAws provides the perfect functionality for easily writing integration tests using Localstack as well as defining test doubles for precise controls of behavior in testing. If you want to dig deeper into integration testing with Elixir, test doubles, end-to-end tests, and more, check out &lt;a href=&quot;https://pragprog.com/titles/lmelixir/testing-elixir/&quot;&gt;Testing Elixir&lt;/a&gt;, the book I co-wrote with &lt;a href=&quot;https://twitter.com/idlehands&quot;&gt;Jeffrey Matthias&lt;/a&gt;.&lt;/p&gt;&lt;p&gt;Remember to check out the &lt;a href=&quot;https://github.com/whatyouhide/testing_aws_in_elixir&quot;&gt;repository&lt;/a&gt; that contains all the code and techniques discussed in this post if you want to see it all in action.&lt;/p&gt;</content>
    
    </entry>
  
    <entry>
      <id>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;posts&#x2F;example-based-tests-and-property-based-tests-are-best-friends&#x2F;</id>
      <title type="html"><![CDATA[ Example-based Tests And Property-based Tests Are Good Friends ]]></title>
      <link rel="alternate"
            type="text/html"
            href="https://andrealeopardi.com/posts/example-based-tests-and-property-based-tests-are-best-friends/"
            title="Example-based Tests And Property-based Tests Are Good Friends" />
      <published>2022-01-09T00:00:00+00:00</published>
      <author>
        <name>Andrea Leopardi</name>
        <uri>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;</uri>
        <email>hi@andrealeopardi.com</email>
      </author>
      <updated>2022-01-09T00:00:00+00:00</updated>
      <summary type="html">&lt;p&gt;I mostly use property-based testing to test stateless functional code. A technique I love to use is to pair property-based tests together with &lt;em&gt;example-based tests&lt;/em&gt; (that is, &quot;normal&quot; tests) in order to have some tests that check real input. Let&apos;s dive deeper into this technique, some contrived blog-post-adequate examples, and links to real-world examples.&lt;/p&gt;</summary>
    
      <content type="html">&lt;p&gt;I mostly use property-based testing to test stateless functional code. A technique I love to use is to pair property-based tests together with &lt;em&gt;example-based tests&lt;/em&gt; (that is, &quot;normal&quot; tests) in order to have some tests that check real input. Let&apos;s dive deeper into this technique, some contrived blog-post-adequate examples, and links to real-world examples.&lt;/p&gt;&lt;span id=&quot;continue-reading&quot;&gt;&lt;/span&gt;&lt;p&gt;&lt;img src=&quot;https://andrealeopardi.com/posts/example-based-tests-and-property-based-tests-are-best-friends/cover-image.jpg&quot; alt=&quot;Cover image of just a bunch of pencils&quot; /&gt;&lt;/p&gt;&lt;span class=&quot;unsplash-credit&quot;&gt;
    Photo by &lt;a href=&quot;https:&amp;#x2F;&amp;#x2F;unsplash.com&amp;#x2F;@dtpennington?utm_source=unsplash&amp;amp;utm_medium=referral&amp;amp;utm_content=creditCopyText&quot;&gt;David Pennington&lt;/a&gt; on &lt;a href=&quot;https://unsplash.com&quot;&gt;Unsplash&lt;/a&gt;&lt;/span&gt;&lt;p&gt;I&apos;ve been a vocal advocate of property-based testing for a while. I wrote &lt;a href=&quot;https://github.com/whatyouhide/stream_data&quot;&gt;&lt;code&gt;stream_data&lt;/code&gt;&lt;/a&gt;, a property-based testing framework for Elixir, &lt;a href=&quot;https://www.youtube.com/watch?v=p84DMv8TQuo&quot;&gt;gave talks about the topic&lt;/a&gt;, and used property-based testing at work and in my open-source software (such as &lt;a href=&quot;https://github.com/whatyouhide/corsica/blob/a4328f6bae1ccdaeb6d9fed14263c5c5a43540a6/test/properties_test.exs&quot;&gt;Corsica&lt;/a&gt; or &lt;a href=&quot;https://github.com/whatyouhide/redix/blob/53216ab4ba96ceceb3e963faca02e2bf25abdb9a/test/redix/protocol_test.exs&quot;&gt;Redix&lt;/a&gt;).&lt;/p&gt;&lt;p&gt;The most common way I use property-based testing is to test &lt;em&gt;stateless&lt;/em&gt; pieces of code. These tend to be the easiest to come up with properties for.&lt;/p&gt;&lt;p&gt;In this short post, I want to talk about one of my favorite techniques to use when writing property-based tests: mixing properties with explicit &quot;example-based&quot; tests. Example-based tests are the tests you&apos;re used to, where you have some predefined inputs and expected respective outputs and assert that your code matches the inputs to the outputs.&lt;/p&gt;&lt;p&gt;The idea behind this technique is to combine the ability of property-based testing to test a wide range of input data together with some practical example-based tests that ensure that our code behaves as expected on real inputs.&lt;/p&gt;&lt;h2 id=&quot;diving-into-an-example&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#diving-into-an-example&quot; aria-label=&quot;Anchor link for: diving-into-an-example&quot;&gt;Diving Into an Example&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;I use this technique quite often. Recently, I used this when writing tests for some JSON-related code in the &lt;a href=&quot;https://github.com/elixir-protobuf/protobuf&quot;&gt;Protobuf library for Elixir&lt;/a&gt; that I help maintain. Let&apos;s take this as the main example.&lt;/p&gt;&lt;p&gt;We&apos;re writing a function called &lt;code&gt;parse_nanoseconds/1&lt;/code&gt; with this spec:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-variable z-other z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-definition z-constant z-elixir&quot;&gt;@&lt;/span&gt;spec&lt;/span&gt; parse_nanoseconds&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;t&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt; :: &lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-elixir&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;999_999_999&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;t&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Its job is to:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;take a string&lt;/li&gt;&lt;li&gt;extract the leading one to nine digits from it&lt;/li&gt;&lt;li&gt;parse those digits into an integer that represents conventional nanoseconds in a timestamp&lt;/li&gt;&lt;li&gt;return the parsed integer alongside whatever&apos;s left of the original string (similar to &lt;a href=&quot;https://hexdocs.pm/elixir/Integer.html#parse/1&quot;&gt;&lt;code&gt;Integer.parse/2&lt;/code&gt;&lt;/a&gt;)&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;For example, &lt;code&gt;123&lt;/code&gt; means 123 &lt;em&gt;milliseconds&lt;/em&gt;, so &lt;code&gt;123_000_000&lt;/code&gt; nanoseconds. &lt;code&gt;000_001&lt;/code&gt; means one microsecond, &lt;code&gt;000_000_001&lt;/code&gt; means one nanosecond. You get the idea. By the way, see what I did just now? I just showed you some &lt;strong&gt;examples&lt;/strong&gt; of how the function should behave. These make perfect material for our example-based tests.&lt;/p&gt;&lt;h3 id=&quot;designing-the-properties&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#designing-the-properties&quot; aria-label=&quot;Anchor link for: designing-the-properties&quot;&gt;Designing the Properties&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Thinking about properties that hold for the output of this function given a valid input, here&apos;s what I got.&lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;p&gt;For valid strings of nine or fewer digits, the output of &lt;code&gt;parse_nanoseconds/1&lt;/code&gt; must be an integer in the range &lt;code&gt;0..999_999_999&lt;/code&gt;.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;For any string of nine or fewer digits followed by any string &lt;code&gt;trail&lt;/code&gt;, &lt;code&gt;trail&lt;/code&gt; should be returned untouched.&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;I encoded these into a single &lt;code&gt;property&lt;/code&gt; test (this uses &lt;code&gt;stream_data&lt;/code&gt;):&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MyTest&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;use&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;ExUnit&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Case&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;use&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;ExUnitProperties&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  property &lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;returns valid nanoseconds integer and trailing string&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; Generator that generates strings of 1 to 9 digits.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    nanos_prefix_gen &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; string&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;?0&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-elixir&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;?9&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;min_length&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;max_length&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;9&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    check all nanos &lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;&amp;lt;-&lt;/span&gt; nanos_prefix_gen&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;              rest &lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;&amp;lt;-&lt;/span&gt; string&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;printable&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;              string &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; nanos &lt;span class=&quot;z-keyword z-operator z-binary-concatenation z-elixir&quot;&gt;&amp;lt;&amp;gt;&lt;/span&gt; rest &lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;      assert &lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;parsed_nanos&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; parsed_rest&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; parse_nanoseconds&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;string&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;      assert parsed_nanos &lt;span class=&quot;z-keyword z-operator z-elixir&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-elixir&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;999_999_999&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;      assert parse_rest &lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;==&lt;/span&gt; rest
&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Now for the catch: we can write a bunch of implementations of &lt;code&gt;parse_nanoseconds/1&lt;/code&gt; that satisfy this property with no issue, but that are &lt;strong&gt;semantically wrong&lt;/strong&gt;. A contrived, slightly-weird, but effective example is below.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; Sneaky implementation that is wrong but satisfies our properties:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;parse_nanoseconds&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;string&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;case&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Regex&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;split&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-storage z-type z-string z-elixir&quot;&gt;~r&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-interpolated z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-escape-sequence z-regexp z-elixir&quot;&gt;\d&lt;/span&gt;&lt;span class=&quot;z-meta z-quantifier z-regexp z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-quantifier z-regexp z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-quantifier z-begin z-regexp z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-quantifier z-min z-regexp z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-quantifier z-regexp z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-quantifier z-max z-regexp z-elixir&quot;&gt;9&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-quantifier z-end z-regexp z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;/&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; string&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;parts&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; rest&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; rest&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    _other &lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;error&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The implementation above uses a regex to split the string in two parts on the first occurrence of one to nine digits. The &lt;code&gt;[&quot;&quot;, rest]&lt;/code&gt; match means that the string was split at the start, so a sequence of digits was found at the start. To keep getting weirder, we&apos;re just returning &lt;code&gt;0&lt;/code&gt; as the nanoseconds. Seems crazy, but guess what? It passes our property. Yeah.&lt;/p&gt;&lt;h3 id=&quot;reintroducing-example-based-tests&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#reintroducing-example-based-tests&quot; aria-label=&quot;Anchor link for: reintroducing-example-based-tests&quot;&gt;Reintroducing Example-Based Tests&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Are property-based tests bad? Should we go back to example-based tests and curse the day we thought to use something cool? Well, what I like to do is reintroduce example-based tests to save the day but keep the property-based tests to get all the benefits from those.&lt;/p&gt;&lt;p&gt;I turned the property above into this:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;property &lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;returns a valid nanoseconds integer and the trailing string&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; Example-based part:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  assert parse_nanoseconds&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;123foo&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;123_000_000&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;foo&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  assert parse_nanoseconds&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;000000001&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; Property part (unchanged):
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  nanos_prefix_gen &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; string&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;?0&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-elixir&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;?9&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;min_length&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;max_length&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;9&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  check all nanos &lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;&amp;lt;-&lt;/span&gt; nanos_prefix_gen&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;            rest &lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;&amp;lt;-&lt;/span&gt; string&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;printable&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;            string &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; nanos &lt;span class=&quot;z-keyword z-operator z-binary-concatenation z-elixir&quot;&gt;&amp;lt;&amp;gt;&lt;/span&gt; rest &lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    assert &lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;parsed_nanos&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; parsed_rest&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; parse_nanoseconds&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;string&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    assert parsed_nanos &lt;span class=&quot;z-keyword z-operator z-elixir&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-elixir&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;999_999_999&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    assert parse_rest &lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;==&lt;/span&gt; rest
&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;With just a couple of example-based assertions thrown in there, the bogus implementation crumbles and fails miserably.&lt;/p&gt;&lt;p&gt;I sometimes keep the example-based assertions in the &lt;code&gt;property&lt;/code&gt; itself and other times prefer to split them up, but the principle stays the same.&lt;/p&gt;&lt;h3 id=&quot;regressions&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#regressions&quot; aria-label=&quot;Anchor link for: regressions&quot;&gt;Regressions&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Another fantastic use case for using example-based tests together with property-based tests is testing &lt;strong&gt;regressions&lt;/strong&gt;. &lt;code&gt;stream_data&lt;/code&gt; (and I&apos;m sure other property-based testing frameworks) often gets feature requests to specify some explicit values in generators. This way, users can be sure that the property they&apos;re encoding will go through some known values that are likely to create issues because of the domain or that caused regressions in the past. My answer is always that this is exactly where the technique described in this blog post comes in handy. You can write your property and pair it up with example-based tests that test your explicit values.&lt;/p&gt;&lt;h2 id=&quot;conclusion&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#conclusion&quot; aria-label=&quot;Anchor link for: conclusion&quot;&gt;Conclusion&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;This technique is simple, but I find it effective and practical. You get the benefits of property-based testing, like covering a wide range of inputs and discovering unhandled corner cases, but pair those with some practical examples. Those can provide you with some &quot;sanity checks&quot; to have at least some confidence that your code is doing what it&apos;s supposed to on real-world examples. Those example-based tests can also cover well-known &quot;problematic&quot; values of your input space as well as regressions.&lt;/p&gt;&lt;p&gt;If you are curious about actual examples, go look at the &lt;a href=&quot;https://github.com/elixir-protobuf/protobuf/blob/00144b3a08aac7a38e3e9774a438dcc7da3d8bc7/test/protobuf/json/utils_test.exs&quot;&gt;actual tests in the Protobuf library&lt;/a&gt;.&lt;/p&gt;&lt;p&gt;I wrote a bit more about this technique and in general about property-based testing in &lt;a href=&quot;https://pragprog.com/titles/lmelixir/testing-elixir/&quot;&gt;Testing Elixir&lt;/a&gt;, the Pragmatic Programmers book I co-authored with Jeffrey Matthias.&lt;/p&gt;</content>
    
    </entry>
  
    <entry>
      <id>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;posts&#x2F;rpc-over-rabbitmq-with-elixir&#x2F;</id>
      <title type="html"><![CDATA[ RPC over RabbitMQ (with Elixir) ]]></title>
      <link rel="alternate"
            type="text/html"
            href="https://andrealeopardi.com/posts/rpc-over-rabbitmq-with-elixir/"
            title="RPC over RabbitMQ (with Elixir)" />
      <published>2020-11-23T00:00:00+00:00</published>
      <author>
        <name>Andrea Leopardi</name>
        <uri>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;</uri>
        <email>hi@andrealeopardi.com</email>
      </author>
      <updated>2020-11-23T00:00:00+00:00</updated>
      <summary type="html">&lt;p&gt;At &lt;a href=&quot;https://www.community.com&quot;&gt;Community&lt;/a&gt;, we use &lt;a href=&quot;https://www.rabbitmq.com&quot;&gt;RabbitMQ&lt;/a&gt;, a lot. It&apos;s the infrastructure backbone that allows our services (over forty at this point) to communicate with each other. That mostly happens through &lt;strong&gt;events&lt;/strong&gt; (since we have an event-sourced system), but in some cases what we need is a &lt;em&gt;request-response&lt;/em&gt; interaction between two services. This is the best tool in a few use cases, like retrieving data on the fly or asking a service to do something and return a response. An industry standard for such interactions is HTTP, but we are not big fans of that. Instead, since RabbitMQ is so ubiquitous in our system, we settled on using it for request-response interactions as well in the form of &lt;strong&gt;Remote Procedure Calls&lt;/strong&gt; (RPCs). In this post, I&apos;ll go over the architecture of such interactions. I&apos;ll talk about the RabbitMQ topologies we use to make them work, the benefits around reliability, the compromises around performance, and finally how this all implemented to be as fault-tolerant as possible with Elixir.&lt;/p&gt;</summary>
    
      <content type="html">&lt;p&gt;At &lt;a href=&quot;https://www.community.com&quot;&gt;Community&lt;/a&gt;, we use &lt;a href=&quot;https://www.rabbitmq.com&quot;&gt;RabbitMQ&lt;/a&gt;, a lot. It&apos;s the infrastructure backbone that allows our services (over forty at this point) to communicate with each other. That mostly happens through &lt;strong&gt;events&lt;/strong&gt; (since we have an event-sourced system), but in some cases what we need is a &lt;em&gt;request-response&lt;/em&gt; interaction between two services. This is the best tool in a few use cases, like retrieving data on the fly or asking a service to do something and return a response. An industry standard for such interactions is HTTP, but we are not big fans of that. Instead, since RabbitMQ is so ubiquitous in our system, we settled on using it for request-response interactions as well in the form of &lt;strong&gt;Remote Procedure Calls&lt;/strong&gt; (RPCs). In this post, I&apos;ll go over the architecture of such interactions. I&apos;ll talk about the RabbitMQ topologies we use to make them work, the benefits around reliability, the compromises around performance, and finally how this all implemented to be as fault-tolerant as possible with Elixir.&lt;/p&gt;&lt;span id=&quot;continue-reading&quot;&gt;&lt;/span&gt;&lt;p&gt;&lt;img src=&quot;https://andrealeopardi.com/posts/rpc-over-rabbitmq-with-elixir/cover-image.jpg&quot; alt=&quot;Cover image people queuing&quot; /&gt;&lt;/p&gt;&lt;span class=&quot;unsplash-credit&quot;&gt;
    Photo by &lt;a href=&quot;https:&amp;#x2F;&amp;#x2F;unsplash.com&amp;#x2F;@amandazi_photography?utm_source=unsplash&amp;amp;utm_medium=referral&amp;amp;utm_content=creditCopyText&quot;&gt;amandazi photography&lt;/a&gt; on &lt;a href=&quot;https://unsplash.com&quot;&gt;Unsplash&lt;/a&gt;&lt;/span&gt;&lt;h2 id=&quot;what-is-an-rpc&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#what-is-an-rpc&quot; aria-label=&quot;Anchor link for: what-is-an-rpc&quot;&gt;What is an RPC&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;An RPC can be seen as a function call across system boundaries, instead of at the code execution level. An RPC allows you to call a &lt;em&gt;procedure&lt;/em&gt; on another service and treat it mostly like a local function call (with the additional error handling to account for the network interaction).&lt;/p&gt;&lt;p&gt;&lt;img src=&quot;https://andrealeopardi.com/posts/rpc-over-rabbitmq-with-elixir/sketch-rpc-definition.png&quot; alt=&quot;Sketch of caller and receiver of an RPC&quot; /&gt;&lt;/p&gt;&lt;p&gt;I won&apos;t go into too much detail about RPCs themselves, but you&apos;re probably familiar with a common form of RPC: HTTP. HTTP request-response interactions between services in a service-oriented architecture are essentially RPCs, they&apos;re just less explicit on the fact that they&apos;re &lt;em&gt;calling a procedure&lt;/em&gt;. One of the benefits of RPCs is, like HTTP, that they are agnostic of technologies. A services written in Elixir can make an RPC (or HTTP request) to a service written in Go, for example. If you want to read more about RPCs, their definition, their benefits, and more, guess where I&apos;ll link you to? Exactly, &lt;a href=&quot;https://en.wikipedia.org/wiki/Remote_procedure_call&quot;&gt;Wikipedia&lt;/a&gt;.&lt;/p&gt;&lt;p&gt;Throughout this post, I will refer to the services involved in an RPC as the &lt;strong&gt;caller service&lt;/strong&gt; and the &lt;strong&gt;receiver service&lt;/strong&gt;.&lt;/p&gt;&lt;h2 id=&quot;why-rpcs-over-rabbitmq&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#why-rpcs-over-rabbitmq&quot; aria-label=&quot;Anchor link for: why-rpcs-over-rabbitmq&quot;&gt;Why RPCs over RabbitMQ&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;At Community, we chose to do RPCs over RabbitMQ, instead of the common service-to-service communication via HTTP, for a few reasons.&lt;/p&gt;&lt;p&gt;The main reason is that we want to use message queues as often as possible. When you have a queue-based message broker between services that talk to each other, the availability requirements of the services can be less demanding. If you have two services that communicate over HTTP, then if the receiver service is down it means that the requester service will not get a response. Instead, the requester service will have to implement request retries in order to increase the chances of a successful request. With RabbitMQ in the middle, if the receiver is down then the RPC is queued and can be picked up once the receiver comes back up.&lt;/p&gt;&lt;p&gt;Another important reason that influenced our decision is that we make heavy use of RabbitMQ for all sorts of things. This means our engineer know it well, our infrastructure is solid, and we have good systems to trace and observe messages flowing through it.&lt;/p&gt;&lt;p&gt;One compromise we had to make is that, generally speaking, RPCs over RabbitMQ tend to be &lt;em&gt;slower&lt;/em&gt; than direct service-to-service communication (such as HTTP). This is hard to avoid given that in our case we have a message broker sitting between the caller service and the receiver service. That means that you&apos;ll &lt;em&gt;at least&lt;/em&gt; have twice the RTT (round-trip time) on the network, since the messages you&apos;re sending and receiving need to jump through one more hop than if you do direct service-to-service communication. However, when we do RPCs the bottleneck is rarely the network or the message broker, and instead tends to be the processing of the RPC itself. So, we&apos;re fine with the compromise here.&lt;/p&gt;&lt;h2 id=&quot;rabbitmq-topology&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#rabbitmq-topology&quot; aria-label=&quot;Anchor link for: rabbitmq-topology&quot;&gt;RabbitMQ topology&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Let&apos;s talk about the &lt;strong&gt;RabbitMQ topology&lt;/strong&gt; that powers our RPC system. We have the following components in place:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;p&gt;A &lt;em&gt;headers&lt;/em&gt; exchange called &lt;code&gt;rpc&lt;/code&gt;. Caller services publish RPCs to this exchange with two headers, &lt;code&gt;destination&lt;/code&gt; (the receiver service name) and &lt;code&gt;procedure&lt;/code&gt; (the procedure name).&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;Per-service queues where RPCs end up. Their name usually looks like &lt;code&gt;receiver_service.rpcs&lt;/code&gt;. Multiple &lt;em&gt;instances&lt;/em&gt; (nodes) of the same service share a single queue. All the running instances of the receiver service consume from this queue.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;A binding between each per-service queue and the &lt;code&gt;rpc&lt;/code&gt; exchange. Since &lt;code&gt;rpc&lt;/code&gt; is a headers exchange, the binding happens on the headers. Most commonly, receiver services bind their queue to the &lt;code&gt;rpc&lt;/code&gt; exchange on the &lt;code&gt;destination: receiver_service_name&lt;/code&gt; header, but sometimes we can be more flexible and specific by also using the &lt;code&gt;procedure&lt;/code&gt; header.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;A per-instance &lt;em&gt;response queue&lt;/em&gt; where responses to RPCs are published by the receiver service. Each &lt;em&gt;instance&lt;/em&gt; of the caller service consumes from its dedicated response queue.&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;Below is an artistic representation of the RabbitMQ topology. This one is for you, my visual friends.&lt;/p&gt;&lt;p&gt;&lt;img src=&quot;https://andrealeopardi.com/posts/rpc-over-rabbitmq-with-elixir/sketch-rabbitmq-topology.png&quot; alt=&quot;Sketch of RabbitMQ topology&quot; /&gt;&lt;/p&gt;&lt;h2 id=&quot;caller-architecture&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#caller-architecture&quot; aria-label=&quot;Anchor link for: caller-architecture&quot;&gt;Caller architecture&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Our focus when designing this architecture &lt;em&gt;was not&lt;/em&gt; performance. Since our system is event-sourced, when services need to access data &lt;em&gt;fast&lt;/em&gt;, we usually have alternatives to RPCs. In those cases, instead of fetching data from another service via RPC, a service can usually build a &quot;local&quot; data store (usually Redis, but whatever fits best) by consuming events and have fast access to that data store. However, this doesn&apos;t cover use cases where a service wants to ask another service to do something and return a result. This can be usually also be done via asynchronous events, but sometimes it really can&apos;t and in any case we like the agility of RPCs for when we&apos;re moving fast and don&apos;t want to commit to particular data exchanges in the long term.&lt;/p&gt;&lt;p&gt;Instead, we heavily focused on reliability and resource utilization. We want our RPCs to succeed whenever they can. We also want to limit RabbitMQ resource utilization as much as possible, since the message broker architecture shares the broker between all the services that use it.&lt;/p&gt;&lt;p&gt;With these goals in mind, we came up with the topology described above. In the sketch below, I&apos;m focusing on the caller service perspective.&lt;/p&gt;&lt;p&gt;&lt;img src=&quot;https://andrealeopardi.com/posts/rpc-over-rabbitmq-with-elixir/sketch-caller-architecture.png&quot; alt=&quot;Sketch of the architecture of the sender service&quot; /&gt;&lt;/p&gt;&lt;p&gt;This is what happens, step by step, when a service makes an RPC:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;p&gt;The caller assigns a new UUID to the request and encodes the request (we happen to use Protobuf, but anything would work).&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;The caller includes the name of the &lt;em&gt;response queue&lt;/em&gt; in the &lt;code&gt;reply_to&lt;/code&gt; metadata field of the RabbitMQ message.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;The caller publishes the request on the main RPC exchange (&lt;code&gt;rpc&lt;/code&gt;) using headers to specify the &lt;code&gt;destination&lt;/code&gt; and &lt;code&gt;procedure&lt;/code&gt; to call.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;If publishing the request is successful, the caller stores the request in an in-memory key-value store (ETS for Elixir and Erlang folks), storing the mapping from request ID to caller process. This is used to map responses back to requests when they come back.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;The caller has a pool of AMQP channels also consuming from the response queue. When the response comes back on such queue, a consumer channel picks it up, finds the corresponding caller process from the in-memory key-value store, and hands the caller process the response.&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;From a code standpoint, an RPC really does look like a function call. The main difference is that an RPC can &lt;em&gt;definitely&lt;/em&gt; fail due to the network interaction, so we always make sure to return a successful value or an error value. In Elixir, that translates to &lt;code&gt;{:ok, response}&lt;/code&gt; or &lt;code&gt;{:error, reason}&lt;/code&gt; tuples. In a typed language (say Haskell) it would be the &quot;either&quot; type. This is what an RPC looks like from the caller side (in Elixir-flavored pseudocode):&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;case&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;RPCPool&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;call&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;my_receiver_svc&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;add&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;args&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-map-pair z-elixir&quot;&gt;=&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;9&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;result&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-map-pair z-elixir&quot;&gt;=&amp;gt;&lt;/span&gt; result&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    result &lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt;=&amp;gt; 13
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;error&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; reason&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;raise&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;failed because: &lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-interpolation z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-interpolation z-begin z-elixir&quot;&gt;#{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-interpolation z-elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir z-embedded&quot;&gt;inspect&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;reason&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-interpolation z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt;=&amp;gt; such as :timeout
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&quot;the-response-queue&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#the-response-queue&quot; aria-label=&quot;Anchor link for: the-response-queue&quot;&gt;The response queue&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;It&apos;s worth focusing on the &lt;strong&gt;response queue&lt;/strong&gt;. All AMQP channels in the caller pool declare this queue when they start up. This is a common pattern in RabbitMQ since declaring resources (queues, exchanges, and bindings) is &lt;em&gt;idempotent&lt;/em&gt;, that is, you can do it as many times as you want with the resource being declared only once.&lt;/p&gt;&lt;p&gt;The response queue is declared with a key property: &lt;code&gt;auto_delete&lt;/code&gt;. When this property is present, RabbitMQ deletes the queue as soon as there are no channels consuming from it anymore. This is exactly the behavior we want: as long as a caller pool is &quot;up and running&quot;, there&apos;s going to be at least one channel consuming from the queue and handing responses over to caller processes. However, if the whole pool or the whole node for the caller goes down then the queue will be deleted. This works perfectly, because if the caller node goes down, then we likely lost the &quot;context&quot; of the requests, and even if the node will come back up then it won&apos;t know what to do with the responses anymore. As &lt;a href=&quot;https://www.rabbitmq.com/direct-reply-to.html&quot;&gt;one RabbitMQ documentation page&lt;/a&gt; puts it:&lt;/p&gt;&lt;blockquote&gt;&lt;p&gt;Reply messages sent using [RPC] are in general not fault-tolerant; they will be discarded if the client that published the original request subsequently disconnects. The assumption is that an RPC client will reconnect and submit another request in this case.&lt;/p&gt;&lt;/blockquote&gt;&lt;p&gt;In this way, we allow RabbitMQ to clean itself up and avoid leaving garbage in it, without writing any code to do so.&lt;/p&gt;&lt;p&gt;The code for each AMQP channel that consumes responses goes something like this:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;channel &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;AMQP&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Channel&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;open&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;amqp_connection&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; &amp;quot;response_queue&amp;quot; is determined per-pool.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; Usually it looks like: &amp;quot;caller_service.#{UUID.generate()}&amp;quot;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;AMQP&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Queue&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;declare&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;channel&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; response_queue&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;auto_delete&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;AMQP&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Basic&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;consume&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;channel&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; response_queue&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;When a response comes back, the caller does a key lookup on the response&apos;s request ID in the in-memory key-value data store to retrieve the original request and moreover the process that&apos;s waiting on the response. It looks like this:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;handle_rabbitmq_message&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;message&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  response &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; decode!&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;message&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  caller_process &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;KVStore&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;fetch&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;response&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;request_id&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  send&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;caller_process&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; response&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&quot;elixir-process-architecture&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#elixir-process-architecture&quot; aria-label=&quot;Anchor link for: elixir-process-architecture&quot;&gt;Elixir process architecture&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;The Elixir process architecture and supervision tree structure we use for the caller is based on the properties of the response queue described above. We have the following constraints:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;p&gt;If the in-memory key-value store that holds the mappings between request IDs and caller processes (ETS) crashes, we want the whole pool to crash. We wouldn&apos;t be able to map responses back to requests in any case at that point, and it&apos;s better to let RabbitMQ delete the whole response queue in such cases.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;If a connection or a channel goes down, we don&apos;t want to delete the response queue. As long as there&apos;s at least one channel consuming from the response queue, we&apos;ll be able to hand responses back to the corresponding caller processes.&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;With these constraints, we designed this supervision tree:&lt;/p&gt;&lt;p&gt;&lt;img src=&quot;https://andrealeopardi.com/posts/rpc-over-rabbitmq-with-elixir/sketch-supervision-tree.png&quot; alt=&quot;Sketch of the supervision tree&quot; /&gt;&lt;/p&gt;&lt;p&gt;It&apos;s pretty deep and nested, but a lot of it is dancing to use the right supervision strategies. We have a main supervisor for the whole caller architecture. Then, we have a pool supervisor that supervises the connections and channels. That supervisor&apos;s children are supervisors that each look over one AMQP connection and one &quot;channel supervisor&quot;. The channel supervisor supervises AMQP channels. That was hard to type, but hopefully it makes sense?&lt;/p&gt;&lt;p&gt;I won&apos;t go into detail here, but the point of this design is that if anything in that supervisor fails, the failures bubble up and cascade correctly. If there&apos;s really nothing more fun that you could do (I hardly believe that), play &quot;kill the process&quot; in your head and see what happens when you kill any process above. It&apos;s fun, if this sort of stuff is fun for you (which is a tautology).&lt;/p&gt;&lt;p&gt;The registry shown in the diagram is an Elixir &lt;code&gt;Registry&lt;/code&gt; that all AMQP channels register themselves to. This allows us to access AMQP channels fast, without going through a single pool process. I talked more about Registry-based process pools in Elixir in &lt;a href=&quot;https://andrealeopardi.com/posts/process-pools-with-elixirs-registry&quot;&gt;another blog post&lt;/a&gt;.&lt;/p&gt;&lt;p&gt;All the code in there is build on top of the &lt;a href=&quot;https://github.com/pma/amqp&quot;&gt;AMQP&lt;/a&gt; Elixir library.&lt;/p&gt;&lt;h2 id=&quot;receiver-architecture-and-topology&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#receiver-architecture-and-topology&quot; aria-label=&quot;Anchor link for: receiver-architecture-and-topology&quot;&gt;Receiver architecture and topology&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;The receiver architecture, compared to the caller, is straightforward. Every service sets up a pool of RabbitMQ connections (and channels), declares a queue, and binds it to the main RPC exchange (&lt;code&gt;rpc&lt;/code&gt;). That exchange is a &lt;em&gt;headers&lt;/em&gt; exchange, and each service usually binds the queue with the &lt;code&gt;destination&lt;/code&gt; header matching that service. For example, here&apos;s the pseudocode for the &lt;code&gt;receiver_svc&lt;/code&gt; service:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;AMQP&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Queue&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;declare&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;channel&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;receiver_svc.rpcs&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;durable&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;AMQP&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Queue&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;bind&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  channel&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;receiver_svc.rpcs&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;exchange&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;rpc&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;headers&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;destination&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;receiver_svc&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;AMQP&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Basic&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;consume&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;channel&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;receiver_svc.rpcs&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;All AMQP channels over all nodes of the receiver service declare the queue and bind it &lt;em&gt;on every startup&lt;/em&gt;. Idempotency, friends!&lt;/p&gt;&lt;p&gt;From here, it&apos;s all downhill: when a request comes in on a channel, the node decodes it, processes it, produces a response, and publishes it back on RabbitMQ. Where does it publish it? Well, good question. That&apos;s why all requests have the &lt;code&gt;reply_to&lt;/code&gt; RabbitMQ metadata field set to the reply queue of the caller. We take advantage of the default &lt;code&gt;amqp.direct&lt;/code&gt; exchange, which is pre-declared by all RabbitMQ nodes, to publish the response directly to the reply queue. The pseudocode to handle a request is this:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;response &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; process_request&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;request&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;AMQP&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Basic&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;publish&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;exchange&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;amqp.direct&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;routing_key&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; request&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;metadata&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;reply_to&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Below is a nice artsy drawing focusing on the RabbitMQ topology and interactions of the receiver service.&lt;/p&gt;&lt;p&gt;&lt;img src=&quot;https://andrealeopardi.com/posts/rpc-over-rabbitmq-with-elixir/sketch-receiver-architecture.png&quot; alt=&quot;Sketch of the pool supervision tree&quot; /&gt;&lt;/p&gt;&lt;h3 id=&quot;in-elixir-as-always-the-answer-is-broadway&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#in-elixir-as-always-the-answer-is-broadway&quot; aria-label=&quot;Anchor link for: in-elixir-as-always-the-answer-is-broadway&quot;&gt;In Elixir, as always, the answer is Broadway&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;As far as Elixir specifics goes, we use &lt;a href=&quot;https://github.com/dashbitco/broadway&quot;&gt;Broadway&lt;/a&gt; to consume RPCs, hooking it up with the &lt;a href=&quot;https://github.com/dashbitco/broadway_rabbitmq&quot;&gt;&lt;code&gt;broadway_rabbitmq&lt;/code&gt;&lt;/a&gt; producer.&lt;/p&gt;&lt;p&gt;I personally made enough changes to &lt;code&gt;broadway_rabbitmq&lt;/code&gt; by now that, look at that, it perfectly fits our use case! This is how a typical Broadway pipeline to consume RPCs looks like in our services:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MyService&lt;/span&gt;.&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;RPCConsumer&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;use&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Broadway&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;start_link&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    broadway_rabbitmq_options &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;queue&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;my_service.rpcs&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;declare&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;durable&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;bindings&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;rpc&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;arguments&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;destination&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;longstr&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;my_service&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;metadata&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;reply_to&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Broadway&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;start_link&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-elixir&quot;&gt;__MODULE__&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;name&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-elixir&quot;&gt;__MODULE__&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;producer&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;BroadwayRabbitMQ&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Producer&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; broadway_rabbitmq_options&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;processors&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;default&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;concurrency&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;handle_message&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;_&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; %&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Broadway&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Message&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; message&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; _context&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    response &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;      request
&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-pipe z-elixir&quot;&gt;|&amp;gt;&lt;/span&gt; decode_request!&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-pipe z-elixir&quot;&gt;|&amp;gt;&lt;/span&gt; process_request&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-pipe z-elixir&quot;&gt;|&amp;gt;&lt;/span&gt; encode_response!&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; This is where we publish the response.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;AMQP&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Basic&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;publish&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;      message&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;metadata&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;amqp_channel&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;exchange&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;amqp.direct&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;routing_key&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; message&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;metadata&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;reply_to&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;payload&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; response
&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    message
&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;As you can see, &lt;code&gt;broadway_rabbitmq&lt;/code&gt; exposes the AMQP channel it uses to consume under the hood in the message metadata. We use that to send replies. Easy-peasy.&lt;/p&gt;&lt;p&gt;Small disclaimer: we have a wrapper library around Broadway that makes this slightly boilerplate-y code a bit simpler and more tailored to our use case. It also provides us with some nice additions such as round-robin connection attempts over a list of RabbitMQ URLs (for reliability), automatic decoding of requests (so that the decoding is done under the hood), metrics, error reporting, and so on. However, the gist of it is exactly the code above.&lt;/p&gt;&lt;h2 id=&quot;conclusion&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#conclusion&quot; aria-label=&quot;Anchor link for: conclusion&quot;&gt;Conclusion&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;We saw how we architected a system to make service-to-service RPCs over RabbitMQ. Then, we went over the RabbitMQ topology we use, showing all the queues, exchanges, and bindings involved. Finally, we also covered the Elixir-specific implementation of this system, to sprinkle some practical examples on top of this stuff.&lt;/p&gt;&lt;p&gt;Here&apos;s some more resources on RPCs over RabbitMQ:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;p&gt;&lt;a href=&quot;https://www.rabbitmq.com/tutorials/tutorial-six-python.html&quot;&gt;RabbitMQ&apos;s tutorial&lt;/a&gt; shows a nice step-by-step implementation of RPCs over RabbitMQ using the Python client. It&apos;s a bit less complex than our architecture since the response queue doesn&apos;t get deleted when the caller stops, but it can still go a long way. They do make it clear that this is not a totally production-ready solution.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;a href=&quot;https://www.rabbitmq.com/direct-reply-to.html&quot;&gt;RabbitMQ&apos;s &quot;direct reply-to&quot; documentation&lt;/a&gt;, which shows an alternative way to do RPCs over RabbitMQ that&apos;s built-in into RabbitMQ. This solution is simpler than ours as it doesn&apos;t allow multiple consumers to get messages from a shared &lt;em&gt;response queue&lt;/em&gt;, but it&apos;s pretty cool. I learned about it while writing this blog post.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;a href=&quot;https://medium.com/swlh/scalable-microservice-architecture-using-rabbitmq-rpc-d07fa8faac32&quot;&gt;A nice blog post&lt;/a&gt; about RPC over RabbitMQ. Lots of Python code to look at.&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h2 id=&quot;acknowledgements&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#acknowledgements&quot; aria-label=&quot;Anchor link for: acknowledgements&quot;&gt;Acknowledgements&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;I need to thank my coworker and friend Tom Patterer, who designed and implemented the system with me and helps me maintain it while our architecture and needs to keep growing. I also need to thank &lt;a href=&quot;https://twitter.com/josevalim&quot;&gt;José&lt;/a&gt; because he pushed me to write this blog post when I chatted with him about all of this.&lt;/p&gt;</content>
    
    </entry>
  
    <entry>
      <id>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;posts&#x2F;process-pools-with-elixirs-registry&#x2F;</id>
      <title type="html"><![CDATA[ Process pools with Elixir&#x27;s Registry ]]></title>
      <link rel="alternate"
            type="text/html"
            href="https://andrealeopardi.com/posts/process-pools-with-elixirs-registry/"
            title="Process pools with Elixir&#x27;s Registry" />
      <published>2020-04-25T00:00:00+00:00</published>
      <author>
        <name>Andrea Leopardi</name>
        <uri>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;</uri>
        <email>hi@andrealeopardi.com</email>
      </author>
      <updated>2020-04-25T00:00:00+00:00</updated>
      <summary type="html">&lt;p&gt;When you have a limited number of resources that you have to share for your all application, like database connections or worker processes, what you need is a &lt;em&gt;pool&lt;/em&gt;. In this post, we&apos;re going to take a look at one possible pooling strategy that highly leverages Elixir&apos;s built-in &lt;a href=&quot;https://hexdocs.pm/elixir/Registry.html&quot;&gt;Registry&lt;/a&gt; resulting in fast, reliable, and cleanly designed pools.&lt;/p&gt;</summary>
    
      <content type="html">&lt;p&gt;When you have a limited number of resources that you have to share for your all application, like database connections or worker processes, what you need is a &lt;em&gt;pool&lt;/em&gt;. In this post, we&apos;re going to take a look at one possible pooling strategy that highly leverages Elixir&apos;s built-in &lt;a href=&quot;https://hexdocs.pm/elixir/Registry.html&quot;&gt;Registry&lt;/a&gt; resulting in fast, reliable, and cleanly designed pools.&lt;/p&gt;&lt;span id=&quot;continue-reading&quot;&gt;&lt;/span&gt;&lt;p&gt;&lt;img src=&quot;https://andrealeopardi.com/posts/process-pools-with-elixirs-registry/cover-image.jpg&quot; alt=&quot;Cover image of a pool&quot; /&gt;&lt;/p&gt;&lt;span class=&quot;unsplash-credit&quot;&gt;
    Photo by &lt;a href=&quot;https:&amp;#x2F;&amp;#x2F;unsplash.com&amp;#x2F;@etiennegirardet?utm_source=unsplash&amp;amp;utm_medium=referral&amp;amp;utm_content=creditCopyText&quot;&gt;Etienne Girardet&lt;/a&gt; on &lt;a href=&quot;https://unsplash.com&quot;&gt;Unsplash&lt;/a&gt;&lt;/span&gt;&lt;p&gt;There are two most common pool kinds in Elixir: &lt;strong&gt;checkout pools&lt;/strong&gt; and &lt;strong&gt;routing pools&lt;/strong&gt;. I made up those names, but let&apos;s see what I mean.&lt;/p&gt;&lt;h2 id=&quot;checkout-pools-and-routing-pools&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#checkout-pools-and-routing-pools&quot; aria-label=&quot;Anchor link for: checkout-pools-and-routing-pools&quot;&gt;Checkout pools and routing pools&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;A &lt;strong&gt;checkout pool&lt;/strong&gt; is a pool where resources are used &lt;em&gt;exclusively&lt;/em&gt; by callers. What this means is that when a caller needs a resource from the pool, it will check the resource out of the pool and will be able to use it. While the resource is checked out, then the caller is the only process that is able to use the resource at that time. When the caller is finished with the resource, it can check it back in the pool for other processes to use.&lt;/p&gt;&lt;p&gt;&lt;img src=&quot;https://andrealeopardi.com/posts/process-pools-with-elixirs-registry/sketch-checkout-pool.png&quot; alt=&quot;Sketch of a checkout pool&quot; /&gt;&lt;/p&gt;&lt;p&gt;Checkout pools are great for resources that can&apos;t be shared, like a TCP socket in passive mode, where only one process can call &lt;code&gt;:gen_tcp.recv/3&lt;/code&gt; to receive data in a blocking way. They&apos;re also great for cases where sharing a resource doesn&apos;t really bring an advantage: for example, worker pools where a worker (the resource) can only do one thing at a time. However, checkout pools limit performance and utilization of resources that &lt;em&gt;can&lt;/em&gt; be shared. An example that I really like for a good use case around checkout pools is HTTP/1 connections. Imagine you use a client like &lt;a href=&quot;https://github.com/elixir-mint/mint&quot;&gt;Mint&lt;/a&gt;, which behaves like a wrapper around a &lt;code&gt;:gen_tcp&lt;/code&gt; or &lt;code&gt;:ssl&lt;/code&gt; socket. HTTP/1 supports pipelining of requests (where you send multiple requests and await for multiple responses) but in practice it&apos;s rarely used. What clients usually do is send a request and await for the response before sending the next request. This is a natural case of &quot;doing one thing at a time&quot;, as requests can&apos;t be parallelized. In this case a checkout pool works great because it allows to &lt;em&gt;move&lt;/em&gt; the HTTP/1 connection (and socket) over to the process that makes the request. Doing so minimizes the message passing and copying of request and response data between the caller and the HTTP client.&lt;/p&gt;&lt;p&gt;A &lt;strong&gt;routing pool&lt;/strong&gt; is a pool where resources can be shared by callers. In a routing pool, the pool only acts as a &lt;em&gt;router&lt;/em&gt; to route the caller to the right resource, based on a variety of possible strategies (such as least used resource or round-robin). Resources are not checked out from the pool, so multiple callers can use the resource at the same time.&lt;/p&gt;&lt;p&gt;&lt;img src=&quot;https://andrealeopardi.com/posts/process-pools-with-elixirs-registry/sketch-routing-pool.png&quot; alt=&quot;Sketch of a routing pool&quot; /&gt;&lt;/p&gt;&lt;p&gt;This pooling strategy leads to some advantages if the resource is shareable. Some examples of shareable resources are ETS tables or TCP connections where you want to use of multiplexing (to have multiple in-flight requests and responses). In contrast with the HTTP/1 example above, a great use case for routing pools is HTTP/2 connections. HTTP/2 supports &lt;em&gt;streams&lt;/em&gt;, which are essentially requests. The difference with HTTP/1 requests is that you can have multiple streams in flight on the same connection. If you use a checkout pool for an HTTP/2 connection, then you won&apos;t be able to have multiple requests (streams) in flight from different callers and will not take advantage of this fundamental feature of the HTTP/2 design. With a routing pool, instead, you can have a pool of HTTP/2 connections and when you need to make a request the caller can be &lt;em&gt;routed&lt;/em&gt; to one connection which will send the request. Multiple callers can be routed to the &lt;em&gt;same&lt;/em&gt; connection before requests receive a response, since multiple requests can be in flight on the same connection.&lt;/p&gt;&lt;p&gt;Checkout pools tend to be more common in the Erlang and Elixir ecosystem. We have established libraries like &lt;a href=&quot;https://github.com/devinus/poolboy&quot;&gt;poolboy&lt;/a&gt; or &lt;a href=&quot;https://github.com/elixir-ecto/db_connection&quot;&gt;DBConnection&lt;/a&gt; that implement checkout pools. However, routing pools tend to be hand rolled. In this post, we&apos;re going to take a look at how we can leverage &lt;a href=&quot;https://hexdocs.pm/elixir/Registry.html&quot;&gt;Registry&lt;/a&gt; to build routing pools that can route using different strategies. Brace yourself!&lt;/p&gt;&lt;h2 id=&quot;what-we-need-before-we-go&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#what-we-need-before-we-go&quot; aria-label=&quot;Anchor link for: what-we-need-before-we-go&quot;&gt;What we need before we go&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Let&apos;s take a quick look at an example I came up with for a resource that we&apos;ll build a pool for, as well as at a small intro to what Registry is and how it works.&lt;/p&gt;&lt;h3 id=&quot;coming-up-with-a-resource-to-pool&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#coming-up-with-a-resource-to-pool&quot; aria-label=&quot;Anchor link for: coming-up-with-a-resource-to-pool&quot;&gt;Coming up with a resource to pool&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;The example we&apos;ll use to describe routing pools is a pool of GenServers that hold a TCP socket. These GenServers (let&apos;s call them &lt;code&gt;FantaTCP&lt;/code&gt;) are able to send messages over TCP according to an imaginary serialization protocol (let&apos;s call it &lt;code&gt;Fantaprotocol&lt;/code&gt;) and receive responses serialized through the same protocol. Requests have an ID so that responses for those requests can come in any order. This means that we can take advantage of a single TCP socket from multiple callers, but we can respond to callers as soon as we receive responses from the socket. Using one of these GenServers looks like this:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;FantaTCP&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;request&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;genserver_pid&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;PING&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt;=&amp;gt; {:ok, &amp;quot;PONG&amp;quot;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The implementation for &lt;code&gt;FantaTCP&lt;/code&gt; GenServers looks like this:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;FantaTCP&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;use&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;GenServer&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;start_link&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;hostname&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; port&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;GenServer&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;start_link&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-elixir&quot;&gt;__MODULE__&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;hostname&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; port&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;pid&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; request&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;GenServer&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;call&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;pid&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;request&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; request&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-variable z-other z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-definition z-constant z-elixir&quot;&gt;@&lt;/span&gt;impl&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;hostname&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; port&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;case&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;gen_tcp&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;connect&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;hostname&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; port&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; socket&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; &amp;quot;requests&amp;quot; is a map of request IDs to &amp;quot;from&amp;quot;s
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; (callers from handle_call/3). See handle_call/3.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;socket&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; _requests &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;error&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; reason&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;stop&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; reason&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;handle_call&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;request&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; request&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; from&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;socket&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; requests&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; We build the request ID.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    id &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; make_id&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;gen_tcp&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;send&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;socket&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Fantaprotocol&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;encode&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;id&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; request&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; We store the &amp;quot;from&amp;quot; under the request ID so we&amp;#39;ll know
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; who to reply to. We don&amp;#39;t reply right away so that we can
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; send other requests while the response for this request comes back.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;noreply&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;socket&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Map&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;put&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;requests&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; id&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; from&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; Let&amp;#39;s pretend that &amp;quot;data&amp;quot; is always a complete response and can&amp;#39;t
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; have less or more data than that.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;handle_info&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;tcp&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; socket&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;socket&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; requests&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;id&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; response&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Fantaprotocol&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;decode&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;from&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; requests&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Map&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;pop!&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;requests&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; id&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;GenServer&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;reply&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;from&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; response&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;noreply&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;socket&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; requests&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;It&apos;s a bit of code, but the idea is that:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;when we get a request, we encode it and send it through TCP, and then return without sending a response to the caller&lt;/li&gt;&lt;li&gt;while waiting for a response, the caller is blocked on the &lt;code&gt;GenServer.call/2&lt;/code&gt;&lt;/li&gt;&lt;li&gt;when we get a response, we match it to the right caller and reply to that caller through &lt;code&gt;GenServer.reply/2&lt;/code&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;With this in mind, we&apos;re ready to build our first pool of &lt;code&gt;FantaTCP&lt;/code&gt;s.&lt;/p&gt;&lt;h3 id=&quot;registry-101&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#registry-101&quot; aria-label=&quot;Anchor link for: registry-101&quot;&gt;Registry 101&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;If you&apos;re not familiar with Registry, I&apos;ll give you a quick rundown. Registry is a key-value store tailored to registering PIDs under given keys. It&apos;s the same principle as when you call &lt;code&gt;Process.register(pid, :some_name)&lt;/code&gt; to register a process under a name. To use it like &lt;code&gt;Process.register/2&lt;/code&gt;, you can start it as a &lt;em&gt;unique&lt;/em&gt; registry:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;pid &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; self&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Registry&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;start_link&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;name&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;FantaRegistry&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;keys&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;unique&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Registry&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;register&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;FantaRegistry&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;some_name&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; _value &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Registry&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;lookup&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;FantaRegistry&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;some_name&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt;=&amp;gt; [{pid, nil}]
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;As you might have already noticed, you can even store an arbitrary value alongside a PID under a certain key. We&apos;ll make pretty cool uses of this later!&lt;/p&gt;&lt;p&gt;Another cool feature of Registry is that you can create a &lt;em&gt;duplicate&lt;/em&gt; registry, that is, a registry that can store multiple PID-value pairs &lt;em&gt;under the same key&lt;/em&gt;.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Registry&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;start_link&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;name&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;FantaRegistry&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;keys&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;duplicate&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; From a process with PID pid1 we call this:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Registry&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;register&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;FantaRegistry&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;cool_processes&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;cool process 1&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; From a process with PID pid2 we call this:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Registry&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;register&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;FantaRegistry&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;cool_processes&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;cool process 2&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; From whatever process:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Registry&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;lookup&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;FantaRegistry&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;cool_processes&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt;=&amp;gt; [{pid1, &amp;quot;cool process 1&amp;quot;}, {pid2, &amp;quot;cool process 2&amp;quot;}]
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;That&apos;s some cool stuff right there.&lt;/p&gt;&lt;p&gt;Since registries are smart bees, they monitor processes that are registered in them, so that if a process dies, then it will be removed from that registry.&lt;/p&gt;&lt;p&gt;Alright, we&apos;re ready to get pooling.&lt;/p&gt;&lt;h2 id=&quot;building-a-naive-registry-based-routing-pool&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#building-a-naive-registry-based-routing-pool&quot; aria-label=&quot;Anchor link for: building-a-naive-registry-based-routing-pool&quot;&gt;Building a naive Registry-based routing pool&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;For our first naive pool, we&apos;re going to use Registry like we would use the built-in process registry (the one used by &lt;code&gt;Process.register/2&lt;/code&gt;). We&apos;ll start a registry and pass it to the GenServers in the pool. Each GenServer will register itself in the registry. Let&apos;s start by looking at the changes needed in the &lt;code&gt;FantaTCP&lt;/code&gt; GenServers.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;FantaTCP&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;use&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;GenServer&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;start_link&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;hostname&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; port&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;GenServer&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;start_link&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-elixir&quot;&gt;__MODULE__&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;hostname&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; port&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-variable z-other z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-definition z-constant z-elixir&quot;&gt;@&lt;/span&gt;impl&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;hostname&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; port&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;case&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;gen_tcp&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;connect&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;hostname&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; port&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; socket&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Registry&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;register&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;FantaRegistry&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;connections&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; _value &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;socket&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; _requests &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;error&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; reason&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;stop&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; reason&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;When a &lt;code&gt;FantaTCP&lt;/code&gt; GenServer starts up, it will register itself in the given registry under the &lt;code&gt;:connections&lt;/code&gt; key. All the GenServers will register under that same key, so retrieving all the GenServers in the pool will be a matter of looking up that key in the registry.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;FantaPool&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;start_link&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;hostname&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; port&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; _&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Registry&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;start_link&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;name&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;FantaRegistry&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;keys&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;duplicate&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;for&lt;/span&gt; _ &lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-elixir&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; _&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;FantaTCP&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;start_link&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;hostname&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; port&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;request&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; &amp;quot;connections&amp;quot; is a list of {pid, nil} tuples.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    connections &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Registry&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;lookup&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;FantaRegistry&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;connections&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;pid&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; _value &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Enum&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;random&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;connections&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; Now we got &amp;quot;routed&amp;quot; to a connection to which we can send the request.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;FantaTCP&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;request&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;pid&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; request&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Here we&apos;re using &lt;code&gt;Enum.random/1&lt;/code&gt; to pick a connection from the ones registered in the registry, which means we&apos;ll do random routing. It tends to work well for many use cases since the load distribution is uniform over a decent number of requests, but we could potentially make things more complicated and use smarted strategies like round-robin.&lt;/p&gt;&lt;h3 id=&quot;supervising-the-pool-and-its-connections&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#supervising-the-pool-and-its-connections&quot; aria-label=&quot;Anchor link for: supervising-the-pool-and-its-connections&quot;&gt;Supervising the pool and its connections&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;The &lt;code&gt;FantaPool&lt;/code&gt; is a proper OTP disaster: no supervisors in sight. In this case, a single supervisor with the registry plus all the connections under it won&apos;t work. The reason is this: which supervision strategy would we pick? We want all connections to go down if the registry goes down since they become unreachable, so &lt;code&gt;:one_for_one&lt;/code&gt; is a no-go. We don&apos;t want other connections to go down if a single connection goes down (so no &lt;code&gt;:rest_for_one&lt;/code&gt;), but we also don&apos;t want &lt;em&gt;everything&lt;/em&gt; to go down if anything goes down (so no &lt;code&gt;:one_for_all&lt;/code&gt;). So, we have to go with more supervision layers: we&apos;ll have a &lt;code&gt;:rest_for_one&lt;/code&gt; supervisor supervising the registry and a &lt;em&gt;connections&apos; supervisor&lt;/em&gt;. The connections&apos; supervisor will be a &lt;code&gt;:one_for_one&lt;/code&gt; supervisor that will supervise all the connections. Now go back on this paragraph and count all the variations of the word &quot;supervisor&quot;: we&apos;re truly living the OTP life, aren&apos;t we?&lt;/p&gt;&lt;p&gt;&lt;img src=&quot;https://andrealeopardi.com/posts/process-pools-with-elixirs-registry/pool-supervision-tree.png&quot; alt=&quot;Sketch of the pool supervision tree&quot; /&gt;&lt;/p&gt;&lt;p&gt;Here&apos;s the code for the supervision tree above, with clarifying comments inline:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;FantaPool&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;use&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Supervisor&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;start_link&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;host&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; port&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Supervisor&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;start_link&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-elixir&quot;&gt;__MODULE__&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;host&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; port&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-variable z-other z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-definition z-constant z-elixir&quot;&gt;@&lt;/span&gt;impl&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;host&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; port&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    connections_specs &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;for&lt;/span&gt; index &lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-elixir&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; Since all these children will live under the same supervisor,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; they need to have different IDs. We overwrite the ID with
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; Supervisor.child_spec/2.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Supervisor&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;child_spec&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;FantaTCP&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;host&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; port&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;id&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;FantaTCP&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; index&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; Here we build the child spec for another supervisor inline, without
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; having to define a new module.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    connections_supervisor_spec &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;id&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;connections_supervisor&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;type&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;supervisor&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;start&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Supervisor&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;start_link&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;connections_specs&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;strategy&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;one_for_one&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    children &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Registry&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;name&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;FantaRegistry&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;keys&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;duplicate&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;      connections_supervisor_spec
&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Supervisor&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;init&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;children&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;strategy&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;rest_for_one&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;request&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; Same as before, with random routing
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;This code does already &lt;em&gt;a lot&lt;/em&gt;. The registry monitors registered processes, so if a connection crashes, you don&apos;t get accidentally routed to it. That is, unless you catch the moment where the connection crashes, but the registry hasn&apos;t had time to deregister the connection yet, which is pretty rare.&lt;/p&gt;&lt;h2 id=&quot;improving-our-routing-pool-by-accounting-for-disconnections&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#improving-our-routing-pool-by-accounting-for-disconnections&quot; aria-label=&quot;Anchor link for: improving-our-routing-pool-by-accounting-for-disconnections&quot;&gt;Improving our routing pool by accounting for disconnections&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;The implementation of pooling we just described works great for processes like the &lt;code&gt;FantaTCP&lt;/code&gt; GenServer. However, most connection-like processes handle disconnections gracefully by going into a &lt;em&gt;disconnected&lt;/em&gt; state. In this state, they reply with some kind of error to the caller and wait until they&apos;re reconnected (for example, to the TCP host) before accepting requests again. We can optimize our pool in these cases by &lt;em&gt;unregistering&lt;/em&gt; a connection when it disconnects from the resource (TCP) and registering it again once it reconnects. Essentially, we can a registry where every connection registered under the &lt;code&gt;:connections&lt;/code&gt; key is &lt;em&gt;connected&lt;/em&gt;. This way, when we pick a random connection we&apos;ll most likely get one that&apos;s connected and that can handle our request.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;FantaTCP&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;use&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;GenServer&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; ...
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-variable z-other z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-definition z-constant z-elixir&quot;&gt;@&lt;/span&gt;impl&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;hostname&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; port&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;case&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;gen_tcp&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;connect&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;hostname&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; port&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; socket&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Registry&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;register&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;FantaRegistry&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;connections&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; _value &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;socket&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; _requests &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;error&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; reason&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;stop&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; reason&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-variable z-other z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-definition z-constant z-elixir&quot;&gt;@&lt;/span&gt;impl&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;handle_info&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;tcp_closed&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; socket&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;socket&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; _requests&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Registry&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;unregister&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;FantaRegistry&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;connections&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; Let&amp;#39;s imagine we can send a messaeg to ourselves to reconnect in 1
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; second, without actually implementing the handle_info/2 clause.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Process&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;send_after&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;self&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;reconnect&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;noreply&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;nosocket&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; _requests &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;There&apos;s a race condition to consider: if a connection disconnects, it might take a bit before it gets notified and unregisters itself. In that time frame, our callers might be routed to the disconnected connection. This is totally fine, because connections are prepared to return an error in case they can&apos;t send the request and get a response. However, with this strategy such cases happen in very short periods of time, so we can still see substantial benefits.&lt;/p&gt;&lt;h2 id=&quot;round-robin-routing&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#round-robin-routing&quot; aria-label=&quot;Anchor link for: round-robin-routing&quot;&gt;Round-robin routing&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Wow, we&apos;ve been already through a lot. Hopefully at this point you had a glimpse of the potential of routing pools built on top of Registry. The last thing I want to sketch out is how you can build more &quot;complex&quot; routing strategies on top of what we built until now. We used the simplest routing strategy: choosing a resource at random. This requires no state and no coordination between callers of the pool. We&apos;ll look at how to build a pool that uses a round-robin routing strategy.&lt;/p&gt;&lt;p&gt;The &lt;strong&gt;round-robin&lt;/strong&gt; strategy consists in going over the list of resources in the pool in order. The first caller gets the first resource, the second caller gets the second resource, and so on. Once callers got routed to all resources in the pool, they start over from the first one. To do this, a common strategy is to keep a shared index for the pool across all callers. When a caller needs a resource, it reads the index and then increments it (both operations are performed as an atomic transaction). The index is used as the index in the list of connections to the pool.&lt;/p&gt;&lt;p&gt;Our registry-based pools have the desirable property that callers don&apos;t need to talk to a centralized pool process to get resources from the pool, but can directly read the resources from the registry. To keep this property, we&apos;ll make the shared index readable and writable across callers. The simplest tool to do that in Erlang is ETS. Alongside the registry, our pool can spin up a process whose only job is to create an ETS table and keep it alive. The code for this &quot;table owner&quot; looks something like this.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;FantaTable&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;use&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;GenServer&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;start_link&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;_opts&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;GenServer&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;start_link&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-elixir&quot;&gt;__MODULE__&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    ets &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ets&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;new&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-elixir&quot;&gt;__MODULE__&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;public&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;named_table&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; We start with -1 so that when we start incrementing the first value
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; will be 0.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ets&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;insert&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-elixir&quot;&gt;__MODULE__&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;index&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-elixir&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; ets&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Now, whenever a caller needs a resource, it can read plus increment the counter stored in the ETS table. The &lt;code&gt;:ets&lt;/code&gt; module provides a useful function to do these operations atomically: &lt;code&gt;:ets.update_counter/3&lt;/code&gt;. Let&apos;s add that as part of the API exposed by &lt;code&gt;FantaTable&lt;/code&gt;.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;FantaTable&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; ...
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;read_and_increment&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ets&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;update_counter&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-elixir&quot;&gt;__MODULE__&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; _key &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;index&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; _increment_by &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;code&gt;:ets.update_counter/3&lt;/code&gt; increments the counter under the given key by the given amount and returns the updated amount. We can now change the &lt;code&gt;FantaPool.request/1&lt;/code&gt; function that we wrote above:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;request&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; &amp;quot;connections&amp;quot; is a list of {pid, nil} tuples.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  connections &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Registry&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;lookup&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;FantaRegistry&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;connections&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  next_index &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;FantaTable&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;read_and_increment&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; We get the connection in the list at the incremented index, modulo
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; the number of connections in the list (so that we wrap around).
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;pid&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; _value &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Enum&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;at&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;connections&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; rem&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;next_index&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; length&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;connections&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; Now we got &amp;quot;routed&amp;quot; to a connection to which we can send the request.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;FantaTCP&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;request&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;pid&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; request&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;There are two tiny issues with this implementation.&lt;/p&gt;&lt;p&gt;The first one is almost non-existent: we never reset the index in the ETS table. This means that if we do &lt;em&gt;a lot&lt;/em&gt; of requests, we could potentially overflow the memory of the machine by making the index very big. In practice, if you do that many requests without restarting your node, you&apos;ll probably have other kinds of problems! It&apos;s a simple problem to fix though, since &lt;code&gt;:ets.update_counter/4&lt;/code&gt; exists. This variant of the &lt;code&gt;updated_counter&lt;/code&gt; function lets you specify a &lt;em&gt;threshold&lt;/em&gt; after which the counter should reset to a given value. That way, you can reset the counter to &lt;code&gt;0&lt;/code&gt; after you reach a high enough number.&lt;/p&gt;&lt;p&gt;The second problem is only a problem if we really stick with the definition of round-robin. Since the number of resources in our pool can vary, it might be that we have &lt;code&gt;10&lt;/code&gt; resources in the pool when we do one request but then the first two resources disconnect. Now we have &lt;code&gt;8&lt;/code&gt; resources in the pool. A caller might get the fifth resource when there&apos;s &lt;code&gt;10&lt;/code&gt; resources in the pool, but if the next caller asks for the sixth resource &lt;em&gt;after&lt;/em&gt; the first two resources disconnected, it&apos;s actually going to skip two resources and jump to the eighth resource in the original list. There are other ways to implement stricter round-robin where every resource is hit exactly once before the next one, but in practice this algorithm works fine for most use cases since often resources stay connected most of the time.&lt;/p&gt;&lt;h2 id=&quot;conclusion&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#conclusion&quot; aria-label=&quot;Anchor link for: conclusion&quot;&gt;Conclusion&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Oooph. This post was a &lt;strong&gt;large&lt;/strong&gt; one. We went over the basics of pools and the two most common kinds of pools used in the Erlang and Elixir landscape, that is, checkout pools and routing pools. Then, we set some context by describing the common use cases for a pool, with a focus on where routing pools shine and a look at a sample resource to pool (our &lt;code&gt;FantaTCP&lt;/code&gt; GenServer). After that, we had a first look at how to use Elixir&apos;s built-in Registry module to build a naive routing pool that routes randomly to connections in the pool. We then improved this pool by adding logic to handle disconnections and reconnections of resources in the pool. Finally, we looked at a &quot;smarter&quot; routing strategy, round-robin, and how to implement that on top of our pool with the help of some hand-rolled ETS moves.&lt;/p&gt;&lt;p&gt;Hopefully, this post gave you an idea of how to build this kind of pools as well as help you understand the distinction between checkout pools and routing pools (and when to use one or the other). In my experience, building pools is not a day-to-day activity, but I had the need to build something like what I described here a few times, so it&apos;s not an extremely rare thing to do either.&lt;/p&gt;&lt;p&gt;If you build something cool from this article, you&apos;re welcome to share it with me. Now let&apos;s get pooling!&lt;/p&gt;</content>
    
    </entry>
  
    <entry>
      <id>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;posts&#x2F;sharing-protobuf-schemas-across-services&#x2F;</id>
      <title type="html"><![CDATA[ Sharing Protobuf schemas across services ]]></title>
      <link rel="alternate"
            type="text/html"
            href="https://andrealeopardi.com/posts/sharing-protobuf-schemas-across-services/"
            title="Sharing Protobuf schemas across services" />
      <published>2020-02-24T00:00:00+00:00</published>
      <author>
        <name>Andrea Leopardi</name>
        <uri>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;</uri>
        <email>hi@andrealeopardi.com</email>
      </author>
      <updated>2020-02-24T00:00:00+00:00</updated>
      <summary type="html">&lt;p&gt;The system that we&apos;re building at &lt;a href=&quot;https://www.community.com&quot;&gt;Community.com&lt;/a&gt; is made of a few services (around fifteen at the time of writing) that interact with each other through a basic version of event sourcing. All events flow (published and consumed) through RabbitMQ and are serialized with &lt;a href=&quot;https://developers.google.com/protocol-buffers&quot;&gt;Protobuf&lt;/a&gt;. With several services already and many more coming in the future, managing the Protobuf schemas becomes a painful part of evolving and maintaining the system. Do we copy the schemas in all services? Do we keep them somewhere and use something akin to Git submodules to keep them in sync in all of our projects? What do we do?! In this post, I&apos;ll go through the tooling that we came up with in order to sanely manage our Protobuf schemas throughout our services and technology stack.&lt;/p&gt;</summary>
    
      <content type="html">&lt;p&gt;The system that we&apos;re building at &lt;a href=&quot;https://www.community.com&quot;&gt;Community.com&lt;/a&gt; is made of a few services (around fifteen at the time of writing) that interact with each other through a basic version of event sourcing. All events flow (published and consumed) through RabbitMQ and are serialized with &lt;a href=&quot;https://developers.google.com/protocol-buffers&quot;&gt;Protobuf&lt;/a&gt;. With several services already and many more coming in the future, managing the Protobuf schemas becomes a painful part of evolving and maintaining the system. Do we copy the schemas in all services? Do we keep them somewhere and use something akin to Git submodules to keep them in sync in all of our projects? What do we do?! In this post, I&apos;ll go through the tooling that we came up with in order to sanely manage our Protobuf schemas throughout our services and technology stack.&lt;/p&gt;&lt;span id=&quot;continue-reading&quot;&gt;&lt;/span&gt;&lt;p&gt;&lt;img src=&quot;https://andrealeopardi.com/posts/sharing-protobuf-schemas-across-services/cover-image.jpg&quot; alt=&quot;Cover image of a library with books&quot; /&gt;&lt;/p&gt;&lt;span class=&quot;unsplash-credit&quot;&gt;
    Photo by &lt;a href=&quot;https:&amp;#x2F;&amp;#x2F;unsplash.com&amp;#x2F;s&amp;#x2F;photos&amp;#x2F;library?utm_source=unsplash&amp;amp;utm_medium=referral&amp;amp;utm_content=creditCopyText&quot;&gt;Fahrul Azmi&lt;/a&gt; on &lt;a href=&quot;https://unsplash.com&quot;&gt;Unsplash&lt;/a&gt;&lt;/span&gt;&lt;p&gt;This post will go through the steps that led us to the solution we&apos;re currently using, so feel free to skip ahead if you just want to know what we ended up with.&lt;/p&gt;&lt;h2 id=&quot;starting-out-a-single-elixir-library&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#starting-out-a-single-elixir-library&quot; aria-label=&quot;Anchor link for: starting-out-a-single-elixir-library&quot;&gt;Starting out: a single Elixir library&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;When we started defining schemas for our Protobuf events, we were only using such schemas from Elixir. We created a library called &lt;code&gt;events&lt;/code&gt; and started hosting it on our private &lt;a href=&quot;https://hex.pm&quot;&gt;Hex&lt;/a&gt; repository. &lt;code&gt;events&lt;/code&gt; contained all the &lt;code&gt;.proto&lt;/code&gt; schema files and depended on the &lt;a href=&quot;https://github.com/bitwalker/exprotobuf&quot;&gt;exprotobuf&lt;/a&gt; library to &quot;compile&quot; the Protobuf schemas to Elixir code. exprotobuf uses a different approach than most Protobuf libraries for other languages that I encountered: it loads the &lt;code&gt;.proto&lt;/code&gt; schema definitions at compile time instead of using &lt;code&gt;protoc&lt;/code&gt; to compile the Protobuf files to &lt;code&gt;.ex&lt;/code&gt; Elixir files. Essentially, we created a module like this:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Events&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;use&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Protobuf&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;from&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Path&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;wildcard&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Path&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;expand&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;../schemas/*.proto&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-elixir&quot;&gt;__DIR__&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The most common approach to turning a Protobuf schema into a data structure representable by the programming language you&apos;re using is to turn the schema into some kind of &quot;struct&quot; representation. That&apos;s exactly what exprotobuf does for Elixir. This is one of our schemas:&lt;/p&gt;&lt;pre data-lang=&quot;proto&quot; class=&quot;language-proto z-code&quot;&gt;&lt;code class=&quot;language-proto&quot; data-lang=&quot;proto&quot;&gt;&lt;span class=&quot;z-source z-proto&quot;&gt;# In schemas/event_envelope.proto
&lt;/span&gt;&lt;span class=&quot;z-source z-proto&quot;&gt;&lt;span class=&quot;z-keyword z-other z-syntax z-proto&quot;&gt;syntax&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-proto&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-proto&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-proto&quot;&gt;&amp;quot;&lt;/span&gt;proto3&lt;span class=&quot;z-punctuation z-definition z-string z-end z-proto&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-proto&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-proto&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-proto&quot;&gt;&lt;span class=&quot;z-meta z-class z-proto&quot;&gt;&lt;span class=&quot;z-storage z-type z-message z-proto&quot;&gt;message&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-proto&quot;&gt;EventEnvelope&lt;/span&gt;&lt;span class=&quot;z-meta z-class z-proto&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-block z-message z-begin z-proto&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-class z-proto&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-proto&quot;&gt;&lt;span class=&quot;z-meta z-class z-proto&quot;&gt;&lt;span class=&quot;z-support z-type z-proto&quot;&gt;int64&lt;/span&gt;&lt;span class=&quot;z-variable z-other z-field z-proto&quot;&gt;timestamp&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-proto&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-proto&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-proto&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-proto&quot;&gt;&lt;span class=&quot;z-meta z-class z-proto&quot;&gt;&lt;span class=&quot;z-support z-type z-proto&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;z-variable z-other z-field z-proto&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-proto&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-proto&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-proto&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-proto&quot;&gt;&lt;span class=&quot;z-meta z-class z-proto&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-block z-message z-end z-proto&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;exprotobuf loads this up at compile time and turns it into roughly this Elixir definition:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Events&lt;/span&gt;.&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;EventEnvelope&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;defstruct&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;timestamp&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;source&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; A bunch of encode/decode functions plus
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; new/1 to create a new struct.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; ...
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;This whole approach worked okay for a while, but soon we needed to use our Protobuf definitions from a service written in Python.&lt;/p&gt;&lt;h2 id=&quot;sharing-protobuf-schemas-through-git-submodules&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#sharing-protobuf-schemas-through-git-submodules&quot; aria-label=&quot;Anchor link for: sharing-protobuf-schemas-through-git-submodules&quot;&gt;Sharing Protobuf schemas through Git submodules&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;The first thing that came to mind when we thought about sharing Protobuf schema definitions across different programming languages was &lt;a href=&quot;https://git-scm.com/book/en/v2/Git-Tools-Submodules&quot;&gt;Git submodules&lt;/a&gt;. We created a &lt;code&gt;proto_schemas&lt;/code&gt; repository containing all the &lt;code&gt;.proto&lt;/code&gt; files and added it as a Git submodule to our &lt;code&gt;events&lt;/code&gt; Elixir library and to a single Python service. Not much changed on the Elixir side, but on the Python side things were working a bit differently. The Protobuf Python library uses a common approach among Protobuf libraries, which is to use a plugin to the &lt;a href=&quot;https://github.com/protocolbuffers/protobuf/releases&quot;&gt;&lt;code&gt;protoc&lt;/code&gt;&lt;/a&gt; compiler in order to generate Python code from the &lt;code&gt;.proto&lt;/code&gt; files. Essentially, you call:&lt;/p&gt;&lt;pre data-lang=&quot;bash&quot; class=&quot;language-bash z-code&quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;z-source z-shell z-bash&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-shell&quot;&gt;&lt;span class=&quot;z-variable z-function z-shell&quot;&gt;protoc&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-arguments z-shell&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-option z-shell&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-parameter z-shell&quot;&gt; --&lt;/span&gt;python_out&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-option z-shell&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-shell&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-shell&quot;&gt;&amp;quot;&lt;/span&gt;.&lt;span class=&quot;z-punctuation z-definition z-string z-end z-shell&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-option z-shell&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-parameter z-shell&quot;&gt; -&lt;/span&gt;I&lt;/span&gt; ../schemas event_envelope.proto&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;So, for example, our &lt;code&gt;event_envelope.proto&lt;/code&gt; file would become &lt;code&gt;event_envelope.pb2.py&lt;/code&gt; once compiled.&lt;/p&gt;&lt;p&gt;The Git-submodule approach worked okay for a while, but it presented two main challenges: how to uniformly version schemas across languages? How to avoid having every project contain a copy of the Protobuf schemas and having to compile them individually to the host language?&lt;/p&gt;&lt;p&gt;Lucky for me, one day I was discussing these problems with my friend &lt;a href=&quot;https://github.com/ericmj&quot;&gt;Eric&lt;/a&gt; from the Elixir team, and we figured out a way to only keep the Protobuf schemas in a single place, compile them all in a single place, but use them from different languages all around.&lt;/p&gt;&lt;h2 id=&quot;protoc-ci-and-libraries&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#protoc-ci-and-libraries&quot; aria-label=&quot;Anchor link for: protoc-ci-and-libraries&quot;&gt;&lt;code&gt;protoc&lt;/code&gt;, CI, and libraries&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;I did some research on available Protobuf libraries for Elixir and was lucky to find an alternative to exprotobuf called &lt;a href=&quot;https://github.com/tony612/protobuf-elixir&quot;&gt;protobuf-elixir&lt;/a&gt;. The APIs that this library exposes to manipulate Protobuf structs and manage serialization were exactly the same as the APIs exposed by exprotobuf, so compatibility was not an issue. However, this library had a key features that I was interested in: it supported code generation through the &lt;code&gt;protoc&lt;/code&gt; Protobuf compiler. It worked like it does in Python (and many other languages).&lt;/p&gt;&lt;pre data-lang=&quot;bash&quot; class=&quot;language-bash z-code&quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;z-source z-shell z-bash&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-shell&quot;&gt;&lt;span class=&quot;z-variable z-function z-shell&quot;&gt;protoc&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-arguments z-shell&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-option z-shell&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-parameter z-shell&quot;&gt; --&lt;/span&gt;elixir_out&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-option z-shell&quot;&gt;=&lt;/span&gt;./lib&lt;span class=&quot;z-variable z-parameter z-option z-shell&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-parameter z-shell&quot;&gt; -&lt;/span&gt;I&lt;/span&gt; ../schemas event_envelope.proto&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;At this point, I had code generation through &lt;code&gt;protoc&lt;/code&gt; working for both Python and Elixir. The next step was to map Protobuf packages (that is, collections of Protobuf schemas) to &lt;em&gt;language libraries&lt;/em&gt; and publish those to package repositories for the respective languages. We&apos;ll go through what we did for Elixir, but the setup for Python looks almost identical.&lt;/p&gt;&lt;p&gt;All our events-related Protobuf schemas live in the &lt;code&gt;events&lt;/code&gt; Protobuf package. So, we decided to map that to an Elixir library called &lt;code&gt;events_schemas&lt;/code&gt;. The nice thing about this library is that it only contains the auto-generated code for the Protobuf schemas and nothing else. It essentially exposes an interface to the Protobuf schemas from Elixir. In the same repository where we keep the &lt;code&gt;.proto&lt;/code&gt; files, we created a &lt;code&gt;languages/elixir/&lt;/code&gt; directory to store everything necessary for compiling to Elixir and publishing this library on our private &lt;a href=&quot;https://hex.pm&quot;&gt;hex.pm&lt;/a&gt; repository. The &quot;skeleton&quot; of the &lt;code&gt;events_schemas&lt;/code&gt; library looks like this:&lt;/p&gt;&lt;pre class=&quot;z-code&quot;&gt;&lt;code&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;events_schemas
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;├── .gitignore
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;├── lib
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;│   └── .gitkeep
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;└── mix.exs
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Basically, the library is empty. The &lt;code&gt;mix.exs&lt;/code&gt; file looks like this:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;EventsSchemas&lt;/span&gt;.&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MixProject&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;use&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Mix&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Project&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;project&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;app&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;events_schemas&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;version&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; version&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;elixir&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;~&amp;gt; 1.8&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;deps&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; deps&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;package&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; package&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;application&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;extra_applications&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defp&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-private z-elixir&quot;&gt;deps&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;protobuf&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; protobuf_dependency_version&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defp&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-private z-elixir&quot;&gt;package&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;organization&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;community&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;files&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;lib/**/*.pb.ex&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;mix.exs&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;VERSION&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;PROTOBUF_EX_VERSION&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defp&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-private z-elixir&quot;&gt;protobuf_dependency_version&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;PROTOBUF_EX_VERSION&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-pipe z-elixir&quot;&gt;|&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;read!&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-pipe z-elixir&quot;&gt;|&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;trim&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defp&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-private z-elixir&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;VERSION&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-pipe z-elixir&quot;&gt;|&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;read!&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-pipe z-elixir&quot;&gt;|&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;trim&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;There are a couple of peculiar things here. First, we read the version of the library from a magic &lt;code&gt;VERSION&lt;/code&gt; file. We keep this file alongside the &lt;code&gt;.proto&lt;/code&gt; schemas. This file contains the version of the schemas themselves. Keeping it alongside the schemas means that we can copy it over in the right places when building libraries for different languages so that the &lt;code&gt;events_schemas&lt;/code&gt; library can have the same version across all target languages. We copy this file to the root of the &lt;code&gt;events_schemas&lt;/code&gt; Elixir directory before building and publishing the library. We use a similar idea for the &lt;code&gt;PROTOBUF_EX_VERSION&lt;/code&gt; file. This file contains the version of the protobuf-elixir library that we use. We keep that in a separate file so that we can make sure it&apos;s the same between the plugin for the &lt;code&gt;protoc&lt;/code&gt; compiler as well as the dependency of the &lt;code&gt;events_schemas&lt;/code&gt; library.&lt;/p&gt;&lt;p&gt;Other that the things we just talked about, this looks like a pretty standard &lt;code&gt;mix.exs&lt;/code&gt; file. Now, the magic happens in CI.&lt;/p&gt;&lt;h3 id=&quot;concourse-ci&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#concourse-ci&quot; aria-label=&quot;Anchor link for: concourse-ci&quot;&gt;Concourse CI&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Our CI system of choice is &lt;a href=&quot;https://concourse-ci.org&quot;&gt;Concourse CI&lt;/a&gt;. Concourse lets you define pipelines with different steps. Here, we&apos;re interested in the last step of our CI pipeline: publishing the libraries for all the languages. Our Concourse pipeline looks like this:&lt;/p&gt;&lt;p&gt;&lt;img src=&quot;https://andrealeopardi.com/posts/sharing-protobuf-schemas-across-services/concourse.png&quot; alt=&quot;Screenshot of our Concourse CI pipeline&quot; /&gt;&lt;/p&gt;&lt;p&gt;The last step, &lt;code&gt;build-and-publish&lt;/code&gt;, is triggered manually by clicking on it and telling it to start. This means that if you want to release a new version of the &lt;code&gt;events_schemas&lt;/code&gt; library in all languages, you have to go to Concourse and click this. That&apos;s all you need to do. Note that we have Docker containers that build and publish the library for each target language so that we don&apos;t have to install anything on the CI system. At this point, Concourse will do the same routine for all target languages:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;Copy all the necessary version files to the right places.&lt;/li&gt;&lt;li&gt;Generate code for the Protobuf schemas through &lt;code&gt;protoc&lt;/code&gt;.&lt;/li&gt;&lt;li&gt;Publish to the right package repository (for example, &lt;a href=&quot;https://hex.pm&quot;&gt;hex.pm&lt;/a&gt; for Elixir).&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;That&apos;s all. Now, our services can depend on an actual library that contains the auto-generated code representing the Protobuf schemas that we use. However, services don&apos;t need to have access to the original &lt;code&gt;.proto&lt;/code&gt; files containing the schemas. We&apos;re delighted with this system since it feels streamlined and straightforward to use, while providing everything we need.&lt;/p&gt;&lt;h3 id=&quot;encore-multiple-protobuf-packages&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#encore-multiple-protobuf-packages&quot; aria-label=&quot;Anchor link for: encore-multiple-protobuf-packages&quot;&gt;Encore: multiple Protobuf packages&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;We moved even a bit further than what I described. In fact, currently we have three Protobuf packages: one for common custom types, one for events, and one for inter-service RPCs. The events and RPC packages both depend on the custom types package. The way we solve the inter-package dependencies is to simply publish the &lt;code&gt;types_schemas&lt;/code&gt; libraries first and then depend on that library from the &lt;code&gt;events_schemas&lt;/code&gt; and &lt;code&gt;rpc_schemas&lt;/code&gt; libraries. For example, in Elixir we changed the &lt;code&gt;mix.exs&lt;/code&gt; file we looked at earlier (for the &lt;code&gt;events_schemas&lt;/code&gt; library) and added the dependency:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defp&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-private z-elixir&quot;&gt;deps&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;protobuf&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; protobuf_dependency_version&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;types_schemas&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;0.1.0&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;organization&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;community&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&quot;conclusion&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#conclusion&quot; aria-label=&quot;Anchor link for: conclusion&quot;&gt;Conclusion&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;To recap, our Protobuf pipeline and workflow currently work like this. First, you make changes to a Protobuf schema. Then, you bump a version in a file. Then, you push those changes up to GitHub. Once CI makes sure you didn&apos;t break anything, you log into Concourse and kick-start the &lt;code&gt;build-and-publish&lt;/code&gt; task. A new version of the right library gets published to different package repositories for different languages. It&apos;s not the simplest system, but the workflow is easy to use and effective. Most of all, this workflow can apply to most programming languages and make it easier to manage versioning and evolving shared collections of Protobuf schemas.&lt;/p&gt;</content>
    
    </entry>
  
    <entry>
      <id>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;posts&#x2F;connection-managers-with-gen-statem&#x2F;</id>
      <title type="html"><![CDATA[ Persistent connections with gen_statem ]]></title>
      <link rel="alternate"
            type="text/html"
            href="https://andrealeopardi.com/posts/connection-managers-with-gen-statem/"
            title="Persistent connections with gen_statem" />
      <published>2019-04-14T00:00:00+00:00</published>
      <author>
        <name>Andrea Leopardi</name>
        <uri>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;</uri>
        <email>hi@andrealeopardi.com</email>
      </author>
      <updated>2019-04-14T00:00:00+00:00</updated>
      <summary type="html">&lt;p&gt;Our applications often interact with external systems. In many cases, we need a &lt;em&gt;persistent&lt;/em&gt; connection to one or more of these external services. For example, if your application makes continuous use of a database, you&apos;ll likely want to stay connected to such database so that you can avoid spending time and resources connecting and disconnecting each time you perform a request. With Erlang and Elixir, the natural abstraction to maintain a persistent connection is a process. In this post, we&apos;ll have a look at how we can take advantage of the &lt;code&gt;gen_statem&lt;/code&gt; behaviour to write state machine processes that act as persistent connections to external systems.&lt;/p&gt;</summary>
    
      <content type="html">&lt;p&gt;Our applications often interact with external systems. In many cases, we need a &lt;em&gt;persistent&lt;/em&gt; connection to one or more of these external services. For example, if your application makes continuous use of a database, you&apos;ll likely want to stay connected to such database so that you can avoid spending time and resources connecting and disconnecting each time you perform a request. With Erlang and Elixir, the natural abstraction to maintain a persistent connection is a process. In this post, we&apos;ll have a look at how we can take advantage of the &lt;code&gt;gen_statem&lt;/code&gt; behaviour to write state machine processes that act as persistent connections to external systems.&lt;/p&gt;&lt;span id=&quot;continue-reading&quot;&gt;&lt;/span&gt;&lt;p&gt;&lt;img src=&quot;https://andrealeopardi.com/posts/connection-managers-with-gen-statem/cover-image.jpg&quot; alt=&quot;Cover image of a electricity&quot; /&gt;&lt;/p&gt;&lt;span class=&quot;unsplash-credit&quot;&gt;
    Photo by &lt;a href=&quot;https:&amp;#x2F;&amp;#x2F;unsplash.com&amp;#x2F;photos&amp;#x2F;ImcUkZ72oUs?utm_source=unsplash&amp;amp;utm_medium=referral&amp;amp;utm_content=creditCopyText&quot;&gt;Israel Palacio&lt;/a&gt; on &lt;a href=&quot;https://unsplash.com&quot;&gt;Unsplash&lt;/a&gt;&lt;/span&gt;&lt;p&gt;This article is an evolution of a previous article posted on this blog, &lt;a href=&quot;https://andrealeopardi.com/posts/handling-tcp-connections-in-elixir&quot;&gt;&quot;Handling TCP connections in Elixir&quot;&lt;/a&gt;. In that article, I describe how to build a connection process that talks to a Redis server over TCP. Instead of &lt;code&gt;gen_statem&lt;/code&gt; (which wasn&apos;t available at that time), I use the &lt;a href=&quot;https://github.com/fishcakez/connection&quot;&gt;connection&lt;/a&gt; library by James Fish, but the concepts are similar. If you&apos;re interested in the TCP interactions more than you are in &lt;code&gt;gen_statem&lt;/code&gt;, read that article first. What I describe here is an evolution of the old implementation that doesn&apos;t require external dependencies and that nicely shows a practical use case for many of the features that &lt;code&gt;gen_statem&lt;/code&gt; provides.&lt;/p&gt;&lt;p&gt;&lt;em&gt;Note&lt;/em&gt;: I&apos;m more used to Elixir and its syntax, so that&apos;s what I&apos;m going to use here. However, I won&apos;t use almost any Elixir-specific features, so the article should also be readable for folks that are more comfortable with Erlang. If you want to follow along with the finished Erlang code for the state machine we&apos;ll build, look at &lt;a href=&quot;https://gist.github.com/whatyouhide/e7531e10128af58b9830af8938eae478&quot;&gt;the Gist&lt;/a&gt; containing the final implementation in Elixir and Erlang.&lt;/p&gt;&lt;h2 id=&quot;the-connection-manager&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#the-connection-manager&quot; aria-label=&quot;Anchor link for: the-connection-manager&quot;&gt;The connection &quot;manager&quot;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;During the blog post, we&apos;ll build a connection process that maintains a persistent TCP connection to a database.&lt;/p&gt;&lt;p&gt;It&apos;s important to understand the design and purpose of our connection process. This process is not the connection to the database itself but only a &lt;em&gt;wrapper&lt;/em&gt; around the connection. This means that if the connection itself goes down, our process should stay alive and try to reconnect while replying with errors to clients that try to make requests. While a catchphrase of the Erlang and Elixir world is &quot;let it crash&quot;, erroneous conditions such as the TCP connection going down are known in advance and our system should strive to be resilient when they happen. TCP errors are not errors for our connection process, they&apos;re just another event happening in the system. This design decision is a powerful one because it leads us to a stable and resilient process that our system can rely on, regardless of the state of the actual connection.&lt;/p&gt;&lt;p&gt;A side effect of the design of the connection process so that it&apos;s independent of the state of the connection is that we don&apos;t need to establish the TCP connection synchronously when starting up our process. We can start our connection process and return a PID right away, start establishing the connection in the background, and then act as if the connection is &quot;broken&quot; until the connection is established. After all, our connection process and application will need to deal with the connection being broken at some point, so there&apos;s often no reason to require synchronous connecting.&lt;/p&gt;&lt;p&gt;The ideas briefly mentioned above come from an article by Fred Hebert, &lt;a href=&quot;https://ferd.ca/it-s-about-the-guarantees.html&quot;&gt;&quot;It&apos;s about the guarantees&quot;&lt;/a&gt;, which does a great job at explaining why the design I discussed works well especially in Erlang and Elixir applications.&lt;/p&gt;&lt;h2 id=&quot;gen-statem-primer&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#gen-statem-primer&quot; aria-label=&quot;Anchor link for: gen-statem-primer&quot;&gt;&lt;code&gt;gen_statem&lt;/code&gt; primer&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;http://erlang.org/doc/man/gen_statem.html&quot;&gt;&lt;code&gt;gen_statem&lt;/code&gt;&lt;/a&gt; is an OTP behaviour (like &lt;code&gt;GenServer&lt;/code&gt;) that was introduced in OTP 19. Like its name suggests, it&apos;s an abstraction over a state machine. A common example of a state machine is an ATM:&lt;/p&gt;&lt;p&gt;&lt;img src=&quot;https://andrealeopardi.com/posts/connection-managers-with-gen-statem/atm-state-machine-diagram.png&quot; alt=&quot;ATM state machine diagram&quot; /&gt;&lt;/p&gt;&lt;p&gt;There are states that the ATM can be in (like &lt;code&gt;waiting_for_pin&lt;/code&gt; or &lt;code&gt;requesting_cash&lt;/code&gt;) and events that cause state transitions, that is, moving from one state to another state (or to the same state).&lt;/p&gt;&lt;p&gt;&lt;code&gt;gen_statem&lt;/code&gt; mirrors the design of a state machine very closely. Essentially, you have something similar to a GenServer, where you have callbacks and events like user calls or messages. In a &lt;code&gt;gen_statem&lt;/code&gt; module, however, you have a state which represents the state machine&apos;s state and a &lt;code&gt;data&lt;/code&gt; term that represents information that the state machine is carrying around. The &quot;data&quot; in a &lt;code&gt;gen_statem&lt;/code&gt; is what we usually call the &quot;state&quot; in a GenServer (this is confusing, bear with me).&lt;/p&gt;&lt;p&gt;The &lt;code&gt;gen_statem&lt;/code&gt; states are represented through functions: in the ATM machine, you would have a &lt;code&gt;waiting_for_pin/3&lt;/code&gt; function (with one or more clauses) to handle events in the &lt;code&gt;waiting_for_pin&lt;/code&gt; state, and so on for the other states. The return value of state functions determines what the state machine should do next and looks something like this:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;p&gt;&lt;code&gt;{:next_state, next_state, new_data, actions}&lt;/code&gt; to transition to the next state &lt;code&gt;next_state&lt;/code&gt;. &lt;code&gt;new_data&lt;/code&gt; is the new data of the state machine and &lt;code&gt;actions&lt;/code&gt; is a list of actions, like firing off internal events, setting up timers, or replying to calls. We&apos;ll have a better understanding of actions as we go along.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;code&gt;{:keep_state, new_data, actions}&lt;/code&gt; to remain in the same state. &lt;code&gt;new_data&lt;/code&gt; and &lt;code&gt;actions&lt;/code&gt; are the same as described for &lt;code&gt;:next_state&lt;/code&gt;.&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;The API that &lt;code&gt;:gen_statem&lt;/code&gt; exposes is actually a bit complex. A symptom of this is that there are many more return values than the two mentioned above, but most of them end up being simplifications of these two. For example, you can return &lt;code&gt;{:keep_state, new_data}&lt;/code&gt; instead of &lt;code&gt;{:keep_state, new_data, []}&lt;/code&gt; if you don&apos;t want to execute any actions. We&apos;ll try to use whatever fits best in each instance.&lt;/p&gt;&lt;h2 id=&quot;it-s-all-about-the-connection&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#it-s-all-about-the-connection&quot; aria-label=&quot;Anchor link for: it-s-all-about-the-connection&quot;&gt;It&apos;s all about the connection&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;We&apos;re going to use TCP with &lt;code&gt;:gen_tcp&lt;/code&gt; to connect to the database. We&apos;ll send requests through the socket and then asynchronously receive responses from the database. The clients calling our connections will wait synchronously on responses to the requests that they sent, but our connection will be able to handle multiple requests from different clients concurrently. We&apos;ll assume our fictional database has a protocol that expects each request to have an ID and that tags each response with the ID of the corresponding request. This will allow our state machine to maintain a map of request ID to requesting process for in-flight requests. When a response arrives, we can retrieve the caller waiting for it from this map.&lt;/p&gt;&lt;h3 id=&quot;designing-the-state-machine&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#designing-the-state-machine&quot; aria-label=&quot;Anchor link for: designing-the-state-machine&quot;&gt;Designing the state machine&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Let&apos;s start with designing the states of our connection. We already figured out that there&apos;s going to be a &lt;code&gt;disconnected&lt;/code&gt; state for when the TCP connection is down. This will also be the starting state since we&apos;ll start as &lt;code&gt;disconnected&lt;/code&gt; and then try to connect the first time as mentioned at the beginning of the article. We only need one more state, the &lt;code&gt;connected&lt;/code&gt; state, for when the TCP connection is alive and well. The next step when designing the state machine is figuring out what events cause the state machine to transition from one state to another. In our case, we can think of these events causing state transitions:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;p&gt;The TCP connection goes down — this makes the state machine transition from the &lt;code&gt;connected&lt;/code&gt; state to the &lt;code&gt;disconnected&lt;/code&gt; state.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;The TCP connection is established successfully — this makes the state machine from &lt;code&gt;disconnected&lt;/code&gt; to &lt;code&gt;connected&lt;/code&gt;.&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;Then, we have events that don&apos;t cause state transition. In our case, that&apos;s only requests from clients.&lt;/p&gt;&lt;p&gt;A helpful habit when designing state machines is to draw a diagram of the state machine. This lets us visualize the states and state transitions at a glance.&lt;/p&gt;&lt;p&gt;&lt;img src=&quot;https://andrealeopardi.com/posts/connection-managers-with-gen-statem/connection-state-machine-diagram.png&quot; alt=&quot;Connection state machine diagram&quot; /&gt;&lt;/p&gt;&lt;h3 id=&quot;implementing-the-state-machine&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#implementing-the-state-machine&quot; aria-label=&quot;Anchor link for: implementing-the-state-machine&quot;&gt;Implementing the state machine&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Let&apos;s turn this diagram into a functioning &lt;code&gt;gen_statem&lt;/code&gt;. The first thing to do is to create a &lt;code&gt;Connection&lt;/code&gt; module and specify that it&apos;s an implementation of the &lt;code&gt;:gen_statem&lt;/code&gt; behaviour. We&apos;ll also define an internal struct that we&apos;ll use as the data carried by the state machine. The data will contain the host and port to connect/reconnect to, the TCP socket, and a map of request ID to caller waiting for a response.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Connection&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-variable z-other z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-definition z-constant z-elixir&quot;&gt;@&lt;/span&gt;behaviour&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;gen_statem&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;defstruct&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;host&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;port&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;socket&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;requests&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; Ignore this for now. We&amp;#39;ll see what this is about later on.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-variable z-other z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-definition z-constant z-elixir&quot;&gt;@&lt;/span&gt;impl&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;callback_mode&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;state_functions&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;start_link&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;opts&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    host &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Keyword&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;fetch!&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;opts&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;host&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    port &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Keyword&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;fetch!&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;opts&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;port&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;gen_statem&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;start_link&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-elixir&quot;&gt;__MODULE__&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;to_charlist&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;host&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; port&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;As we mentioned, the state machine starts in the &lt;code&gt;disconnected&lt;/code&gt; state. Similarly to a GenServer, when you start the state machine process, &lt;code&gt;start_link&lt;/code&gt; won&apos;t return until the &lt;code&gt;init/1&lt;/code&gt; callback that both &lt;code&gt;GenServer&lt;/code&gt; and &lt;code&gt;gen_statem&lt;/code&gt; provide returns. We want to return from &lt;code&gt;init/1&lt;/code&gt; right away and then establish the connection in the background. &lt;code&gt;gen_statem&lt;/code&gt; provides us with a perfect tool for this: &lt;strong&gt;internal events&lt;/strong&gt;. In our case, we can return from &lt;code&gt;init/1&lt;/code&gt; right away and generate an internal &lt;code&gt;:connect&lt;/code&gt; event that tells the state machine to initiate connection. Let&apos;s start with implementing the &lt;code&gt;init/1&lt;/code&gt; callback.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;host&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; port&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  data &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; %&lt;span class=&quot;z-variable z-language z-elixir&quot;&gt;__MODULE__&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;host&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; host&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;port&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; port&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  actions &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;next_event&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;internal&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;connect&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;disconnected&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; actions&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;As you can see, the return value of &lt;code&gt;init/1&lt;/code&gt; specifies that the first state to transition to is the &lt;code&gt;:disconnected&lt;/code&gt; state. The only action we want to execute is &lt;code&gt;:next_event&lt;/code&gt; which fires off an event. Events have a type and a term attached to them. For example, an Elixir message coming to the state machine process has the event type as &lt;code&gt;:info&lt;/code&gt; and the term as the message itself. In our case, we fire off an internal event that has the type &lt;code&gt;:internal&lt;/code&gt; and the term &lt;code&gt;:connect&lt;/code&gt;.&lt;/p&gt;&lt;p&gt;The state machine states are implemented as functions named as the state. So in our case, the first function to implement is &lt;code&gt;disconnect/3&lt;/code&gt;. State functions are called with the event type as the first argument, the event term as the second argument, and the data as the third argument.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;disconnected&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;internal&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;connect&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; We use the socket in active mode for simplicity, but
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; it&amp;#39;s often better to use &amp;quot;active: :once&amp;quot; for better control.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  socket_opts &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;binary&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;active&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;case&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;gen_tcp&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;connect&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;host&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;port&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; socket_opts&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; socket&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; We omit the actions as there are none.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;next_state&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;connected&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;data &lt;span class=&quot;z-keyword z-operator z-other z-elixir&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;socket&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; socket&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;error&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; error&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Logger&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;error&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;Connection failed: &lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-interpolation z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-interpolation z-begin z-elixir&quot;&gt;#{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-interpolation z-elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir z-embedded&quot;&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;inet&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;format_error&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;error&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-interpolation z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; This is the same as {:keep_state, data, actions} but makes it clear
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; we&amp;#39;re not changing the data.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;      actions &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;next_event&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;internal&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;connect&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;keep_state_and_data&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; actions&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;If the connection is established successfully, we store the socket in the data and move to the &lt;code&gt;:connected&lt;/code&gt; state. If there&apos;s an error connecting, we stay in the &lt;code&gt;:disconnected&lt;/code&gt; state with the same data and fire the internal &lt;code&gt;:connect&lt;/code&gt; event again. This means that we&apos;ll try to reconnect right away and might end up in a failed connection loop. We&apos;ll fix this later on by introducing back-offs.&lt;/p&gt;&lt;p&gt;Now that we&apos;re in the &lt;code&gt;:connected&lt;/code&gt; state, let&apos;s handle the connection going down so that we&apos;ll have all the state &lt;em&gt;transitions&lt;/em&gt;. Since our TCP socket is in active mode, we&apos;ll get a &lt;code&gt;{:tcp_closed, socket}&lt;/code&gt; message when the connection goes down (let&apos;s ignore &lt;code&gt;{:tcp_error, socket, reason}&lt;/code&gt; for now).&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;connected&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;info&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;tcp_closed&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; socket&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;socket&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; socket&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; data&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  disconnect&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; Let&amp;#39;s use a helper function, it will come in handy later.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defp&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-private z-elixir&quot;&gt;disconnect&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Logger&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;error&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;Connection closed&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  data &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;data &lt;span class=&quot;z-keyword z-operator z-other z-elixir&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;socket&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  actions &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;next_event&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;internal&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;connect&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;next_state&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;disconnected&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; actions&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;We return to the &lt;code&gt;:disconnected&lt;/code&gt; state and immediately fire off an internal &lt;code&gt;:connect&lt;/code&gt; event so that we&apos;ll try to re-establish the connection right away. This is the same as what happens when we can&apos;t connect for now.&lt;/p&gt;&lt;h3 id=&quot;handling-requests&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#handling-requests&quot; aria-label=&quot;Anchor link for: handling-requests&quot;&gt;Handling requests&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Now, we need to handle requests from clients and data coming back from the database. These requests will be made through &lt;code&gt;request/2&lt;/code&gt;:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;pid&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; request&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;gen_statem&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;call&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;pid&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;request&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; request&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The event type that results from a &lt;code&gt;:gen_statem.call/2&lt;/code&gt; call is &lt;code&gt;{:call, from}&lt;/code&gt;. &lt;code&gt;from&lt;/code&gt; identifies the caller, similarly to the &lt;code&gt;from&lt;/code&gt; argument in &lt;code&gt;handle_call/3&lt;/code&gt; for GenServers. The event content is the request itself, in our case &lt;code&gt;{:request, request}&lt;/code&gt;.&lt;/p&gt;&lt;p&gt;A request can come in either the &lt;code&gt;:connected&lt;/code&gt; or the &lt;code&gt;:disconnected&lt;/code&gt; state and it never causes a state transition. When a request comes in the &lt;code&gt;:disconnected&lt;/code&gt; state, we reply with &lt;code&gt;{:error, :disconnected}&lt;/code&gt; right away. Replying is another &lt;em&gt;action&lt;/em&gt; that we can perform.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;disconnected&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;call&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; from&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;request&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; request&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  actions &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;reply&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; from&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;error&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;disconnected&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;keep_state_and_data&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; actions&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;When a request comes in the &lt;code&gt;:connected&lt;/code&gt; state, we issue the request to the database and store the caller under the request ID in our request map. &lt;code&gt;request&lt;/code&gt; here could be anything, but let&apos;s imagine it&apos;s a map that contains a &lt;code&gt;:id&lt;/code&gt; key holding the ID of the request. If there&apos;s an error sending, we close the socket and go back to the disconnected state.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;connected&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;call&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; from&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;request&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; request&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;case&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;gen_tcp&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;send&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;socket&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; encode_request&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;request&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;      data &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;data &lt;span class=&quot;z-keyword z-operator z-other z-elixir&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;requests&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Map&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;put&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;requests&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; request&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;id&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; from&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;keep_state&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;error&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; _reason&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;gen_tcp&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;close&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;socket&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;      disconnect&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Since our TCP socket is in active mode, packets sent by the database will arrive as messages to the state machine. A &lt;code&gt;{:tcp, socket, data}&lt;/code&gt; message can only come in the &lt;code&gt;:connected&lt;/code&gt; state, so we can skip the additional &lt;code&gt;disconnected/3&lt;/code&gt; clause to handle TCP packets. For simplicity, we&apos;re going to assume that a packet always contains a single complete response so that we can avoid buffering.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;connected&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;info&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;tcp&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; socket&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; packet&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;socket&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; socket&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; data&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  response &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; decode_response&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;packet&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;from&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; requests&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Map&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;pop&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;requests&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; response&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;id&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; :gen_statem.reply/2 can be used to manually reply to a
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; :gen_statem.call/2 (similarly to GenServer.reply/2).
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;gen_statem&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;reply&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;from&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; response&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;keep_state&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;data &lt;span class=&quot;z-keyword z-operator z-other z-elixir&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;requests&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; requests&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&quot;performing-actions-when-entering-a-state&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#performing-actions-when-entering-a-state&quot; aria-label=&quot;Anchor link for: performing-actions-when-entering-a-state&quot;&gt;Performing actions when entering a state&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;You might notice there&apos;s a bug in our implementation: when we disconnect, we don&apos;t notify the clients that are waiting for a response. To do that, we can modify the &lt;code&gt;disconnect/1&lt;/code&gt; helper function:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defp&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-private z-elixir&quot;&gt;disconnect&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Logger&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;error&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;Connection closed&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Enum&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;each&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;requests&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;fn&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;_id&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; from&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-other z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;gen_statem&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;reply&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;from&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;error&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;disconnected&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  data &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;data &lt;span class=&quot;z-keyword z-operator z-other z-elixir&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;socket&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;requests&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  actions &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;next_event&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;internal&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;connect&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;next_state&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;disconnected&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; actions&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;This works, but &lt;code&gt;:gen_statem&lt;/code&gt; provides a possibly better way to perform common clean up code when disconnecting: state enter events. It&apos;s enough to change the &lt;code&gt;callback_mode/0&lt;/code&gt; callback we implemented initially:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-variable z-other z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-definition z-constant z-elixir&quot;&gt;@&lt;/span&gt;impl&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;callback_mode&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;state_functions&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;state_enter&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Now, &lt;code&gt;:gen_statem&lt;/code&gt; will call &lt;code&gt;new_state(:enter, old_state, data)&lt;/code&gt; every time the state machine transitions from &lt;code&gt;old_state&lt;/code&gt; to &lt;code&gt;new_state&lt;/code&gt;. If we transition from &lt;code&gt;:connected&lt;/code&gt; to &lt;code&gt;:disconnected&lt;/code&gt; then &lt;code&gt;disconnected(:enter, :connected, data)&lt;/code&gt; will be called. This is ideal for our use case, as we can now remove the &lt;code&gt;disconnect/1&lt;/code&gt; helper function and implement the &lt;code&gt;disconnected/3&lt;/code&gt; clause that handles the &lt;code&gt;:enter&lt;/code&gt; event.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;disconnected&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;enter&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;connected&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Logger&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;error&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;Connection closed&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Enum&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;each&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;requests&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;fn&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;_id&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; from&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-other z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;gen_statem&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;reply&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;from&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;error&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;disconnected&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  data &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;data &lt;span class=&quot;z-keyword z-operator z-other z-elixir&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;socket&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;requests&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  actions &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;next_event&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;internal&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;connect&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;next_state&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;disconnected&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; actions&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;This allows us to just move to the disconnected state when we want to disconnect, and the state enter clause will take care of replying to waiting clients and cleaning the data up. Note that since &lt;code&gt;:disconnected&lt;/code&gt; is our first state, the &lt;code&gt;:enter&lt;/code&gt; event will fire the first time with the old state being &lt;code&gt;:disconnected&lt;/code&gt; as well. We can just do nothing in that case.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;disconnected&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;enter&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;disconnected&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; _data&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;keep_state_and_data&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The enter callback is called for every state transition, so we need to handle it in the &lt;code&gt;:connected&lt;/code&gt; state as well. We don&apos;t want to do anything when entering that state.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;connected&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;enter&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; _old_state&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; _data&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;keep_state_and_data&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&quot;timeouts-for-back-offs&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#timeouts-for-back-offs&quot; aria-label=&quot;Anchor link for: timeouts-for-back-offs&quot;&gt;Timeouts for back-offs&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;We&apos;ve now got a pretty neat connection process that holds the TCP connection to our database and is able to reply to clients regardless of the state of such connection. However, in the code we built we try to reconnect as soon as the connection goes down or we fail to connect. This is usually a terrible idea, because if a connection goes down there&apos;s a good chance it won&apos;t be up right away, especially if we also fail to reconnect. A common technique to avoid frequent connection attempts is to wait a &lt;strong&gt;back-off period&lt;/strong&gt; before attempting reconnections. When the connection goes down or we fail to connect, we&apos;ll wait a few hundred milliseconds before trying again.&lt;/p&gt;&lt;p&gt;&lt;code&gt;:gen_statem&lt;/code&gt; has the perfect tool to implement this: &lt;strong&gt;timeouts&lt;/strong&gt;. One of the possible actions you can return from state functions is &lt;code&gt;{:timeout, timeout_name}&lt;/code&gt;, which you can use to set a timeout with some term attached to it after a given amount of time. When the timeout expires, an event of type &lt;code&gt;{:timeout, timeout_name}&lt;/code&gt; is fired.&lt;/p&gt;&lt;p&gt;Let&apos;s start by setting the timeout when we enter the disconnected state.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;disconnected&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;enter&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;connected&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; Same as before: logging, replying to
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; waiting clients, resetting the data.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  actions &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;timeout&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;reconnect&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;500&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;keep_state&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; actions&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Our timeout will fire after 500 milliseconds We use &lt;code&gt;nil&lt;/code&gt; as its term since we&apos;re not carrying any information alongside the timeout other than its name (&lt;code&gt;:reconnect&lt;/code&gt;). When the timeout expires, we need to handle it in &lt;code&gt;disconnected/3&lt;/code&gt;:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;disconnected&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;timeout&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;reconnect&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; _content&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  actions &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;next_event&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;internal&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;connect&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;keep_state&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; actions&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;When the &lt;code&gt;:reconnect&lt;/code&gt; timeout is fired, we just fire the internal &lt;code&gt;:connect&lt;/code&gt; event so that we end up trying to reconnect. This removes repetition in the code and hides the plumbing of setting up timeouts manually.&lt;/p&gt;&lt;h3 id=&quot;exponential-and-random-back-off&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#exponential-and-random-back-off&quot; aria-label=&quot;Anchor link for: exponential-and-random-back-off&quot;&gt;Exponential and random back-off&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Without going too much into detail, a fixed back-off time might not be the best idea. Imagine you have one hundred TCP connections established with the database. If the database goes down, all those connections will go down at the same time and will try to reconnect every 500 milliseconds, all at the &lt;em&gt;same time&lt;/em&gt;. Part of the fix is to increase the back-off exponentially so that we can avoid situations where the database is down for a while and all connections try to reconnect very often. Then, we can add some random interval of time before reconnecting for each connection so that we avoid all the connections trying to reconnect at the same time. In code, the formula for the next back-off (given the previous back-off) can be something like:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;next_backoff &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; round&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;previous_backoff &lt;span class=&quot;z-keyword z-operator z-arithmetic z-elixir&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;next_backoff &lt;span class=&quot;z-keyword z-operator z-arithmetic z-elixir&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Enum&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;random&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-elixir&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-elixir&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&quot;dynamic-state&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#dynamic-state&quot; aria-label=&quot;Anchor link for: dynamic-state&quot;&gt;Dynamic state&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;The last feature of &lt;code&gt;:gen_statem&lt;/code&gt; that I want to explore is &lt;strong&gt;dynamic state&lt;/strong&gt;. Let&apos;s see how that could be needed in our state machine. Right now, the &lt;code&gt;:socket&lt;/code&gt; field in the data is only present in the &lt;code&gt;:connected&lt;/code&gt; state and &lt;code&gt;nil&lt;/code&gt; the rest of the time. This information perfectly mirrors the state but it&apos;s encoded in the data and has to be managed side by side with the state and state transitions. It would be nice if we could stick the socket alongside the &lt;code&gt;:connected&lt;/code&gt; state, wouldn&apos;t it? Well, we can do exactly that with &quot;handle event&quot; functions instead of state functions. With &quot;handle event&quot; functions, the state is not a simple atom (like &lt;code&gt;:connected&lt;/code&gt; or &lt;code&gt;:disconnected&lt;/code&gt;) anymore, but it can be any term. However, this means we can&apos;t use functions to represent the state: we&apos;ll have to use a common &lt;code&gt;handle_event/4&lt;/code&gt; callback to handle all events in all state. We&apos;ll pattern match on the state to mimic what we were essentially doing with the names of the functions.&lt;/p&gt;&lt;p&gt;The first thing to do to use &quot;handle event&quot; functions is change &lt;code&gt;:state_functions&lt;/code&gt; to &lt;code&gt;:handle_event_function&lt;/code&gt; in &lt;code&gt;callback_mode/0&lt;/code&gt;:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-variable z-other z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-definition z-constant z-elixir&quot;&gt;@&lt;/span&gt;impl&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;true&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;callback_mode&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;handle_event_function&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;state_enter&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;We won&apos;t rewrite the whole state machine, but just a small snippet. Let&apos;s see how we can now handle the internal &lt;code&gt;:connect&lt;/code&gt; event in the &lt;code&gt;:disconnected&lt;/code&gt; state. For the &lt;code&gt;:disconnected&lt;/code&gt; state, we&apos;ll use the &lt;code&gt;:disconnected&lt;/code&gt; atom since we don&apos;t want to carry any information with it.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;handle_event&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;internal&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;connect&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;disconnected&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  socket_opts &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;binary&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;active&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;case&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;gen_tcp&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;connect&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;host&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;port&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; socket_opts&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; socket&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;next_state&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;connected&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; socket&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; data&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;error&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; error&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; Same as before.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;      actions &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;next_event&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;internal&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;connect&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;keep_state_and_data&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; actions&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Now, instead of moving to the &lt;code&gt;:connected&lt;/code&gt; state in case of successful connection, we move to the &lt;code&gt;{:connected, socket}&lt;/code&gt; state. This means that the socket is tied to the &quot;connected&quot; state and doesn&apos;t exist in the &lt;code&gt;:disconnected&lt;/code&gt; state.&lt;/p&gt;&lt;p&gt;&quot;Handle event&quot; functions are powerful. They set &lt;code&gt;:gen_statem&lt;/code&gt; aside from its previous version, &lt;a href=&quot;http://erlang.org/doc/man/gen_fsm.html&quot;&gt;&lt;code&gt;:gen_fsm&lt;/code&gt;&lt;/a&gt; (which is now deprecated). &lt;code&gt;:gen_fsm&lt;/code&gt; would only let users implement &lt;strong&gt;finite-state machines&lt;/strong&gt; (hence the &lt;code&gt;fsm&lt;/code&gt; in the module name), but &lt;code&gt;:gen_statem&lt;/code&gt; with &quot;handle event&quot; functions lets users implement a generic &lt;a href=&quot;https://en.wikipedia.org/wiki/Transition_system&quot;&gt;transition system&lt;/a&gt;.&lt;/p&gt;&lt;h2 id=&quot;conclusion&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#conclusion&quot; aria-label=&quot;Anchor link for: conclusion&quot;&gt;Conclusion&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;In this article, we explored a way to build processes acting as persistent connections to the outside world using &lt;code&gt;:gen_statem&lt;/code&gt;. We learned how to build a real-world state machine and how to use a bunch of features provided by &lt;code&gt;:gen_statem&lt;/code&gt; to avoid repetition and simplify our implementation. For more information on the TCP interaction bits of this article, check out &lt;a href=&quot;https://andrealeopardi.com/posts/handling-tcp-connections-in-elixir&quot;&gt;&quot;Handling TCP connections in Elixir&quot;&lt;/a&gt;. If you&apos;re interested in the reasoning behind the design of the persistent connection, refer to &lt;a href=&quot;https://ferd.ca/it-s-about-the-guarantees.html&quot;&gt;&quot;It&apos;s about the guarantees&quot;&lt;/a&gt;.&lt;/p&gt;&lt;p&gt;If you&apos;re interested in the whole code for the state machine that we built, you can find it as &lt;a href=&quot;https://gist.github.com/whatyouhide/e7531e10128af58b9830af8938eae478&quot;&gt;a Gist&lt;/a&gt;. In the Gist there are both the Elixir version we built and an Erlang version if you&apos;re more comfortable with Erlang.&lt;/p&gt;</content>
    
    </entry>
  
    <entry>
      <id>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;posts&#x2F;a-story-of-regret-and-retiring-a-library-from-hex&#x2F;</id>
      <title type="html"><![CDATA[ A story of regret and retiring a library from Hex ]]></title>
      <link rel="alternate"
            type="text/html"
            href="https://andrealeopardi.com/posts/a-story-of-regret-and-retiring-a-library-from-hex/"
            title="A story of regret and retiring a library from Hex" />
      <published>2018-09-15T00:00:00+00:00</published>
      <author>
        <name>Andrea Leopardi</name>
        <uri>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;</uri>
        <email>hi@andrealeopardi.com</email>
      </author>
      <updated>2018-09-15T00:00:00+00:00</updated>
      <summary type="html">&lt;p&gt;Now the story of an Elixir library and the one author who had no choice but to take it away.&lt;/p&gt;</summary>
    
      <content type="html">&lt;p&gt;Now the story of an Elixir library and the one author who had no choice but to take it away.&lt;/p&gt;&lt;span id=&quot;continue-reading&quot;&gt;&lt;/span&gt;&lt;p&gt;&lt;img src=&quot;https://andrealeopardi.com/posts/a-story-of-regret-and-retiring-a-library-from-hex/cover-image.jpg&quot; alt=&quot;Cover image of a map&quot; /&gt;&lt;/p&gt;&lt;p&gt;&lt;a style=&quot;background-color:black;color:white;text-decoration:none;padding:4px 6px;font-family:-apple-system, BlinkMacSystemFont, &amp;quot;San Francisco&amp;quot;, &amp;quot;Helvetica Neue&amp;quot;, Helvetica, Ubuntu, Roboto, Noto, &amp;quot;Segoe UI&amp;quot;, Arial, sans-serif;font-size:12px;font-weight:bold;line-height:1.2;display:inline-block;border-radius:3px&quot; href=&quot;https://unsplash.com/@nicnut?utm_medium=referral&amp;amp;utm_campaign=photographer-credit&amp;amp;utm_content=creditBadge&quot; target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; title=&quot;Download free do whatever you want high-resolution photos from Nicola Nuttall&quot;&gt;&lt;span style=&quot;display:inline-block;padding:2px 3px&quot;&gt;&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; style=&quot;height:12px;width:auto;position:relative;vertical-align:middle;top:-1px;fill:white&quot; viewBox=&quot;0 0 32 32&quot;&gt;&lt;title&gt;unsplash-logo&lt;/title&gt;&lt;path d=&quot;M20.8 18.1c0 2.7-2.2 4.8-4.8 4.8s-4.8-2.1-4.8-4.8c0-2.7 2.2-4.8 4.8-4.8 2.7.1 4.8 2.2 4.8 4.8zm11.2-7.4v14.9c0 2.3-1.9 4.3-4.3 4.3h-23.4c-2.4 0-4.3-1.9-4.3-4.3v-15c0-2.3 1.9-4.3 4.3-4.3h3.7l.8-2.3c.4-1.1 1.7-2 2.9-2h8.6c1.2 0 2.5.9 2.9 2l.8 2.4h3.7c2.4 0 4.3 1.9 4.3 4.3zm-8.6 7.5c0-4.1-3.3-7.5-7.5-7.5-4.1 0-7.5 3.4-7.5 7.5s3.3 7.5 7.5 7.5c4.2-.1 7.5-3.4 7.5-7.5z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/span&gt;&lt;span style=&quot;display:inline-block;padding:2px 3px&quot;&gt;Nicola Nuttall&lt;/span&gt;&lt;/a&gt;&lt;/p&gt;&lt;p&gt;It was October of 2015. I was a young Elixir developer, eager to contribute and help the community. One day, someone on the &lt;a href=&quot;https://groups.google.com/forum/#!topic/elixir-lang-core/NoUo2gqQR3I&quot;&gt;mailing list&lt;/a&gt; proposed a new feature for Elixir: ES6-like map destructuring. It would look like this:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;iex&lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;&amp;gt;&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;username&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; age&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;username&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;andrea&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;age&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;27&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;iex&lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;&amp;gt;&lt;/span&gt; username
&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;andrea&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;iex&lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;&amp;gt;&lt;/span&gt; age
&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;27&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;In short, you don&apos;t bind variables through the usual &lt;code&gt;%{username: username} = map&lt;/code&gt; pattern matching. You instead use a short-hand syntax that lets you reduce the repetition.&lt;/p&gt;&lt;p&gt;The initial response was good. People looked excited. Then Josh Adams wrote this:&lt;/p&gt;&lt;blockquote&gt;&lt;p&gt;I worry that this feature makes code much harder to read and encourages a bit of magic that I don&apos;t much love.&lt;/p&gt;&lt;/blockquote&gt;&lt;p&gt;I was with Josh on this one. This was me a few messages later:&lt;/p&gt;&lt;blockquote&gt;&lt;p&gt;[...] it&apos;s often tedious to do &lt;code&gt;foo: foo&lt;/code&gt; but I prefer clarity over conciseness in this case.&lt;/p&gt;&lt;/blockquote&gt;&lt;p&gt;A bit after this, José pointed out that this syntax would not work everywhere because we would need support for matching on atom keys but also string keys. He also pointed out that maybe a better way to implement this in Elixir would have been sigils. For example, we could have a &lt;code&gt;~m&lt;/code&gt; sigil:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;iex&lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-storage z-type z-string z-elixir&quot;&gt;~m&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-interpolated z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;(&lt;/span&gt;username age&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;username&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;andrea&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;age&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;27&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;iex&lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;&amp;gt;&lt;/span&gt; username
&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;andrea&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Since sigils support modifiers, we would have &lt;code&gt;~m(...)&lt;/code&gt; to match on string keys and &lt;code&gt;~m(...)a&lt;/code&gt; to match on atom keys. I liked this and wrote:&lt;/p&gt;&lt;blockquote&gt;&lt;p&gt;I stood against the &lt;code&gt;%{foo, bar, baz}&lt;/code&gt; syntax and deemed that too implicit, but I&apos;m in favour of a possible &lt;code&gt;~m&lt;/code&gt; sigil. [...] I took a stab at it and wrote a simple implementation for such sigil. We can try it out and see if we like it.&lt;/p&gt;&lt;/blockquote&gt;&lt;p&gt;I had just released &lt;a href=&quot;https://github.com/whatyouhide/short_maps&quot;&gt;short_maps&lt;/a&gt;. Life was good.&lt;/p&gt;&lt;h2 id=&quot;the-decline&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#the-decline&quot; aria-label=&quot;Anchor link for: the-decline&quot;&gt;The decline&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Fast forward a few years. short_maps is used here and there in the Elixir community. But requests for features keep coming in. Someone wants support for nested maps. Others want the &lt;code&gt;a&lt;/code&gt; modifier to go, defaulting to atoms. At some point, a long discussion takes place in short_maps&apos; &lt;a href=&quot;https://github.com/whatyouhide/short_maps/issues/11&quot;&gt;issue tracker&lt;/a&gt;. The discussion -- a very nice and wholesome discussion, thanks Elixir community! -- eventually leads to a fork of short_maps being published. &lt;a href=&quot;https://github.com/meyercm/shorter_maps&quot;&gt;shorter_maps&lt;/a&gt; supports everything and then some: update syntax, nested maps, string keys through a different sigil, you name it. I was not happy about the fork because it created a &quot;split&quot; in the community who now had two packages to choose from that did similar things. This is democracy and open source though, so all was good.&lt;/p&gt;&lt;p&gt;However, this discussion started to make me think about short_maps and the reason it existed. I had created it so the Elixir community could try out a feature that eventually &lt;em&gt;might&lt;/em&gt; have made it into the core language. It was not meant to be a widely used library: if the community liked it so much, we could have merged it into core. That didn&apos;t seem like the case, but moreover, I was the one not liking it.&lt;/p&gt;&lt;h2 id=&quot;why-i-don-t-like-short-maps&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#why-i-don-t-like-short-maps&quot; aria-label=&quot;Anchor link for: why-i-don-t-like-short-maps&quot;&gt;Why I don&apos;t like short_maps&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;short_maps adds magic to Elixir. When someone uses short_maps in their codebase, it forces folks that read that codebase -- even experienced Elixir developers -- to know about it. Being a syntax feature, it&apos;s really in your face and it makes code hard to read if you are not familiar with it. The distinction between atom keys and string keys is also not obvious, with the result being code that looks more obfuscated. Incidentally, these reasons are what made me dislike the built-in &lt;code&gt;~w&lt;/code&gt; sigil as well. I understand verbosity annoys many, but I wouldn&apos;t sacrifice verbosity over clarity.&lt;/p&gt;&lt;h2 id=&quot;taking-action&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#taking-action&quot; aria-label=&quot;Anchor link for: taking-action&quot;&gt;Taking action&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;All of this led me to be really against short_maps. So I&apos;m taking a dramatic decision: I am retiring short_maps from Hex. Practically, this means that short_maps will still work as usual, but you will get a warning when using it. I feel strongly about moving the community away from this library, but at the same time, I am at peace with this decision because of the existence of shorter_maps. If you really like short_maps, you&apos;ll have shorter_maps available. After all, Elixir is an extensible language and I love it for that, so you should always be free to bend it in whatever way you like.&lt;/p&gt;&lt;h2 id=&quot;conclusion&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#conclusion&quot; aria-label=&quot;Anchor link for: conclusion&quot;&gt;Conclusion&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;From the infamous &lt;a href=&quot;https://github.com/whatyouhide/short_maps/issues/11&quot;&gt;short_maps issue&lt;/a&gt;:&lt;/p&gt;&lt;blockquote&gt;&lt;p&gt;It&apos;s really unfortunate that the split happened. Elixir has far fewer libs than the nodejs ecosystem.&lt;/p&gt;&lt;/blockquote&gt;&lt;p&gt;So there you go. Consider short_maps gone, and the split reverted.&lt;/p&gt;&lt;p&gt;I don&apos;t regret creating short_maps. It was an experiment and it showed me once again how flexible Elixir is. But it&apos;s time for it to go, and in this case, for stability and simplicity to replace experimentation.&lt;/p&gt;&lt;p&gt;Bye short_maps. It was a fun ride. Thanks for listening.&lt;/p&gt;</content>
    
    </entry>
  
    <entry>
      <id>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;posts&#x2F;the-guts-of-a-property-testing-library&#x2F;</id>
      <title type="html"><![CDATA[ The guts of a property testing library ]]></title>
      <link rel="alternate"
            type="text/html"
            href="https://andrealeopardi.com/posts/the-guts-of-a-property-testing-library/"
            title="The guts of a property testing library" />
      <published>2017-08-15T00:00:00+00:00</published>
      <author>
        <name>Andrea Leopardi</name>
        <uri>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;</uri>
        <email>hi@andrealeopardi.com</email>
      </author>
      <updated>2017-08-15T00:00:00+00:00</updated>
      <summary type="html">&lt;p&gt;Property-based testing is a common tool to improve testing by testing properties of a piece of software over many values drawn at random from a large space of valid values. This methodology was first introduced in the paper &lt;a href=&quot;http://www.cs.tufts.edu/~nr/cs257/archive/john-hughes/quick.pdf&quot;&gt;QuickCheck: A Lightweight Tool for Random Testing of Haskell Programs&lt;/a&gt;, which describes the basic idea and shows a possible implementation in Haskell. Since then, many tools to aid in property based testing appeared for many programming languages: as of the time of writing, there are libraries for &lt;a href=&quot;https://hackage.haskell.org/package/QuickCheck&quot;&gt;Haskell&lt;/a&gt;, &lt;a href=&quot;http://www.quviq.com/products/&quot;&gt;Erlang&lt;/a&gt;, &lt;a href=&quot;https://github.com/clojure/test.check&quot;&gt;Clojure&lt;/a&gt;, &lt;a href=&quot;https://hypothesis.works&quot;&gt;Python&lt;/a&gt;, &lt;a href=&quot;https://www.scalacheck.org&quot;&gt;Scala&lt;/a&gt;, and many others. A few days ago I released the first version of &lt;a href=&quot;https://github.com/whatyouhide/stream_data&quot;&gt;StreamData&lt;/a&gt;, a property testing (and data generation) library for &lt;a href=&quot;https://elixir-lang.org&quot;&gt;Elixir&lt;/a&gt; (that is a candidate for inclusion in Elixir itself in the future). This post is not an introduction to property-based testing nor a tutorial on how to use StreamData: what I want to do is dig into the mechanics of how StreamData works, its design, and how it compares to some of the other property-based testing libraries mentioned above.&lt;/p&gt;</summary>
    
      <content type="html">&lt;p&gt;Property-based testing is a common tool to improve testing by testing properties of a piece of software over many values drawn at random from a large space of valid values. This methodology was first introduced in the paper &lt;a href=&quot;http://www.cs.tufts.edu/~nr/cs257/archive/john-hughes/quick.pdf&quot;&gt;QuickCheck: A Lightweight Tool for Random Testing of Haskell Programs&lt;/a&gt;, which describes the basic idea and shows a possible implementation in Haskell. Since then, many tools to aid in property based testing appeared for many programming languages: as of the time of writing, there are libraries for &lt;a href=&quot;https://hackage.haskell.org/package/QuickCheck&quot;&gt;Haskell&lt;/a&gt;, &lt;a href=&quot;http://www.quviq.com/products/&quot;&gt;Erlang&lt;/a&gt;, &lt;a href=&quot;https://github.com/clojure/test.check&quot;&gt;Clojure&lt;/a&gt;, &lt;a href=&quot;https://hypothesis.works&quot;&gt;Python&lt;/a&gt;, &lt;a href=&quot;https://www.scalacheck.org&quot;&gt;Scala&lt;/a&gt;, and many others. A few days ago I released the first version of &lt;a href=&quot;https://github.com/whatyouhide/stream_data&quot;&gt;StreamData&lt;/a&gt;, a property testing (and data generation) library for &lt;a href=&quot;https://elixir-lang.org&quot;&gt;Elixir&lt;/a&gt; (that is a candidate for inclusion in Elixir itself in the future). This post is not an introduction to property-based testing nor a tutorial on how to use StreamData: what I want to do is dig into the mechanics of how StreamData works, its design, and how it compares to some of the other property-based testing libraries mentioned above.&lt;/p&gt;&lt;span id=&quot;continue-reading&quot;&gt;&lt;/span&gt;&lt;p&gt;&lt;img src=&quot;https://andrealeopardi.com/posts/the-guts-of-a-property-testing-library/cover-image.jpg&quot; alt=&quot;Cover image of a factory&quot; /&gt;&lt;/p&gt;&lt;h2 id=&quot;what-streamdata-looks-like&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#what-streamdata-looks-like&quot; aria-label=&quot;Anchor link for: what-streamdata-looks-like&quot;&gt;What StreamData looks like&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Let&apos;s say we want to test a basic property of the &lt;code&gt;:lists.reverse/1&lt;/code&gt; function: that is, we want to test that the first element of a list is the last element of the reverse of that list. These properties written using StreamData would look like this:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;property &lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;the first elem of a list is the last elem of its reverse&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  check all list &lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;&amp;lt;-&lt;/span&gt; list_of&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;int&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    assert hd&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;list&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;==&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;List&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;last&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;lists&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;reverse&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;list&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;This syntax means: take a list randomly generated from the &lt;code&gt;list_of(int())&lt;/code&gt; generator (which generates lists of integers) and test the &lt;code&gt;do&lt;/code&gt; body (the assertion) using the generated list. If the test passes, a new &lt;code&gt;list&lt;/code&gt; is generated and this goes on until a failure is found. When a failure is found, StreamData will try to shrink the &lt;code&gt;list&lt;/code&gt; in order to find the &quot;smallest&quot; example that still fails the property. In the case above, &lt;code&gt;hd/1&lt;/code&gt; will fail for the empty list &lt;code&gt;[]&lt;/code&gt; and StreamData will report that (the correct test would use values generated by &lt;code&gt;non_empty(list_of(int()))&lt;/code&gt;).&lt;/p&gt;&lt;p&gt;&lt;code&gt;check all&lt;/code&gt; is capable of doing more than the above: we can also combine generators, use previously generated values to influence further generators, and filter out values that are not good for our tests. For example, take this trivial test:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;property &lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;in/2 returns true for elements taken out of a list&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  check all list &lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;&amp;lt;-&lt;/span&gt; list_of&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;int&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;            list &lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;!=&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;            elem &lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;&amp;lt;-&lt;/span&gt; member_of&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;list&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    assert elem &lt;span class=&quot;z-keyword z-operator z-elixir&quot;&gt;in&lt;/span&gt; list
&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;As you can see, &lt;code&gt;member_of/1&lt;/code&gt; is a generator and in this case it uses &lt;code&gt;list&lt;/code&gt; which is a value previously generated by the &lt;code&gt;list_of(int())&lt;/code&gt; generator. The &lt;code&gt;list != []&lt;/code&gt; line is a &lt;em&gt;filter&lt;/em&gt;: when a filter fails for a generated value, the test &quot;run&quot; is thrown away and new values are generated.&lt;/p&gt;&lt;h3 id=&quot;data-generation&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#data-generation&quot; aria-label=&quot;Anchor link for: data-generation&quot;&gt;Data generation&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;While until now we only focused on property testing, StreamData also provides data generation functionality. All generators implement the &lt;code&gt;Enumerable&lt;/code&gt; protocol and are infinite streams of data that can easily be used for generating test data and similar purposes.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;StreamData&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;int&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-pipe z-elixir&quot;&gt;|&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Stream&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;map&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-other z-capture z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-capture z-elixir&quot;&gt;&amp;amp;&lt;/span&gt;abs&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-elixir&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-pipe z-elixir&quot;&gt;|&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Enum&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;take&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt;=&amp;gt; [1, 0, 2]
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&quot;the-inner-workings&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#the-inner-workings&quot; aria-label=&quot;Anchor link for: the-inner-workings&quot;&gt;The inner workings&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;The first things I did when starting to research a possible property testing implementation were reading the &lt;a href=&quot;http://www.cs.tufts.edu/~nr/cs257/archive/john-hughes/quick.pdf&quot;&gt;original QuickCheck paper&lt;/a&gt; and having a look at the &lt;a href=&quot;https://hackage.haskell.org/package/QuickCheck&quot;&gt;resulting library&lt;/a&gt;.&lt;/p&gt;&lt;h3 id=&quot;generators&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#generators&quot; aria-label=&quot;Anchor link for: generators&quot;&gt;Generators&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;After reading the paper and doing some more research on Haskell&apos;s implementation, I had a few requirements in mind for the generators:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;they have to be able to generate random values indefinitely (without running out of values);&lt;/li&gt;&lt;li&gt;they have to be &lt;em&gt;reproducible&lt;/em&gt;, that is, they should explicitly &quot;take in&quot; the randomness in order to be able to deterministically &quot;replay&quot; the generated values;&lt;/li&gt;&lt;li&gt;we have to be able to use a &quot;size&quot; to control the space of generated values to be able to start a test run with smaller values and grow the generated values over time.&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;The requirements above already got me going and I implemented the first version of generators. Back then, a generator was a struct (in order to be able to distinguish it from any other term) with just one field, &lt;code&gt;:generator&lt;/code&gt;, which was a function that took a random seed and a size.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;StreamData&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;defstruct&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;generator&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;In the first version, the generator functions had to return &lt;code&gt;{term, :rand.state}&lt;/code&gt; tuples where the first value was the generated value and the second value was the updated random seed. It&apos;s important that generators don&apos;t use a mutable seed or don&apos;t share the seed, and making the seed explicit both as input and as output ensured that by passing the same initial seed around the generated values would have been the same. To give an idea, the &lt;code&gt;int/0&lt;/code&gt; generator (generator of integers) was implemented like this:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  %&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;StreamData&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;generator&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;fn&lt;/span&gt; seed&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; size &lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;random_int&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; new_seed&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;rand&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;uniform_s&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;size &lt;span class=&quot;z-keyword z-operator z-arithmetic z-elixir&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; seed&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;random_int &lt;span class=&quot;z-keyword z-operator z-arithmetic z-elixir&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-elixir&quot;&gt;-&lt;/span&gt; size&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; new_seed&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;As you can see, the &lt;code&gt;seed&lt;/code&gt; is used to generated a random value and the &lt;code&gt;size&lt;/code&gt; is used to control the space this value can be drawn from (in this case, &lt;code&gt;int/0&lt;/code&gt; returns integers in the &lt;code&gt;-size..size&lt;/code&gt; range).&lt;/p&gt;&lt;p&gt;Generating values from this generator was straightforward:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;data &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; int&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;seed0 &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;rand&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;seed_s&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;exs1024&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;first_value&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; seed1&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; data&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;generator&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;seed0&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; _size &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;second_value&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; seed2&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; data&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;generator&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;seed1&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; _size &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; ...and so on
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&quot;random-splitting&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#random-splitting&quot; aria-label=&quot;Anchor link for: random-splitting&quot;&gt;Random splitting&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;This worked fairly well, but when reading the QuickCheck paper again I noticed something I had missed the first time: the seed was never returned alongside the value. What QuickCheck does, instead, is they &quot;split&quot; the seed. Splitting the seed is a way to take one random seed and deterministically return two random seeds. This can be used when we need to use the random seed twice (or more): instead of using something like &lt;code&gt;:rand.uniform_s/2&lt;/code&gt; above, we can split the seed into &lt;code&gt;seed1&lt;/code&gt; and &lt;code&gt;seed2&lt;/code&gt; and use &lt;code&gt;seed1&lt;/code&gt; just once to generate an integer and then throw it away, since we still have &lt;code&gt;seed2&lt;/code&gt; if we need a seed for something else. &lt;code&gt;seed2&lt;/code&gt; can be further split, effectively making us able to use as many seeds as we want to generate values.&lt;/p&gt;&lt;p&gt;With this in mind, I changed the generator function to take a seed and a size but only return a value. If I needed to call a generator twice, I would just split the seed and use the two resulting seeds to call it twice. It now looked like this:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  %&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;StreamData&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;generator&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;fn&lt;/span&gt; seed&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; size &lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;random_int&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; _seed&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;rand&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;uniform_s&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;size &lt;span class=&quot;z-keyword z-operator z-arithmetic z-elixir&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; seed&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;    random_int &lt;span class=&quot;z-keyword z-operator z-arithmetic z-elixir&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-elixir&quot;&gt;-&lt;/span&gt; size
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;data &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; int&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;seed0 &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;rand&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;seed_s&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;exs1024&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;seed1&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; seed2&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; split_seed&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;seed0&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;first_value &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; data&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;generator&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;seed1&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; _size &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;second_value &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; data&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;generator&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;seed2&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; _size &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; ...and so on
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;This worked really well and it&apos;s what ended up being used in StreamData. The only thing that changed is the return value which is not a simple value anymore because of shrinking, which we&apos;ll discuss below.&lt;/p&gt;&lt;h4 id=&quot;random-byte-stream-approach&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#random-byte-stream-approach&quot; aria-label=&quot;Anchor link for: random-byte-stream-approach&quot;&gt;Random byte stream approach&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;This approach is used by Haskell&apos;s QuickCheck but also, for example, by &lt;a href=&quot;https://github.com/clojure/test.check&quot;&gt;Clojure&apos;s test.check&lt;/a&gt;. A very interesting and a bit different approach is taken by &lt;a href=&quot;https://hypothesis.works&quot;&gt;Hypothesis&lt;/a&gt;, Python&apos;s library for property testing. Instead of using a random seed to &quot;drive&quot; the generation, Hypothesis uses an infinite random stream of bytes. Each generator can take as many bytes as needed from the stream to generate a value that is deterministically related to those bytes. This approach is also deterministic and reproducible since by feeding generators the same byte stream, the whole generation is unchanged. This enables Hypothesis to have a &quot;database&quot; of known failures that is just a set of byte streams saved from previous runs: these streams are &quot;replayed&quot; on new runs to ensure known failures are always tested. In StreamData&apos;s case, it would be enough to store the initial seed for the known failure in order to reproduce it. Below we&apos;ll also take a look at how Hypothesis takes advantage of the byte stream approach to model shrinking.&lt;/p&gt;&lt;h3 id=&quot;haskell-s-approach&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#haskell-s-approach&quot; aria-label=&quot;Anchor link for: haskell-s-approach&quot;&gt;Haskell&apos;s approach&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Haskell takes a similar approach to what we have in StreamData (or rather, the other way around) but with a big difference: Haskell is able to use its type system to infer what values to generate just based on the type. So in Haskell, while the generation of integers is done similarly to what we do in &lt;code&gt;int/0&lt;/code&gt; above, there&apos;s no need to define &lt;code&gt;int/0&lt;/code&gt; in the first place but only to define how to generate integers for the &lt;code&gt;Int&lt;/code&gt; type. This makes a noticeable difference, since you can give Haskell&apos;s QuickCheck a function and it will be able to test it on the right randomly generated values just by looking at its type signature. However, the &quot;typed approach&quot; has a drawback, as we&apos;ll see in the &quot;Shrinking&quot; section below.&lt;/p&gt;&lt;h3 id=&quot;shrinking&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#shrinking&quot; aria-label=&quot;Anchor link for: shrinking&quot;&gt;Shrinking&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Once I got generation down, I knew the other toughest problem to tackle was shrinking. Shrinking is an important component of property testing: since property testing is based on the idea of generating random data in order to find bugs in software, often the data that finds the bug is full of &lt;em&gt;noise&lt;/em&gt;. Shrinking is what takes the noise out of the data that causes the failure and finds out the minimal failure case. A common example used to illustrate this is an always-failing property that looks like this:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;property &lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;lists of integers don&amp;#39;t contain 42&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  check all list &lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;&amp;lt;-&lt;/span&gt; list_of&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;int&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    assert &lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;42&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-logical z-elixir&quot;&gt;not&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-elixir&quot;&gt;in&lt;/span&gt; list
&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;This property will fail anytime &lt;code&gt;42&lt;/code&gt; is generated by &lt;code&gt;int()&lt;/code&gt;, but often the list &lt;code&gt;42&lt;/code&gt; is generated in will contain more elements, for example, &lt;code&gt;[30, 12, 9, 0, 4, 42, 93]&lt;/code&gt;. From this list, it&apos;s hard to tell that the failure is caused by the number &lt;code&gt;42&lt;/code&gt; being in the list. After shrinking the list, however, StreamData will reduce it to &lt;code&gt;[42]&lt;/code&gt; which is the minimal value that &lt;code&gt;list_of(int())&lt;/code&gt; can generate that fails the property.&lt;/p&gt;&lt;h4 id=&quot;the-typed-approach-to-shrinking&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#the-typed-approach-to-shrinking&quot; aria-label=&quot;Anchor link for: the-typed-approach-to-shrinking&quot;&gt;The typed approach to shrinking&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;The approach Haskell takes is straightforward: it completely separates generation and shrinking. Haskell can do this fairly easily thanks to its type system. All you need to generate data and to shrink such data is a type. QuickCheck for Haskell defines a &lt;code&gt;Arbitrary&lt;/code&gt; class that defines two functions, &lt;code&gt;arbitrary&lt;/code&gt; and &lt;code&gt;shrink&lt;/code&gt;:&lt;/p&gt;&lt;pre data-lang=&quot;haskell&quot; class=&quot;language-haskell z-code&quot;&gt;&lt;code class=&quot;language-haskell&quot; data-lang=&quot;haskell&quot;&gt;&lt;span class=&quot;z-source z-haskell&quot;&gt;&lt;span class=&quot;z-meta z-declaration z-class z-haskell&quot;&gt;&lt;span class=&quot;z-keyword z-other z-haskell&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;z-entity z-other z-inherited-class z-haskell&quot;&gt;Arbitrary&lt;/span&gt;&lt;span class=&quot;z-variable z-other z-generic-type z-haskell&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;z-keyword z-other z-haskell&quot;&gt;where&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-haskell&quot;&gt;&lt;span class=&quot;z-meta z-function z-type-declaration z-haskell&quot;&gt;&lt;span class=&quot;z-entity z-name z-function z-haskell&quot;&gt;arbitrary&lt;/span&gt;&lt;span class=&quot;z-keyword z-other z-double-colon z-haskell&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-haskell&quot;&gt;Gen&lt;/span&gt;&lt;span class=&quot;z-variable z-other z-generic-type z-haskell&quot;&gt;a&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-haskell&quot;&gt;&lt;span class=&quot;z-meta z-function z-type-declaration z-haskell&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-type-declaration z-haskell&quot;&gt;&lt;span class=&quot;z-entity z-name z-function z-haskell&quot;&gt;shrink&lt;/span&gt;&lt;span class=&quot;z-keyword z-other z-double-colon z-haskell&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;z-variable z-other z-generic-type z-haskell&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;z-keyword z-other z-arrow z-haskell&quot;&gt;-&amp;gt;&lt;/span&gt; [&lt;span class=&quot;z-variable z-other z-generic-type z-haskell&quot;&gt;a&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The &lt;code&gt;arbitrary&lt;/code&gt; function is responsible for generating a random value for the type that implements the class. &lt;code&gt;Gen a&lt;/code&gt; is a wrapper type around a function that takes a random seed and a size and returns a value of type &lt;code&gt;a&lt;/code&gt; (same as what StreamData does as we described above). For example, &lt;code&gt;arbitrary&lt;/code&gt; for the &lt;code&gt;Int&lt;/code&gt; type is implemented very similarly to how we implemented the function in &lt;code&gt;int/0&lt;/code&gt; above.&lt;/p&gt;&lt;p&gt;The &lt;code&gt;shrink&lt;/code&gt; function is completely independent of the &lt;code&gt;arbitrary&lt;/code&gt; function. It takes a value of type &lt;code&gt;a&lt;/code&gt; (let&apos;s call it &lt;code&gt;x&lt;/code&gt;) and returns a list of values of type &lt;code&gt;a&lt;/code&gt;. These values should be the possible shrinks of &lt;code&gt;x&lt;/code&gt;. To go into slightly more detail, the return value of &lt;code&gt;shrink&lt;/code&gt; should be the first level of the &lt;em&gt;shrink tree&lt;/em&gt; for &lt;code&gt;x&lt;/code&gt;: as you can imagine, since the shrinks of &lt;code&gt;x&lt;/code&gt; are of the same &lt;code&gt;a&lt;/code&gt; type, they can also be passed to the &lt;code&gt;shrink&lt;/code&gt; function and be further shrunk. This can be done recursively, effectively forming a tree of shrinks of &lt;code&gt;x&lt;/code&gt;. Note that thanks to Haskell&apos;s laziness, this tree is completely lazy: the list returned by &lt;code&gt;shrink&lt;/code&gt; is evaluated one element at the time when needed, so when we want to &quot;go down&quot; in the tree instead of &quot;going left&quot;, we can just call &lt;code&gt;shrink&lt;/code&gt; on a value and the rest of the original list will not be evaluated.&lt;/p&gt;&lt;p&gt;&lt;code&gt;shrink&lt;/code&gt; is easy to implement as well: for example, &lt;code&gt;shrink&lt;/code&gt; for the &lt;code&gt;[a]&lt;/code&gt; type could simply take a list and return all the lists obtained by removing each element from the original list. This would make the tree have smaller lists as we go down in the tree, ending up with &lt;code&gt;[]&lt;/code&gt; (the smallest list) as leaves.&lt;/p&gt;&lt;p&gt;This approach is elegant and easy to implement, but it has one major drawback. Since generation and shrinking are completely separated, any generation logic that is not encoded in the type must be repeated when shrinking. To understand what this means, let&apos;s say we want to generate even integers. Assuming we have a &lt;code&gt;map/2&lt;/code&gt; function that maps a function over values generated by a generator, the &lt;code&gt;even_int&lt;/code&gt; generator would look like this:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;map&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;int&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; &amp;amp;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-capture z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-capture z-elixir&quot;&gt;&amp;amp;&lt;/span&gt;1&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-elixir&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;This generator correctly generates even integers but in the typed approach such integers would still be shrunk as integers, so we would have to repeat the even logic when using this generator in tests:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Integer&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;check all i &lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;&amp;lt;-&lt;/span&gt; even_int&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Integer&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;is_even&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; ...
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The solution to this problem is to couple generation and shrinking,&lt;/p&gt;&lt;h4 id=&quot;lazy-trees&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#lazy-trees&quot; aria-label=&quot;Anchor link for: lazy-trees&quot;&gt;Lazy trees&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;The approach I went with (which was taken straight out of &lt;code&gt;test.check&lt;/code&gt;) keeps in mind the idea of a &lt;em&gt;shrink tree&lt;/em&gt; mentioned above. Basically, a generator now returns a &lt;code&gt;StreamData.LazyTree&lt;/code&gt; struct instead of a simple value. A &quot;lazy tree&quot; is a tree that has a realized (that is, not eager) root and a lazy stream of children, each child being a lazy tree itself.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;StreamData&lt;/span&gt;.&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;LazyTree&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;defstruct&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;root&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;children&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The root is the generated value, and the children are the shrunk values. The first level (the root of each child) is the first level in the shrink tree which corresponds to the return value of &lt;code&gt;shrink&lt;/code&gt; in the Haskell implementation. Let&apos;s see how the &lt;code&gt;list_of/1&lt;/code&gt; generator, which takes a generator and generates lists of values generated by that generator, could be implemented returning a lazy tree:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;list_of&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  %&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;StreamData&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;generator&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;fn&lt;/span&gt; seed&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; size &lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;seed1&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; seed2&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; split_seed&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;seed&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;length&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; _&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;rand&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;uniform_s&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;size&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; seed1&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; Let&amp;#39;s pretend we have a function that generates values from a generator
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; for &amp;quot;n&amp;quot; times.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;    root &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; generate_n_values&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;data&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; length&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; seed2&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; size&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;    list_lazy_tree&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;root&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defp&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-private z-elixir&quot;&gt;list_lazy_tree&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  %&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;LazyTree&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;root&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;children&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defp&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-private z-elixir&quot;&gt;list_lazy_tree&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;list&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  children &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-elixir&quot;&gt;..&lt;/span&gt;length&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;list&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-elixir&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-pipe z-elixir&quot;&gt;|&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Stream&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;map&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&amp;amp;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;List&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;delete_at&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;list&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-capture z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-capture z-elixir&quot;&gt;&amp;amp;&lt;/span&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-pipe z-elixir&quot;&gt;|&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Stream&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;map&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-other z-capture z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-capture z-elixir&quot;&gt;&amp;amp;&lt;/span&gt;list_lazy_tree&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-elixir&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  %&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;LazyTree&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;root&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; list&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;children&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; children&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The core idea is that the root of the lazy tree we return is the generated list. The first-level children are a stream of trees where the roots are the values obtained by removing each element one at a time from the generated list, and the children are recursively calculated using the same process.&lt;/p&gt;&lt;p&gt;Generator combinators (such as &lt;code&gt;map/2&lt;/code&gt;) now just transform the whole tree instead of just the returned value. For example, &lt;code&gt;map/2&lt;/code&gt; maps the given function over all the values in each tree generated by the given generator.&lt;/p&gt;&lt;p&gt;With lazy trees in place, shrinking becomes straightforward: it&apos;s now just a fancy depth-first search in the lazy tree. Basically, we walk down the tree until we find a value that passes the test, and then we move &quot;to the right&quot; and start again. When a node passes and has no right siblings, the parent is the smallest failing value; when it fails and has no right siblings or children, it&apos;s the smallest failing value. This algorithm does not explore the whole tree (which is unfeasible since when we start composing generators the trees can become very large) but in practice it usually finds very good shrinks.&lt;/p&gt;&lt;h4 id=&quot;random-byte-stream-approach-to-shrinking-this-time&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#random-byte-stream-approach-to-shrinking-this-time&quot; aria-label=&quot;Anchor link for: random-byte-stream-approach-to-shrinking-this-time&quot;&gt;Random byte stream approach (to shrinking this time)&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;I briefly mentioned above that Hypothesis, Python&apos;s library for property-based testing, uses an infinite stream of random bytes that generators can use to generate values. This stream is the foundation of shrinking as well: when we need to shrink a value, we can remove bytes from the original stream and also shrink bytes of the original stream (towards 0). Generators are expected to be written so that they are somehow &quot;proportional&quot; to the byte stream so that shrinking the byte stream also shrinks the generated value. By using a deterministic way to generate values from the byte stream, shrinking is also deterministic. Hypothesis&apos; approach is fascinating, and I am doing some research to see how it compares practically to our approach and our platform, to evaluate a potential switch to this architecture.&lt;/p&gt;&lt;h2 id=&quot;conclusion&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#conclusion&quot; aria-label=&quot;Anchor link for: conclusion&quot;&gt;Conclusion&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;I had tons of fun writing this library and learned a lot of things. This post was just a little insight on how I learned those things and hopefully an interesting read for everyone and especially potential contributors to StreamData.&lt;/p&gt;&lt;h3 id=&quot;credit&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#credit&quot; aria-label=&quot;Anchor link for: credit&quot;&gt;Credit&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Most ideas in StreamData are not original and are taken partially from QuickCheck but mostly from &lt;code&gt;test.check&lt;/code&gt;, so a big thank you goes to everyone that helped with those projects. This blog post was also influenced by &lt;a href=&quot;https://hypothesis.works/articles/how-hypothesis-works/&quot;&gt;this great article&lt;/a&gt; by the author of Hypothesis, so thank you as well, David!&lt;/p&gt;</content>
    
    </entry>
  
    <entry>
      <id>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;posts&#x2F;using-c-from-elixir-with-nifs&#x2F;</id>
      <title type="html"><![CDATA[ Using C from Elixir with NIFs ]]></title>
      <link rel="alternate"
            type="text/html"
            href="https://andrealeopardi.com/posts/using-c-from-elixir-with-nifs/"
            title="Using C from Elixir with NIFs" />
      <published>2015-12-05T00:00:00+00:00</published>
      <author>
        <name>Andrea Leopardi</name>
        <uri>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;</uri>
        <email>hi@andrealeopardi.com</email>
      </author>
      <updated>2015-12-05T00:00:00+00:00</updated>
      <summary type="html">&lt;p&gt;Erlang supports a way to implement functions in C and use them transparently from Erlang. These functions are called NIFs (native implemented functions). There are two scenarios where NIFs can turn out to be the perfect solution: when you need raw computing speed and when you need to interface to existing C bindings from Erlang. In this article, we&apos;re going to take a look at both use cases.&lt;/p&gt;</summary>
    
      <content type="html">&lt;p&gt;Erlang supports a way to implement functions in C and use them transparently from Erlang. These functions are called NIFs (native implemented functions). There are two scenarios where NIFs can turn out to be the perfect solution: when you need raw computing speed and when you need to interface to existing C bindings from Erlang. In this article, we&apos;re going to take a look at both use cases.&lt;/p&gt;&lt;span id=&quot;continue-reading&quot;&gt;&lt;/span&gt;&lt;p&gt;Note that if we want to use C bindings (i.e., we want to interface with an existing C program), then NIFs are not our only choice. Erlang has other ways to do foreign-function interface in order to talk to other languages. One example is ports; Saša Jurić wrote an excellent &lt;a href=&quot;https://theerlangelist.com/article/outside_elixir&quot;&gt;blog post&lt;/a&gt; about ports if you want to know more about them.&lt;/p&gt;&lt;p&gt;Here, we&apos;ll take a look at all-things-NIFs. First, we&apos;ll see how to write simple NIFs that perform calculations; then, we&apos;ll see how to use those NIFs from Elixir. Later on, we will see how to interface with existing C bindings from NIFs. Finally, we&apos;ll see how to integrate the C compilation step into the compilation of our Elixir code.&lt;/p&gt;&lt;p&gt;Most of the things I&apos;ll talk about here can be read in more detail in the Erlang &lt;a href=&quot;https://www.erlang.org/doc/man/erl_nif.html&quot;&gt;documentation for the &lt;code&gt;erl_nif&lt;/code&gt; C library&lt;/a&gt;.&lt;/p&gt;&lt;p&gt;The things discussed in this article apply both to Erlang and Elixir with minimal tweaking. I&apos;ll show all my examples in Elixir, but I&apos;ll refer to Erlang and Elixir indifferently.&lt;/p&gt;&lt;h2 id=&quot;canonical-nif-warning&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#canonical-nif-warning&quot; aria-label=&quot;Anchor link for: canonical-nif-warning&quot;&gt;Canonical NIF warning&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;NIFs are &lt;strong&gt;dangerous&lt;/strong&gt;. I bet you&apos;ve heard about how Erlang (and Elixir) are reliable and fault-tolerant, how processes are isolated and a crash in a process only takes that process down, and other resiliency properties. You can kiss all that good stuff goodbye when you start to play with NIFs. A crash in a NIF (such as a dreaded segmentation fault) will &lt;strong&gt;crash the entire Erlang VM&lt;/strong&gt;. No supervisors to the rescue, no fault-tolerance, no isolation. This means you need to be extremely careful when writing NIFs, and you should always make sure that you have a good reason to use them.&lt;/p&gt;&lt;p&gt;Another thing worth noting is that NIFs are not preempted by the Erlang scheduler: a NIF runs as a single unit of computation and cannot be interrupted. This means your NIFs should strive to be as fast as possible; as the Erlang documentation for NIFs suggest, a good rule of thumb is to keep NIFs under a millisecond of execution time. Check out the Erlang documentation for suggestions on what to do when your NIFs need more time to finish.&lt;/p&gt;&lt;h2 id=&quot;the-basics&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#the-basics&quot; aria-label=&quot;Anchor link for: the-basics&quot;&gt;The basics&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;The way NIF works is simple: you write a C file and export a bunch of functions with the help of some Erlang-provided facilities, then compile that file. Then, you define an Erlang/Elixir module and call &lt;code&gt;:erlang.load_nif/2&lt;/code&gt; in it. This function will define all the NIFs in the C file as functions in the calling module.&lt;/p&gt;&lt;p&gt;It&apos;s easier to see this in practice.&lt;/p&gt;&lt;p&gt;Let&apos;s start easy: let&apos;s write a NIF with no side effects that only takes a value in and returns a value out. For the purpose of this example, we&apos;ll write &lt;code&gt;fast_compare&lt;/code&gt;, a function that takes two integers and compares them, returning &lt;code&gt;0&lt;/code&gt; if they&apos;re equal, &lt;code&gt;-1&lt;/code&gt; if the first is smaller than the second and &lt;code&gt;1&lt;/code&gt; otherwise.&lt;/p&gt;&lt;h3 id=&quot;defining-a-nif&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#defining-a-nif&quot; aria-label=&quot;Anchor link for: defining-a-nif&quot;&gt;Defining a NIF&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Let&apos;s start with the C side of things: we&apos;ll work on &lt;code&gt;fast_compare.c&lt;/code&gt;. The first thing we have to do is include the &lt;code&gt;erl_nif.h&lt;/code&gt; header file, which contains all the stuff we need (types, functions, and macros) to work with NIFs.&lt;/p&gt;&lt;pre data-lang=&quot;c&quot; class=&quot;language-c z-code&quot;&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-preprocessor z-include z-c&quot;&gt;&lt;span class=&quot;z-keyword z-control z-import z-include z-c&quot;&gt;#include&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-include z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-c&quot;&gt;&amp;quot;&lt;/span&gt;erl_nif.h&lt;span class=&quot;z-punctuation z-definition z-string z-end z-c&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The C compiler won&apos;t know where &lt;code&gt;erl_nif.h&lt;/code&gt; is so we&apos;ll have to specify that when we compile our program later on.&lt;/p&gt;&lt;p&gt;Now, every C file defining NIFs has a similar structure: there&apos;s a list of C functions, then a list of which of these C functions should be exported to Erlang/Elixir (and with what name), and finally a call to the &lt;code&gt;ERL_NIF_INIT&lt;/code&gt; macro, which performs all the magic needed to actually hook things up.&lt;/p&gt;&lt;p&gt;For our example, the list of C function will only include the &lt;code&gt;fast_compare&lt;/code&gt; function. The signature of this function looks like this:&lt;/p&gt;&lt;pre data-lang=&quot;c&quot; class=&quot;language-c z-code&quot;&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-c&quot;&gt;static&lt;/span&gt; ERL_NIF_TERM
&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-entity z-name z-function z-c&quot;&gt;fast_compare&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;ErlNifEnv &lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-c&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-c&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-c&quot;&gt;argc&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-c&quot;&gt;const&lt;/span&gt; ERL_NIF_TERM &lt;span class=&quot;z-variable z-parameter z-c&quot;&gt;argv&lt;/span&gt;&lt;span class=&quot;z-meta z-brackets z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-brackets z-begin z-c&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-brackets z-end z-c&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-c&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-c&quot;&gt;//&lt;/span&gt; cool stuff here
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-c&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;There are two NIF-specific types here: &lt;code&gt;ERL_NIF_TERM&lt;/code&gt; and &lt;code&gt;ErlNifEnv&lt;/code&gt;. &lt;code&gt;ERL_NIF_TERM&lt;/code&gt; is a &quot;wrapper&quot; type that represents all Erlang types (like binary, list, tuple, and so on) in C. We&apos;ll have to use functions provided by &lt;code&gt;erl_nif.h&lt;/code&gt; in order to convert a &lt;code&gt;ERL_NIF_TERM&lt;/code&gt; to a C value (or multiple C values) and vice versa. &lt;code&gt;ErlNifEnv&lt;/code&gt; is just the Erlang environment the NIF is executed in, and we&apos;ll mostly just pass this around without actually doing anything with it.&lt;/p&gt;&lt;p&gt;Let&apos;s take a look at the arguments for &lt;code&gt;fast_compare&lt;/code&gt; (which are the same for all NIFs):&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;code&gt;env&lt;/code&gt;, as mentioned above, is just the Erlang environment the NIF is executed in and we won&apos;t care too much about it;&lt;/li&gt;&lt;li&gt;&lt;code&gt;argc&lt;/code&gt; is the number of arguments passed to the NIF when called from Erlang. We&apos;ll expand on this later;&lt;/li&gt;&lt;li&gt;&lt;code&gt;argv&lt;/code&gt; is the array of arguments passed to the NIF.&lt;/li&gt;&lt;/ul&gt;&lt;h3 id=&quot;reading-erlang-elixir-values-into-c-values&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#reading-erlang-elixir-values-into-c-values&quot; aria-label=&quot;Anchor link for: reading-erlang-elixir-values-into-c-values&quot;&gt;Reading Erlang/Elixir values into C values&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;We&apos;ll call &lt;code&gt;fast_compare&lt;/code&gt; from Elixir like this:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;fast_compare&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;99&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt;=&amp;gt; -1
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;When executing &lt;code&gt;fast_compare&lt;/code&gt;, &lt;code&gt;argc&lt;/code&gt; will be &lt;code&gt;2&lt;/code&gt; and &lt;code&gt;argv&lt;/code&gt; will be an array with the &lt;code&gt;99&lt;/code&gt; and &lt;code&gt;100&lt;/code&gt; values. These arguments however are of type &lt;code&gt;ERL_NIF_TERM&lt;/code&gt;, so we have to &quot;convert&quot; them to C terms before being able to manipulate them. &lt;code&gt;erl_nif.h&lt;/code&gt; provides functions to &quot;get&quot; Erlang terms into C terms; in this case, we need &lt;code&gt;enif_get_int&lt;/code&gt;. The signature for &lt;code&gt;enif_get_int&lt;/code&gt; is this:&lt;/p&gt;&lt;pre data-lang=&quot;c&quot; class=&quot;language-c z-code&quot;&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-storage z-type z-c&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-entity z-name z-function z-c&quot;&gt;enif_get_int&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;ErlNifEnv &lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-c&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt; ERL_NIF_TERM &lt;span class=&quot;z-variable z-parameter z-c&quot;&gt;term&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-c&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-c&quot;&gt;ip&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;We have to pass in the environment &lt;code&gt;env&lt;/code&gt;, the Erlang term we want to &quot;get&quot; (which we&apos;ll take from &lt;code&gt;argv&lt;/code&gt;) and the address of an integer pointer that will be filled with the Erlang integer value. It will return 0 if &lt;code&gt;term&lt;/code&gt; is not an integer.&lt;/p&gt;&lt;h3 id=&quot;turning-c-values-to-erlang-values&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#turning-c-values-to-erlang-values&quot; aria-label=&quot;Anchor link for: turning-c-values-to-erlang-values&quot;&gt;Turning C values to Erlang values&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;&lt;code&gt;erl_nif.h&lt;/code&gt; provides several &lt;code&gt;enif_make_*&lt;/code&gt; functions to convert C values back to Erlang values. They all have a similar signature (which is adapted to the type each function has to convert) and they all return a &lt;code&gt;ERL_NIF_TERM&lt;/code&gt; value. In our case, we&apos;ll need &lt;code&gt;enif_make_int&lt;/code&gt;, which has this signature:&lt;/p&gt;&lt;pre data-lang=&quot;c&quot; class=&quot;language-c z-code&quot;&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span class=&quot;z-source z-c&quot;&gt;ERL_NIF_TERM &lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-entity z-name z-function z-c&quot;&gt;enif_make_int&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;ErlNifEnv &lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-c&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-c&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-c&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&quot;writing-the-nif&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#writing-the-nif&quot; aria-label=&quot;Anchor link for: writing-the-nif&quot;&gt;Writing the NIF&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Now that we know how to go back and forth between Erlang values and C values, writing the NIF is straightforward.&lt;/p&gt;&lt;pre data-lang=&quot;c&quot; class=&quot;language-c z-code&quot;&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-c&quot;&gt;static&lt;/span&gt; ERL_NIF_TERM
&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-entity z-name z-function z-c&quot;&gt;fast_compare&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;ErlNifEnv &lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-c&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-c&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-c&quot;&gt;argc&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-c&quot;&gt;const&lt;/span&gt; ERL_NIF_TERM &lt;span class=&quot;z-variable z-parameter z-c&quot;&gt;argv&lt;/span&gt;&lt;span class=&quot;z-meta z-brackets z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-brackets z-begin z-c&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-brackets z-end z-c&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-c&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-storage z-type z-c&quot;&gt;int&lt;/span&gt; a&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt; b&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-c&quot;&gt;//&lt;/span&gt; Fill a and b with the values of the first two args
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-keyword z-control z-c&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-c&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-variable z-function z-c&quot;&gt;enif_get_int&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;env&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt; argv&lt;span class=&quot;z-meta z-brackets z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-brackets z-begin z-c&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-c&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-brackets z-end z-c&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;&amp;amp;&lt;/span&gt;a&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-c&quot;&gt;||&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-c&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-variable z-function z-c&quot;&gt;enif_get_int&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;env&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt; argv&lt;span class=&quot;z-meta z-brackets z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-brackets z-begin z-c&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-c&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-brackets z-end z-c&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;&amp;amp;&lt;/span&gt;b&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-c&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-keyword z-control z-flow z-return z-c&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-variable z-function z-c&quot;&gt;enif_make_badarg&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;env&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-c&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-c&quot;&gt;//&lt;/span&gt; Usual C unreadable code because this way is more true
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-storage z-type z-c&quot;&gt;int&lt;/span&gt; result &lt;span class=&quot;z-keyword z-operator z-assignment z-c&quot;&gt;=&lt;/span&gt; a &lt;span class=&quot;z-keyword z-operator z-comparison z-c&quot;&gt;==&lt;/span&gt; b &lt;span class=&quot;z-keyword z-operator z-ternary z-c&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-c&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-ternary z-c&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;a &lt;span class=&quot;z-keyword z-operator z-comparison z-c&quot;&gt;&amp;gt;&lt;/span&gt; b &lt;span class=&quot;z-keyword z-operator z-ternary z-c&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-c&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-ternary z-c&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-c&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-c&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-keyword z-control z-flow z-return z-c&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-variable z-function z-c&quot;&gt;enif_make_int&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;env&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt; result&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-c&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&quot;wiring-our-c-up&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#wiring-our-c-up&quot; aria-label=&quot;Anchor link for: wiring-our-c-up&quot;&gt;Wiring our C up&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;We now have to export the function we wrote to Erlang. We&apos;ll have to use the &lt;code&gt;ERL_NIF_INIT&lt;/code&gt; macro. It looks like this:&lt;/p&gt;&lt;pre data-lang=&quot;c&quot; class=&quot;language-c z-code&quot;&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-assumed-macro z-c&quot;&gt;&lt;span class=&quot;z-variable z-function z-assumed-macro z-c&quot;&gt;ERL_NIF_INIT&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;erl_module&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt; functions&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt; load&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt; upgrade&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt; unload&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt; reload&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;where:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;code&gt;erl_module&lt;/code&gt; is the Erlang module where the NIFs we export will be defined; it shouldn&apos;t be surrounded by quotes as it will be string-ified by the &lt;code&gt;ERL_NIF_INIT&lt;/code&gt; macro (for example, &lt;code&gt;my_module&lt;/code&gt; instead of &lt;code&gt;&quot;my_module&quot;&lt;/code&gt;);&lt;/li&gt;&lt;li&gt;&lt;code&gt;functions&lt;/code&gt; is an array of &lt;code&gt;ErlNifFunc&lt;/code&gt; structs that defines which NIFs will be exported, along with the name to use as their Erlang counterpart and the arity;&lt;/li&gt;&lt;li&gt;&lt;code&gt;load&lt;/code&gt;, &lt;code&gt;upgrade&lt;/code&gt;, &lt;code&gt;unload&lt;/code&gt;, and &lt;code&gt;reload&lt;/code&gt; are function pointers that point to hook functions that will be called when the NIF module is loaded, unloaded, and so on; we won&apos;t pay too much attention to these hooks right now, setting all of them to &lt;code&gt;NULL&lt;/code&gt;.&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;We have all the ingredients we need. The complete C file looks like this:&lt;/p&gt;&lt;pre data-lang=&quot;c&quot; class=&quot;language-c z-code&quot;&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-preprocessor z-include z-c&quot;&gt;&lt;span class=&quot;z-keyword z-control z-import z-include z-c&quot;&gt;#include&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-include z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-c&quot;&gt;&amp;quot;&lt;/span&gt;erl_nif.h&lt;span class=&quot;z-punctuation z-definition z-string z-end z-c&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-c&quot;&gt;static&lt;/span&gt; ERL_NIF_TERM
&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-entity z-name z-function z-c&quot;&gt;fast_compare&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;ErlNifEnv &lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-c&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-c&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-c&quot;&gt;argc&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-c&quot;&gt;const&lt;/span&gt; ERL_NIF_TERM &lt;span class=&quot;z-variable z-parameter z-c&quot;&gt;argv&lt;/span&gt;&lt;span class=&quot;z-meta z-brackets z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-brackets z-begin z-c&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-brackets z-end z-c&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-c&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-storage z-type z-c&quot;&gt;int&lt;/span&gt; a&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt; b&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-keyword z-control z-c&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-c&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-variable z-function z-c&quot;&gt;enif_get_int&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;env&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt; argv&lt;span class=&quot;z-meta z-brackets z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-brackets z-begin z-c&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-c&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-brackets z-end z-c&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;&amp;amp;&lt;/span&gt;a&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-c&quot;&gt;||&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-c&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-variable z-function z-c&quot;&gt;enif_get_int&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;env&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt; argv&lt;span class=&quot;z-meta z-brackets z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-brackets z-begin z-c&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-c&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-brackets z-end z-c&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;&amp;amp;&lt;/span&gt;b&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-c&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-keyword z-control z-flow z-return z-c&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-variable z-function z-c&quot;&gt;enif_make_badarg&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;env&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-c&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-storage z-type z-c&quot;&gt;int&lt;/span&gt; result &lt;span class=&quot;z-keyword z-operator z-assignment z-c&quot;&gt;=&lt;/span&gt; a &lt;span class=&quot;z-keyword z-operator z-comparison z-c&quot;&gt;==&lt;/span&gt; b &lt;span class=&quot;z-keyword z-operator z-ternary z-c&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-c&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-ternary z-c&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;a &lt;span class=&quot;z-keyword z-operator z-comparison z-c&quot;&gt;&amp;gt;&lt;/span&gt; b &lt;span class=&quot;z-keyword z-operator z-ternary z-c&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-c&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-ternary z-c&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-c&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-c&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-keyword z-control z-flow z-return z-c&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-variable z-function z-c&quot;&gt;enif_make_int&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;env&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt; result&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-c&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-c&quot;&gt;//&lt;/span&gt; Let&amp;#39;s define the array of ErlNifFunc beforehand:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-c&quot;&gt;static&lt;/span&gt; ErlNifFunc nif_funcs&lt;span class=&quot;z-meta z-brackets z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-brackets z-begin z-c&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-brackets z-end z-c&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-c&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-c&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-c&quot;&gt;//&lt;/span&gt; {erl_function_name, erl_function_arity, c_function}
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-c&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-c&quot;&gt;&amp;quot;&lt;/span&gt;fast_compare&lt;span class=&quot;z-punctuation z-definition z-string z-end z-c&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-c&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt; fast_compare&lt;span class=&quot;z-punctuation z-section z-block z-end z-c&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-c&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-assumed-macro z-c&quot;&gt;&lt;span class=&quot;z-variable z-function z-assumed-macro z-c&quot;&gt;ERL_NIF_INIT&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;Elixir&lt;span class=&quot;z-punctuation z-accessor z-c&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-variable z-other z-member z-c&quot;&gt;FastCompare&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt; nif_funcs&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-c&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-c&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-c&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-c&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Remember we have to use the full Elixir module name atom in the &lt;code&gt;ERL_NIF_INIT&lt;/code&gt; macro (&lt;code&gt;Elixir.FastCompare&lt;/code&gt; instead of just &lt;code&gt;FastCompare&lt;/code&gt;).&lt;/p&gt;&lt;h3 id=&quot;compiling-our-c-code&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#compiling-our-c-code&quot; aria-label=&quot;Anchor link for: compiling-our-c-code&quot;&gt;Compiling our C code&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;NIF files should be compiled to &lt;code&gt;.so&lt;/code&gt; shared objects. The compilation flags vary between different systems and compilers, but they should look something like this:&lt;/p&gt;&lt;pre data-lang=&quot;bash&quot; class=&quot;language-bash z-code&quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;z-source z-shell z-bash&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-shell&quot;&gt;&lt;span class=&quot;z-variable z-function z-shell&quot;&gt;$&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-arguments z-shell&quot;&gt; cc&lt;span class=&quot;z-variable z-parameter z-option z-shell&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-parameter z-shell&quot;&gt; -&lt;/span&gt;fPIC&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-option z-shell&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-parameter z-shell&quot;&gt; -&lt;/span&gt;I&lt;span class=&quot;z-meta z-group z-expansion z-command z-parens z-shell&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-variable z-shell&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-parens z-begin z-shell&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-shell&quot;&gt;&lt;span class=&quot;z-variable z-function z-shell&quot;&gt;ERL_INCLUDE_PATH&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-parens z-end z-shell&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-continuation z-line z-shell&quot;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-shell z-bash&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-arguments z-shell&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-option z-shell&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-parameter z-shell&quot;&gt;     -&lt;/span&gt;dynamiclib&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-option z-shell&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-parameter z-shell&quot;&gt; -&lt;/span&gt;undefined&lt;/span&gt; dynamic_lookup &lt;span class=&quot;z-punctuation z-separator z-continuation z-line z-shell&quot;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-shell z-bash&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-arguments z-shell&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-option z-shell&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-parameter z-shell&quot;&gt;     -&lt;/span&gt;o&lt;/span&gt; fast_compare.so fast_compare.c&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;With this command, we&apos;re compiling &lt;code&gt;fast_compare.c&lt;/code&gt; into &lt;code&gt;fast_compare.so&lt;/code&gt; (&lt;code&gt;-o fast_compare.so&lt;/code&gt;), using some flags for dynamic code along the way. Note how we&apos;re including &lt;code&gt;$(ERL_INCLUDE_PATH)&lt;/code&gt; in the &quot;include paths&quot;: this is the directory that contains the &lt;code&gt;erl_nif.h&lt;/code&gt; header file. This path is usually in the Erlang&apos;s installation directory, under &lt;code&gt;lib/erts-VERSION/include&lt;/code&gt;.&lt;/p&gt;&lt;h3 id=&quot;loading-nifs-in-elixir&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#loading-nifs-in-elixir&quot; aria-label=&quot;Anchor link for: loading-nifs-in-elixir&quot;&gt;Loading NIFs in Elixir&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;The only thing we have left to do is load the NIF we defined in the Elixir &lt;code&gt;FastCompare&lt;/code&gt; module. As the Erlang documentation for NIFs suggests, the &lt;code&gt;@on_load&lt;/code&gt; hook is a great place to do this.&lt;/p&gt;&lt;p&gt;Note that for each NIF we want to define, we need to define the corresponding Erlang/Elixir function in the loading module as well. This can be taken advantage of in order to define, for example, fallback code in case NIFs aren&apos;t available.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; fast_compare.ex
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;FastCompare&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-variable z-other z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-definition z-constant z-elixir&quot;&gt;@&lt;/span&gt;on_load&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;load_nifs&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;load_nifs&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;erlang&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;load_nif&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-single z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;#39;&lt;/span&gt;./fast_compare&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;fast_compare&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;_a&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; _b&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;raise&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;NIF fast_compare/2 not implemented&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The second term for &lt;code&gt;:erlang.load_nif/2&lt;/code&gt; can be anything and it will be passed to the &lt;code&gt;load&lt;/code&gt; hook we mentioned above. You can have a look at the &lt;a href=&quot;https://www.erlang.org/doc/man/erlang.html#load_nif-2&quot;&gt;docs for &lt;code&gt;:erlang.load_nif/2&lt;/code&gt;&lt;/a&gt; for more information.&lt;/p&gt;&lt;p&gt;We&apos;re done! We can test our module in IEx:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;iex&lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;&amp;gt;&lt;/span&gt; c &lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;fast_compare.ex&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;iex&lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;FastCompare&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;fast_compare&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;99&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-elixir&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&quot;examples-in-the-wild&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#examples-in-the-wild&quot; aria-label=&quot;Anchor link for: examples-in-the-wild&quot;&gt;Examples in the wild&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Writing &quot;pure&quot; NIFs (with no side effects, just transformations) is extremely useful. One example of this that I like a lot is the &lt;a href=&quot;https://github.com/devinus/markdown&quot;&gt;devinus/markdown&lt;/a&gt; Elixir library: this library wraps a C Markdown parser in a bunch of NIFs. This use case is perfect as turning Markdown into HTML can be an expensive task, and a lot can be gained by delegating that work to C.&lt;/p&gt;&lt;h2 id=&quot;something-useful-resources&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#something-useful-resources&quot; aria-label=&quot;Anchor link for: something-useful-resources&quot;&gt;Something useful: resources&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;As I mentioned above, a great use of NIFs is wrapping existing C libraries. Often, however, these libraries provide their own data abstractions and data structures. For example, a C database driver could export a &lt;code&gt;db_conn_t&lt;/code&gt; type to represent a database connection, defined like this:&lt;/p&gt;&lt;pre data-lang=&quot;c&quot; class=&quot;language-c z-code&quot;&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-storage z-type z-c&quot;&gt;typedef&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-c&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-c&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-c&quot;&gt;//&lt;/span&gt; fields
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-c&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-type z-typedef z-c&quot;&gt;db_conn_t&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;alongside functions to initialize a connection, issue queries, and free a connection, like this:&lt;/p&gt;&lt;pre data-lang=&quot;c&quot; class=&quot;language-c z-code&quot;&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span class=&quot;z-source z-c&quot;&gt;db_conn_t &lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-entity z-name z-function z-c&quot;&gt;db_init_conn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;db_type &lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-entity z-name z-function z-c&quot;&gt;db_query&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;db_conn_t &lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-c&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-c&quot;&gt;const&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-c&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-c&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-storage z-type z-c&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-entity z-name z-function z-c&quot;&gt;db_free_conn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;db_conn_t &lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-c&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;It would be useful if we were able to handle &lt;code&gt;db_conn_t&lt;/code&gt; values in Erlang/Elixir and pass them around between NIF calls. The NIF API has something just like that: &lt;strong&gt;resources&lt;/strong&gt;. No better way to quickly explain what resources do than the Erlang documentation:&lt;/p&gt;&lt;blockquote&gt;&lt;p&gt;The use of resource objects is a safe way to return pointers to native data structures from a NIF. A resource object is just a block of memory […].&lt;/p&gt;&lt;/blockquote&gt;&lt;p&gt;Resources are blocks of memory, and we can build and return safe pointers to that memory &lt;em&gt;as Erlang terms&lt;/em&gt;.&lt;/p&gt;&lt;p&gt;Let&apos;s explore how we could wrap the simple API sketched above inside NIFs. We&apos;re going to start with this skeleton C file:&lt;/p&gt;&lt;pre data-lang=&quot;c&quot; class=&quot;language-c z-code&quot;&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-preprocessor z-include z-c&quot;&gt;&lt;span class=&quot;z-keyword z-control z-import z-include z-c&quot;&gt;#include&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-include z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-c&quot;&gt;&amp;quot;&lt;/span&gt;db.h&lt;span class=&quot;z-punctuation z-definition z-string z-end z-c&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-preprocessor z-include z-c&quot;&gt;&lt;span class=&quot;z-keyword z-control z-import z-include z-c&quot;&gt;#include&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-include z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-c&quot;&gt;&amp;quot;&lt;/span&gt;erl_nif.h&lt;span class=&quot;z-punctuation z-definition z-string z-end z-c&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-storage z-type z-c&quot;&gt;typedef&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-c&quot;&gt;struct&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-c&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-c&quot;&gt;//&lt;/span&gt; fields here
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-c&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-type z-typedef z-c&quot;&gt;db_conn_t&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;db_conn_t &lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-entity z-name z-function z-c&quot;&gt;db_init_conn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;db_type &lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-entity z-name z-function z-c&quot;&gt;db_query&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;db_conn_t &lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-c&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-c&quot;&gt;const&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-c&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-c&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-storage z-type z-c&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-entity z-name z-function z-c&quot;&gt;db_free_conn&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;db_conn_t &lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-c&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&quot;creating-resources&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#creating-resources&quot; aria-label=&quot;Anchor link for: creating-resources&quot;&gt;Creating resources&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;To create a resource, we have to allocate some memory with the help of the &lt;code&gt;enif_alloc_resource&lt;/code&gt; function. This function is similar (in principle) to &lt;code&gt;malloc&lt;/code&gt;, as you can tell by its signature:&lt;/p&gt;&lt;pre data-lang=&quot;c&quot; class=&quot;language-c z-code&quot;&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-storage z-type z-c&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-entity z-name z-function z-c&quot;&gt;enif_alloc_resource&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;ErlNifResourceType &lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-c&quot;&gt;res_type&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-c&quot;&gt;unsigned&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-c&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;code&gt;enif_alloc_resource&lt;/code&gt; takes a resource type (which is just something we use to distinguish resources of different types) and the size of the memory to allocate, and returns a pointer to the allocated memory.&lt;/p&gt;&lt;h4 id=&quot;resource-types&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#resource-types&quot; aria-label=&quot;Anchor link for: resource-types&quot;&gt;Resource types&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;Resource types are created with the &lt;code&gt;enif_open_resource_type&lt;/code&gt; function. We can declare resource types as global variables in our C files and take advantage of the &lt;code&gt;load&lt;/code&gt; hook passed to &lt;code&gt;ERL_NIF_INIT&lt;/code&gt; to create the resource types and assign them to the global variables. It goes something like this:&lt;/p&gt;&lt;pre data-lang=&quot;c&quot; class=&quot;language-c z-code&quot;&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span class=&quot;z-source z-c&quot;&gt;ErlNifResourceType &lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;DB_RES_TYPE&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-c&quot;&gt;//&lt;/span&gt; This is called everytime a resource is deallocated (which happens when
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-c&quot;&gt;//&lt;/span&gt; enif_release_resource is called and Erlang garbage collects the memory)
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-storage z-type z-c&quot;&gt;void&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-entity z-name z-function z-c&quot;&gt;db_res_destructor&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;ErlNifEnv &lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-c&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-c&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-c&quot;&gt;res&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-c&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;  db_conn_t &lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;conn_res &lt;span class=&quot;z-keyword z-operator z-assignment z-c&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;db_conn_t&lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt; res&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-variable z-function z-c&quot;&gt;db_free_conn&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;conn_res&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-c&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-storage z-type z-c&quot;&gt;int&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-entity z-name z-function z-c&quot;&gt;load&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;ErlNifEnv &lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-c&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-c&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-c&quot;&gt;priv_data&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt; ERL_NIF_TERM &lt;span class=&quot;z-variable z-parameter z-c&quot;&gt;load_info&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-c&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-storage z-type z-c&quot;&gt;int&lt;/span&gt; flags &lt;span class=&quot;z-keyword z-operator z-assignment z-c&quot;&gt;=&lt;/span&gt; ERL_NIF_RT_CREATE &lt;span class=&quot;z-keyword z-operator z-arithmetic z-c&quot;&gt;|&lt;/span&gt; ERL_NIF_RT_TAKEOVER&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;  DB_RES_TYPE &lt;span class=&quot;z-keyword z-operator z-assignment z-c&quot;&gt;=&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-variable z-function z-c&quot;&gt;enif_open_resource_type&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;env&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-c&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-string z-quoted z-double z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-c&quot;&gt;&amp;quot;&lt;/span&gt;db&lt;span class=&quot;z-punctuation z-definition z-string z-end z-c&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt; db_res_destructor&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt; flags&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-c&quot;&gt;NULL&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-c&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&quot;creating-the-resource&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#creating-the-resource&quot; aria-label=&quot;Anchor link for: creating-the-resource&quot;&gt;Creating the resource&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;We can now wrap &lt;code&gt;db_init_conn&lt;/code&gt; and create our resource.&lt;/p&gt;&lt;pre data-lang=&quot;c&quot; class=&quot;language-c z-code&quot;&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-c&quot;&gt;static&lt;/span&gt; ERL_NIF_TERM
&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-entity z-name z-function z-c&quot;&gt;db_init_conn_nif&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;ErlNifEnv &lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-c&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-c&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-c&quot;&gt;argc&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-c&quot;&gt;const&lt;/span&gt; ERL_NIF_TERM &lt;span class=&quot;z-variable z-parameter z-c&quot;&gt;argv&lt;/span&gt;&lt;span class=&quot;z-meta z-brackets z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-brackets z-begin z-c&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-brackets z-end z-c&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-c&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-c&quot;&gt;//&lt;/span&gt; Let&amp;#39;s allocate the memory for a db_conn_t * pointer
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;  db_conn_t &lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;conn_res &lt;span class=&quot;z-keyword z-operator z-assignment z-c&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-variable z-function z-c&quot;&gt;enif_alloc_resource&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;DB_RES_TYPE&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-word z-c&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;db_conn_t &lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-c&quot;&gt;//&lt;/span&gt; Let&amp;#39;s create conn and let the resource point to it
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;  db_conn_t &lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;conn &lt;span class=&quot;z-keyword z-operator z-assignment z-c&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-variable z-function z-c&quot;&gt;db_init_conn&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;conn_res &lt;span class=&quot;z-keyword z-operator z-assignment z-c&quot;&gt;=&lt;/span&gt; conn&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-c&quot;&gt;//&lt;/span&gt; We can now make the Erlang term that holds the resource...
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;  ERL_NIF_TERM term &lt;span class=&quot;z-keyword z-operator z-assignment z-c&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-variable z-function z-c&quot;&gt;enif_make_resource&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;env&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt; conn_res&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-c&quot;&gt;//&lt;/span&gt; ...and release the resource so that it will be freed when Erlang garbage collects
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-variable z-function z-c&quot;&gt;enif_release_resource&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;conn_res&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-keyword z-control z-flow z-return z-c&quot;&gt;return&lt;/span&gt; term&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-c&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&quot;retrieving-the-resource&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#retrieving-the-resource&quot; aria-label=&quot;Anchor link for: retrieving-the-resource&quot;&gt;Retrieving the resource&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;In order to wrap &lt;code&gt;db_query&lt;/code&gt;, we&apos;ll need to retrieve the resource that we returned in &lt;code&gt;db_init_conn_nif&lt;/code&gt;. To do that, we&apos;ll use &lt;code&gt;enif_get_resource&lt;/code&gt;.&lt;/p&gt;&lt;pre data-lang=&quot;c&quot; class=&quot;language-c z-code&quot;&gt;&lt;code class=&quot;language-c&quot; data-lang=&quot;c&quot;&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-storage z-modifier z-c&quot;&gt;static&lt;/span&gt; ERL_NIF_TERM
&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-entity z-name z-function z-c&quot;&gt;db_query_nif&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-parameters z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;ErlNifEnv &lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-c&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-c&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-c&quot;&gt;argc&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-storage z-modifier z-c&quot;&gt;const&lt;/span&gt; ERL_NIF_TERM &lt;span class=&quot;z-variable z-parameter z-c&quot;&gt;argv&lt;/span&gt;&lt;span class=&quot;z-meta z-brackets z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-brackets z-begin z-c&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-brackets z-end z-c&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-c&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;  db_conn_t &lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;conn_res&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-keyword z-control z-c&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-c&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-variable z-function z-c&quot;&gt;enif_get_resource&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;env&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt; argv&lt;span class=&quot;z-meta z-brackets z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-brackets z-begin z-c&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-c&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-brackets z-end z-c&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt; DB_RES_TYPE&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-storage z-type z-c&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;&amp;amp;&lt;/span&gt;conn_res&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-begin z-c&quot;&gt;{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-keyword z-control z-flow z-return z-c&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-variable z-function z-c&quot;&gt;enif_make_badarg&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;env&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-c&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;  db_conn_t &lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;conn &lt;span class=&quot;z-keyword z-operator z-assignment z-c&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-c&quot;&gt;*&lt;/span&gt;conn_res&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-comment z-line z-double-slash z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-c&quot;&gt;//&lt;/span&gt; We can now run our query
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-variable z-function z-c&quot;&gt;db_query&lt;/span&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-begin z-c&quot;&gt;(&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;conn&lt;span class=&quot;z-punctuation z-separator z-c&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-variadic z-c&quot;&gt;...&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-c&quot;&gt;&lt;span class=&quot;z-meta z-group z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-group z-end z-c&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-keyword z-control z-flow z-return z-c&quot;&gt;return&lt;/span&gt; argv&lt;span class=&quot;z-meta z-brackets z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-brackets z-begin z-c&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-integer z-decimal z-c&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-brackets z-end z-c&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-terminator z-c&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-c&quot;&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-c&quot;&gt;&lt;span class=&quot;z-meta z-block z-c&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-block z-end z-c&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&quot;using-resources-in-elixir&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#using-resources-in-elixir&quot; aria-label=&quot;Anchor link for: using-resources-in-elixir&quot;&gt;Using resources in Elixir&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Let&apos;s skip the part where we export the NIFs we created to a &lt;code&gt;DB&lt;/code&gt; module and jump right into IEx, assuming the C code is compiled and loaded by &lt;code&gt;DB&lt;/code&gt;. As I mentioned above, resources are completely opaque terms when returned to Erlang/Elixir. They&apos;re represented as references:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;iex&lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;&amp;gt;&lt;/span&gt; conn_res &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;DB&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;db_conn_init&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt;Reference&amp;lt;0.3569050097.3772514305.191818&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;iex&lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;DB&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;db_query&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;conn_res&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-range z-elixir&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-range z-elixir&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Since resources are opaque, you can&apos;t really do anything with them in Erlang/Elixir other than passing them back to other NIFs. They act and look like references. My advice is to wrap resources inside structs. This way, we can limit our public API to only handle structs and handle resources internally. We also get the benefit of being able to implement the &lt;code&gt;Inspect&lt;/code&gt; protocol for structs, which means we can safely inspect resources, hiding the fact that they look like references.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;DBConn&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;defstruct&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;resource&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-protocol-implementation z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-protocol z-elixir&quot;&gt;defimpl&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-protocol z-elixir&quot;&gt;Inspect&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-protocol z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; ...
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&quot;compiling-with-mix&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#compiling-with-mix&quot; aria-label=&quot;Anchor link for: compiling-with-mix&quot;&gt;Compiling with Mix&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Mix provides a feature called &lt;a href=&quot;https://hexdocs.pm/mix/Mix.html#compilers/0&quot;&gt;Mix compilers&lt;/a&gt;. Each Mix project can specify a list of compilers to run when the project is compiled. A new Mix compiler the perfect place to automate the compilation of our C source code. For the scope of this section, let&apos;s say we&apos;re building a &lt;code&gt;:my_nifs&lt;/code&gt; Elixir application that will use NIFs from the &lt;code&gt;my_nifs.c&lt;/code&gt; C source file.&lt;/p&gt;&lt;p&gt;First, let&apos;s create a &lt;code&gt;Makefile&lt;/code&gt; to compile the C source (as we would probably do anyway).&lt;/p&gt;&lt;pre data-lang=&quot;make&quot; class=&quot;language-make z-code&quot;&gt;&lt;code class=&quot;language-make&quot; data-lang=&quot;make&quot;&gt;&lt;span class=&quot;z-source z-makefile&quot;&gt;&lt;span class=&quot;z-variable z-other z-makefile&quot;&gt;ERL_INCLUDE_PATH&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-makefile&quot;&gt;=&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-makefile&quot;&gt;&lt;span class=&quot;z-meta z-string z-makefile&quot;&gt;&lt;span class=&quot;z-string z-unquoted z-makefile&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-makefile&quot;&gt;&lt;span class=&quot;z-keyword z-other z-block z-begin z-makefile&quot;&gt;$(&lt;/span&gt;...&lt;span class=&quot;z-keyword z-other z-block z-end z-makefile&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-makefile&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-makefile&quot;&gt;&lt;span class=&quot;z-meta z-function z-makefile&quot;&gt;&lt;span class=&quot;z-entity z-name z-function z-makefile&quot;&gt;all&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-makefile&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-arguments z-makefile&quot;&gt;&lt;span class=&quot;z-string z-unquoted z-makefile&quot;&gt;priv/my_nifs.so&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-body z-makefile&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-makefile&quot;&gt;&lt;span class=&quot;z-meta z-function z-body z-makefile&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-makefile&quot;&gt;&lt;span class=&quot;z-meta z-function z-makefile&quot;&gt;&lt;span class=&quot;z-entity z-name z-function z-makefile&quot;&gt;priv/my_nifs.so&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-makefile&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-arguments z-makefile&quot;&gt;&lt;span class=&quot;z-string z-unquoted z-makefile&quot;&gt;my_nifs.c&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-body z-makefile&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-makefile&quot;&gt;&lt;span class=&quot;z-meta z-function z-body z-makefile&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function z-body z-makefile&quot;&gt;&lt;span class=&quot;z-source z-shell&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-shell&quot;&gt;&lt;span class=&quot;z-variable z-function z-shell&quot;&gt;cc&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-arguments z-shell&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-option z-shell&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-parameter z-shell&quot;&gt; -&lt;/span&gt;fPIC&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-option z-shell&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-parameter z-shell&quot;&gt; -&lt;/span&gt;I&lt;span class=&quot;z-variable z-parameter z-makefile&quot;&gt;&lt;span class=&quot;z-keyword z-other z-block z-begin z-makefile&quot;&gt;$(&lt;/span&gt;ERL_INCLUDE_PATH&lt;span class=&quot;z-keyword z-other z-block z-end z-makefile&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-option z-shell&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-parameter z-shell&quot;&gt; -&lt;/span&gt;dynamiclib&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-option z-shell&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-parameter z-shell&quot;&gt; -&lt;/span&gt;undefined&lt;/span&gt; dynamic_lookup&lt;span class=&quot;z-variable z-parameter z-option z-shell&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-parameter z-shell&quot;&gt; -&lt;/span&gt;o&lt;/span&gt; my_nifs.so my_nifs.c&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;This Makefile assumes &lt;code&gt;my_nifs.c&lt;/code&gt; is stored in the root of your Mix project. We&apos;re going to put the &lt;code&gt;.so&lt;/code&gt; shared object in the &lt;code&gt;priv&lt;/code&gt; directory of our application so that it will be available in releases. Now, whenever we change &lt;code&gt;my_nifs.c&lt;/code&gt; and run &lt;code&gt;$ make&lt;/code&gt;, then &lt;code&gt;priv/my_nifs.so&lt;/code&gt; will be recompiled.&lt;/p&gt;&lt;p&gt;We can now hook up a new Mix compiler that just calls &lt;code&gt;make&lt;/code&gt;. Let&apos;s do this at the top of &lt;code&gt;mix.exs&lt;/code&gt;:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Mix&lt;/span&gt;.&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Tasks&lt;/span&gt;.&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Compile&lt;/span&gt;.&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MyNifs&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;_args&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;result&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; _errcode&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;cmd&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;make&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;stdout_to_stderr&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;IO&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;binwrite&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;result&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;We call &lt;code&gt;IO.binwrite/1&lt;/code&gt; in order to write whatever was the output of &lt;code&gt;$ make&lt;/code&gt; on the terminal. In a real-world application, we obviously would want to check the result of the &lt;code&gt;make&lt;/code&gt; command, as well as make sure that &lt;code&gt;cc&lt;/code&gt; and &lt;code&gt;make&lt;/code&gt; are installed on the system and available in the path; here, we&apos;re just omitting those parts for simplicity.&lt;/p&gt;&lt;p&gt;We now need to add the &lt;code&gt;:my_nifs&lt;/code&gt; compiler to the list of compilers for the &lt;code&gt;:my_nifs&lt;/code&gt; application:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; in mix.exs
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MyNifs&lt;/span&gt;.&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Mixfile&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;use&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Mix&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Project&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;project&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;app&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;my_nifs&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;compilers&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;my_nifs&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-list-manipulation z-elixir&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Mix&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;compilers&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-range z-elixir&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Now, whenever we run &lt;code&gt;$ mix compiler&lt;/code&gt;, our C code will be recompiled (if necessary) automatically. This will also work when other libraries list &lt;code&gt;:my_nifs&lt;/code&gt; as a dependency, as now running &lt;code&gt;make&lt;/code&gt; is part of the compilation process for the &lt;code&gt;:my_nifs&lt;/code&gt; project.&lt;/p&gt;&lt;h2 id=&quot;conclusion&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#conclusion&quot; aria-label=&quot;Anchor link for: conclusion&quot;&gt;Conclusion&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;This was a long post, but I hope I covered most of the NIF universe in it. As you saw, using NIFs in Erlang/Elixir turns out to be fairly straightforward. As mentioned at the beginning of this article, NIFs are to be used carefully and are not always the right tool for the job because of their fragility (remember that NIFs can cause the entire Erlang VM to crash) and speed requirements.&lt;/p&gt;&lt;p&gt;Thanks for making it this far!&lt;/p&gt;&lt;h3 id=&quot;updates&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#updates&quot; aria-label=&quot;Anchor link for: updates&quot;&gt;Updates&lt;/a&gt;&lt;/h3&gt;&lt;h4 id=&quot;undefined-reference-errors-on-debian-jesse&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#undefined-reference-errors-on-debian-jesse&quot; aria-label=&quot;Anchor link for: undefined-reference-errors-on-debian-jesse&quot;&gt;Undefined reference errors on Debian Jesse&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;Brent Shaffer commmented that this was helpful:&lt;/p&gt;&lt;pre data-lang=&quot;bash&quot; class=&quot;language-bash z-code&quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;z-source z-shell z-bash&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-shell&quot;&gt;&lt;span class=&quot;z-variable z-function z-shell&quot;&gt;cc&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-arguments z-shell&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-option z-shell&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-parameter z-shell&quot;&gt; -&lt;/span&gt;fPIC&lt;/span&gt;&lt;span class=&quot;z-variable z-parameter z-option z-shell&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-parameter z-shell&quot;&gt; -&lt;/span&gt;I&lt;/span&gt;/usr/local/lib/erlang/usr/include &lt;span class=&quot;z-punctuation z-separator z-continuation z-line z-shell&quot;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-shell z-bash&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-arguments z-shell&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-option z-shell&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-parameter z-shell&quot;&gt;    -&lt;/span&gt;Wl&lt;/span&gt;,-undefined&lt;span class=&quot;z-variable z-parameter z-option z-shell&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-parameter z-shell&quot;&gt; -&lt;/span&gt;Wl&lt;/span&gt;,dynamic_lookup&lt;span class=&quot;z-variable z-parameter z-option z-shell&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-parameter z-shell&quot;&gt; -&lt;/span&gt;shared&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-continuation z-line z-shell&quot;&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-shell z-bash&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-arguments z-shell&quot;&gt;&lt;span class=&quot;z-variable z-parameter z-option z-shell&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-parameter z-shell&quot;&gt;    -&lt;/span&gt;o&lt;/span&gt; fast_compare.so fast_compare.c&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;</content>
    
    </entry>
  
    <entry>
      <id>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;posts&#x2F;compile-time-work-with-elixir-macros&#x2F;</id>
      <title type="html"><![CDATA[ Compile-time work with Elixir macros ]]></title>
      <link rel="alternate"
            type="text/html"
            href="https://andrealeopardi.com/posts/compile-time-work-with-elixir-macros/"
            title="Compile-time work with Elixir macros" />
      <published>2015-10-10T00:00:00+00:00</published>
      <author>
        <name>Andrea Leopardi</name>
        <uri>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;</uri>
        <email>hi@andrealeopardi.com</email>
      </author>
      <updated>2015-10-10T00:00:00+00:00</updated>
      <summary type="html">&lt;p&gt;Macros are a very common way to do metaprogramming in Elixir. There are many
resources that explain what macros are and how to use them (much better than I
could): there&apos;s the &lt;a href=&quot;https://elixir-lang.org/getting-started/meta/macros.html&quot; title=&quot;Chapter on macros from Elixir&amp;#39;s &amp;quot;Getting Started&amp;quot; guide&quot;&gt;Macro chapter&lt;/a&gt; from the
&quot;Getting Started&quot; guide on Elixir&apos;s website, an awesome
&lt;a href=&quot;https://www.theerlangelist.com/article/macros_1&quot; title=&quot;Understanding Elixir Macros by Saša Jurić&quot;&gt;series of articles&lt;/a&gt; by Saša Jurić, and even a
book (&lt;a href=&quot;https://pragprog.com/book/cmelixir/metaprogramming-elixir&quot; title=&quot;Metaprogramming Elixir&quot;&gt;Metaprogramming Elixir&lt;/a&gt;) by Chris McCord. In this
article, I&apos;ll assume you are familiar with macros and how they work, and I&apos;ll
talk about another use case of macros that is rarely examined: doing
compile-time things in macros.&lt;/p&gt;</summary>
    
      <content type="html">&lt;p&gt;Macros are a very common way to do metaprogramming in Elixir. There are many
resources that explain what macros are and how to use them (much better than I
could): there&apos;s the &lt;a href=&quot;https://elixir-lang.org/getting-started/meta/macros.html&quot; title=&quot;Chapter on macros from Elixir&amp;#39;s &amp;quot;Getting Started&amp;quot; guide&quot;&gt;Macro chapter&lt;/a&gt; from the
&quot;Getting Started&quot; guide on Elixir&apos;s website, an awesome
&lt;a href=&quot;https://www.theerlangelist.com/article/macros_1&quot; title=&quot;Understanding Elixir Macros by Saša Jurić&quot;&gt;series of articles&lt;/a&gt; by Saša Jurić, and even a
book (&lt;a href=&quot;https://pragprog.com/book/cmelixir/metaprogramming-elixir&quot; title=&quot;Metaprogramming Elixir&quot;&gt;Metaprogramming Elixir&lt;/a&gt;) by Chris McCord. In this
article, I&apos;ll assume you are familiar with macros and how they work, and I&apos;ll
talk about another use case of macros that is rarely examined: doing
compile-time things in macros.&lt;/p&gt;&lt;span id=&quot;continue-reading&quot;&gt;&lt;/span&gt;&lt;h2 id=&quot;macro-expansion&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#macro-expansion&quot; aria-label=&quot;Anchor link for: macro-expansion&quot;&gt;Macro expansion&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Macros are often used as tools to manipulate the AST (Abstract Syntax Tree,
the representation of Elixir code) and transform it into new AST. For example, the
definition of the &lt;code&gt;if&lt;/code&gt; macro looks something like this:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmacro&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;condition&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;do:&lt;/span&gt;&lt;/span&gt; do_block&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;else&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; else_block&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;quote&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;case&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;unquote&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;condition&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;      x &lt;span class=&quot;z-keyword z-operator z-elixir&quot;&gt;when&lt;/span&gt; x &lt;span class=&quot;z-keyword z-operator z-elixir&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;unquote&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;else_block&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;      _                        &lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;unquote&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;do_block&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;code&gt;if&lt;/code&gt; just &lt;em&gt;expands&lt;/em&gt; to a &lt;code&gt;case&lt;/code&gt; statement that checks whether the condition is
false-y (&lt;code&gt;nil&lt;/code&gt; or &lt;code&gt;false&lt;/code&gt;) or truthy (anything else), executing the correct block
of code.&lt;/p&gt;&lt;p&gt;The key concept here is &lt;strong&gt;expansion&lt;/strong&gt;: a macro call just gets transformed to
other code. It&apos;s easy to see this process using
&lt;a href=&quot;https://hexdocs.pm/elixir/Macro.html#expand/2&quot; title=&quot;Docs for Macro.expand/2&quot;&gt;&lt;code&gt;Macro.expand/2&lt;/code&gt;&lt;/a&gt; (or
&lt;a href=&quot;https://hexdocs.pm/elixir/Macro.html#expand_once/2&quot; title=&quot;Docs for Macro.expand_once/2&quot;&gt;&lt;code&gt;Macro.expand_once/2&lt;/code&gt;&lt;/a&gt;). Let&apos;s work with a simple
macro so that our examples are straightforward:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;SimpleMacro&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmacro&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;plus&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; y&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;quote&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;do&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;unquote&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;x&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arithmetic z-elixir&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;unquote&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;y&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Seeing the expansion of this macro is trivial:&lt;/p&gt;&lt;pre class=&quot;z-code&quot;&gt;&lt;code&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;iex&amp;gt; import SimpleMacro
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;iex&amp;gt; ast = quote do: plus(x, 23)
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;iex&amp;gt; ast |&amp;gt; Macro.expand(__ENV__) |&amp;gt; Macro.to_string
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;&amp;quot;x + 23&amp;quot;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Expanding a macro means executing the code inside the macro and replacing the
macro call with the AST (the quoted code) it returns. This expansion step
happens at compile time: a macro is executed at compile time and replaced with
the code it returns, which is expanded recursively (searching for nested macros)
but not executed until runtime. Turns out, we can take advantage of this! We can
write macros that do not transform the AST they receive, but that perform some
operation at compile time using this AST.&lt;/p&gt;&lt;h2 id=&quot;working-at-compile-time&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#working-at-compile-time&quot; aria-label=&quot;Anchor link for: working-at-compile-time&quot;&gt;Working at compile time&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Usually, macros are described as functions that take code instead of data and
return code instead of data; in this description, we describe macros in terms of
functions. However, we can also define functions in terms of macros: each
function is just a macro that does nothing at compile time.&lt;/p&gt;&lt;p&gt;Say we have this code:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MacroPhilosophy&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;hello&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;name&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;Hello &lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-interpolation z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-interpolation z-begin z-elixir&quot;&gt;#{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-interpolation z-elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir z-embedded&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-interpolation z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;!&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;pre class=&quot;z-code&quot;&gt;&lt;code&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;iex&amp;gt; hello &amp;quot;Elixir&amp;quot;
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;&amp;quot;Hello Elixir!&amp;quot;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;We can turn &lt;code&gt;hello/1&lt;/code&gt; into a macro without changing any of the existing code
that relies on it, except for having to &lt;code&gt;require&lt;/code&gt; the &lt;code&gt;MacroPhilosophy&lt;/code&gt;
module. The only thing we have to change about the definition of &lt;code&gt;hello/1&lt;/code&gt; is
that we have to return the quoted code instead of executing the code: luckily
this change is trivial if we take advantage of the &lt;code&gt;:bind_quoted&lt;/code&gt; option for
&lt;code&gt;quote&lt;/code&gt;.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MacroPhilosophy&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmacro&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;hello&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;name&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;quote&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;bind_quoted&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; binding&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;Hello &lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-interpolation z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-interpolation z-begin z-elixir&quot;&gt;#{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-interpolation z-elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir z-embedded&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-interpolation z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;!&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;pre class=&quot;z-code&quot;&gt;&lt;code&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;iex&amp;gt; require MacroPhilosophy
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;iex&amp;gt; hello &amp;quot;Elixir&amp;quot;
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;&amp;quot;Hello Elixir&amp;quot;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;As you can see, the actual body of the function (the string interpolation) is
the same both in the function and in the macro.&lt;/p&gt;&lt;p&gt;This lets us see functions from a different perspective, but also highlights
something about macros: they can be used to do work at compile time. We can
execute any code inside the macro at compile time, as long as we return valid
quoted code. Furthermore, the code we execute before returning the quoted code
will just disappear at runtime. Poof!&lt;/p&gt;&lt;h3 id=&quot;a-useless-expression-counting-macro&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#a-useless-expression-counting-macro&quot; aria-label=&quot;Anchor link for: a-useless-expression-counting-macro&quot;&gt;A useless expression-counting macro&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;To stay true to the ancient tradition of making useless example with absolutely
no connection to the real world, let&apos;s build a macro that logs the number of
Elixir expressions (and sub-expressions) in some given code:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;UselessExamplesAreFun&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmacro&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;log_number_of_expressions&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;code&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;_&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; counter&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Macro&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;prewalk code&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;fn&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;expr&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; counter&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;expr&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; counter &lt;span class=&quot;z-keyword z-operator z-arithmetic z-elixir&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;IO&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;puts &lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;You passed me &lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-interpolation z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-interpolation z-begin z-elixir&quot;&gt;#{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-interpolation z-elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir z-embedded&quot;&gt;counter&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-interpolation z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt; expressions/sub-expressions&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    code
&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Let&apos;s walk through the macro. First, we count the expressions and
sub-expressions by using &lt;a href=&quot;https://hexdocs.pm/elixir/Macro.html#prewalk/3&quot; title=&quot;Docs for Macro.prewalk/3&quot;&gt;&lt;code&gt;Macro.prewalk/3&lt;/code&gt;&lt;/a&gt;. Then, we
print this number: this is our compile time work. Finally, we just return the
argument code (which is already an AST). This macro effectively does nothing at
runtime: in fact, it won&apos;t leave a trace in the compiled code. This is great for
performance because, well, the compile-time logging code just disappears.&lt;/p&gt;&lt;h3 id=&quot;a-real-world-example-there-is-one-this-time&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#a-real-world-example-there-is-one-this-time&quot; aria-label=&quot;Anchor link for: a-real-world-example-there-is-one-this-time&quot;&gt;A real-world example (there is one this time!)&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;I realized macros can be used to do compile-time work after José Valim proposed
to use this technique while we were building
&lt;a href=&quot;https://github.com/elixir-lang/gettext&quot; title=&quot;gettext for Elixir&quot;&gt;gettext for Elixir&lt;/a&gt;. Gettext provides a &lt;code&gt;mix gettext.extract&lt;/code&gt; task which is used to extract translations from source files
and write them to &lt;code&gt;.po&lt;/code&gt; files. Translations are just calls to gettext macros
with strings as arguments:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; in lib/greetings.ex
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;import&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;MyApp&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Gettext&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;gettext &lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;Hello people of Gotham!&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;fr&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Running &lt;code&gt;mix gettext.extract&lt;/code&gt; results in a &lt;code&gt;.po&lt;/code&gt; file with this content:&lt;/p&gt;&lt;pre data-lang=&quot;txt&quot; class=&quot;language-txt z-code&quot;&gt;&lt;code class=&quot;language-txt&quot; data-lang=&quot;txt&quot;&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;#: lib/greetings.ex:2
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;msgid &amp;quot;Hello people of Gotham!&amp;quot;
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;msgstr &amp;quot;&amp;quot;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;What most gettext bindings for other languages (such as Python) do to extract
translations is parsing the code and looking for calls to &lt;code&gt;gettext()&lt;/code&gt;
functions. In Elixir, instead, we just have to register the string to extract
inside the macro, at compile-time, and then force-recompile the project to
expand the macros and extract the translations. Awesome!&lt;/p&gt;&lt;p&gt;This is what the definition of &lt;code&gt;gettext&lt;/code&gt; roughly looks like
(and the &lt;a href=&quot;https://github.com/elixir-lang/gettext/blob/v0.6.1/lib/gettext/compiler.ex#L40-L60&quot; title=&quot;Implementation of a gettext macro&quot;&gt;actual implementation&lt;/a&gt;):&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmacro&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;gettext&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;msgid&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; locale&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  extract&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;msgid&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;quote&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    translate&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;unquote&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;msgid&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;unquote&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;locale&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;When we call &lt;code&gt;extract/2&lt;/code&gt;, we register the &lt;code&gt;msgid&lt;/code&gt; by pushing it to an agent that
we started before recompiling. When the compilation is done, we just dump the
state of this agent. This has no impact whatsoever on the expanded code that is
executed at runtime: calls to &lt;code&gt;gettext/2&lt;/code&gt; are just calls to &lt;code&gt;translate/2&lt;/code&gt; at
runtime.&lt;/p&gt;&lt;h2 id=&quot;conclusion&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#conclusion&quot; aria-label=&quot;Anchor link for: conclusion&quot;&gt;Conclusion&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Deeply understanding macros and how they work is fundamental in order to be able
to meta-program, optimize, and understand Elixir code. In this article, we
experimented with using macros to do compile-time work. We saw a non-real-world
example and then a real-world example taken from the gettext Elixir library.&lt;/p&gt;</content>
    
    </entry>
  
    <entry>
      <id>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;posts&#x2F;handling-tcp-connections-in-elixir&#x2F;</id>
      <title type="html"><![CDATA[ Handling TCP connections in Elixir ]]></title>
      <link rel="alternate"
            type="text/html"
            href="https://andrealeopardi.com/posts/handling-tcp-connections-in-elixir/"
            title="Handling TCP connections in Elixir" />
      <published>2015-06-19T00:00:00+00:00</published>
      <author>
        <name>Andrea Leopardi</name>
        <uri>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;</uri>
        <email>hi@andrealeopardi.com</email>
      </author>
      <updated>2015-06-19T00:00:00+00:00</updated>
      <summary type="html">&lt;p&gt;Elixir is frequently used in network-aware applications because of the core design of Erlang and the Erlang VM. In this context, there&apos;s often the need to connect to external services through the network: for example, a classic web application could connect to a relational database and a key-value store, while an application that runs on embedded systems could connect to other nodes on the network.&lt;/p&gt;</summary>
    
      <content type="html">&lt;p&gt;Elixir is frequently used in network-aware applications because of the core design of Erlang and the Erlang VM. In this context, there&apos;s often the need to connect to external services through the network: for example, a classic web application could connect to a relational database and a key-value store, while an application that runs on embedded systems could connect to other nodes on the network.&lt;/p&gt;&lt;span id=&quot;continue-reading&quot;&gt;&lt;/span&gt;&lt;p&gt;Many times, the connection with the network service will be transparent to the programmer thanks to external libraries (for example, database drivers), but I think it&apos;s interesting to know how to handle such connections by hand. This turns out to be useful if there are no external libraries for a particular service but also if we want to understand how these libraries work.&lt;/p&gt;&lt;p&gt;In this article we will only talk about TCP connections since TCP is probably the most common protocol used in network applications. The principles we describe, however, are very similar for any other type of connection (for example, connections that use the UDP protocol).&lt;/p&gt;&lt;h2 id=&quot;a-semi-realistic-example&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#a-semi-realistic-example&quot; aria-label=&quot;Anchor link for: a-semi-realistic-example&quot;&gt;A semi-realistic example&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;For the sake of this article, we will build an &lt;em&gt;almost&lt;/em&gt; working driver for the &lt;a href=&quot;https://redis.io&quot;&gt;Redis&lt;/a&gt; key-value store. A Redis server is just a TCP server sends and receives messages. Redis uses its own protocol (more on this in a while) on top of TCP to exchange data, without relying on common protocols such as HTTP, but we will not focus on that: we will only deal with the TCP connection from Elixir to the Redis server.&lt;/p&gt;&lt;p&gt;A little side note: obviously, there are several Erlang and Elixir libraries for talking to Redis, but bear with me. Since there&apos;s no point in coming up with a clever name for the library we&apos;re going to write, we&apos;ll just call it &lt;code&gt;Redis&lt;/code&gt;.&lt;/p&gt;&lt;p&gt;Let&apos;s get started!&lt;/p&gt;&lt;h2 id=&quot;brief-overview-of-tcp-connections-in-erlang-elixir&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#brief-overview-of-tcp-connections-in-erlang-elixir&quot; aria-label=&quot;Anchor link for: brief-overview-of-tcp-connections-in-erlang-elixir&quot;&gt;Brief overview of TCP connections in Erlang/Elixir&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;In Erlang and Elixir, TCP connections are handled using the &lt;a href=&quot;https://www.erlang.org/doc/man/gen_tcp.html&quot;&gt;&lt;code&gt;:gen_tcp&lt;/code&gt;&lt;/a&gt; module. In this article we&apos;ll only set up clients that connect to an external TCP server, but the &lt;code&gt;:gen_tcp&lt;/code&gt; module can also be used to set up TCP servers.&lt;/p&gt;&lt;p&gt;All messages to the server are sent using &lt;code&gt;:gen_tcp.send/2&lt;/code&gt;. Messages sent from the server to the client are usually delivered to the client process as Erlang messages, so it&apos;s straightforward to work with them. As we will see later on, we can control how messages are delivered to the client process with the value of the &lt;code&gt;:active&lt;/code&gt; option on the TCP socket.&lt;/p&gt;&lt;p&gt;To establish a connection with a TCP server we use &lt;code&gt;:gen_tcp.connect/3&lt;/code&gt; passing the host (as a charlist, damn you Erlang!), the port and a list of options. By default, the process that calls &lt;code&gt;connect/3&lt;/code&gt; is the &quot;controlling process&quot; of the TCP connection, which means that TCP messages from the socket will be delivered to it.&lt;/p&gt;&lt;p&gt;That&apos;s all we need to know about TCP connections for now, let&apos;s move on.&lt;/p&gt;&lt;h2 id=&quot;first-implementation&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#first-implementation&quot; aria-label=&quot;Anchor link for: first-implementation&quot;&gt;First implementation&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;We&apos;ll use a &lt;code&gt;GenServer&lt;/code&gt; as the only interface with the TCP connection. We need a GenServer so that we will be able to keep the TCP socket in the GenServer&apos;s state and reuse that socket for all communication.&lt;/p&gt;&lt;h3 id=&quot;establishing-the-connection&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#establishing-the-connection&quot; aria-label=&quot;Anchor link for: establishing-the-connection&quot;&gt;Establishing the connection&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Since the GenServer will be the only interface to the TCP server and it will only hold a single TCP socket in its state, we want it to always be connected to the TCP server. The best strategy for this is establishing the connection when the GenServer is started, in the &lt;code&gt;init/1&lt;/code&gt; callback. &lt;code&gt;init/1&lt;/code&gt; is called when &lt;code&gt;GenServer.start_link/2&lt;/code&gt; is used to start the process, and the GenServer doesn&apos;t start to do any work until &lt;code&gt;init/1&lt;/code&gt; returns, so it&apos;s the perfect place for us.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Redis&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;use&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;GenServer&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-variable z-other z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-definition z-constant z-elixir&quot;&gt;@&lt;/span&gt;initial_state&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;socket&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;start_link&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;GenServer&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;start_link&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-elixir&quot;&gt;__MODULE__&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-variable z-other z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-definition z-constant z-elixir&quot;&gt;@&lt;/span&gt;initial_state&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;state&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    opts &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;binary&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;active&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; socket&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;gen_tcp&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;connect&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-single z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;#39;&lt;/span&gt;localhost&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;6379&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; opts&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;state &lt;span class=&quot;z-keyword z-operator z-other z-elixir&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;socket&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; socket&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The options we pass to &lt;code&gt;:gen_tcp.connect/3&lt;/code&gt; are straightforward. &lt;code&gt;:binary&lt;/code&gt; instructs the socket to deliver messages from the TCP server to the GenServer as binaries instead of Erlang strings (charlists): in Elixir this is probably what we want, and it&apos;s probably the most efficient choice as well. &lt;code&gt;active: false&lt;/code&gt; tells the socket to never deliver TCP messages as Erlang messages to the GenServer process; we will have to manually retrieve those messages using &lt;a href=&quot;https://www.erlang.org/doc/man/gen_tcp.html#recv-2&quot;&gt;&lt;code&gt;:gen_tcp.recv/2&lt;/code&gt;&lt;/a&gt;. We do this so that the GenServer isn&apos;t flooded with messages coming from the TCP server: we only retrieve messages when we&apos;re ready to process them.&lt;/p&gt;&lt;h3 id=&quot;sending-messages&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#sending-messages&quot; aria-label=&quot;Anchor link for: sending-messages&quot;&gt;Sending messages&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;We now have a GenServer which is connected to a Redis server. Let&apos;s send commands to the Redis server now.&lt;/p&gt;&lt;h4 id=&quot;resp-protocol&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#resp-protocol&quot; aria-label=&quot;Anchor link for: resp-protocol&quot;&gt;RESP protocol&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;At this point, I should mention the Redis binary protocol, RESP: this is the protocol that Redis uses to encode and decode commands and responses. The &lt;a href=&quot;https://redis.io/topics/protocol&quot;&gt;specification for this protocol&lt;/a&gt; is short and simple to understand, so I encourage you to go read it if you want to know more. For the purpose of this article, we&apos;ll assume we have a full RESP encoder/decoder (&lt;code&gt;Redis.RESP&lt;/code&gt;) which provides two functions:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;code&gt;Redis.RESP.encode/1&lt;/code&gt; which encodes a list into a Redis command, like this:&lt;/li&gt;&lt;/ul&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Redis&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;RESP&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;encode&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;GET&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;mykey&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt;=&amp;gt; &amp;lt;&amp;lt;...&amp;gt;&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;ul&gt;&lt;li&gt;&lt;code&gt;Redis.RESP.decode/1&lt;/code&gt; which decodes a binary into an Elixir term, like this:&lt;/li&gt;&lt;/ul&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;resp_to_get_command &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-binary z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-binary z-begin z-elixir&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;...&lt;span class=&quot;z-punctuation z-definition z-binary z-end z-elixir&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Redis&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;RESP&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;decode&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;resp_to_get_command&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt;=&amp;gt; 1
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&quot;gen-tcp-send-2&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#gen-tcp-send-2&quot; aria-label=&quot;Anchor link for: gen-tcp-send-2&quot;&gt;&lt;code&gt;:gen_tcp.send/2&lt;/code&gt;&lt;/a&gt;&lt;/h4&gt;&lt;p&gt;As we mentioned at the beginning of the article, we use &lt;code&gt;:gen_tcp.send/2&lt;/code&gt; to send messages through a TCP socket. Our &lt;code&gt;Redis&lt;/code&gt; module will provide a single function to send commands to the Redis server: &lt;code&gt;Redis.command/2&lt;/code&gt;. The implementation is straightforward:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Redis&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; ...as before...
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;pid&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; cmd&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;GenServer&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;call&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;pid&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;command&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; cmd&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;handle_call&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;command&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; cmd&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; from&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;socket&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; socket&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; state&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;gen_tcp&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;send&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;socket&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Redis&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;RESP&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;encode&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;cmd&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; `0` means receive all available bytes on the socket.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; msg&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;gen_tcp&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;recv&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;socket&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;reply&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Redis&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;RESP&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;decode&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;msg&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; state&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;This works fine...&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; pid&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Redis&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;start_link&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Redis&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;command&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;pid&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;SET&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;mykey&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Redis&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;command&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;pid&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;GET&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;mykey&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt;=&amp;gt; 1
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;...but there&apos;s a big problem.&lt;/p&gt;&lt;h2 id=&quot;what-went-wrong&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#what-went-wrong&quot; aria-label=&quot;Anchor link for: what-went-wrong&quot;&gt;What went wrong&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Long story short: &lt;code&gt;:gen_tcp.recv/2&lt;/code&gt; is blocking!&lt;/p&gt;&lt;p&gt;The code we wrote would work just fine if the GenServer would be used by just one Elixir process. This is what happens when an Elixir process wants to send a command to the Redis server:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;the Elixir process calls &lt;code&gt;command/2&lt;/code&gt; on the GenServer and &lt;em&gt;blocks&lt;/em&gt;, waiting for the response&lt;/li&gt;&lt;li&gt;the GenServer sends the command to the Redis server and &lt;em&gt;blocks&lt;/em&gt; on &lt;code&gt;:gen_tcp.recv/2&lt;/code&gt;&lt;/li&gt;&lt;li&gt;the Redis server responds to the GenServer&lt;/li&gt;&lt;li&gt;the GenServer responds to the Elixir process&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;Can you spot the problem? The GenServer is blocked when it waits for the Redis server to respond. While this is fine when a single Elixir process talks to the GenServer, it instantly becomes terrible when more processes want to communicate with the Redis server through the GenServer. Luckily, we can implement a much better solution.&lt;/p&gt;&lt;h2 id=&quot;queuing-for-the-win&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#queuing-for-the-win&quot; aria-label=&quot;Anchor link for: queuing-for-the-win&quot;&gt;Queuing for the win&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;As you probably know, the &lt;code&gt;handle_call/3&lt;/code&gt; callback in a GenServer doesn&apos;t have to return a result to the client right away: it can return a &lt;code&gt;{:noreply, state}&lt;/code&gt; tuple and then reply to the client using &lt;a href=&quot;https://hexdocs.pm/elixir/GenServer.html#reply/2&quot;&gt;&lt;code&gt;GenServer.reply/2&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt;&lt;p&gt;This is exactly what we need here: a way for clients to call a function on the GenServer and block waiting for the response, but at the same time a way for the GenServer to keep doing work until it has a response &lt;strong&gt;for that specific client&lt;/strong&gt;.&lt;/p&gt;&lt;p&gt;In order continue with this strategy, however, we need to ditch &lt;code&gt;:gen_tcp.recv/2&lt;/code&gt; in favor of receiving TCP messages as Erlang messages. We can do that using the &lt;code&gt;active: true&lt;/code&gt; instead of &lt;code&gt;active: false&lt;/code&gt; when connecting to the Redis server: when &lt;code&gt;:active&lt;/code&gt; is &lt;code&gt;true&lt;/code&gt;, all messages from a TCP socket are delivered as Erlang messages in the form of &lt;code&gt;{:tcp, socket, message}&lt;/code&gt;.&lt;/p&gt;&lt;p&gt;What will happen is this:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;the Elixir process calls &lt;code&gt;command/2&lt;/code&gt; on the GenServer and &lt;strong&gt;blocks&lt;/strong&gt;, waiting for the response&lt;/li&gt;&lt;li&gt;the GenServer sends the command to the Redis server and returns &lt;code&gt;{:noreply, state}&lt;/code&gt; so that it doesn&apos;t block&lt;/li&gt;&lt;li&gt;the Redis server responds to the GenServer, which receives a &lt;code&gt;{:tcp, socket, message}&lt;/code&gt; message&lt;/li&gt;&lt;li&gt;the GenServer handles the message in the &lt;code&gt;handle_info/2&lt;/code&gt; callback, responding to the appropriate client&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;As you can see, the main difference is that from the moment the GenServer sends a command to the Redis server to the moment it receives a response, the GenServer is not blocked and it can send other commands to the server. This is great!&lt;/p&gt;&lt;p&gt;The last thing we need to deal with is how the GenServer is supposed to respond to the &lt;strong&gt;right&lt;/strong&gt; request: when it receives a &lt;code&gt;{:tcp, ...}&lt;/code&gt; message, how does it know who to send it back with &lt;code&gt;GenServer.reply/2&lt;/code&gt;? Since we&apos;re sure Redis responds to requests &lt;em&gt;sequentially&lt;/em&gt; (first in, first out), we can use a simple queue to keep a list of Elixir processes waiting for a response. We&apos;ll keep this queue in the GenServer&apos;s state, enqueuing clients when they make a request and dequeuing them when a response is delivered.&lt;/p&gt;&lt;p&gt;{% raw %}&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Redis&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-variable z-other z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-definition z-constant z-elixir&quot;&gt;@&lt;/span&gt;initial_state&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;socket&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;queue&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;queue&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;new&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; ...as before...
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;handle_call&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;command&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; cmd&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; from&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;queue&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; queue&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; state&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; We send the command...
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;gen_tcp&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;send&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;state&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;socket&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Redis&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;RESP&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;encode&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;cmd&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; ...enqueue the client...
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    state &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;state &lt;span class=&quot;z-keyword z-operator z-other z-elixir&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;queue&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;queue&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;in&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;from&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; queue&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; ...and we don&amp;#39;t reply right away.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;noreply&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; state&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;handle_info&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;tcp&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; socket&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; msg&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;socket&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; socket&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; state&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; We dequeue the next client:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;value&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; client&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; new_queue&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;queue&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;out&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;state&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;queue&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; We can finally reply to the right client.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;GenServer&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;reply&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;client&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Redis&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;RESP&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;decode&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;msg&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;noreply&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;state &lt;span class=&quot;z-keyword z-operator z-other z-elixir&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;queue&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; new_queue&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-invalid z-illegal z-stray-closing-brace z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&quot;messages-on-demand&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#messages-on-demand&quot; aria-label=&quot;Anchor link for: messages-on-demand&quot;&gt;Messages on demand&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;In the sections above, we moved from a &lt;code&gt;active: false&lt;/code&gt; socket to a &lt;code&gt;active: true&lt;/code&gt; socket in order to receive TCP data as Erlang messages. This works fine, but can lead to problems if the TCP server sends the GenServer &lt;em&gt;a lot&lt;/em&gt; of data: since Erlang has no limit on the message queue of a process, the GenServer can be easily flooded with messages; after all, we chose to use &lt;code&gt;active: false&lt;/code&gt; for this reason in the first place. To avoid that, we can change &lt;code&gt;active: true&lt;/code&gt; to the more conservative &lt;code&gt;active: :once&lt;/code&gt;: this way, only one TCP messages is delivered as an Erlang message, and then the socket goes back to &lt;code&gt;active: false&lt;/code&gt;. We can set &lt;code&gt;active: :once&lt;/code&gt; again to receive the next message, and so on. We can process TCP data as Erlang messages but one at the time, so that we&apos;re sure we&apos;re able to process them.&lt;/p&gt;&lt;p&gt;We just have to remember to reactivate the socket when we receive a &lt;code&gt;{:tcp, ...}&lt;/code&gt; message in the &lt;code&gt;handle_info/2&lt;/code&gt; callback. We can do that using &lt;a href=&quot;https://www.erlang.org/doc/man/inet.html#setopts-2&quot;&gt;&lt;code&gt;:inet.setopts/2&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Redis&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; ...as before...
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;state&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    opts &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;binary&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;active&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;once&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; ...as before...
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; ...as before...
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;handle_info&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;tcp&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; socket&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; msg&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;socket&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; socket&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; state&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; Allow the socket to send us the next message.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;inet&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;setopts&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;socket&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;active&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;once&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; exactly as before
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&quot;plot-twist&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#plot-twist&quot; aria-label=&quot;Anchor link for: plot-twist&quot;&gt;Plot twist&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;I didn&apos;t think of the pattern I wrote about. That&apos;s a shocker, right? The pattern I described here is very common and is shared by a number of Erlang and Elixir applications. This pattern applies nicely to any connection with a TCP server (or with anything similar for that matter), and it&apos;s often used in drivers for databases: that&apos;s why I went with Redis in the example.&lt;/p&gt;&lt;p&gt;Lots of real-world libraries use the pattern I talked about: for example, &lt;a href=&quot;https://github.com/wooga/eredis&quot;&gt;eredis&lt;/a&gt; (one of the most used Redis drivers for Erlang) is built very similarly to our example: just look at &lt;a href=&quot;https://github.com/wooga/eredis/blob/770f828918db710d0c0958c6df63e90a4d341ed7/src/eredis_client.erl#L1-L21&quot;&gt;this comment&lt;/a&gt; in the eredis source, which is basically a summary of this article (or is this article an expanded version of that comment? Who knows!). Other examples of libraries that roughly follow this pattern are the Elixir drivers for PostgreSQL (&lt;a href=&quot;https://github.com/ericmj/postgrex&quot;&gt;Postgrex&lt;/a&gt;) and MongoDB (&lt;a href=&quot;https://github.com/ericmj/mongodb&quot;&gt;mongodb&lt;/a&gt;). Currently I&apos;m working on an Elixir driver for &lt;a href=&quot;https://orientdb.org&quot;&gt;OrientDB&lt;/a&gt; (still not public) which uses this pattern as well. So, it must work right?&lt;/p&gt;&lt;h2 id=&quot;better-handling-of-the-tcp-connection&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#better-handling-of-the-tcp-connection&quot; aria-label=&quot;Anchor link for: better-handling-of-the-tcp-connection&quot;&gt;Better handling of the TCP connection&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;We happily ignored an annoying thing to deal with throughout this article: error handling!&lt;/p&gt;&lt;p&gt;We&apos;ll keep happily ignoring a subset of the errors that can happen, for example, an empty client queue (which fails the &lt;code&gt;{{:value, val}, new_queue}&lt;/code&gt; pattern match) or an incomplete message from the TCP socket. However, a common set of errors that can happen when dealing with TCP connections are, well, TCP errors like dropped connections or timeouts.&lt;/p&gt;&lt;p&gt;We could try to handle this kind of errors ourselves, but, luckily for us, Elixir core team member James Fish (a.k.a. &lt;a href=&quot;https://github.com/fishcakez&quot;&gt;fishcakez&lt;/a&gt;) did most of the work in its awesome library &lt;a href=&quot;https://github.com/fishcakez/connection&quot;&gt;connection&lt;/a&gt;. While this library is quite young at the time of writing, it&apos;s already being used in the &lt;a href=&quot;https://github.com/ericmj/mongodb&quot;&gt;MongoDB driver&lt;/a&gt; I mentioned before and in the OrientDB driver I&apos;m working on.&lt;/p&gt;&lt;h3 id=&quot;handling-connections-with-connection&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#handling-connections-with-connection&quot; aria-label=&quot;Anchor link for: handling-connections-with-connection&quot;&gt;Handling connections with... Connection&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;The connection library defines the &lt;code&gt;Connection&lt;/code&gt; behaviour: the API specified by this behaviour is a superset of the &lt;code&gt;GenServer&lt;/code&gt; API, so it&apos;s easy to understand and integrate into existing projects.&lt;/p&gt;&lt;p&gt;The &lt;a href=&quot;https://hexdocs.pm/connection&quot;&gt;docs&lt;/a&gt; explain what &lt;code&gt;Connection&lt;/code&gt; does in great detail, but the gist of it is this: it helps implement a process that has a peer it connects to and has to deal with that peer being possibly unavailable. To do this, the &lt;code&gt;Connection&lt;/code&gt; behaviour defines two additional functions (other than the &lt;code&gt;GenServer&lt;/code&gt; ones) and revises the return values of some &lt;code&gt;GenServer&lt;/code&gt; callbacks.&lt;/p&gt;&lt;p&gt;We will only look at some of the functionality provided by &lt;code&gt;Connection&lt;/code&gt; here, but make sure to read the docs if you want to know more.&lt;/p&gt;&lt;h3 id=&quot;connecting-on-startup&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#connecting-on-startup&quot; aria-label=&quot;Anchor link for: connecting-on-startup&quot;&gt;Connecting on startup&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;Our &lt;code&gt;Redis.init/1&lt;/code&gt; callback implementation performs the connection to the Redis server, blocking the process that called &lt;code&gt;Redis.start_link/0&lt;/code&gt; until it returns. This may be fine as we don&apos;t want our GenServer to be able to do anything before it&apos;s connected to the Redis server. However, &lt;code&gt;start_link/0&lt;/code&gt; may be called by a supervisor or by a process specifically designed to just &lt;em&gt;start&lt;/em&gt; the GenServer: in these cases, we&apos;d like &lt;code&gt;start_link/0&lt;/code&gt; to return &lt;code&gt;{:ok, pid}&lt;/code&gt; as soon as possible, handling the process of establishing the TCP connection in the background. We&apos;d also like the GenServer to queue messages until it&apos;s connected to the Redis server. This behaviour would enable us to start the GenServer without blocking the process that called &lt;code&gt;start_link/0&lt;/code&gt;, but blocking all subsequent requests until the GenServer is connected to Redis.&lt;/p&gt;&lt;p&gt;With &lt;code&gt;Connection&lt;/code&gt; we can do exactly this. Returning &lt;code&gt;{:connect, info, state}&lt;/code&gt; from the &lt;code&gt;init/1&lt;/code&gt; callback (instead of &lt;code&gt;{:ok, state}&lt;/code&gt;) makes &lt;code&gt;init/1&lt;/code&gt; return &lt;code&gt;{:ok, pid}&lt;/code&gt; instantly, but also calls the &lt;code&gt;connect/2&lt;/code&gt; callback on the GenServer and stops the GenServer from processing incoming messages until the connection is complete. The &lt;code&gt;info&lt;/code&gt; element in the &lt;code&gt;{:connect, info, state}&lt;/code&gt; tuple should contain any information needed to connect to the peer but that we don&apos;t want to keep in the GenServer&apos;s state.&lt;/p&gt;&lt;p&gt;Let&apos;s change our code to take advantage of this:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Redis&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;use&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Connection&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-variable z-other z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-definition z-constant z-elixir&quot;&gt;@&lt;/span&gt;initial_state&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;socket&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;start_link&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; We need Connection.start_link/2 now,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; not GenServer.start_link/2
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Connection&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;start_link&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-variable z-language z-elixir&quot;&gt;__MODULE__&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-variable z-other z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-definition z-constant z-elixir&quot;&gt;@&lt;/span&gt;initial_state&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;state&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; We use `nil` as we don&amp;#39;t need any additional info
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; to connect
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;connect&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-language z-elixir&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; state&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;connect&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;_info&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; state&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    opts &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;binary&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;active&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;once&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; socket&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;gen_tcp&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;connect&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-single z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;#39;&lt;/span&gt;localhost&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;6379&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; opts&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;state &lt;span class=&quot;z-keyword z-operator z-other z-elixir&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;socket&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; socket&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;This is a big improvement over what we had before, but &lt;code&gt;Connection&lt;/code&gt; allows us to make our library even better.&lt;/p&gt;&lt;h3 id=&quot;back-off&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#back-off&quot; aria-label=&quot;Anchor link for: back-off&quot;&gt;Back off!&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;The line where we connect to the Redis server using &lt;code&gt;:gen_tcp.connect/3&lt;/code&gt; should raise a loud alarm bell in your head: &lt;code&gt;{:ok, socket} = ...&lt;/code&gt; is not very responsible. In case the connection fails for any reason, the pattern match will fail and, instead of handling the error, the whole GenServer blows up. The obvious thing to do is to handle the result of &lt;code&gt;:gen_tcp.connect/3&lt;/code&gt; with a case statement:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;case&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;gen_tcp&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;connect&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-single z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;#39;&lt;/span&gt;localhost&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;6379&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; opts&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; socket&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;state &lt;span class=&quot;z-keyword z-operator z-other z-elixir&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;socket&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; socket&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;error&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; reason&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; now what?
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Now we have to decide what we want to do in case there&apos;s an error. Blowing up the GenServer or returning the error to the client is trivial, but in real-world™ code we would probably want to try to reconnect to the TCP server. &lt;code&gt;Connection&lt;/code&gt; to the rescue! We can make &lt;code&gt;connect/2&lt;/code&gt; return a &lt;code&gt;{:backoff, timeout, state}&lt;/code&gt; tuple: &lt;code&gt;connect/2&lt;/code&gt; will be called again after &lt;code&gt;timeout&lt;/code&gt; in an attempt to reconnect to the peer. Our &lt;code&gt;connect/2&lt;/code&gt; would look like this:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;connect&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;_info&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; state&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;  opts &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;binary&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;active&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;once&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;case&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;gen_tcp&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;connect&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-single z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;#39;&lt;/span&gt;localhost&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;6379&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; opts&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; socket&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; %&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;state &lt;span class=&quot;z-keyword z-operator z-other z-elixir&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;socket&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt; socket&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;error&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; reason&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-arrow z-elixir&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;IO&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;puts&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;TCP connection error: &lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-interpolation z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-interpolation z-begin z-elixir&quot;&gt;#{&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-interpolation z-elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir z-embedded&quot;&gt;inspect reason&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-interpolation z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-comment z-line z-number-sign z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-comment z-elixir&quot;&gt;#&lt;/span&gt; Try again in one second:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;backoff&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; state&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The great thing about &lt;code&gt;Connection&lt;/code&gt; is that you can return &lt;code&gt;{:backoff, timeout, state}&lt;/code&gt; from almost every callback function, so handling connection failures become straightforward.&lt;/p&gt;&lt;p&gt;When &lt;code&gt;{:backoff, timeout, state}&lt;/code&gt; is returned, &lt;code&gt;connect/2&lt;/code&gt; is called with &lt;code&gt;:backoff&lt;/code&gt; as its first argument: this lets us easily detect &lt;strong&gt;re&lt;/strong&gt;-connections (instead of first connections) and deal with them appropriately. For example, we may want to implement exponential back-off, that is, we retry after one second, then after two seconds, then after four seconds and so on, possibly with a maximum number of retries.&lt;/p&gt;&lt;h2 id=&quot;pooling&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#pooling&quot; aria-label=&quot;Anchor link for: pooling&quot;&gt;Pooling&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Just one last tip: the GenServer we built can be used smoothly with pooling libraries like the famous &lt;a href=&quot;https://github.com/devinus/poolboy&quot;&gt;poolboy&lt;/a&gt;. There&apos;s plenty of literature about poolboy around the web, so I&apos;m not going to describe how it works here. I will just show you a small example.&lt;/p&gt;&lt;p&gt;First, we can create a pool of a given number of our GenServers using &lt;code&gt;:poolboy.start_link/2&lt;/code&gt;.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;poolboy_opts &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;worker_module&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Redis&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-keywords z-elixir&quot;&gt;size&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;50&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;redis_opts &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; pool&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;poolboy&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;start_link&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;poolboy_opts&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; redis_opts&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Then, we can just check out worker processes (which are our &lt;code&gt;Redis&lt;/code&gt; GenServers) out of the pool, perform operations on Redis through them, and then check them back in the pool.&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;worker &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;poolboy&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;checkout&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;pool&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Redis&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;command&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;worker&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;SET&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;mykey&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;poolboy&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;checkin&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;pool&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt; worker&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Nothing smoother than that!&lt;/p&gt;&lt;h2 id=&quot;conclusion&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#conclusion&quot; aria-label=&quot;Anchor link for: conclusion&quot;&gt;Conclusion&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;We saw how to implement a GenServer that works as an interface to a TCP server. We built a non-blocking GenServer that queues clients in order to send multiple commands to the TCP server while waiting for responses from the server. We used the &lt;a href=&quot;https://github.com/fishcakez/connection&quot;&gt;connection&lt;/a&gt; library to deal with TCP errors (for example, the server being temporarily unavailable) by implementing a back-off strategy. Finally, we briefly looked at how &lt;a href=&quot;https://github.com/devinus/poolboy&quot;&gt;poolboy&lt;/a&gt; can be used to make a pool of our GenServers.&lt;/p&gt;&lt;p&gt;Thanks for reading!&lt;/p&gt;</content>
    
    </entry>
  
    <entry>
      <id>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;posts&#x2F;tokenizing-and-parsing-in-elixir-using-leex-and-yecc&#x2F;</id>
      <title type="html"><![CDATA[ Tokenizing and parsing in Elixir with yecc and leex ]]></title>
      <link rel="alternate"
            type="text/html"
            href="https://andrealeopardi.com/posts/tokenizing-and-parsing-in-elixir-using-leex-and-yecc/"
            title="Tokenizing and parsing in Elixir with yecc and leex" />
      <published>2015-06-05T00:00:00+00:00</published>
      <author>
        <name>Andrea Leopardi</name>
        <uri>https:&#x2F;&#x2F;andrealeopardi.com&#x2F;</uri>
        <email>hi@andrealeopardi.com</email>
      </author>
      <updated>2015-06-05T00:00:00+00:00</updated>
      <summary type="html">&lt;p&gt;Lexical analysis (tokenizing) and parsing are very important concepts in computer science and programming. There is a lot of theory behind these concepts, but I won&apos;t be talking about any of that here because, well, it&apos;s &lt;em&gt;a lot&lt;/em&gt;. Also, I feel like approaching these topics in a &quot;scientific&quot; way makes them look a bit scary; however, using them in practice turns out to be pretty straightforward. If you want to know more about the theory, head over to Wikipedia (&lt;a href=&quot;https://en.wikipedia.org/wiki/Lexical_analysis&quot;&gt;lexical analysis&lt;/a&gt; and &lt;a href=&quot;https://en.wikipedia.org/wiki/Parsing&quot;&gt;parsing&lt;/a&gt;) or read the amazing &lt;a href=&quot;https://en.wikipedia.org/wiki/Compilers:_Principles,_Techniques,_and_Tools&quot;&gt;dragon book&lt;/a&gt; (which I recommend to all programmers, it&apos;s fantastic).&lt;/p&gt;</summary>
    
      <content type="html">&lt;p&gt;Lexical analysis (tokenizing) and parsing are very important concepts in computer science and programming. There is a lot of theory behind these concepts, but I won&apos;t be talking about any of that here because, well, it&apos;s &lt;em&gt;a lot&lt;/em&gt;. Also, I feel like approaching these topics in a &quot;scientific&quot; way makes them look a bit scary; however, using them in practice turns out to be pretty straightforward. If you want to know more about the theory, head over to Wikipedia (&lt;a href=&quot;https://en.wikipedia.org/wiki/Lexical_analysis&quot;&gt;lexical analysis&lt;/a&gt; and &lt;a href=&quot;https://en.wikipedia.org/wiki/Parsing&quot;&gt;parsing&lt;/a&gt;) or read the amazing &lt;a href=&quot;https://en.wikipedia.org/wiki/Compilers:_Principles,_Techniques,_and_Tools&quot;&gt;dragon book&lt;/a&gt; (which I recommend to all programmers, it&apos;s fantastic).&lt;/p&gt;&lt;span id=&quot;continue-reading&quot;&gt;&lt;/span&gt;&lt;p&gt;Usually people tend to avoid using lexers and parsers in favor of manual string manipulation and &lt;strong&gt;regular expressions&lt;/strong&gt;. I think this may happen because of the inherent complexity that is generally associated with these tools. In this post, we&apos;ll try to make this complexity go away!&lt;/p&gt;&lt;h2 id=&quot;why&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#why&quot; aria-label=&quot;Anchor link for: why&quot;&gt;Why&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;First, lexers and parser are usually used together, but they don&apos;t &lt;em&gt;need&lt;/em&gt; to be. You can use a lexer to tokenize some string into a flat list of tokens, and you can use a parser to understand a grammar of anything.&lt;/p&gt;&lt;p&gt;A little side note before we begin. I said people often choose regular expressions to &quot;parse&quot; and understand text. While this is fine for very simple parsing tasks, most of the time it results in cryptic and fragile code. Also, regular expressions are limited in what type of grammars they can parse (try &lt;a href=&quot;https://stackoverflow.com/questions/1732348/regex-match-open-tags-except-xhtml-self-contained-tags&quot;&gt;parsing HTML with regexps&lt;/a&gt;), so at times you will &lt;em&gt;need&lt;/em&gt; something more powerful.&lt;/p&gt;&lt;h2 id=&quot;enter-leex-and-yecc&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#enter-leex-and-yecc&quot; aria-label=&quot;Anchor link for: enter-leex-and-yecc&quot;&gt;Enter &lt;code&gt;leex&lt;/code&gt; and &lt;code&gt;yecc&lt;/code&gt;&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Erlang provides two modules that greatly simplify the task of writing lexers and parsers: &lt;a href=&quot;https://erlang.org/doc/man/leex.html&quot;&gt;&lt;code&gt;leex&lt;/code&gt;&lt;/a&gt; and &lt;a href=&quot;https://erlang.org/doc/man/yecc.html&quot;&gt;&lt;code&gt;yecc&lt;/code&gt;&lt;/a&gt;. The &lt;code&gt;leex&lt;/code&gt; module is a lexer &lt;em&gt;generator&lt;/em&gt;: it reads a file written in a special syntax and spits out an Erlang module (in a &lt;code&gt;.erl&lt;/code&gt; file) that you can compile and use for the actual tokenizing. &lt;code&gt;yecc&lt;/code&gt; behaves in the same way, except it generates parsers instead of lexers.&lt;/p&gt;&lt;p&gt;Since these modules are available in the Erlang standard distribution (in the &quot;Parse tools&quot; application group), I think there are little to no downsides in using them whenever there&apos;s a problem they could help to solve.&lt;/p&gt;&lt;h2 id=&quot;the-small-contrived-and-unrealistic-example&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#the-small-contrived-and-unrealistic-example&quot; aria-label=&quot;Anchor link for: the-small-contrived-and-unrealistic-example&quot;&gt;The small, contrived and unrealistic example&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Every post explaining something needs one of these examples, so let&apos;s make up ours: we&apos;re going to tokenize and parse Elixir lists of atoms and integers dumped as strings. The final goal will be to be able to read an Elixir list expressed as a string and convert it back to an Elixir string, like this:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;iex&lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;ListParser&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;parse&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;[1, 2, [:foo, [:bar]]]&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;foo&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;bar&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;That&apos;s small, contrived, and unrealistic, so we should be good to go.&lt;/p&gt;&lt;h2 id=&quot;the-lexer&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#the-lexer&quot; aria-label=&quot;Anchor link for: the-lexer&quot;&gt;The lexer&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;The first thing we have to do is &lt;strong&gt;tokenize&lt;/strong&gt; the string: tokenizing just means turning a string into a list of tokens, which are just things a bit more structured than a flat list of characters.&lt;/p&gt;&lt;p&gt;For example, a single token could be an integer like &lt;code&gt;4917&lt;/code&gt;: the &lt;em&gt;integer&lt;/em&gt;&lt;code&gt;4917&lt;/code&gt; has &quot;more structure&quot; than the list of characters &lt;code&gt;[?4, ?9, ?1, ?7]&lt;/code&gt; because we can treat it as a whole.&lt;/p&gt;&lt;p&gt;Tokenizing our lists is straightforward: we only tokenize parentheses (left &lt;code&gt;[&lt;/code&gt; and right &lt;code&gt;]&lt;/code&gt;), commas, integers, and atoms. We&apos;re going to tokenize only simple atoms, like &lt;code&gt;:foo&lt;/code&gt; or &lt;code&gt;:foo_bar&lt;/code&gt;, ignoring atoms that have to use double or single quotes, like &lt;code&gt;:&apos;foo bar&apos;&lt;/code&gt; or &lt;code&gt;:&quot;hello world!&quot;&lt;/code&gt;.&lt;/p&gt;&lt;p&gt;Rolling our own tokenizer for this basic syntax would be easy, but &lt;code&gt;leex&lt;/code&gt; greatly simplifies the job by letting us write a lexer with a very straightforward syntax. Basically, you identify tokens with regular expressions, and you associate an Erlang expression to each regular expression in order to create a token. I mentioned before that regular expressions aren&apos;t cut for this job: well, they&apos;re not a great tool for parsing because of the recursive nature of the task, but they&apos;re great for splitting things in a flat structure.&lt;/p&gt;&lt;p&gt;The syntax of a &lt;code&gt;leex&lt;/code&gt;&lt;strong&gt;rule&lt;/strong&gt; is this:&lt;/p&gt;&lt;pre class=&quot;z-code&quot;&gt;&lt;code&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;Regular expression : Erlang code.
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;In the &quot;Erlang code&quot;, we have to return a &lt;code&gt;{:token, value}&lt;/code&gt; tuple if we want the lexer to return that token to us (actually, a &lt;code&gt;{token, Value}&lt;/code&gt; tuple since we have to use Erlang syntax, not Elixir).&lt;/p&gt;&lt;p&gt;Our lexer is simple:&lt;/p&gt;&lt;pre class=&quot;z-code&quot;&gt;&lt;code&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;Rules.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;[0-9]+   : {token, {int,  TokenLine, TokenChars}}.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;:[a-z_]+ : {token, {atom, TokenLine, TokenChars}}.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;\[       : {token, {&amp;#39;[&amp;#39;,  TokenLine}}.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;\]       : {token, {&amp;#39;]&amp;#39;,  TokenLine}}.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;,        : {token, {&amp;#39;,&amp;#39;,  TokenLine}}.
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;We return a &lt;code&gt;{:token, value}&lt;/code&gt; to tell &lt;code&gt;leex&lt;/code&gt; we&apos;re interested in the matched token (that&apos;s why the first element of the tuple is &lt;code&gt;:token&lt;/code&gt;) and we want to include it in the output of the lexical analysis.&lt;/p&gt;&lt;p&gt;&lt;code&gt;TokenLine&lt;/code&gt; and &lt;code&gt;TokenChars&lt;/code&gt; are variables that &lt;code&gt;leex&lt;/code&gt; makes available in the Erlang expression following each regexp. These variables contain the line of the matching token and the matched token&apos;s contents (as a char list).&lt;/p&gt;&lt;p&gt;We always use two- or three-element tuples as the value of tokens because this is the format &lt;code&gt;yecc&lt;/code&gt; wants. As you can see, sometimes we&apos;re interested in the token value, so we return a three-element tuple but sometimes the token itself is its value (for example, the comma) so a two-element tuple is enough. The token line is mandatory so that &lt;code&gt;yecc&lt;/code&gt; can spit out accurate error messages.&lt;/p&gt;&lt;p&gt;We don&apos;t have to keep all the tokens we find: we can discard them by returning the atom &lt;code&gt;:skip_token&lt;/code&gt; instead of a &lt;code&gt;{:token, value}&lt;/code&gt; tuple. A common use case is skipping whitespace:&lt;/p&gt;&lt;pre class=&quot;z-code&quot;&gt;&lt;code&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;[\s\t\n\r]+ : skip_token.
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Regular expressions can quickly become nasty, but we can extract them into &lt;em&gt;definitions&lt;/em&gt; in the form &lt;code&gt;ALIAS = REGEX&lt;/code&gt;. We put definitions at the top of the file, before the list of rules. To use these definitions in the regexps, we have to surround them with curly braces.&lt;/p&gt;&lt;pre class=&quot;z-code&quot;&gt;&lt;code&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;Definitions.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;INT        = [0-9]+
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;ATOM       = :[a-z_]+
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;WHITESPACE = [\s\t\n\r]
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;Rules.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;{INT}         : {token, {int,  TokenLine, TokenChars}}.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;{ATOM}        : {token, {atom, TokenLine, TokenChars}}.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;\[            : {token, {&amp;#39;[&amp;#39;,  TokenLine}}.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;\]            : {token, {&amp;#39;]&amp;#39;,  TokenLine}}.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;,             : {token, {&amp;#39;,&amp;#39;,  TokenLine}}.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;{WHITESPACE}+ : skip_token.
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;We&apos;re ready to try out our lexer. First, we have to write it to a file with the &lt;code&gt;.xrl&lt;/code&gt; extension. Then, we can turn the &lt;code&gt;.xrl&lt;/code&gt; file into a &lt;code&gt;.erl&lt;/code&gt; file with &lt;code&gt;:leex.file/1&lt;/code&gt;. Finally, we can compile the newly generated Erlang module. Remember that most Erlang modules accept char lists instead of binaries, so we have to surround them in single quotes instead of double quotes. (Side note: Erlang uses single quotes to express complex atoms like &lt;code&gt;&apos;foo bar&apos;&lt;/code&gt; that can&apos;t be expressed using the &lt;code&gt;regular&lt;/code&gt; syntax, but you remembered that, right?)&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;iex&lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;leex&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;file&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-single z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;#39;&lt;/span&gt;list_lexer.xrl&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;iex&lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;&amp;gt;&lt;/span&gt; c&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;list_lexer.erl&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;iex&lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; tokens&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; _&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;list_lexer&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;string&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-single z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;#39;&lt;/span&gt;[1, [:foo]]&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;iex&lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;&amp;gt;&lt;/span&gt; tokens
&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-double-quoted z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&amp;quot;&lt;/span&gt;[&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;int&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-single z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;#39;&lt;/span&gt;1&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-double-quoted z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&amp;quot;&lt;/span&gt;,&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-double-quoted z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&amp;quot;&lt;/span&gt;[&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;atom&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-single z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;#39;&lt;/span&gt;:foo&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-double-quoted z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&amp;quot;&lt;/span&gt;]&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-double-quoted z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&amp;quot;&lt;/span&gt;]&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Nice! &lt;code&gt;leex&lt;/code&gt; also provides the possibility to define some Erlang code associated with the lexer: this is done in the &lt;code&gt;Erlang code.&lt;/code&gt; section at the bottom of the &lt;code&gt;.xrl&lt;/code&gt; file. We could take advantage of this to convert atom tokens to atoms:&lt;/p&gt;&lt;pre class=&quot;z-code&quot;&gt;&lt;code&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;...
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;{INT}  : {token, {int,  TokenLine, list_to_integer(TokenChars)}}.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;{ATOM} : {token, {atom, TokenLine, to_atom(TokenChars)}}.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;...
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;Erlang code.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;to_atom([$:|Chars]) -&amp;gt;
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;  list_to_atom(Chars).
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;code&gt;to_atom/1&lt;/code&gt; just strips the first character of an atom token (which is a colon, &lt;code&gt;$:&lt;/code&gt; in Erlang land) and converts the rest to an atom. We also used &lt;code&gt;list_to_integer/1&lt;/code&gt; to convert integer tokens to integers.&lt;/p&gt;&lt;p&gt;Our full lexer looks like this:&lt;/p&gt;&lt;pre class=&quot;z-code&quot;&gt;&lt;code&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;Definitions.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;INT        = [0-9]+
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;ATOM       = :[a-z_]+
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;WHITESPACE = [\s\t\n\r]
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;Rules.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;{INT}         : {token, {int,  TokenLine, list_to_integer(TokenChars)}}.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;{ATOM}        : {token, {atom, TokenLine, to_atom(TokenChars)}}.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;\[            : {token, {&amp;#39;[&amp;#39;,  TokenLine}}.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;\]            : {token, {&amp;#39;]&amp;#39;,  TokenLine}}.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;,             : {token, {&amp;#39;,&amp;#39;,  TokenLine}}.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;{WHITESPACE}+ : skip_token.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;Erlang code.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;to_atom([$:|Chars]) -&amp;gt;
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;    list_to_atom(Chars).
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;It works like we expect it to:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;iex&lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; tokens&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; _&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;list_lexer&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;string&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-single z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;#39;&lt;/span&gt;[1, :foo]&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;iex&lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;&amp;gt;&lt;/span&gt; tokens
&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-double-quoted z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&amp;quot;&lt;/span&gt;[&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;int&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-double-quoted z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&amp;quot;&lt;/span&gt;,&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;atom&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;foo&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-double-quoted z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&amp;quot;&lt;/span&gt;]&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&quot;the-parser&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#the-parser&quot; aria-label=&quot;Anchor link for: the-parser&quot;&gt;The parser&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;We now have a flat list of tokens. We want to give structure to those tokens and turn them into Elixir lists: we need to &lt;strong&gt;parse&lt;/strong&gt; the list of tokens. A parser works based on a &lt;strong&gt;grammar&lt;/strong&gt;, which is a set of rules that describe how tokens should be structured.&lt;/p&gt;&lt;p&gt;While we could hand-roll our own parser as well (which is a bit harder than rolling out our own lexer), it&apos;s easy to use &lt;code&gt;yecc&lt;/code&gt;: it lets you write very &lt;em&gt;declarative&lt;/em&gt; grammars and it&apos;s as easy to use as &lt;code&gt;leex&lt;/code&gt;.&lt;/p&gt;&lt;p&gt;Small side note: at this point, you might think these names make no sense. They do (more or less). They&apos;re both inspired by two very famous pieces of software: the &lt;a href=&quot;https://en.wikipedia.org/wiki/Lex_(software)&quot;&gt;&lt;code&gt;lex&lt;/code&gt;&lt;/a&gt; lexer generator and the &lt;a href=&quot;https://en.wikipedia.org/wiki/Yacc&quot;&gt;&lt;code&gt;yacc&lt;/code&gt;&lt;/a&gt; parser generator. Turns out these Erlang people aren&apos;t just crazy, uh?&lt;/p&gt;&lt;p&gt;Back to us. The central unit of &lt;code&gt;yecc&lt;/code&gt;&apos;s syntax is a &lt;strong&gt;rule&lt;/strong&gt;, which has the form:&lt;/p&gt;&lt;pre class=&quot;z-code&quot;&gt;&lt;code&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;Left-hand side -&amp;gt; Right-hand side : Erlang expressions.
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The left-hand side is a &lt;strong&gt;category&lt;/strong&gt; of tokens, while the right-hand side is a category or list of categories of tokens. Categories of tokens can be of two types: &lt;em&gt;terminal&lt;/em&gt; and &lt;em&gt;non-terminal&lt;/em&gt;. Terminals are just tokens that do not expand to other categories; non-terminals are categories that recursively expand to other categories.&lt;/p&gt;&lt;p&gt;For example, the &lt;code&gt;:&quot;[&quot;&lt;/code&gt; or &lt;code&gt;{atom, Atom}&lt;/code&gt; tokens are terminals. A list could be represented by the &lt;code&gt;list&lt;/code&gt; non-terminal:&lt;/p&gt;&lt;pre class=&quot;z-code&quot;&gt;&lt;code&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;list -&amp;gt; &amp;#39;[&amp;#39; &amp;#39;]&amp;#39;.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;% or...
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;list -&amp;gt; &amp;#39;[&amp;#39; elems &amp;#39;]&amp;#39;.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;% By the way, &amp;#39;%&amp;#39; is used for comments just like in Erlang.
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;As you can see, we can define multiple &quot;clauses&quot; for each category: the category can assume any value from these clauses (think of them like an &quot;or&quot;).&lt;/p&gt;&lt;p&gt;&lt;code&gt;elems&lt;/code&gt; is a non-terminal itself. We can define it as a single element or an element, a comma and a list of elements:&lt;/p&gt;&lt;pre class=&quot;z-code&quot;&gt;&lt;code&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;elems -&amp;gt; elem.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;elems -&amp;gt; elem &amp;#39;,&amp;#39; elems.
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The &lt;code&gt;elems&lt;/code&gt; category could be &lt;code&gt;elem&lt;/code&gt;, &lt;code&gt;elem, elem&lt;/code&gt;, and so on.&lt;/p&gt;&lt;p&gt;&lt;code&gt;elem&lt;/code&gt; is a non-terminal itself: it represents an integer, an atom, or a list. Note how elegantly we can represent the fact that an element of a list can be itself a list:&lt;/p&gt;&lt;pre class=&quot;z-code&quot;&gt;&lt;code&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;elem -&amp;gt; int.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;elem -&amp;gt; atom.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;elem -&amp;gt; list.
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Beautiful!&lt;/p&gt;&lt;p&gt;All non-terminals must at some point expand to terminals: you can&apos;t have a non-terminal that doesn&apos;t expand to anything. &lt;code&gt;yecc&lt;/code&gt; also requires you to specify which categories are terminals and which ones are non-terminals at the top of the file:&lt;/p&gt;&lt;pre class=&quot;z-code&quot;&gt;&lt;code&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;Terminals &amp;#39;[&amp;#39; &amp;#39;]&amp;#39; &amp;#39;,&amp;#39; int atom.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;Nonterminals list elems elem.
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;You also have to specify a &lt;strong&gt;root symbol&lt;/strong&gt;, that is, the starting non-terminal that generates the entire grammar. In our case, that&apos;s &lt;code&gt;list&lt;/code&gt;:&lt;/p&gt;&lt;pre class=&quot;z-code&quot;&gt;&lt;code&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;Rootsymbol list.
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;We&apos;re almost finished! The last thing we need to do is convert the parsed lists to Elixir lists. We can do this in the Erlang code associated with each parsing rule. In these Erlang expressions, we have some special atoms available: &lt;code&gt;&apos;$1&apos;&lt;/code&gt;, &lt;code&gt;&apos;$2&apos;&lt;/code&gt;, &lt;code&gt;&apos;$3&apos;&lt;/code&gt; and so on. &lt;code&gt;yecc&lt;/code&gt; replaces them with the value returned by the Erlang code associated with the category at the same index on the right-hand side of the rule. I just heard you thought &quot;&lt;em&gt;what?!&lt;/em&gt;&quot;; you&apos;re right, this is way easier to understand in practice:&lt;/p&gt;&lt;pre class=&quot;z-code&quot;&gt;&lt;code&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;list -&amp;gt;
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;  &amp;#39;[&amp;#39; &amp;#39;]&amp;#39; : []. % an empty list translate to, well, an empty list
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;list -&amp;gt;
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;  &amp;#39;[&amp;#39; elems &amp;#39;]&amp;#39; : &amp;#39;$2&amp;#39;. % the list is formed by its elements
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;elems -&amp;gt;
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;  elem : [&amp;#39;$1&amp;#39;]. % single-element list (and base case for the recursion)
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;elems -&amp;gt;
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;  elem &amp;#39;,&amp;#39; elems : [&amp;#39;$1&amp;#39;|&amp;#39;$3&amp;#39;]. % &amp;#39;$3&amp;#39; will be replaced recursively
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;elem -&amp;gt; int  : extract_token(&amp;#39;$1&amp;#39;).
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;elem -&amp;gt; atom : extract_token(&amp;#39;$1&amp;#39;).
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;elem -&amp;gt; list : &amp;#39;$1&amp;#39;.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;% Yep, we can use Erlang code here as well.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;Erlang code.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;extract_token({_Token, _Line, Value}) -&amp;gt; Value.
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;We&apos;re done! This is how our full parser looks like:&lt;/p&gt;&lt;pre class=&quot;z-code&quot;&gt;&lt;code&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;Nonterminals list elems elem.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;Terminals &amp;#39;[&amp;#39; &amp;#39;]&amp;#39; &amp;#39;,&amp;#39; int atom.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;Rootsymbol list.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;list -&amp;gt; &amp;#39;[&amp;#39; &amp;#39;]&amp;#39;       : [].
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;list -&amp;gt; &amp;#39;[&amp;#39; elems &amp;#39;]&amp;#39; : &amp;#39;$2&amp;#39;.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;elems -&amp;gt; elem           : [&amp;#39;$1&amp;#39;].
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;elems -&amp;gt; elem &amp;#39;,&amp;#39; elems : [&amp;#39;$1&amp;#39;|&amp;#39;$3&amp;#39;].
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;elem -&amp;gt; int  : extract_token(&amp;#39;$1&amp;#39;).
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;elem -&amp;gt; atom : extract_token(&amp;#39;$1&amp;#39;).
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;elem -&amp;gt; list : &amp;#39;$1&amp;#39;.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;Erlang code.
&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;&lt;/span&gt;&lt;span class=&quot;z-text z-plain&quot;&gt;extract_token({_Token, _Line, Value}) -&amp;gt; Value.
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;We can now create an Erlang file from the &lt;code&gt;yecc&lt;/code&gt; file (which has a &lt;code&gt;.yrl&lt;/code&gt; extension) just like we did with &lt;code&gt;leex&lt;/code&gt;:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;iex&lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;yecc&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;file&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-single z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;#39;&lt;/span&gt;list_parser.yrl&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;#39;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;iex&lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;&amp;gt;&lt;/span&gt; c&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;list_parser.erl&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;iex&lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;list_parser&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;parse&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-double-quoted z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&amp;quot;&lt;/span&gt;[&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;atom&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;foo&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-double-quoted z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&amp;quot;&lt;/span&gt;]&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;foo&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;It works!&lt;/p&gt;&lt;h2 id=&quot;putting-it-together&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#putting-it-together&quot; aria-label=&quot;Anchor link for: putting-it-together&quot;&gt;Putting it together&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;We can feed the output of the lexer directly into the parser now:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;iex&lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;&amp;gt;&lt;/span&gt; source &lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-meta z-string z-elixir&quot;&gt;&lt;span class=&quot;z-string z-quoted z-double z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-string z-begin z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;[:foo, [1], [:bar, [2, 3]]]&lt;span class=&quot;z-punctuation z-definition z-string z-end z-elixir&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;iex&lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; tokens&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; _&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; source &lt;span class=&quot;z-keyword z-operator z-pipe z-elixir&quot;&gt;|&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;to_charlist&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-pipe z-elixir&quot;&gt;|&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;list_lexer&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;string
&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;iex&lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;list_parser&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;parse&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;tokens&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;foo&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;bar&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-numeric z-elixir&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Awesome!&lt;/p&gt;&lt;h2 id=&quot;elixir-integration&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#elixir-integration&quot; aria-label=&quot;Anchor link for: elixir-integration&quot;&gt;Elixir integration&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;Manually generating Erlang files from &lt;code&gt;.xrl&lt;/code&gt; and &lt;code&gt;.yrl&lt;/code&gt; files and then compiling those Erlang files can become tedious very quickly. Luckily, Mix can do that for you!&lt;/p&gt;&lt;p&gt;Mix has the concept of &quot;compilers&quot;: they&apos;re just what you think they are, compilers. Mix provides a compiler for Erlang (which just compiles &lt;code&gt;.erl&lt;/code&gt; files through the Erlang installation), one for Elixir, but also a &lt;code&gt;:leex&lt;/code&gt; compiler and &lt;code&gt;:yecc&lt;/code&gt; compiler. They are actually enabled by default, as you can see by inspecting the return value of &lt;a href=&quot;https://hexdocs.pm/mix/Mix.html#compilers/0&quot;&gt;&lt;code&gt;Mix.compilers/0&lt;/code&gt;&lt;/a&gt; inside a Mix project:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;iex&lt;span class=&quot;z-keyword z-operator z-comparison z-elixir&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;Mix&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;compilers&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;yecc&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;leex&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;erlang&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;elixir&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-object z-elixir&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;app&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-array z-elixir&quot;&gt;]&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The only thing you have to do to make all of this work effortlessly inside a Mix project is to put your &lt;code&gt;.xrl&lt;/code&gt; and &lt;code&gt;.yrl&lt;/code&gt; files in the &lt;code&gt;src/&lt;/code&gt; directory of the project. You&apos;ll have the compiled Erlang modules available when the Mix compiles the project.&lt;/p&gt;&lt;pre data-lang=&quot;bash&quot; class=&quot;language-bash z-code&quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;z-source z-shell z-bash&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-shell&quot;&gt;&lt;span class=&quot;z-variable z-function z-shell&quot;&gt;mix&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-arguments z-shell&quot;&gt; new list_parser&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-shell z-bash&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-shell&quot;&gt;&lt;span class=&quot;z-variable z-function z-shell&quot;&gt;mkdir&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-arguments z-shell&quot;&gt; list_parser/src&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-shell z-bash&quot;&gt;&lt;span class=&quot;z-meta z-function-call z-shell&quot;&gt;&lt;span class=&quot;z-variable z-function z-shell&quot;&gt;mv&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-meta z-function-call z-arguments z-shell&quot;&gt; ./list_parser.yrl ./list_lexer.xrl ./list_parser/src/&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Now, inside &lt;code&gt;list_parser/lib/list_parser.ex&lt;/code&gt;:&lt;/p&gt;&lt;pre data-lang=&quot;elixir&quot; class=&quot;language-elixir z-code&quot;&gt;&lt;code class=&quot;language-elixir&quot; data-lang=&quot;elixir&quot;&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;defmodule&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-class z-elixir&quot;&gt;ListParser&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-variable z-other z-module z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-operator z-definition z-constant z-elixir&quot;&gt;@&lt;/span&gt;spec&lt;/span&gt; parse&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;binary&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt; :: list
&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-function z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;def&lt;/span&gt;&lt;span class=&quot;z-entity z-name z-function z-public z-elixir&quot;&gt;parse&lt;/span&gt;&lt;span class=&quot;z-punctuation z-definition z-parameters z-elixir&quot;&gt;(&lt;/span&gt;str&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-control z-module z-elixir&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; tokens&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; _&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt; str &lt;span class=&quot;z-keyword z-operator z-pipe z-elixir&quot;&gt;|&amp;gt;&lt;/span&gt; to_charlist&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-pipe z-elixir&quot;&gt;|&amp;gt;&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;list_lexer&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;string&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-meta z-sequence z-tuple z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-section z-sequence z-begin z-elixir&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;ok&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-sequence z-elixir&quot;&gt;,&lt;/span&gt; list&lt;span class=&quot;z-punctuation z-section z-sequence z-end z-elixir&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-keyword z-operator z-assignment z-elixir&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;z-constant z-other z-symbol z-elixir&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-constant z-elixir&quot;&gt;:&lt;/span&gt;list_parser&lt;/span&gt;&lt;span class=&quot;z-punctuation z-separator z-method z-elixir&quot;&gt;.&lt;/span&gt;parse&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;(&lt;/span&gt;tokens&lt;span class=&quot;z-punctuation z-section z-function z-elixir&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;    list
&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;z-source z-elixir&quot;&gt;&lt;span class=&quot;z-keyword z-control z-elixir&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&quot;i-m-not-convinced-yet&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#i-m-not-convinced-yet&quot; aria-label=&quot;Anchor link for: i-m-not-convinced-yet&quot;&gt;I&apos;m not convinced yet&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;All of this may sound very abstract, but I assure you that &lt;code&gt;leex&lt;/code&gt; and &lt;code&gt;yecc&lt;/code&gt; have tons of practical uses. For example, I recently had to write a parser for &lt;a href=&quot;https://www.gnu.org/software/gettext/manual/html_node/PO-Files.html&quot;&gt;PO files&lt;/a&gt; in the context of writing an Elixir binding to &lt;a href=&quot;https://www.gnu.org/software/gettext/&quot;&gt;GNU gettext&lt;/a&gt;. Well, I used &lt;code&gt;yecc&lt;/code&gt; to write a parser: this resulted in a very declarative, clean and easy-to-understand grammar (you can see it &lt;a href=&quot;https://github.com/elixir-lang/gettext/blob/e2e3d42edd2a8fa5aa2deada2e5779f122594e71/src/gettext_po_parser.yrl&quot;&gt;here&lt;/a&gt;) and I&apos;m super-happy with it. We didn&apos;t use &lt;code&gt;leex&lt;/code&gt; in Gettext but decided to roll our own lexer, but only because the tokenization was very simple and &lt;code&gt;leex&lt;/code&gt; may have been slight overkill.&lt;/p&gt;&lt;p&gt;Want another Real-World™ example? Wait, I think I have one: ever heard of the Elixir programming language? It&apos;s a nice language built atop the Erlang virtual matching, focused on concurrency, fault to… Well, it&apos;s &lt;a href=&quot;https://github.com/elixir-lang/elixir/blob/main/lib/elixir/src/elixir_parser.yrl&quot;&gt;parsed by &lt;code&gt;yecc&lt;/code&gt;&lt;/a&gt;!&lt;/p&gt;&lt;h2 id=&quot;recap&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#recap&quot; aria-label=&quot;Anchor link for: recap&quot;&gt;Recap&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;We built a lexer and a parser for transforming strings representing Elixir lists to actual Elixir lists. We used the &lt;code&gt;leex&lt;/code&gt; Erlang module to generate the lexer and the &lt;code&gt;yecc&lt;/code&gt; module to generate the parser.&lt;/p&gt;&lt;p&gt;Finally, only covered the basics of these two tools: they can do more complicated things (&lt;code&gt;yecc&lt;/code&gt; generates LALR parsers if you know what that means) but for that, as usual, there&apos;s their &lt;a href=&quot;https://www.erlang.org/doc/apps/parsetools/&quot;&gt;documentation&lt;/a&gt;.&lt;/p&gt;&lt;hr /&gt;&lt;p&gt;I&apos;m realizing just now that this post, even if it&apos;s my first post about Elixir, contains barely any Elixir. Let&apos;s just see this as an opportunity to sing the praises of how easy it is to use Erlang from Elixir, shall we?&lt;/p&gt;&lt;h3 id=&quot;very-small-update&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#very-small-update&quot; aria-label=&quot;Anchor link for: very-small-update&quot;&gt;Very small update&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;I updated the source code in this blog post to use &lt;code&gt;String.to_charlist/1&lt;/code&gt; and &lt;code&gt;to_charlist/1&lt;/code&gt; instead of &lt;code&gt;String.to_char_list/1&lt;/code&gt; and &lt;code&gt;to_char_list/1&lt;/code&gt; respectively. The &lt;code&gt;charlist&lt;/code&gt; spelling has been deprecated in Elixir 1.3.&lt;/p&gt;</content>
    
    </entry>
  
</feed>
