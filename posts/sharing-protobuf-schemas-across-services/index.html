<!DOCTYPE html>
<html prefix="og: https://ogp.me/ns# article: https://ogp.me/ns/article#" lang="en" xml:lang="en">

<head>
    <title>Sharing Protobuf schemas across services – Andrea Leopardi</title>
    






<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="description" content="How we&#x27;re managing, evolving, and sharing Protobuf schemas across several services and programming languages." />
<meta name="author" content="Andrea Leopardi" />

<!-- Favicons -->
<link rel="icon" href="/favicon.ico" sizes="any" />
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon.png" />
<link rel="manifest" href="/manifest.webmanifest" />

<!-- Mobile -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

<!-- Open Graph -->
<meta property="og:title" content="Sharing Protobuf schemas across services">
<meta property="og:description" content="How we&#x27;re managing, evolving, and sharing Protobuf schemas across several services and programming languages.">
<meta property="og:url" content="https://andrealeopardi.com/posts/sharing-protobuf-schemas-across-services/">
<meta property="og:image" content="https://andrealeopardi.com/posts/sharing-protobuf-schemas-across-services/cover-image.jpg">

<meta property="og:type" content="article">
<meta property="article:published_time" content="2020-02-24T00:00:00+00:00">


<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:creator" content="@whatyouhide">
<meta name="twitter:title" content="Sharing Protobuf schemas across services">
<meta name="twitter:description" content="How we&#x27;re managing, evolving, and sharing Protobuf schemas across several services and programming languages.">
<meta name="twitter:image" content="https://andrealeopardi.com/posts/sharing-protobuf-schemas-across-services/cover-image.jpg">


    <!--[if lt IE 9]>
    <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&display=swap">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Spectral:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap">
    <link rel="alternate" type="application/rss+xml" title="Andrea Leopardi" href="/feed.xml" />

    
    <link rel="alternate" type="application/rss+xml" title="Andrea Leopardi" href="https://andrealeopardi.com/ feed.xml" />
    

    




<script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "url": "https://andrealeopardi.com/posts/sharing-protobuf-schemas-across-services/",
    "author": {
        "@type": "Person",
        "name": "Andrea Leopardi",
        "email": "hi@andrealeopardi.com",
        "url": "https://andrealeopardi.com//about.html"
    },
    "datePublished": "2020-02-24",
    "dateCreated": "2020-02-24",
    "dateModified": "2020-02-24",
    "headline": "Sharing Protobuf schemas across services",
    "description": "How we're managing, evolving, and sharing Protobuf schemas across several services and programming languages.",
    "image": "https://andrealeopardi.com/posts/sharing-protobuf-schemas-across-services/cover-image.jpg",
    "inLanguage": {
        "@type": "Language",
        "name": "English"
    }
}
</script>



    <script>
        function createSnowflakes() {
            const snowflakesInARow = 15;
            const snowflakeRows = 12;
            const viewportJiggle = 8;
            const body = document.body;

            for (let row = 0; row < snowflakeRows; row++) {
                for (let col = 0; col < snowflakesInARow; col++) {
                    const snowflake = document.createElement('div');
                    snowflake.classList.add('snowflake');

                    // Random size (scale), rotation, and opacity.
                    const scale = Math.random() * 0.8 + 0.2; // Scale between 0.2 and 1
                    snowflake.style.width = `${50 * scale}px`;
                    snowflake.style.height = `${50 * scale}px`;
                    snowflake.style.transform = `rotate(${Math.random() * 360}deg)`;
                    snowflake.style.opacity = `${Math.random() * 0.1}`; // Opacity between 0.5 and 1

                    // Random position
                    const startLeft = 100 * (col / snowflakesInARow);
                    const startTop = 100 * (row / snowflakeRows);
                    // Jiggle the position a bit to make it look more natural.
                    snowflake.style.left = `${startLeft + Math.random() * viewportJiggle - (viewportJiggle / 2)}vw`;
                    snowflake.style.top = `${startTop + Math.random() * viewportJiggle - (viewportJiggle / 2)}vh`;

                    body.appendChild(snowflake);
                }
            }
        }

        // Re-enable during holidays.
        // document.addEventListener('DOMContentLoaded', createSnowflakes);
    </script>
</head>

<body>
    <div class="wrapper-masthead">
        
        <header>
  <h1 class="site-name">
    <a href="/">

      <picture>
        <source srcset="https://andrealeopardi.com/assets/media/hero-portrait-dark.png"
        media="(prefers-color-scheme: dark)">

        <img class="hero-portrait"
             src="https://andrealeopardi.com/assets/media/hero-portrait.png"
             alt="Portrait of Andrea, daylight, looking to your right" />
      </picture>
      <span>Andrea Leopardi</span>
    </a>
  </h1>
</header>

        

        
<div id="main" role="main" class="container">
  <article class="post">
    <h1>Sharing Protobuf schemas across services</h1>

    <div class="entry"><p>The system that we're building at <a href="https://www.community.com">Community.com</a> is made of a few services (around fifteen at the time of writing) that interact with each other through a basic version of event sourcing. All events flow (published and consumed) through RabbitMQ and are serialized with <a href="https://developers.google.com/protocol-buffers">Protobuf</a>. With several services already and many more coming in the future, managing the Protobuf schemas becomes a painful part of evolving and maintaining the system. Do we copy the schemas in all services? Do we keep them somewhere and use something akin to Git submodules to keep them in sync in all of our projects? What do we do?! In this post, I'll go through the tooling that we came up with in order to sanely manage our Protobuf schemas throughout our services and technology stack.</p>
<span id="continue-reading"></span>
<p><img src="https://andrealeopardi.com/posts/sharing-protobuf-schemas-across-services/cover-image.jpg" alt="Cover image of a library with books" /></p>
<span class="unsplash-credit">
    Photo by <a href="https:&#x2F;&#x2F;unsplash.com&#x2F;s&#x2F;photos&#x2F;library?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Fahrul Azmi</a> on <a href="https://unsplash.com">Unsplash</a>
</span>
<p>This post will go through the steps that led us to the solution we're currently using, so feel free to skip ahead if you just want to know what we ended up with.</p>
<h2 id="starting-out-a-single-elixir-library"><a class="zola-anchor" href="#starting-out-a-single-elixir-library" aria-label="Anchor link for: starting-out-a-single-elixir-library">Starting out: a single Elixir library</a></h2>
<p>When we started defining schemas for our Protobuf events, we were only using such schemas from Elixir. We created a library called <code>events</code> and started hosting it on our private <a href="https://hex.pm">Hex</a> repository. <code>events</code> contained all the <code>.proto</code> schema files and depended on the <a href="https://github.com/bitwalker/exprotobuf">exprotobuf</a> library to "compile" the Protobuf schemas to Elixir code. exprotobuf uses a different approach than most Protobuf libraries for other languages that I encountered: it loads the <code>.proto</code> schema definitions at compile time instead of using <code>protoc</code> to compile the Protobuf files to <code>.ex</code> Elixir files. Essentially, we created a module like this:</p>
<pre data-lang="elixir" class="language-elixir z-code"><code class="language-elixir" data-lang="elixir"><span class="z-source z-elixir"><span class="z-meta z-module z-elixir"><span class="z-keyword z-control z-module z-elixir">defmodule</span> <span class="z-entity z-name z-class z-elixir">Events</span> <span class="z-keyword z-control z-module z-elixir">do</span></span>
</span><span class="z-source z-elixir">  <span class="z-keyword z-control z-elixir">use</span> <span class="z-entity z-name z-class z-elixir">Protobuf</span><span class="z-punctuation z-separator z-object z-elixir">,</span>
</span><span class="z-source z-elixir">    <span class="z-constant z-other z-keywords z-elixir">from<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-entity z-name z-class z-elixir">Path</span><span class="z-punctuation z-separator z-method z-elixir">.</span>wildcard<span class="z-punctuation z-section z-function z-elixir">(</span><span class="z-entity z-name z-class z-elixir">Path</span><span class="z-punctuation z-separator z-method z-elixir">.</span>expand<span class="z-punctuation z-section z-function z-elixir">(</span><span class="z-meta z-string z-elixir"><span class="z-string z-quoted z-double z-elixir"><span class="z-punctuation z-definition z-string z-begin z-elixir">&quot;</span>../schemas/*.proto<span class="z-punctuation z-definition z-string z-end z-elixir">&quot;</span></span></span><span class="z-punctuation z-separator z-object z-elixir">,</span> <span class="z-variable z-language z-elixir">__DIR__</span><span class="z-punctuation z-section z-function z-elixir">)</span><span class="z-punctuation z-section z-function z-elixir">)</span>
</span><span class="z-source z-elixir"><span class="z-keyword z-control z-elixir">end</span>
</span></code></pre>
<p>The most common approach to turning a Protobuf schema into a data structure representable by the programming language you're using is to turn the schema into some kind of "struct" representation. That's exactly what exprotobuf does for Elixir. This is one of our schemas:</p>
<pre data-lang="proto" class="language-proto z-code"><code class="language-proto" data-lang="proto"><span class="z-source z-proto"># In schemas/event_envelope.proto
</span><span class="z-source z-proto"><span class="z-keyword z-other z-syntax z-proto">syntax</span> <span class="z-keyword z-operator z-assignment z-proto">=</span> <span class="z-string z-quoted z-double z-proto"><span class="z-punctuation z-definition z-string z-begin z-proto">&quot;</span>proto3<span class="z-punctuation z-definition z-string z-end z-proto">&quot;</span></span><span class="z-punctuation z-terminator z-proto">;</span>
</span><span class="z-source z-proto">
</span><span class="z-source z-proto"><span class="z-meta z-class z-proto"><span class="z-storage z-type z-message z-proto">message</span> <span class="z-entity z-name z-class z-proto">EventEnvelope</span> <span class="z-meta z-class z-proto"><span class="z-punctuation z-definition z-block z-message z-begin z-proto">{</span></span></span><span class="z-meta z-class z-proto">
</span></span><span class="z-source z-proto"><span class="z-meta z-class z-proto">  <span class="z-support z-type z-proto">int64</span> <span class="z-variable z-other z-field z-proto">timestamp</span> <span class="z-keyword z-operator z-assignment z-proto">=</span> <span class="z-constant z-numeric z-proto">1</span><span class="z-punctuation z-terminator z-proto">;</span>
</span></span><span class="z-source z-proto"><span class="z-meta z-class z-proto">  <span class="z-support z-type z-proto">string</span> <span class="z-variable z-other z-field z-proto">source</span> <span class="z-keyword z-operator z-assignment z-proto">=</span> <span class="z-constant z-numeric z-proto">2</span><span class="z-punctuation z-terminator z-proto">;</span>
</span></span><span class="z-source z-proto"><span class="z-meta z-class z-proto"><span class="z-punctuation z-definition z-block z-message z-end z-proto">}</span></span>
</span></code></pre>
<p>exprotobuf loads this up at compile time and turns it into roughly this Elixir definition:</p>
<pre data-lang="elixir" class="language-elixir z-code"><code class="language-elixir" data-lang="elixir"><span class="z-source z-elixir"><span class="z-meta z-module z-elixir"><span class="z-keyword z-control z-module z-elixir">defmodule</span> <span class="z-entity z-name z-class z-elixir">Events</span>.<span class="z-entity z-name z-class z-elixir">EventEnvelope</span> <span class="z-keyword z-control z-module z-elixir">do</span></span>
</span><span class="z-source z-elixir">  <span class="z-keyword z-control z-elixir">defstruct</span> <span class="z-punctuation z-section z-array z-elixir">[</span><span class="z-constant z-other z-symbol z-elixir"><span class="z-punctuation z-definition z-constant z-elixir">:</span>timestamp</span><span class="z-punctuation z-separator z-object z-elixir">,</span> <span class="z-constant z-other z-symbol z-elixir"><span class="z-punctuation z-definition z-constant z-elixir">:</span>source</span><span class="z-punctuation z-section z-array z-elixir">]</span>
</span><span class="z-source z-elixir">
</span><span class="z-source z-elixir"><span class="z-comment z-line z-number-sign z-elixir">  <span class="z-punctuation z-definition z-comment z-elixir">#</span> A bunch of encode/decode functions plus
</span></span><span class="z-source z-elixir"><span class="z-comment z-line z-number-sign z-elixir">  <span class="z-punctuation z-definition z-comment z-elixir">#</span> new/1 to create a new struct.
</span></span><span class="z-source z-elixir"><span class="z-comment z-line z-number-sign z-elixir">  <span class="z-punctuation z-definition z-comment z-elixir">#</span> ...
</span></span><span class="z-source z-elixir"><span class="z-keyword z-control z-elixir">end</span>
</span></code></pre>
<p>This whole approach worked okay for a while, but soon we needed to use our Protobuf definitions from a service written in Python.</p>
<h2 id="sharing-protobuf-schemas-through-git-submodules"><a class="zola-anchor" href="#sharing-protobuf-schemas-through-git-submodules" aria-label="Anchor link for: sharing-protobuf-schemas-through-git-submodules">Sharing Protobuf schemas through Git submodules</a></h2>
<p>The first thing that came to mind when we thought about sharing Protobuf schema definitions across different programming languages was <a href="https://git-scm.com/book/en/v2/Git-Tools-Submodules">Git submodules</a>. We created a <code>proto_schemas</code> repository containing all the <code>.proto</code> files and added it as a Git submodule to our <code>events</code> Elixir library and to a single Python service. Not much changed on the Elixir side, but on the Python side things were working a bit differently. The Protobuf Python library uses a common approach among Protobuf libraries, which is to use a plugin to the <a href="https://github.com/protocolbuffers/protobuf/releases"><code>protoc</code></a> compiler in order to generate Python code from the <code>.proto</code> files. Essentially, you call:</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">protoc</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>python_out</span><span class="z-keyword z-operator z-assignment z-option z-shell">=</span><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>.<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>I</span> ../schemas event_envelope.proto</span>
</span></code></pre>
<p>So, for example, our <code>event_envelope.proto</code> file would become <code>event_envelope.pb2.py</code> once compiled.</p>
<p>The Git-submodule approach worked okay for a while, but it presented two main challenges: how to uniformly version schemas across languages? How to avoid having every project contain a copy of the Protobuf schemas and having to compile them individually to the host language?</p>
<p>Lucky for me, one day I was discussing these problems with my friend <a href="https://github.com/ericmj">Eric</a> from the Elixir team, and we figured out a way to only keep the Protobuf schemas in a single place, compile them all in a single place, but use them from different languages all around.</p>
<h2 id="protoc-ci-and-libraries"><a class="zola-anchor" href="#protoc-ci-and-libraries" aria-label="Anchor link for: protoc-ci-and-libraries"><code>protoc</code>, CI, and libraries</a></h2>
<p>I did some research on available Protobuf libraries for Elixir and was lucky to find an alternative to exprotobuf called <a href="https://github.com/tony612/protobuf-elixir">protobuf-elixir</a>. The APIs that this library exposes to manipulate Protobuf structs and manage serialization were exactly the same as the APIs exposed by exprotobuf, so compatibility was not an issue. However, this library had a key features that I was interested in: it supported code generation through the <code>protoc</code> Protobuf compiler. It worked like it does in Python (and many other languages).</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">protoc</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>elixir_out</span><span class="z-keyword z-operator z-assignment z-option z-shell">=</span>./lib<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>I</span> ../schemas event_envelope.proto</span>
</span></code></pre>
<p>At this point, I had code generation through <code>protoc</code> working for both Python and Elixir. The next step was to map Protobuf packages (that is, collections of Protobuf schemas) to <em>language libraries</em> and publish those to package repositories for the respective languages. We'll go through what we did for Elixir, but the setup for Python looks almost identical.</p>
<p>All our events-related Protobuf schemas live in the <code>events</code> Protobuf package. So, we decided to map that to an Elixir library called <code>events_schemas</code>. The nice thing about this library is that it only contains the auto-generated code for the Protobuf schemas and nothing else. It essentially exposes an interface to the Protobuf schemas from Elixir. In the same repository where we keep the <code>.proto</code> files, we created a <code>languages/elixir/</code> directory to store everything necessary for compiling to Elixir and publishing this library on our private <a href="https://hex.pm">hex.pm</a> repository. The "skeleton" of the <code>events_schemas</code> library looks like this:</p>
<pre class="z-code"><code><span class="z-text z-plain">events_schemas
</span><span class="z-text z-plain">├── .gitignore
</span><span class="z-text z-plain">├── lib
</span><span class="z-text z-plain">│   └── .gitkeep
</span><span class="z-text z-plain">└── mix.exs
</span></code></pre>
<p>Basically, the library is empty. The <code>mix.exs</code> file looks like this:</p>
<pre data-lang="elixir" class="language-elixir z-code"><code class="language-elixir" data-lang="elixir"><span class="z-source z-elixir"><span class="z-meta z-module z-elixir"><span class="z-keyword z-control z-module z-elixir">defmodule</span> <span class="z-entity z-name z-class z-elixir">EventsSchemas</span>.<span class="z-entity z-name z-class z-elixir">MixProject</span> <span class="z-keyword z-control z-module z-elixir">do</span></span>
</span><span class="z-source z-elixir">  <span class="z-keyword z-control z-elixir">use</span> <span class="z-entity z-name z-class z-elixir">Mix</span><span class="z-punctuation z-separator z-method z-elixir">.</span><span class="z-entity z-name z-class z-elixir">Project</span>
</span><span class="z-source z-elixir">
</span><span class="z-source z-elixir"><span class="z-meta z-function z-elixir">  <span class="z-keyword z-control z-module z-elixir">def</span> <span class="z-entity z-name z-function z-public z-elixir">project</span> <span class="z-keyword z-control z-module z-elixir">do</span></span>
</span><span class="z-source z-elixir">    <span class="z-punctuation z-section z-array z-elixir">[</span>
</span><span class="z-source z-elixir">      <span class="z-constant z-other z-keywords z-elixir">app<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-constant z-other z-symbol z-elixir"><span class="z-punctuation z-definition z-constant z-elixir">:</span>events_schemas</span><span class="z-punctuation z-separator z-object z-elixir">,</span>
</span><span class="z-source z-elixir">      <span class="z-constant z-other z-keywords z-elixir">version<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> version<span class="z-punctuation z-section z-function z-elixir">(</span><span class="z-punctuation z-section z-function z-elixir">)</span><span class="z-punctuation z-separator z-object z-elixir">,</span>
</span><span class="z-source z-elixir">      <span class="z-constant z-other z-keywords z-elixir">elixir<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-meta z-string z-elixir"><span class="z-string z-quoted z-double z-elixir"><span class="z-punctuation z-definition z-string z-begin z-elixir">&quot;</span>~&gt; 1.8<span class="z-punctuation z-definition z-string z-end z-elixir">&quot;</span></span></span><span class="z-punctuation z-separator z-object z-elixir">,</span>
</span><span class="z-source z-elixir">      <span class="z-constant z-other z-keywords z-elixir">deps<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> deps<span class="z-punctuation z-section z-function z-elixir">(</span><span class="z-punctuation z-section z-function z-elixir">)</span><span class="z-punctuation z-separator z-object z-elixir">,</span>
</span><span class="z-source z-elixir">      <span class="z-constant z-other z-keywords z-elixir">package<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> package<span class="z-punctuation z-section z-function z-elixir">(</span><span class="z-punctuation z-section z-function z-elixir">)</span>
</span><span class="z-source z-elixir">    <span class="z-punctuation z-section z-array z-elixir">]</span>
</span><span class="z-source z-elixir">  <span class="z-keyword z-control z-elixir">end</span>
</span><span class="z-source z-elixir">
</span><span class="z-source z-elixir"><span class="z-meta z-function z-elixir">  <span class="z-keyword z-control z-module z-elixir">def</span> <span class="z-entity z-name z-function z-public z-elixir">application</span> <span class="z-keyword z-control z-module z-elixir">do</span></span>
</span><span class="z-source z-elixir">    <span class="z-punctuation z-section z-array z-elixir">[</span><span class="z-constant z-other z-keywords z-elixir">extra_applications<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-punctuation z-section z-array z-elixir">[</span><span class="z-punctuation z-section z-array z-elixir">]</span><span class="z-punctuation z-section z-array z-elixir">]</span>
</span><span class="z-source z-elixir">  <span class="z-keyword z-control z-elixir">end</span>
</span><span class="z-source z-elixir">
</span><span class="z-source z-elixir"><span class="z-meta z-function z-elixir">  <span class="z-keyword z-control z-module z-elixir">defp</span> <span class="z-entity z-name z-function z-private z-elixir">deps</span> <span class="z-keyword z-control z-module z-elixir">do</span></span>
</span><span class="z-source z-elixir">    <span class="z-punctuation z-section z-array z-elixir">[</span><span class="z-meta z-sequence z-tuple z-elixir"><span class="z-punctuation z-section z-sequence z-begin z-elixir">{</span><span class="z-constant z-other z-symbol z-elixir"><span class="z-punctuation z-definition z-constant z-elixir">:</span>protobuf</span><span class="z-punctuation z-separator z-sequence z-elixir">,</span> protobuf_dependency_version<span class="z-punctuation z-section z-function z-elixir">(</span><span class="z-punctuation z-section z-function z-elixir">)</span><span class="z-punctuation z-section z-sequence z-end z-elixir">}</span></span><span class="z-punctuation z-section z-array z-elixir">]</span>
</span><span class="z-source z-elixir">  <span class="z-keyword z-control z-elixir">end</span>
</span><span class="z-source z-elixir">
</span><span class="z-source z-elixir"><span class="z-meta z-function z-elixir">  <span class="z-keyword z-control z-module z-elixir">defp</span> <span class="z-entity z-name z-function z-private z-elixir">package</span> <span class="z-keyword z-control z-module z-elixir">do</span></span>
</span><span class="z-source z-elixir">    <span class="z-punctuation z-section z-array z-elixir">[</span>
</span><span class="z-source z-elixir">      <span class="z-constant z-other z-keywords z-elixir">organization<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-meta z-string z-elixir"><span class="z-string z-quoted z-double z-elixir"><span class="z-punctuation z-definition z-string z-begin z-elixir">&quot;</span>community<span class="z-punctuation z-definition z-string z-end z-elixir">&quot;</span></span></span><span class="z-punctuation z-separator z-object z-elixir">,</span>
</span><span class="z-source z-elixir">      <span class="z-constant z-other z-keywords z-elixir">files<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-punctuation z-section z-array z-elixir">[</span>
</span><span class="z-source z-elixir">        <span class="z-meta z-string z-elixir"><span class="z-string z-quoted z-double z-elixir"><span class="z-punctuation z-definition z-string z-begin z-elixir">&quot;</span>lib/**/*.pb.ex<span class="z-punctuation z-definition z-string z-end z-elixir">&quot;</span></span></span><span class="z-punctuation z-separator z-object z-elixir">,</span>
</span><span class="z-source z-elixir">        <span class="z-meta z-string z-elixir"><span class="z-string z-quoted z-double z-elixir"><span class="z-punctuation z-definition z-string z-begin z-elixir">&quot;</span>mix.exs<span class="z-punctuation z-definition z-string z-end z-elixir">&quot;</span></span></span><span class="z-punctuation z-separator z-object z-elixir">,</span>
</span><span class="z-source z-elixir">        <span class="z-meta z-string z-elixir"><span class="z-string z-quoted z-double z-elixir"><span class="z-punctuation z-definition z-string z-begin z-elixir">&quot;</span>VERSION<span class="z-punctuation z-definition z-string z-end z-elixir">&quot;</span></span></span><span class="z-punctuation z-separator z-object z-elixir">,</span>
</span><span class="z-source z-elixir">        <span class="z-meta z-string z-elixir"><span class="z-string z-quoted z-double z-elixir"><span class="z-punctuation z-definition z-string z-begin z-elixir">&quot;</span>PROTOBUF_EX_VERSION<span class="z-punctuation z-definition z-string z-end z-elixir">&quot;</span></span></span>
</span><span class="z-source z-elixir">      <span class="z-punctuation z-section z-array z-elixir">]</span>
</span><span class="z-source z-elixir">    <span class="z-punctuation z-section z-array z-elixir">]</span>
</span><span class="z-source z-elixir">  <span class="z-keyword z-control z-elixir">end</span>
</span><span class="z-source z-elixir">
</span><span class="z-source z-elixir"><span class="z-meta z-function z-elixir">  <span class="z-keyword z-control z-module z-elixir">defp</span> <span class="z-entity z-name z-function z-private z-elixir">protobuf_dependency_version</span> <span class="z-keyword z-control z-module z-elixir">do</span></span>
</span><span class="z-source z-elixir">    <span class="z-meta z-string z-elixir"><span class="z-string z-quoted z-double z-elixir"><span class="z-punctuation z-definition z-string z-begin z-elixir">&quot;</span>PROTOBUF_EX_VERSION<span class="z-punctuation z-definition z-string z-end z-elixir">&quot;</span></span></span> <span class="z-keyword z-operator z-pipe z-elixir">|&gt;</span> <span class="z-entity z-name z-class z-elixir">File</span><span class="z-punctuation z-separator z-method z-elixir">.</span>read!<span class="z-punctuation z-section z-function z-elixir">(</span><span class="z-punctuation z-section z-function z-elixir">)</span> <span class="z-keyword z-operator z-pipe z-elixir">|&gt;</span> <span class="z-entity z-name z-class z-elixir">String</span><span class="z-punctuation z-separator z-method z-elixir">.</span>trim<span class="z-punctuation z-section z-function z-elixir">(</span><span class="z-punctuation z-section z-function z-elixir">)</span>
</span><span class="z-source z-elixir">  <span class="z-keyword z-control z-elixir">end</span>
</span><span class="z-source z-elixir">
</span><span class="z-source z-elixir"><span class="z-meta z-function z-elixir">  <span class="z-keyword z-control z-module z-elixir">defp</span> <span class="z-entity z-name z-function z-private z-elixir">version</span> <span class="z-keyword z-control z-module z-elixir">do</span></span>
</span><span class="z-source z-elixir">    <span class="z-meta z-string z-elixir"><span class="z-string z-quoted z-double z-elixir"><span class="z-punctuation z-definition z-string z-begin z-elixir">&quot;</span>VERSION<span class="z-punctuation z-definition z-string z-end z-elixir">&quot;</span></span></span> <span class="z-keyword z-operator z-pipe z-elixir">|&gt;</span> <span class="z-entity z-name z-class z-elixir">File</span><span class="z-punctuation z-separator z-method z-elixir">.</span>read!<span class="z-punctuation z-section z-function z-elixir">(</span><span class="z-punctuation z-section z-function z-elixir">)</span> <span class="z-keyword z-operator z-pipe z-elixir">|&gt;</span> <span class="z-entity z-name z-class z-elixir">String</span><span class="z-punctuation z-separator z-method z-elixir">.</span>trim<span class="z-punctuation z-section z-function z-elixir">(</span><span class="z-punctuation z-section z-function z-elixir">)</span>
</span><span class="z-source z-elixir">  <span class="z-keyword z-control z-elixir">end</span>
</span><span class="z-source z-elixir"><span class="z-keyword z-control z-elixir">end</span>
</span></code></pre>
<p>There are a couple of peculiar things here. First, we read the version of the library from a magic <code>VERSION</code> file. We keep this file alongside the <code>.proto</code> schemas. This file contains the version of the schemas themselves. Keeping it alongside the schemas means that we can copy it over in the right places when building libraries for different languages so that the <code>events_schemas</code> library can have the same version across all target languages. We copy this file to the root of the <code>events_schemas</code> Elixir directory before building and publishing the library. We use a similar idea for the <code>PROTOBUF_EX_VERSION</code> file. This file contains the version of the protobuf-elixir library that we use. We keep that in a separate file so that we can make sure it's the same between the plugin for the <code>protoc</code> compiler as well as the dependency of the <code>events_schemas</code> library.</p>
<p>Other that the things we just talked about, this looks like a pretty standard <code>mix.exs</code> file. Now, the magic happens in CI.</p>
<h3 id="concourse-ci"><a class="zola-anchor" href="#concourse-ci" aria-label="Anchor link for: concourse-ci">Concourse CI</a></h3>
<p>Our CI system of choice is <a href="https://concourse-ci.org">Concourse CI</a>. Concourse lets you define pipelines with different steps. Here, we're interested in the last step of our CI pipeline: publishing the libraries for all the languages. Our Concourse pipeline looks like this:</p>
<p><img src="https://andrealeopardi.com/posts/sharing-protobuf-schemas-across-services/concourse.png" alt="Screenshot of our Concourse CI pipeline" /></p>
<p>The last step, <code>build-and-publish</code>, is triggered manually by clicking on it and telling it to start. This means that if you want to release a new version of the <code>events_schemas</code> library in all languages, you have to go to Concourse and click this. That's all you need to do. Note that we have Docker containers that build and publish the library for each target language so that we don't have to install anything on the CI system. At this point, Concourse will do the same routine for all target languages:</p>
<ol>
<li>Copy all the necessary version files to the right places.</li>
<li>Generate code for the Protobuf schemas through <code>protoc</code>.</li>
<li>Publish to the right package repository (for example, <a href="https://hex.pm">hex.pm</a> for Elixir).</li>
</ol>
<p>That's all. Now, our services can depend on an actual library that contains the auto-generated code representing the Protobuf schemas that we use. However, services don't need to have access to the original <code>.proto</code> files containing the schemas. We're delighted with this system since it feels streamlined and straightforward to use, while providing everything we need.</p>
<h3 id="encore-multiple-protobuf-packages"><a class="zola-anchor" href="#encore-multiple-protobuf-packages" aria-label="Anchor link for: encore-multiple-protobuf-packages">Encore: multiple Protobuf packages</a></h3>
<p>We moved even a bit further than what I described. In fact, currently we have three Protobuf packages: one for common custom types, one for events, and one for inter-service RPCs. The events and RPC packages both depend on the custom types package. The way we solve the inter-package dependencies is to simply publish the <code>types_schemas</code> libraries first and then depend on that library from the <code>events_schemas</code> and <code>rpc_schemas</code> libraries. For example, in Elixir we changed the <code>mix.exs</code> file we looked at earlier (for the <code>events_schemas</code> library) and added the dependency:</p>
<pre data-lang="elixir" class="language-elixir z-code"><code class="language-elixir" data-lang="elixir"><span class="z-source z-elixir"><span class="z-meta z-function z-elixir"><span class="z-keyword z-control z-module z-elixir">defp</span> <span class="z-entity z-name z-function z-private z-elixir">deps</span> <span class="z-keyword z-control z-module z-elixir">do</span></span>
</span><span class="z-source z-elixir">  <span class="z-punctuation z-section z-array z-elixir">[</span>
</span><span class="z-source z-elixir">    <span class="z-meta z-sequence z-tuple z-elixir"><span class="z-punctuation z-section z-sequence z-begin z-elixir">{</span><span class="z-constant z-other z-symbol z-elixir"><span class="z-punctuation z-definition z-constant z-elixir">:</span>protobuf</span><span class="z-punctuation z-separator z-sequence z-elixir">,</span> protobuf_dependency_version<span class="z-punctuation z-section z-function z-elixir">(</span><span class="z-punctuation z-section z-function z-elixir">)</span><span class="z-punctuation z-section z-sequence z-end z-elixir">}</span></span><span class="z-punctuation z-separator z-object z-elixir">,</span>
</span><span class="z-source z-elixir">    <span class="z-meta z-sequence z-tuple z-elixir"><span class="z-punctuation z-section z-sequence z-begin z-elixir">{</span><span class="z-constant z-other z-symbol z-elixir"><span class="z-punctuation z-definition z-constant z-elixir">:</span>types_schemas</span><span class="z-punctuation z-separator z-sequence z-elixir">,</span> <span class="z-meta z-string z-elixir"><span class="z-string z-quoted z-double z-elixir"><span class="z-punctuation z-definition z-string z-begin z-elixir">&quot;</span>0.1.0<span class="z-punctuation z-definition z-string z-end z-elixir">&quot;</span></span></span><span class="z-punctuation z-separator z-sequence z-elixir">,</span> <span class="z-constant z-other z-keywords z-elixir">organization<span class="z-punctuation z-definition z-constant z-elixir">:</span></span> <span class="z-meta z-string z-elixir"><span class="z-string z-quoted z-double z-elixir"><span class="z-punctuation z-definition z-string z-begin z-elixir">&quot;</span>community<span class="z-punctuation z-definition z-string z-end z-elixir">&quot;</span></span></span><span class="z-punctuation z-section z-sequence z-end z-elixir">}</span></span>
</span><span class="z-source z-elixir">  <span class="z-punctuation z-section z-array z-elixir">]</span>
</span><span class="z-source z-elixir"><span class="z-keyword z-control z-elixir">end</span>
</span></code></pre>
<h2 id="conclusion"><a class="zola-anchor" href="#conclusion" aria-label="Anchor link for: conclusion">Conclusion</a></h2>
<p>To recap, our Protobuf pipeline and workflow currently work like this. First, you make changes to a Protobuf schema. Then, you bump a version in a file. Then, you push those changes up to GitHub. Once CI makes sure you didn't break anything, you log into Concourse and kick-start the <code>build-and-publish</code> task. A new version of the right library gets published to different package repositories for different languages. It's not the simplest system, but the workflow is easy to use and effective. Most of all, this workflow can apply to most programming languages and make it easier to manage versioning and evolving shared collections of Protobuf schemas.</p>
</div>

    <time class="posted-at" datetime="2020-02-24">
      Written on February 24, 2020
      
    </time>

    <script src="https://giscus.app/client.js"
        data-repo="whatyouhide/whatyouhide.github.io"
        data-repo-id="MDEwOlJlcG9zaXRvcnkxODQwNDQxNzQ="
        data-category="General"
        data-category-id="DIC_kwDOCvhKjs4CY-gd"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="preferred_color_scheme"
        data-lang="en"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>
  </article>
</div>


        <footer>
    <div class="icons">
        <a href="mailto:hi@andrealeopardi.com">
            <picture>
              <img id="icon-email"
                   class="footer-icon"
                   src="/assets/icons/email.png"
                   alt="Hand-drawn icon of a letter envelope"
                   title="Email" />
            </picture>
        </a>

        <a href="https://github.com/whatyouhide" target="_blank">
            <picture>
              <img id="icon-github"
                   class="footer-icon"
                   src="/assets/icons/github.png"
                   alt="Hand-drawn icon of the GitHub logo"
                   title="GitHub" />
            </picture>
        </a>

        <a href="https://twitter.com/whatyouhide" target="_blank">
            <picture>
              <img id="icon-twitter"
                   class="footer-icon"
                   src="/assets/icons/twitter.png"
                   alt="Hand-drawn icon of the Twitter logo"
                   title="Twitter" />
            </picture>
        </a>

        <a href="/feed.xml">
            <picture>
              <img id="icon-rss"
                   class="footer-icon"
                   src="/assets/icons/rss.png"
                   alt="Hand-drawn icon of the RSS logo"
                   title="RSS feed" />
            </picture>
        </a>
    </div>
</footer>

    </div>
</body>

</html>
